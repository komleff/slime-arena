# План исправлений по аудиту Codex (31 декабря 2025)

## ✅ СТАТУС: ВЫПОЛНЕНО (31 декабря 2025)

Все шаги кроме BoostSystem выполнены. Сложные эффекты талантов отложены в TECH_DEBT.

**Итоги:**
- Пул талантов: 29 → 40 (sense, regeneration + 9 классовых)
- talentRarityByLevel: веса редкостей по уровням 2-7+
- generateTalentCard(): редкость по уровню, гарантия классового
- forceAutoPickTalent(): автовыбор с приоритетами категорий
- talentCardSystem(): пауза таймера при смерти
- cardQueueMax=3: ограничение очереди
- Эффекты: thorns, ambush, parasite, magnet реализованы
- Build + test: ОК

**Отложено:**
- BoostSystem (GDD §8) — требует отдельную реализацию
- Сложные эффекты: sense, regeneration, momentum, berserk, symbiosis

---

## Контекст

Codex провёл аудит и выявил расхождения с GDD v3.3. План учитывает уточнения:
- Строгое соответствие таблице редкостей — **да**
- Уровни 6/7+ — для тестов допускается укороченная шкала
- Классовые таланты — **реализовать сейчас**
- Сундуки — **важнее содержимое** (талант + усиления), чем физика спавна

---

## Шаг 1: Завершить пул талантов (29 → 31 + классовые) ✅

### Ожидаемый результат
- Добавлены таланты «Чутьё» (sense) и «Регенерация» (regeneration)
- Добавлены 9 классовых талантов (3 на класс)
- Всего: 31 базовых + 9 классовых = 40 талантов

### Файлы/модули
| Файл | Изменения |
|------|-----------|
| `config/balance.json` | ✅ Добавлены sense, regeneration в common + секция classTalents |
| `shared/src/config.ts` | ✅ Расширен интерфейс для ClassTalentConfig |
| `client/src/main.ts` | ✅ Расширен talentInfo (иконки, описания) |

### Детали по GDD-Talents.md

**Обычные (добавить):**
```json
"sense": { "name": "Чутьё", "maxLevel": 2, "values": [2, 5], "effect": "chestSense" },
"regeneration": { "name": "Регенерация", "maxLevel": 2, "values": [[0.01, 5], [0.01, 4]], "effect": "outOfCombatRegen" }
```

**Классовые (новая секция):**
```json
"classTalents": {
  "hunter": {
    "ambush": { "name": "Засада", "rarity": "rare", ... },
    "momentum": { "name": "Разгон", "rarity": "rare", ... },
    "invisible": { "name": "Невидимка", "rarity": "epic", ... }  // дублирует общий
  },
  "warrior": {
    "indestructible": { "name": "Несокрушимый", "rarity": "rare", ... },
    "thorns": { "name": "Шипы", "rarity": "rare", ... },
    "berserk": { "name": "Берсерк", "rarity": "epic", ... }
  },
  "collector": {
    "parasite": { "name": "Паразит", "rarity": "rare", ... },
    "magnet": { "name": "Магнит", "rarity": "rare", ... },
    "symbiosis": { "name": "Симбиоз", "rarity": "epic", ... }
  }
}
```

### Риски/неопределённости
- ✅ Невидимка дублируется — решено: hunterInvisible как отдельный ID
- ⏸️ Эффекты Чутья/Регенерации требуют новых систем — отложено в TECH_DEBT

---

## Шаг 2: Распределение редкостей по уровням (GDD 7.2.1) ✅

### Ожидаемый результат
- `generateTalentCard()` учитывает уровень игрока при выборе редкости
- Ранние уровни (2) — только common; поздние (6+) — шанс на epic

### Файлы/модули
| Файл | Изменения |
|------|-----------|
| `config/balance.json` | ✅ Добавлена `talentRarityByLevel` таблица |
| `server/src/rooms/ArenaRoom.ts` | ✅ Изменён `generateTalentCard()` |

### Таблица редкостей (GDD)
```json
"talentRarityByLevel": {
  "2": { "common": 100, "rare": 0, "epic": 0 },
  "3": { "common": 85, "rare": 15, "epic": 0 },
  "4": { "common": 70, "rare": 28, "epic": 2 },
  "5": { "common": 60, "rare": 35, "epic": 5 },
  "6": { "common": 50, "rare": 40, "epic": 10 },
  "7": { "common": 40, "rare": 45, "epic": 15 }
}
```

### Риски/неопределённости
- ✅ Уровни 7+ используют fallback на "7"
- ✅ Если талантов выбранной редкости нет — понижаем редкость

---

## Шаг 3: Правила формирования набора карточек (GDD 7.3) ✅

### Ожидаемый результат
- ✅ Гарантия: минимум 1 классовый талант в наборе (если доступен)
- ✅ Запрет на 3 карточки одного типа эффекта (по category)
- ✅ Таланты с requirement показываются только при наличии умения

### Файлы/модули
| Файл | Изменения |
|------|-----------|
| `server/src/rooms/ArenaRoom.ts` | Рефакторинг `generateTalentCard()` с новыми правилами |

### Алгоритм
1. Получить пул доступных талантов (уже есть `getAvailableTalentsByRarity`)
2. Отфильтровать по requirement (уже есть)
3. Добавить фильтр по classRestriction (новое)
4. Для каждой из 3 карточек:
   - Бросить кубик редкости по уровню
   - Если 1-я карточка и есть классовый талант — гарантировать его
   - Проверить запрет на 3 одинаковых эффекта
5. Если редкость пустая — понизить

### Риски/неопределённости
- Определение «одного типа эффекта» — по полю `effect` в конфиге или группировка?
- Алгоритм может зациклиться при малом пуле

---

## Шаг 4: Ограничения очереди и таймер респауна (GDD 7.4)

### Ожидаемый результат
- Очередь талантов ограничена 3 элементами
- При переполнении — автовыбор старшего
- Таймер карточки паузится на время респауна (2 сек)

### Файлы/модули
| Файл | Изменения |
|------|-----------|
| `config/balance.json` | Добавить `cardQueueMax: 3` |
| `server/src/rooms/ArenaRoom.ts` | Изменить `awardTalentToPlayer()` — проверка лимита; изменить `talentCardSystem()` — пауза таймера при isDead |

### Детали
```typescript
// При добавлении в очередь
if (player.pendingTalentQueue.length >= this.balance.talents.cardQueueMax) {
    // Принудительный автовыбор старшего
    this.forceAutoPickTalent(player);
}

// В talentCardSystem при проверке таймера
if (player.isDead) {
    // Сдвигаем expiresAtTick на время, пока игрок мёртв
    card.expiresAtTick += 1;
}
```

### Риски/неопределённости
- Нужно отслеживать время смерти для корректного сдвига таймера

---

## Шаг 5: Автовыбор с приоритетами класса (GDD 7.5)

### Ожидаемый результат
- При автовыборе учитываются приоритеты класса (скорость/урон/защита)
- Охотник → скорость, Воин → защита, Собиратель → сбор

### Файлы/модули
| Файл | Изменения |
|------|-----------|
| `config/balance.json` | Добавить `autoPickPriorities` по классам |
| `server/src/rooms/ArenaRoom.ts` | Изменить `applyTalentAutoChoice()` — использовать весá |

### Таблица приоритетов (GDD)
```json
"autoPickPriorities": {
  "hunter": { "speed": 3, "damage": 2, "defense": 1 },
  "warrior": { "defense": 3, "damage": 2, "speed": 1 },
  "collector": { "gather": 3, "defense": 2, "speed": 1 }
}
```

### Маппинг эффектов → категории
```typescript
const effectCategories = {
  speedLimitBonus: "speed",
  turnBonus: "speed",
  biteDamageBonus: "damage",
  biteResistBonus: "defense",
  orbMassBonus: "gather",
  // ...
};
```

### Риски/неопределённости
- Не все эффекты однозначно относятся к одной категории
- Агрессор (+урон +потери) — смешанный

---

## Шаг 6: Усиления при отсутствии талантов (GDD-Chests 9)

### Ожидаемый результат
- При открытии сундука, если нет доступных талантов — выдаётся усиление (boost)
- 4 типа: rage, haste, guard, greed
- Разрешение по типу сундука

### Файлы/модули
| Файл | Изменения |
|------|-----------|
| `config/balance.json` | Добавить секцию `boosts` с параметрами |
| `server/src/rooms/schema/GameState.ts` | Добавить поля activeBoosts в Player |
| `server/src/rooms/ArenaRoom.ts` | Изменить `awardChestTalent()` — fallback на boost; добавить `boostSystem()` |
| `client/src/main.ts` | Визуализация активных усилений |

### Параметры (GDD)
```json
"boosts": {
  "types": {
    "rage": { "damageMul": 1.25, "durationSec": 10 },
    "haste": { "speedMul": 1.30, "durationSec": 10 },
    "guard": { "absorbDamage": true, "durationSec": 15 },
    "greed": { "bubbleMassMul": 2.0, "durationSec": 15, "maxBubbles": 3 }
  },
  "allowedByChest": {
    "rare": ["haste", "guard"],
    "epic": ["rage", "haste", "guard"],
    "gold": ["greed", "rage", "guard"]
  },
  "maxStackTimeSec": 20
}
```

### Риски/неопределённости
- Большой объём работы: схема, серверная логика, клиентский UI
- guard требует отслеживания следующего урона
- greed требует счётчика пузырей

---

## Шаг 7: Эффекты новых талантов (Чутьё, Регенерация, классовые)

### Ожидаемый результат
- Чутьё: предупреждение о сундуках за 2-5 сек
- Регенерация: +1% массы за 4-5 сек вне боя
- Классовые: Засада, Разгон, Шипы, Берсерк и т.д.

### Файлы/модули
| Файл | Изменения |
|------|-----------|
| `server/src/rooms/ArenaRoom.ts` | Добавить системы для новых эффектов |
| `client/src/main.ts` | Визуализация (предупреждение о сундуках) |

### Детали

**Чутьё:**
- Сервер: при спавне сундука отправить сообщение игрокам с талантом за N сек до появления
- Клиент: показать полупрозрачный маркер сундука

**Регенерация:**
- Сервер: отслеживать `lastDamageTick`, если прошло 3 сек — регенерировать массу

**Классовые таланты (по GDD):**
| Талант | Эффект | Сложность |
|--------|--------|-----------|
| Засада | +30% урон в бок/хвост | Средняя |
| Разгон | +5% скорость за сек движения (макс +20%) | Высокая |
| Несокрушимый | −15% потери | Низкая |
| Шипы | Атакующий теряет 10% от нанесённого | Средняя |
| Берсерк | +3% урон за 100кг потерь (макс +30%) | Высокая |
| Паразит | +5% массы от укуса слайма | Низкая |
| Магнит | Пузыри в 50м летят к пасти | Средняя |
| Симбиоз | +50% пузырей при укусе | Высокая |

### Риски/неопределённости
- Берсерк требует накопителя потерь за матч
- Разгон требует отслеживания времени непрерывного движения
- Симбиоз требует системы порождения дополнительных пузырей

---

## Приоритеты реализации

| Приоритет | Шаг | Обоснование |
|-----------|-----|-------------|
| 1 | Шаг 1 | Без полного пула талантов остальное не протестировать |
| 2 | Шаг 2 | Критичная механика по GDD |
| 3 | Шаг 3 | Зависит от шага 1 (классовые) |
| 4 | Шаг 6 | Важнее содержимое сундуков (по ТЗ) |
| 5 | Шаг 4 | Средний приоритет |
| 6 | Шаг 5 | Средний приоритет |
| 7 | Шаг 7 | Зависит от шага 1, большой объём |

---

## Оценка трудоёмкости

| Шаг | Оценка | Зависимости |
|-----|--------|-------------|
| 1. Пул талантов | 2-3 часа | — |
| 2. Редкости по уровню | 1-2 часа | — |
| 3. Правила набора | 2-3 часа | Шаг 1 |
| 4. Очередь и респаун | 1-2 часа | — |
| 5. Автовыбор | 2-3 часа | — |
| 6. Усиления | 4-6 часов | — |
| 7. Эффекты талантов | 6-8 часов | Шаг 1 |

**Итого:** ~18-27 часов

---

## Связанные документы

- [GDD-Talents.md](../../docs/gdd/GDD-Talents.md)
- [GDD-Chests.md](../../docs/gdd/GDD-Chests.md)
- [GDD-Core.md](../../docs/gdd/GDD-Core.md)
- [activeContext.md](../activeContext.md)
