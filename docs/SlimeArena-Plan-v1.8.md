# Slime Arena — План разработки

**Версия:** 1.8.1  
**Автор:** Claude Opus  
**Дата:** декабрь 2025  

План обновлён в соответствии с `SlimeArena-GDD-v2_4.md` и `SlimeArena-Flight-TZ-v1.0.md`.  
Техническая архитектура — в `SlimeArena-Architecture-v1.5.md`.

---

## 0. Изменения версии 1.8.1

- **U2-стиль сглаживания реализован** — задача клиентской интерполяции выполнена:
  - Visual State System с velocity integration
  - Упрощён ClientNetSmoothingConfig (только `lookAheadMs`)
  - Документация: `.memory_bank/modules/U2-smoothing.md`
- Обновлены ссылки на GDD v2.4.1 и Architecture v1.5.1.
- Критический путь прототипа: клиентское сглаживание отмечено выполненным.

## 0.1. Изменения версии 1.8

- Обновлена ссылка на GDD: `SlimeArena-GDD-v2_4.md`.
- Обновлена ссылка на архитектуру: `SlimeArena-Architecture-v1.5.md`.
- Добавлен инженерный источник правды по управлению/полёту: `SlimeArena-Flight-TZ-v1.0.md`.
- В прототипе ядра обновлены задачи и критический путь: вместо абстрактного модуля движения — реализация `FlightAssistSystem + PhysicsSystem + CollisionSystem` по Flight_TZ (силы/моменты, Semi‑Implicit Euler, импульсные коллизии, overspeed‑damping).
- Уточнено, что параметры движения/мира/сглаживания хранятся в отдельных конфиг‑структурах (`SlimeConfig`, `WorldPhysicsConfig`, `ClientNetSmoothingConfig`).

---

## 1. Источники правды

| Документ | Содержание |
|----------|------------|
| `SlimeArena-GDD-v2_4.md` | Дизайн, правила, баланс, интерфейсы, Приложение D (v2.4.1) |
| `SlimeArena-Flight-TZ-v1.0.md` | Инженерное ТЗ: управление/движение, FlightAssist/Physics/Collision, конфиги движения/мира/сглаживания (v1.0.1) |
| `SlimeArena-Architecture-v1.5.md` | Архитектура, модули, протокол, хранение (v1.5.1) |
| Этот документ | Этапы, оценки, зависимости, критерии (v1.8.1) |

---

## 2. Принципы (нельзя нарушать)

- **Матч не на паузе.** Любой выбор быстрый и безопасный.
- **Сервер авторитетный.** Клиент не решает урон/массу/столкновения/лут.
- **Конфигурация через config.** Баланс и экономика настраиваются без правок кода.
- **Простой запуск.** `docker compose up` и работает.
- **Оптимизация через ограничения.** Лимиты и простые примитивы важнее сложной графики.

---

## 3. Этапы разработки

Ниже — дорожная карта «слева направо»: от прототипа к публичному MVP, затем расширение.

### 3.1. Прототип ядра (Core Prototype)

**Цель:** доказать цикл «движение → пузырь → рост → столкновение → смерть/респаун → результат».

**Оценка:** 3–4 недели (1 fullstack)

**Зависимости:** нет

**Критический путь прототипа (что блокирует прогресс):**
- Room/матч-цикл (Colyseus) + старт/стоп матча.
- Серверная симуляция 30 Гц (фиксированный `dt`) + детерминированный порядок систем.
- Управление/движение по Flight_TZ: `FlightAssistSystem → PhysicsSystem → CollisionSystem` (forces/torque, drag, импульсы).
- Интенты ввода → симуляция → снапшоты (10–20 Гц) → доставка клиенту.
- Клиентский рендер: U2-стиль сглаживания (visual state + velocity integration) + приоритетная точность угла (боёвка зависит от ориентации).
- Мини-экран результатов (локальный), чтобы замкнуть цикл матча.

**Можно параллелить без риска:** плейсхолдер-арт/UI, звук, мета-меню. плейсхолдер-арт/UI, звук, мета-меню.


| Задача | Оценка | Зависит от | Блокирует |
|--------|--------|------------|-----------|
| Сервер: Colyseus room + tick loop (30 Гц, фиксированный dt) | 2 дня | — | Всё |
| Shared: схемы конфигов `SlimeConfig/WorldPhysicsConfig/ClientNetSmoothingConfig` + загрузка/валидация | 2 дня | — | Физика/движение |
| Сервер: `FlightAssistSystem` по `SlimeArena-Flight-TZ-v1.0.md` (forces/torque, drift‑brake, overspeed) | 3 дня | Room+Config | Управляемость/бой |
| Сервер: `PhysicsSystem` (Semi‑Implicit Euler + drag, правило изменения массы) | 2 дня | FlightAssist | Коллизии/бой |
| Сервер: `CollisionSystem` (круг‑круг + круг‑границы, импульсы + коррекция, 4 итерации) | 3 дня | Physics | Бой/пузырь/сундук |
| Пузыри: спавн, цвет, плотность, физика | 2 дня | Collision | Укус |
| Укус: полное + частичное поглощение, min остаток | 3 дня | Пузыри | Баланс |
| Бой: зоны пасть/хвост/бока + урон + i-frames | 3 дня | Collision | Смерть |
| Смерть/респаун: 2 сек + щит 5 сек + Last Breath 0.5 сек | 2 дня | Бой | — |
| Клиент: Canvas рендер (мир + сущности) | 3 дня | Room | HUD |
| Клиент: SnapshotStore + U2-стиль сглаживания (visual state + velocity integration) | 3 дня | Рендер | Управляемость | ✓ Выполнено |
| Клиент: адаптивный джойстик (default) + fixed (настройка) | 3 дня | Рендер | UX |
| Таймер матча + экран результатов (локальный) | 2 дня | Room | MVP |


**Критерий готовности:**
- Матч 1v1 (или с ботом) можно сыграть от старта до конца без падений.
- Предсказуемые отскоки и укус пузырей.
- Респаун и щит работают, нет «мгновенной смерти» серией ударов.

**Метрики успеха:**
- 0 критических ошибок за 20 тест-матчей.
- `tick_duration` p99 < 20 мс при 10–15 сущностях+ (slime+orbs+chests).

---

### 3.2. Внутренний MVP (Gameplay MVP)

**Цель:** собрать базовый геймплей GDD 2.4 для плейтестов: классы, MVP-умения, сундуки, фазы, мятежник, последний вздох, базовые таланты.

**Оценка:** 3–5 недель после прототипа

**Зависимости:** прототип ядра

| Задача | Оценка | Зависит от | Блокирует |
|--------|--------|------------|-----------|
| 3 класса (пассивы + стартовое умение) | 3 дня | Прототип | Баланс |
| Умения MVP: Рывок (dash) | 2 дня | Классы | — |
| Умения MVP: Выброс (projectile) | 3 дня | Классы | — |
| Умения MVP: Щит | 2 дня | Классы | — |
| Умения MVP: Притяжение (orbs only) | 2 дня | Классы | — |
| GCD 100 мс + очередь нажатий (max 1) | 2 дня | Умения | — |
| Сундуки: спавн, физика, типы, награды (%массы/талант) | 4 дня | Физика | Плейтест |
| Фазы матча + Hot Zones + голод | 4 дня | Таймер | Плейтест |
| Механика «Последний вздох» | 3 дня | Смерть/бой | Плейтест |
| Система «Мятежник» (пересчёт + награда + бафф) | 4 дня | Фазы/лидерборд | Плейтест |
| Таланты: очередь (max 3) + быстрый выбор | 5 дней | UI HUD | Плейтест |
| Таланты: минимальный пул (15 common) + автовыбор 30 сек | 5 дней | Система талантов | Баланс |
| HUD: масса/HP/время/топ-5 | 2 дня | Рендер | UX |
| HUD: кнопки умений + индикаторы КД/GCD | 3 дня | Умения | UX |
| HUD: индикатор очереди талантов + быстрый выбор | 2 дня | Таланты | UX |
| HUD: маркер Мятежника + события (toasts) | 2 дня | Rebel | UX |
| Визуал Last Breath (мигание/прозрачность) | 1 день | Last Breath | UX |
| Телеметрия матчевых событий (минимум) | 3 дня | Room | Аналитика |
| Инструментальный конфиг баланса (json + hot reload в dev) | 3 дня | — | Итерации |

**Критерий готовности:**
- 10–20 игроков могут плейтестить FFA без блокирующих багов.
- Система умений не позволяет «спамить» (GCD работает).
- Фазы дают нужный темп (рост → стычки → финал в зоне).

**Метрики успеха (внутренние):**
- Средняя длительность матча 2–3 минуты.
- Среднее число смертей на игрока за матч: 1–3 (без бесконечного кемпа).
- Доля убийств Мятежника ≥ 1 на матч (в тестах с 10+ игроков).

---

### 3.3. Публичный MVP (Product MVP)

**Цель:** первый релиз с минимальной продуктовой обвязкой и удержанием.

**Оценка:** 4–6 недель после внутреннего MVP

**Зависимости:** внутренний MVP + UI/UX дизайн

| Задача | Оценка | Зависит от | Блокирует |
|--------|--------|------------|-----------|
| Лобби: главный экран + поиск матча | 4 дня | — | Онбординг |
| Гостевой вход (анонимный userId) | 2 дня | — | Профиль |
| Профиль: экран + редактирование ника | 4 дня | Auth | — |
| Персистентность результатов матча (статы, рейтинг, капли) | 5 дней | Auth | Экономика |
| Рейтинг (Elo-like) + лиги | 4 дня | Персистентность | Лидерборд |
| Таблица лидеров (global + друзья позже) | 3 дня | Рейтинг | — |
| Достижения (ядро) + 10–15 достижений | 5 дней | Персистентность | Награды |
| Ежедневный бесплатный сундук + таймер | 4 дня | Персистентность | Удержание |
| Rewarded Ads: ×2 награда (капли/сундук) | 4 дня | Сундук/капли | Монетизация |
| Магазин косметики (минимум 5–10 скинов) | 6 дней | Капли | — |
| Юмористические титулы в конце матча | 2 дня | Results UI | Удержание |
| Модерация: репорты | 5 дней | Профиль | Безопасность |
| Политика конфиденциальности + age gate (если нужно) | 2 дня | — | Паблиш |

**Критерий готовности:**
- Игрок может: зайти → сыграть 5 матчей → получить капли → открыть сундук → купить скин → вернуться завтра за новым сундуком.
- Нет багов, меняющих исход матча (эксплойты умений/физики).

**Метрики успеха (первые 2–4 недели):**
- Retention D1 > 30%
- Retention D7 > 12–15%
- Средняя сессия > 5 минут
- Конверсия в rewarded ads > 20%

---

### 3.4. Альфа (расширение геймплея)

**Цель:** добавить глубину и разнообразие, не ломая ядро.

**Оценка:** 4–8 недель после публичного MVP (итеративно)

Кандидаты (часть может уйти в Бету по приоритету):
- Полный пул талантов (30) + редкости (rare/epic) + гарантии в выборе.
- Доп. умения (после MVP): Приманка, Деление (двойник), Шип.
- Командный режим 2v2/3v3 (без дружественного огня, сквозное прохождение союзников).
- Reroll токен (за рекламу до матча) — если потребуется.
- Улучшение обучения/туториала по дрифту и уязвимому хвосту.

**Метрики успеха:**
- Retention D7 > 18–20%
- Доля матчей в командном режиме > 25% (если режим включён)
- Снижение «rage quit» (дисконнектов в первые 30 сек) на 10%+

---

### 3.5. Бета (масштаб + сезонность)

**Цель:** подготовка к росту аудитории и запуск сезонной экономики.

**Оценка:** 6–10 недель после Альфы (можно параллелить)

| Функционал | Оценка |
|------------|--------|
| Сезонный пропуск (30 уровней, free+premium) | 2–3 недели |
| VIP-подписка | 1–2 недели |
| Капсулы косметики (pity + дубликаты → осколки) | 1–2 недели |
| Нагрузочные тесты + оптимизации снапшотов | 1–2 недели |
| Усиление античита (rate limit, anomaly detection) | 1 неделя |
| Режим босса (PvPvE) | 1–2 недели |

---

### 3.6. После MVP: Сезонный альбом (коллекционирование) — Epic

**Цель:** внедрить систему сезонного коллекционирования (альбом на 4 недели) как долгосрочное удержание.  
Основание: GDD 2.4, раздел 12.3 и Приложение D.

**Интеграции, которые надо учесть заранее (чтобы не ломать MVP):**
- Источники выдачи карт: пропуск, ежедневки/квесты, ивенты, магазин/офферы (по GDD).
- Сезонный ресет: закрытие сезона, выдача бейджа/награды, архив/история.
- UX-узлы: экран альбома, всплывающие награды, прогресс-бар, просмотр коллекции.
- Матч/сессия: триггеры выдачи (по результатам матча/за активность), антифрод.
- Аналитика: прогресс по коллекции, источники карт, конверсия в донат, доля собравших полностью.


**Когда:** после стабилизации публичного MVP (часто логично совместить с запуском пропуска).

**Оценка:** 6–12 недель (backend+client+контент), зависит от готовности пропуска и заданий.

#### 3.6.1. Backend (core)

- Таблицы/сущности: `album_seasons`, `album_cards`, `player_album_state`, `player_album_history`.
- API: `/album/state`, `/album/cards`, `/album/pack/open`, `/album/glue/exchange`, `/album/rewards/*`, `/album/arena-chest/*`.
- Логика: выдача паков, pity-счётчики, конвертация дублей в клей, обмен клея на паки.
- Идемпотентность открытия паков (idempotencyKey).
- Batch job миграции сезона (раз в 28 дней), конвертация клея → капли.

#### 3.6.2. Клиент (UI/UX)

- Экран «Альбом»: 5 страниц × 10 карт, прогресс, таймер сезона, баланс клея.
- Экран открытия пака: анимация, отметка NEW, дубликаты → +клей.
- Экран обмена клея на пак.
- «Сундук арены»: прогресс-бар на экране результатов + клейм пака.

#### 3.6.3. Интеграции

- Матч-сервис: передавать `totalMassCollected` для прогресса сундука арены.
- Задания/пропуск: выдача паков через `grantPack(..., source)`.
- Аналитика: события из Приложения D.

**Метрики успеха (сезон 1–2):**
- Участие в альбоме (открыли ≥1 пак): 60%+ активных
- Среднее число открытых паков на активного: 30+ за сезон
- Рост Retention D30 на 2–5 п.п. относительно сезона без альбома

---

## 4. Детализация экранов (публичный MVP)

### 4.1. Главный экран лобби (обновлено)

| Элемент | Расположение | Действие |
|---------|--------------|----------|
| «Играть» | Центр | Переход к поиску |
| Выбор режима | Под кнопкой | FFA (позже Team/Boss) |
| Профиль | Верхний левый | Переход к профилю |
| Магазин | Верхний правый | Переход к магазину |
| Ежедневный сундук | Рядом с магазином/валютой | Открыть/показать таймер |
| Валюта (капли) | Верхний правый | Отображение |
| Онлайн | Нижний левый | Отображение |

### 4.2. Экран результатов (добавлено)

| Блок | Содержание |
|------|------------|
| Место и масса | итоговое место, финальная масса |
| Награды | капли, рейтинг, достижения/прогресс |
| Титул | юмористический титул матча |
| Кнопки | «Сыграть ещё», «В лобби» |
| (после MVP) Сундук арены | прогресс и клейм пака |

---

## 5. Телеметрия (обновлено)

### 5.1. События матча

| Событие | Поля | Когда |
|---------|------|-------|
| `match_start` | matchId, playerCount, mode, seed | Старт |
| `match_end` | matchId, duration, winnerMass, avgMass, phase | Конец |
| `player_death` | matchId, playerId, killerId, mass, phase, lastBreath | Смерть |
| `last_breath_started` | matchId, playerId | Старт Last Breath |
| `rebel_assigned` | matchId, rebelId, avgMass | Назначение Мятежника |
| `rebel_killed` | matchId, rebelId, killerId | Убийство Мятежника |
| `orb_eaten` | matchId, playerId, orbMass, colorId, wasPartial | Укус |
| `ability_used` | matchId, playerId, abilityId | Умение |
| `chest_opened` | matchId, playerId, chestType, rewardType | Сундук |
| `talent_chosen` | matchId, playerId, talentId, method | Талант |

### 5.2. События продукта

| Событие | Поля | Когда |
|---------|------|-------|
| `daily_chest_claimed` | userId, rewardType, doubled | Получение |
| `ad_watched` | userId, adType, reward | Реклама |
| `purchase` | userId, itemId, price, currency | Покупка |
| `report_sent` | userId, targetId, category | Репорт |

### 5.3. События альбома (после MVP)

Использовать события из Приложения D:
- `album_pack_opened`, `album_card_collected`, `album_page_completed`, `album_glue_exchanged`, `album_arena_chest_claimed`, `album_season_end`, и т.д.

---

## 6. Тестирование (обновлено)

### 6.1. Физика и симуляция

| Тест | Критерий |
|------|----------|
| Упругие столкновения | нет «взрыва» скорости, нет залипаний |
| `overspeedDampingRate` | превышение скорости гасится плавно |
| Плотность пузырей | золотые сложнее сдвигать при той же массе |
| Сундуки физические | сундук отлетает, но открывается пастью |
| Большая масса | формулы и лимиты работают при 10000+ |

### 6.2. Механики

| Тест | Критерий |
|------|----------|
| GCD + очередь | нельзя прожать 2 умения в 1 тик; очередь max 1 |
| Последний вздох | 0.5 сек, неуязвимость, корректная финализация смерти |
| Мятежник | корректное назначение и награда за убийство |
| Щит респауна | 5 сек, снимается атакой |

### 6.3. Управление

| Тест | Критерий |
|------|----------|
| Adaptive joystick | работает «под палец», не прилипает |
| Fixed joystick | стабильно на одинаковом месте |
| Кнопки умений | удобно на 375×667 |
| Быстрый выбор талантов | при уроне закрывается, талант остаётся в очереди |

---

## 7. Definition of Done (без изменений по смыслу)

См. версию 1.3; дополнение для meta/альбома:
- Любая выдача наград имеет идемпотентность и аудит.
- Любые сезонные операции (reset) имеют dry-run и логи.

---

## Приложение A. Формат конфигурации (обновление)

Рекомендуем хранить баланс в виде набора JSON (или TS/JSON) файлов с hot‑reload в dev.

Минимальный набор (MVP/прототип):

- `config/slimes/*.json` — `SlimeConfig` (база + 3 класса + боссы позже).
- `config/worlds/*.json` — `WorldPhysicsConfig` (стандарт/космос/болото/и т.п.).
- `src/client/config/netSmoothing.json` — `ClientNetSmoothingConfig`.

Остальные секции (как и раньше, по мере готовности):
- `orb` (включая `colorDistribution`, `densityByColor`, `spawn`)
- `match` (фазы, зоны, голод)
- `joystick` (mode/radius/deadzone/sensitivity/followSpeed)
- `abilities` (cooldowns, costs, gcdMs, queueSize)
- `classes` (выбор класса → какой SlimeConfig использовать, пассивы)
- `talents`
- `rebel`
- `lastBreath`
- `chests`
- `dailyChest`
- (после MVP) `album` (pity, glue, пороги сундука арены)

---

## Приложение B. Глоссарий

| Термин | Определение |
|--------|-------------|
| GCD | Global Cooldown между умениями |
| Last Breath | 0.5 сек после смерти для контратаки |
| Rebel | Маркер лидера с наградой за убийство |
| Pity | Гарантии выпадения (альбом/капсулы) |
| Idempotency | Защита от двойных наград |
