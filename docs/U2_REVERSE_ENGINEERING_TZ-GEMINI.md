# Техническое Задание (ТЗ): Описание модулей проекта U2

Данный документ описывает логику работы ключевых модулей системы на основе реверс-инжиниринга кодовой базы.

## 1. Физика полета

Физический движок реализует релятивистскую механику движения материальной точки в 2D пространстве с учетом инерции.

**Основные принципы:**
*   **Релятивистская модель:** Интеграция движения построена на связи импульса (Momentum) и скорости (Velocity) через релятивистский множитель Гамма ($\gamma$).
    *   Связь: $p = \gamma \cdot m \cdot v$, где $\gamma = \frac{1}{\sqrt{1 - \beta^2}}$, $\beta = \frac{v}{c'}$.
*   **Ограничение скорости:** Введена фундаментальная константа "скорость света" ($c'$). Максимальная скорость корабля жестко ограничена значением $0.99c'$. При превышении происходит нормализация вектора скорости.
*   **Интеграция:**
    1.  На основе управляющих воздействий (Control Inputs) рассчитываются силы (Force) и крутящий момент (Torque).
    2.  Силы изменяют импульс (линейный и угловой).
    3.  Из нового импульса рассчитывается новая скорость с учетом релятивистской массы.
    4.  Скорость изменяет позицию и ориентацию (Transform).
*   **Инерция:** Без внешних сил корабль сохраняет вектор импульса (Newtons First Law). Трение отсутствует, остановка возможна только применив контр-тягу (активно или через Flight Assist).

## 2. ТТХ кораблей и параметры Default Ship

Характеристики кораблей определяются конфигурационными объектами (`ShipConfig`), которые делятся на группы параметров.

**Структура параметров:**
1.  **Classification (Классификация):** Размер (small/medium/etc.) и роль (fighter/freighter/miner).
2.  **Geometry (Геометрия):** Габариты (длина, ширина, высота) и коллизионный радиус.
3.  **Hull (Корпус):** Сухая масса (`DryMass_t`), прочность (`Hull_HP`) и грузоподъемность.
4.  **Propulsion (Двигательная установка):**
    *   **ThrustForce_MN:** Основной параметр. Сила тяги маршевых двигателей (Forward/Reverse) и маневровых (Lateral) в МегаНьютонах.
    *   **AngularAcceleration:** Угловое ускорение (Pitch/Yaw/Roll) в градусах/сек².
5.  **Signatures (Сигнатуры):** Заметность в спектрах IR, EM, CrossSection.
6.  **FlightAssist (Настройки помощника):** Лимиты перегрузок (`CrewGLimit`), комфортное время торможения.

**Параметры "Default Ship" (на примере *Snub Shuttle*):**
*   **Масса:** Легкий класс (~8 тонн).
*   **Тяга:** Высокая тяговооруженность (50 м/с² ускорение).
*   **Маневренность:** Сбалансированные стрейфы (45 м/с²) и высокая скорость поворота (80 град/с).
*   **Назначение:** Базовый маневренный корабль для перемещения без грузового отсека.

## 3. Принцип управления кораблем

Управление реализовано через систему команд (Command Frames), формируемых на клиенте и обрабатываемых на сервере (Authoritative Server).

**Логика:**
1.  **InputManager:** Опрашивает устройства ввода (клавиатура, мышь, тачскрин).
2.  **Mapping:** Преобразует физические нажатия в абстрактные оси управления:
    *   **Thrust:** Продольная тяга (Вперед/Назад).
    *   **Strafe:** Поперечная тяга (Влево/Вправо).
    *   **Yaw:** Рыскание (Поворот носа влево/вправо).
3.  **Нормализация:** Значения осей нормализуются в диапазон $[-1, 1]$.
4.  **Brake (Тормоз):** Специальный канал управления (Space), который в режиме помощника активирует полную остановку (mapped как отрицательный Strafe Y).
5.  **Пакетная передача:** Клиент отправляет состояние инпутов на сервер тик-в-тик для симуляции.

## 4. Flight Assist и его режимы полета

Flight Assist (FA) — система бортового компьютера, упрощающая пилотирование путем автоматической компенсации инерции.

**Режимы:**

1.  **FA:ON (Включен - Стандартный режим):**
    *   **Drift Damping (Гашение дрейфа):** Если пилот отпускает управление (ось = 0), система применяет контр-тягу, чтобы свести скорость к нулю.
    *   **Comfort Control:** Сглаживает резкие инпуты, обеспечивая плавный разгон и торможение за заданное время (`ComfortableBrakingTime_s`).
    *   **Speed Limits:** Ограничивает максимальную скорость движения в разных направлениях согласно ТТХ корабля (Forward/Lateral caps).
    *   **G-Limiter:** Ограничивает ускорение, чтобы не превысить лимит перегрузки экипажа (по умолчанию 10g).

2.  **FA:OFF (Выключен - "Ньютоновский" режим):**
    *   **Raw Input:** Инпуты пилота напрямую управляют тягой двигателей.
    *   **Без гашения:** При отпускании управления корабль продолжает движение бесконечно (сохраняет импульс).
    *   **Полная мощность:** Игнорируются комфортные лимиты, доступна вся мощность двигателей (до физических пределов массы/тяги).
    *   **Clamp:** Инпуты просто обрезаются до диапазона $[-1, 1]$.

## 5. Логика ассистента управления кораблем в мобильном режиме

Модуль `TouchInputManager` реализует виртуальный интерфейс управления для сенсорных экранов.

**Ключевые особенности:**
*   **Виртуальные стики (Joysticks):**
    *   **Левый стик:** Комбинированное управление тягой (Y-axis = Thrust) и стрейфом (X-axis = Strafe).
    *   **Правый стик:** Управление поворотом (X-axis = Yaw).
*   **Adaptive Layout (Адаптивная верстка):** Позиция и размер элементов управления динамически меняются в зависимости от устройства (Телефон/Планшет) и ориентации (Портрет/Ландшафт).
    *   На телефонах стики смещаются ближе к краям для удобства больших пальцев.
*   **Функциональные кнопки:**
    *   **BRAKE:** Экстренное торможение (расположена над левым стиком).
    *   **FA:** Переключатель режима Flight Assist.
    *   **AUTO:** Автопилот.
*   **Haptic Feedback (Виброотклик):** При использовании стиков и кнопок срабатывает вибрация (Vibration API) для тактильного подтверждения действий.
*   **Dead Zone:** Программная "мертвая зона" в центре стиков для предотвращения случайного дрейфа.

## 6. Алгоритм предиктивного сглаживания

Модуль `EntitySmoother` отвечает за плавное отображение сущностей на клиенте, компенсируя сетевые задержки и низкую частоту обновлений сервера.

**Алгоритм:**
1.  **Hermite Splines (Сплайны Эрмита):** Вместо линейной интерполяции используется кубическая интерполяция Эрмита. Она учитывает не только позиции (Pos), но и скорости (Vel) в начальной и конечной точках, обеспечивая гладкость движения без "углов" в точках обновления.
2.  **Prediction (Предсказание):** Целевая точка (`Target`) рассчитывается с экстраполяцией в будущее на величину `LookAheadMs` + сетевая задержка.
3.  **Toroidal Support (Тороидальный мир):** При расчете путей учитывается зацикленность мира ("бублик"). Вектора и сплайны строятся по кратчайшему пути через границы мира, координаты нормализуются (`wrapCoord`).
4.  **Rotation Smoothing (Сглаживание вращения):** Вращение также интерполируется сплайнами с учетом угловой скорости (`AngularVelocity`), что устраняет рывки при поворотах.
5.  **Adaptive Catch-up (Адаптивная скорость):** Если клиентское представление сильно отстает от серверного, скорость анимации плавно увеличивается (`CatchUpFactor`), чтобы нагнать актуальное состояние без телепортации.
6.  **Teleport:** Если расхождение превышает критический порог (`MaxDeviation`), происходит мгновенный "телетпорт" к актуальным координатам.
