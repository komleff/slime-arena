# Slime Arena v0.7.3 Release Notes

**Дата:** 1 февраля 2026
**Спринты:** 15 (Platform Adapters) + 16 (OAuth)
**PR:** #112, #115
**Статус:** Release

## Ревью-консенсус

### PR #112 (Sprint 15)
| Ревьювер | Статус |
|----------|--------|
| Claude Opus 4.5 | ✅ APPROVED |
| GitHub Copilot | ✅ COMMENTED (fixed) |
| Gemini Code Assist | ✅ APPROVED |
| OpenAI Codex | ✅ APPROVED |

### PR #115 (Sprint 16)
| Ревьювер | Статус |
|----------|--------|
| GitHub Copilot | ✅ CLEAN (0 comments) |
| Claude Opus 4.5 | ⚠️ P1 issues → tech debt |
| Gemini Code Assist | ✅ APPROVED |
| OpenAI Codex | ✅ APPROVED |
| Lingma | ✅ APPROVED |

**Консенсус: 4/5 APPROVED**

---

## Обзор

Релиз v0.7.3 объединяет два больших спринта:
- **Sprint 15:** Полная поддержка игровых платформ (CrazyGames, GameDistribution, Yandex Games, Poki)
- **Sprint 16:** OAuth авторизация для Standalone-пользователей (Google, Yandex)

Это ключевой релиз для софт-лонча: игра теперь полностью готова к публикации на всех целевых платформах с полноценной системой авторизации и рейтингов.

---

## Новые возможности

### Sprint 15 — Platform Adapters

- **YandexAdapter** — интеграция с Yandex Games SDK
  - Авторизация через Yandex ID
  - Поддержка полноэкранной рекламы
  - Соответствие требованиям площадки

- **PokiAdapter** — интеграция с Poki SDK
  - Уникальная идентификация игроков
  - Поддержка рекламных форматов Poki

- **CrazyGamesAdapter** — интеграция с CrazyGames SDK
  - JWT-авторизация
  - CrazyGamesAdsProvider для рекламы
  - Валидация platformData

- **GameDistributionAdapter** — интеграция с GameDistribution SDK
  - GameDistributionAdsProvider
  - SDK caching для производительности

- **PlatformManager v2** — умный менеджер платформ
  - Автоматическое определение платформы
  - Приоритет: Telegram → CrazyGames → GameDistribution → Yandex → Poki → Standalone
  - Унифицированный API для всех платформ

- **Server Auth Providers** — серверная авторизация
  - CrazyGamesAuthProvider (JWT верификация)
  - PokiAuthProvider
  - YandexAuthProvider

### Sprint 16 — OAuth для Standalone

- **Google OAuth Provider** — авторизация через Google
  - PKCE flow для безопасности
  - Региональные ограничения (недоступен в РФ)

- **Yandex OAuth Provider** — авторизация через Яндекс ID
  - Полная поддержка русскоязычной аудитории
  - Получение аватара и displayName

- **OAuthProviderFactory** — фабрика провайдеров
  - Региональная доступность по GeoIP
  - Автоматический выбор доступных провайдеров

- **GeoIP Service** — определение региона
  - ip-api.com интеграция
  - Кэширование результатов
  - Fallback для локальных адресов

- **NicknameConfirmModal** — подтверждение никнейма
  - Дефолт из OAuth провайдера
  - Возможность изменения (2-20 символов)
  - Валидация в реальном времени

- **AccountConflictModal** — разрешение конфликтов
  - 409 обработка (OAuth привязан к другому аккаунту)
  - Выбор: переключиться или остаться гостем

- **Rating System** — система рейтингов
  - Инициализация из claimToken.finalMass
  - Накопление массы после матчей
  - Обновление рекорда (best_mass)
  - Идемпотентность через rating_awards

---

## Исправленные баги

### Sprint 15

| ID | Приоритет | Описание |
|----|-----------|----------|
| Copilot P0 | P0 | CrazyGames platformData format (JWT) |
| Codex P1 | P1 | Poki userId prefix validation |
| Copilot P1 | P1 | GameDistribution SDK caching |
| Gemini P2 | P2 | YandexAdapter trim() |
| Codex P2 | P2 | GD_OPTIONS.gameId warning |

### Sprint 16

| ID | Приоритет | Описание |
|----|-----------|----------|
| P0-1 | P0 | skinId гостя не сохранялся при upgrade |
| P0-2 | P0 | Рейтинг не инициализировался из claimToken |
| P0-3 | P0 | awardRating() не начислял массу |
| P1-4 | P1 | Никнейм устанавливался без подтверждения |
| — | P1 | SPA routing: redirect_uri → root "/" |
| — | P1 | 409 handling: claim_already_consumed vs conflict |
| — | P2 | Math.round для integer колонок в БД |

---

## Технические улучшения

### Архитектура

- **Preact signals** для OAuth state management
- **Two-phase OAuth flow:** prepare-upgrade → nickname confirmation → complete
- **JWT tokens:** prepareToken, claimToken, accessToken с проверкой типа
- **Race condition protection** через атомарные SQL запросы

### Инфраструктура

- **Docker build scripts** — универсальные скрипты для Linux/macOS/Windows
  - `docker/build.sh` — Bash версия
  - `docker/build.ps1` — PowerShell версия
  - Multi-platform support (ARM64 + AMD64)
  - Seed data для первого игрока

- **Миграции БД** — 4 миграции (001, 002, 007, 008)
  - leaderboard_total_mass, leaderboard_best_mass
  - rating_awards (идемпотентность)
  - oauth_links (связь OAuth провайдеров)

### Качество кода

- 12+ итераций код-ревью от 5 AI-ревьюверов
- TypeScript strict mode compliance
- Все P0/P1 замечания исправлены

---

## Tech Debt (Sprint 17)

| Beads ID | Приоритет | Описание |
|----------|-----------|----------|
| slime-arena-b1b | P1 | PKCE валидация на сервере |
| slime-arena-5tp | P1 | UNKNOWN регион: отключить Google |
| slime-arena-3ed | P1 | Rate limiting на /auth/* |
| slime-arena-2q0 | P1 | Nickname validation в /auth/upgrade |
| slime-arena-b48 | P1 | Accessibility: Escape + focus trap |
| slime-arena-k8w | P2 | Скин не сохраняется после OAuth |
| slime-arena-9zu | P2 | GeoIP: HTTPS вместо HTTP |
| slime-arena-2j6 | P1 | Yandex JWT верификация подписи |
| slime-arena-u1r | P1 | CrazyGames JWT верификация подписи |

---

## Миграция с v0.7.0

Никаких breaking changes. Обновление:

```bash
git checkout main
git pull origin main
npm install
npm run build
```

Для Docker:

```bash
# Linux/macOS
./docker/build.sh monolith

# Windows
.\docker\build.ps1 monolith

# Запуск
docker-compose -f docker/docker-compose.monolith-full.yml up
```

---

## Известные ограничения

1. **Google OAuth** недоступен в РФ (региональные ограничения)
2. **PKCE** генерируется на клиенте, но не валидируется на сервере (P1 tech debt)
3. **Rate limiting** не реализован для /auth/* endpoints (P1 tech debt)
4. **Скин гостя** не применяется к профилю после OAuth (P2 tech debt)

---

## Статистика

### Sprint 15
- **PR #112:** 38 коммитов
- **Файлов изменено:** 42 (+3500 / -200)
- **Итераций ревью:** 6

### Sprint 16
- **PR #115:** 47 файлов
- **Строк кода:** +5194 / -1001
- **Итераций ревью:** 5

### Общее
- **Новых компонентов:** 15+ (adapters, modals, services)
- **Закрыто beads:** 10+
- **AI-ревьюверов:** 5 (Opus, Copilot, Gemini, Codex, Lingma)

---

## Благодарности

- **Claude Opus 4.5** — архитектурные решения и код-ревью
- **GitHub Copilot** — детальный анализ edge cases
- **Gemini Code Assist** — проверка соответствия ТЗ
- **OpenAI Codex** — security review
- **Alibaba Lingma** — database review

---

**Релиз:** v0.7.3 — готов к софт-лончу на всех целевых платформах
