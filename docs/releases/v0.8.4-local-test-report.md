# Отчёт локального тестирования v0.8.4

**Дата:** 2026-02-07
**Тестировщик:** Оператор + Claude
**Окружение:** Windows, Docker Desktop, Node.js 24, Chrome

---

## Результаты

| Компонент | Статус | Комментарий |
|-----------|--------|-------------|
| PostgreSQL + Redis (Docker) | PASS | Контейнеры стартуют, healthcheck работает |
| Миграции БД (6 файлов) | PASS | После ручного копирования SQL в dist/ |
| Seed-данные (3 пользователя) | PASS | После миграций, вручную |
| MetaServer (порт 3000) | PASS | Health OK, auth, leaderboard |
| MatchServer (порт 2567) | PASS | WebSocket, матчи сохраняются |
| Client (порт 5173) | PASS | Vite dev, UI отображается |
| Admin Dashboard (порт 5175) | PASS | Логин admin/Admin123!@# |
| Yandex OAuth | PASS | Авторизация, профиль, seed-пользователи |
| Игровой процесс | PASS | Матчи, сбор массы, результаты сохраняются |
| Статистика / Лидерборд | PASS | Загрузка, обновление рейтинга |
| Admin 2FA Setup | PASS | QR-код, verify, totp_enabled = true |
| Admin Restart (2FA + outbox) | PASS | 202 Accepted, файл создан, audit записан |

---

## Найденные проблемы

### P2: seed-data.sql запускается до миграций

**Файл:** `docker/docker-compose.yml` (dev)
**Описание:** seed-data.sql монтируется в `/docker-entrypoint-initdb.d/`, но содержит INSERT в `admin_users`, которая создаётся миграцией 009. PostgreSQL падает при инициализации.
**Решение:** Закомментирован mount. Seed загружается вручную после миграций:
```bash
docker exec -i slime-arena-postgres psql -U slime -d slime_arena < docker/seed-data.sql
```
**Статус:** Workaround применён в docker-compose.yml (закомментирован mount).

### P2: SQL-миграции не копируются в dist/

**Файл:** `server/src/db/migrations/*.sql`
**Описание:** `tsc` не копирует `.sql` файлы в `dist/`. Команда `npm run db:migrate` падает с ENOENT.
**Решение:** Вручную: `cp server/src/db/migrations/*.sql server/dist/server/src/db/migrations/`
**Примечание:** В Docker-образе это не проблема — Dockerfile копирует всё.
**Рекомендация:** Добавить postbuild-скрипт в server/package.json.

### P2: OAUTH_YANDEX_ENABLED=false в production compose

**Файл:** `docker/docker-compose.app-db.yml`, строка 56
**Описание:** `OAUTH_YANDEX_ENABLED` по умолчанию `false`. Если оператор не укажет `OAUTH_YANDEX_ENABLED=true` в `.env`, Yandex OAuth будет отключён на production.
**Решение:** Оператор должен добавить `OAUTH_YANDEX_ENABLED=true` в `.env` на сервере.

### P3: SHARED_DIR и volume для watchdog не настроены в production compose

**Файл:** `docker/docker-compose.app-db.yml`
**Описание:** Restart endpoint пишет outbox-файл в `SHARED_DIR` (default `/shared`). Но в production compose нет ни env var `SHARED_DIR`, ни shared volume между app-контейнером и хостом. Watchdog на хосте не сможет прочитать файл.
**Решение:** Добавить в production compose:
```yaml
app:
  volumes:
    - /root/slime-arena/shared:/shared
  environment:
    - SHARED_DIR=/shared
```
И создать watchdog-скрипт на хосте.
**Статус:** Не блокирует деплой (рестарт можно делать через `docker compose restart app`).

### P3: Зависание на экране смерти

**Описание:** Игрок погиб и завис на экране «Вы погибли / Возрождение...». Не удалось воспроизвести стабильно.
**Контекст:** Возможно связано с перезапуском MetaServer во время активного матча.
**Статус:** Требует отдельного исследования.

---

## Обновления документации

### AI_AGENT_GUIDE.md — нужно добавить

1. **Секция «Первый деплой v0.8.4»:**
   - Убедиться что `.env` содержит `OAUTH_YANDEX_ENABLED=true`
   - Убедиться что `.env` содержит `ADMIN_ENCRYPTION_KEY` (обязательно)
   - После `docker compose up -d app` — обязательно запустить миграции

2. **Секция «Проверка Admin Dashboard»:**
   - Открыть `https://domain/admin/`
   - Логин admin / (пароль из .env или заданный оператором)
   - Настроить 2FA в Settings
   - Проверить рестарт (опционально, требует watchdog)

3. **Red flags — дополнить:**
   - `ADMIN_ENCRYPTION_KEY not set` — критично для production
   - `ENOENT: restart-requested` — SHARED_DIR не настроен

---

## Порядок деплоя v0.8.4 на production

```
1. Бэкап БД (P0)
2. docker compose pull app
3. docker compose up -d app
4. docker exec slime-arena-app npm run db:migrate --workspace=server
5. Проверить: curl /health
6. Проверить: guest auth
7. Проверить: /admin/ (логин, 2FA)
8. Проверить: Yandex OAuth (если OAUTH_YANDEX_ENABLED=true в .env)
```
