# Slime Arena — Chests

**Версия:** 3.3.2  
**Дата:** 03.01.2026  
**Зависимости:** GDD-Core.md (GCD), GDD-Talents.md (редкости)  
**Глоссарий:** [GDD-Glossary.md](GDD-Glossary.md)  

---

## 1. Типы сундуков

| Тип `chestType` | Обручи `armorRings` | Описание |
|---|---:|---|
| `rare` | 0 | Быстро вскрывается |
| `epic` | 1 | Требует снятия одного обруча |
| `gold` | 2 | Требует снятия двух обручей |

---

## 2. Появление сундуков

### 2.1. Общие правила

- Сундук появляется на карте в случайной точке.
- Сундук не может появиться внутри препятствий.
- Сундук не может появиться ближе `chestSpawnMinDistanceToPlayerM` к любому живому игроку.
- Сундук не может появиться ближе `chestSpawnMinDistanceToChestM` к другому сундуку.
- Сундук исчезает по таймеру `chestLifeTimeSec`, если не вскрыт.

### 2.2. Параметры появления

| Параметр | Значение |
|---|---|
| Интервал попытки появления `chestSpawnIntervalSec` | 18–26 сек |
| Максимум сундуков на карте `chestMaxAliveTotal` | 3 |
| Время жизни сундука `chestLifeTimeSec` | 35 сек |
| Минимальное расстояние до игрока `chestSpawnMinDistanceToPlayerM` | 120 м |
| Минимальное расстояние до сундука `chestSpawnMinDistanceToChestM` | 200 м |
| Попыток размещения `spawnRetryCount` | 10 |

При неудаче найти подходящую точку за 10 попыток — спавн пропускается.

### 2.3. Выбор типа по фазе матча

| Фаза | Вес `rare` | Вес `epic` | Вес `gold` |
|---|---:|---:|---:|
| Рост (0–60 сек) | 85 | 15 | 0 |
| Охота (60–120 сек) | 65 | 30 | 5 |
| Финал (120–180 сек) | 50 | 35 | 15 |

---

## 3. Видимость и оповещение

### 3.1. Видимость на мини-карте

**Сундуки видны на мини-карте всем игрокам глобально.**

Это создаёт "горячие точки" и обостряет борьбу за сундуки.

### 3.2. Видимость на экране

- Сундук виден на экране только при попадании в область видимости камеры.
- В момент появления сундук издаёт звук и имеет заметное свечение.

### 3.3. Талант «Чутьё»

Игрок с талантом получает раннее предупреждение о появлении сундука.

| Параметр | Значение |
|---|---|
| Предупреждение `chestSenseLeadTimeSec` | 2–5 сек |

---

## 4. Физика сундука

### 4.1. Требования

- Сундук — физический объект.
- Масса сундука сопоставима с тяжёлым слаймом.
- При ударе сундук должен смещаться, но не улетать слишком далеко от одного удара.

### 4.2. Параметры по типам

| Параметр | `rare` | `epic` | `gold` |
|---|---:|---:|---:|
| Множитель к медианной массе игроков `chestMassMul` | 0.8 | 1.1 | 1.4 |
| Минимальная масса `chestMassMinKg` | 250 | 350 | 450 |
| Максимальная масса `chestMassMaxKg` | 1800 | 2200 | 2600 |
| Ограничение скорости `chestMaxSpeedMps` | 70 | 65 | 60 |
| Множитель сопротивления среды `chestLinearDragMul` | 1.6 | 1.9 | 2.2 |
| Множитель импульса от укуса `chestBiteImpulseMul` | 0.85 | 0.75 | 0.65 |

### 4.3. Геймплейное замечание

Большим игрокам выгодно снижать скорость перед атакой сундука, иначе сундук уходит от них.

---

## 5. Механика вскрытия

### 5.1. Определения

- **Обруч** — слой защиты сундука.
- **Укус по сундуку** — действие укуса, успешно применённое к сундуку.

### 5.2. Правила

1. Если `armorRings > 0`, успешный укус ломает один обруч: `armorRings = armorRings - 1`.
2. Если `armorRings == 0`, следующий успешный укус вскрывает сундук.
3. Вскрывает сундук игрок, нанёсший укус при `armorRings == 0`.
4. Укусы разных игроков могут ломать обручи по очереди. Это делает сундук спорным объектом.

### 5.3. Учёт глобальной перезарядки

- Любое действие подчиняется `gcdTicks` (см. GDD-Core.md).
- Один игрок может засчитать не более одного укуса по сундуку на один `gcdTicks`.

### 5.4. Отображение защиты

- У сундука видны 0–2 обруча.
- При поломке обруча — заметный визуальный эффект и звук.

---

## 6. Награда сундука

Сундук даёт:
1. Немедленное получение таланта (без карточек).
2. Частичное спорное вознаграждение в виде разлёта золотых пузырей.

### 6.1. Цвет пузырей

Из сундуков всех типов вылетают только золотые пузыри (`density = 0.5`).

---

## 7. Немедленный талант

### 7.1. Алгоритм выбора

1. Сформировать список доступных талантов:
   - талант разрешён для класса игрока;
   - выполнены требования таланта (наличие умения);
   - талант отсутствует у игрока, либо `talentLevel < talentMaxLevel`.
2. Выбрать редкость таланта по таблице (зависит от `chestType`).
3. Выбрать случайный талант выбранной редкости.
4. Применить талант:
   - если таланта нет — добавить с `talentLevel = 1`;
   - если уже есть и `talentLevel < talentMaxLevel` — увеличить `talentLevel` на 1.
5. Если на выбранной редкости нет доступных — пробовать более низкие редкости.
6. Если доступных талантов нет вообще — заменить на усиление.

### 7.2. Таблица редкостей

| `chestType` | Обычный | Редкий | Эпический |
|---|---:|---:|---:|
| `rare` | 80% | 20% | 0% |
| `epic` | 30% | 60% | 10% |
| `gold` | 0% | 40% | 60% |

---

## 8. Разлёт пузырей

### 8.1. Общие правила

- Разлёт пузырей не расходует массу игрока.
- Суммарная масса пузырей зависит от типа сундука и **средней массы игроков** на момент открытия.
- Пузыри разлетаются по 360° с начальной скоростью.
- Мелкие пузыри получают большую скорость, крупные — меньшую.

**Расчёт суммарной массы:**
```
averagePlayerMass = сумма масс всех живых игроков / количество живых игроков
scatterTotalMass = averagePlayerMass × scatterTotalMassPct
```

Это делает награду справедливой: маленький слайм, открывший сундук, получает такое же количество пузырей, как и большой.

### 8.2. Параметры разлёта

| Параметр | `rare` | `epic` | `gold` |
|---|---:|---:|---:|
| Суммарная масса `scatterTotalMassPct` | 12% | 18% | 28% |
| Число пузырей `scatterBubbleCount` | 10 | 16 | 24 |
| Доля ближних пузырей `scatterInnerFrac` | 0.30 | 0.30 | 0.25 |
| Скорость ближних (мин..макс) | 25..45 м/с | 25..45 м/с | 25..40 м/с |
| Скорость дальних (мин..макс) | 55..75 м/с | 65..85 м/с | 75..95 м/с |

`scatterTotalMassPct` применяется к средней массе игроков, не к массе открывшего.

### 8.3. Правило скорости по массе

Для пузырей действий: чем меньше масса пузыря, тем выше его скорость.

| Параметр | Значение |
|---|---|
| Коэффициент скорости мелких `scatterSmallBubbleSpeedMul` | 1.25 |

---

## 9. Усиления

### 9.1. Условие получения

Усиление применяется, если:
- у игрока нет доступных талантов для получения или прокачки;
- усиление выбирается случайно из набора, разрешённого для `chestType`.

### 9.2. Типы усилений

| `boostType` | Эффект | Базовая длительность |
|---|---|---:|
| `rage` (Ярость) | Множитель урона ×1.25 | 10 сек |
| `haste` (Ускорение) | Множитель скорости ×1.30 | 10 сек |
| `guard` (Защита) | Поглощает следующий урон | 15 сек или до срабатывания |
| `greed` (Жадность) | Множитель массы от пузырей ×2.0 | 15 сек или 3 пузыря |

### 9.3. Разрешение по типу сундука

| `chestType` | Разрешённые усиления |
|---|---|
| `rare` | `haste`, `guard` |
| `epic` | `rage`, `haste`, `guard` |
| `gold` | `greed`, `rage`, `guard` |

### 9.4. Стекирование

Если усиление того же типа уже активно — продлить длительность до предела.

| Параметр | Значение |
|---|---:|
| Максимум стека `boostMaxStackTimeSec` | 20 сек |

### 9.5. Параметры усилений

| Параметр | Значение |
|---|---|
| `boostRageDamageMul` | 1.25 |
| `boostHasteSpeedMul` | 1.30 |
| `boostGreedBubbleMassMul` | 2.0 |

---

## 10. Визуализация усилений

### 10.1. Уведомление при получении

1. Иконка усиления и название появляются рядом со слаймом.
2. Надпись плавно смещается вверх по экрану и исчезает за 1.5 сек.
3. Звуковой сигнал (уникальный для каждого усиления).

### 10.2. Индикатор оставшегося времени

- Маленькая иконка усиления в интерфейсе рядом с полосой массы.
- Круговой таймер вокруг иконки (заполнение против часовой стрелки).
- Для Защиты и Жадности: счётчик оставшихся зарядов вместо таймера.

### 10.3. Визуал на слайме

| Усиление | Визуальный эффект | Слой |
|---|---|---|
| Ярость | Оранжевые искры вокруг слайма, пульсация спрайта | Частицы вокруг |
| Ускорение | Голубые линии скорости позади слайма | След движения |
| Защита | Золотой мерцающий контур | Контур спрайта |
| Жадность | Мелкие золотые монеты вращаются вокруг | Частицы вокруг |

---

## Связанные документы

- [GDD-Core.md](GDD-Core.md) — основные правила
- [GDD-Talents.md](GDD-Talents.md) — таланты
- [GDD-UI.md](GDD-UI.md) — интерфейс
