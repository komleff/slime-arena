# Slime Arena — Core

**Версия:** 3.3  
**Дата:** 28.12.2025  
**Зависимости:** Нет (корневой документ)  
**Глоссарий:** [GDD-Glossary.md](GDD-Glossary.md)  

---

## 0. Принципы

- Сервер авторитетный.
- Масса является здоровьем. Отдельного параметра HP нет.
- Любое действие подчиняется глобальной перезарядке `GCD`.
- Выбор умений и талантов выполняется через карточки «выбери 1 из 3». Матч не ставится на паузу.
- Сундуки не создают выбор карточек. Награда применяется сразу.

---

## 1. Структура матча

### 1.1. Выбор класса и вход в матч

- Перед входом в матч игрок выбирает класс `classId` в лобби.
- `classId` фиксируется на весь матч.
- Смена класса доступна только в лобби перед входом на арену.
- Игрок присоединяется к идущему матчу. Если матч уже идёт (`Running`), игрок появляется на карте сразу.

### 1.2. Длительность и победа

| Параметр | Значение |
|---|---|
| Длительность матча `matchDurationSec` | 180 сек |
| Условие победы | Наибольшая масса по завершении матча |
| Игроков в матче | 2–30 (зависит от размера карты) |

### 1.3. Фазы матча

| Фаза | Время | Особенности |
|---|---:|---|
| Рост | 0–60 сек | Максимальная плотность ресурсов |
| Охота | 60–120 сек | Ресурсов меньше, чаще конфликты |
| Финал | 120–180 сек | Безопасные зоны, повышенная награда за риск |

### 1.4. Состояния комнаты

| Состояние `roomState` | Описание |
|---|---|
| `Lobby` | Ожидание игроков, матч не идёт |
| `Running` | Матч идёт |
| `Results` | Таблица лидеров, объявление победителя |

Правила:
- После завершения матча показывается экран результатов.
- Новый матч стартует автоматически по истечении `resultsDurationSec`.
- Если игрок входит в состоянии `Results`, он ждёт старта следующего матча.
- Если игрок входит в состоянии `Running`, он появляется на карте сразу.

| Параметр | Значение |
|---|---:|
| `resultsDurationSec` | 12 сек |

### 1.5. Очистка мира между матчами

При переходе `Results` → `Running` (старт нового матча):

| Объект | Действие |
|---|---|
| Слаймы | Удаляются, игроки респавнятся с 100 кг |
| Пузыри | Удаляются все |
| Сундуки | Удаляются все |
| Токсичные лужи | Удаляются |
| Мины | Удаляются |
| Карта | Генерируется заново (см. GDD-Arena.md) |
| Таланты/умения игроков | Сбрасываются |

---

## 2. Классы

### 2.1. Базовые характеристики

| Класс | Пассивный бонус | Пассивный штраф | Стартовое умение | Цвет пузырей |
|---|---|---|---|---|
| Охотник | +15% к скорости | — | Рывок | Зелёный |
| Воин | +10% к урону укусом слаймов | −10% к скорости | Щит | Красный |
| Собиратель | +25% к размеру укуса пузырей | — | Замедление | Синий |

Модификаторы укуса применяются к конкретным целям:
- Воин: бонус только при укусе слаймов (не пузырей).
- Собиратель: бонус только при укусе пузырей (не слаймов).
- Охотник: без модификаторов укуса.

---

## 3. Система массы

### 3.1. Базовые правила

| Параметр | Значение |
|---|---|
| Единица измерения | Масса равна здоровью и размеру |
| Минимум `minSlimeMassKg` | 50 кг (гибель) |
| Старт `baseMassKg` | 100 кг |
| Возрождение `respawnMassKg` | 100 кг через 2 сек |

Отдельного параметра здоровья не существует. Все механики оперируют массой.

### 3.2. Получение массы

| Источник | Количество |
|---|---|
| Укус пузыря | `biteMassPercent` × масса игрока |
| Укус слайма в бок | 20% массы жертвы: 10% атакующему, 10% в пузыри |
| Укус слайма в хвост | 30% массы жертвы: 15% атакующему, 15% в пузыри |
| Зона Нектар | +1% массы в секунду |
| Сундук | См. GDD-Chests.md |

### 3.3. Потеря массы

| Источник | Количество |
|---|---|
| Укус врага в бок | 20% массы |
| Укус врага в хвост | 30% массы |
| Активация умения | Указано в описании умения |
| Зона Лава | 2% массы в секунду |
| Отравление | 2% массы в секунду |

При потере массы от отравления и зон 50% потерянной массы выбрасывается в виде пузырей цвета класса слайма.

---

## 4. Пузыри

### 4.1. Плотность

При `baseMassKg = 100` и `baseRadiusM = 10`:
- Площадь = π × 10² ≈ 314 м²
- Плотность слайма ≈ 0.318 кг/м²

| Цвет | `density` (кг/м²) | Описание |
|---|---:|---|
| Зелёный | 0.2 | Лёгкий, крупный |
| Синий | 0.3 | Средний |
| Красный | 0.4 | Плотный |
| Золотой | 0.5 | Самый плотный |

Зелёные и синие менее плотные, чем слайм — крупнее и легче толкать. Красные и золотые — более плотные, компактнее и тяжелее.

### 4.2. Формула радиуса

```
radius = √(mass / π / density)
```

### 4.3. Цвет по источнику

| Источник | Цвет | `density` |
|---|---|---:|
| Карта (фаза Рост) | Зелёный/Синий | По цвету |
| Карта (фаза Охота) | +Красные | По цвету |
| Карта (фаза Финал) | +Золотые | По цвету |
| Охотник (укус/гибель) | Зелёный | 0.2 |
| Собиратель (укус/гибель) | Синий | 0.3 |
| Воин (укус/гибель) | Красный | 0.4 |
| Король (укус/гибель) | Золотой | 0.5 |
| Сундук | Золотой | 0.5 |
| Урон от зон/яда | По классу слайма | По цвету |

### 4.4. Фазы появления пузырей карты

| Фаза | Время | Интервал | Макс. | Зелёные | Синие | Красные | Золотые |
|---|---|---:|---:|---:|---:|---:|---:|
| Рост | 0–60 сек | 0.3 сек | 30 | 70% | 30% | — | — |
| Охота | 60–120 сек | 0.5 сек | 25 | 30% | 45% | 25% | — |
| Финал | 120–180 сек | 1.0 сек | 15 | 10% | 30% | 40% | 20% |

### 4.5. Диапазоны массы пузырей карты

| Цвет | Мин | Макс |
|---|---:|---:|
| Зелёный | 10 кг | 50 кг |
| Синий | 30 кг | 150 кг |
| Красный | 80 кг | 400 кг |
| Золотой | 200 кг | 1000 кг |

Масса пузырей от слаймов определяется механикой боя и не ограничена этими диапазонами.

---

## 5. Прогресс внутри матча

### 5.1. Уровни и пороги массы

| Масса | Уровень | Событие |
|---:|---:|---|
| 100 кг | 1 | Старт, первый слот с классовым умением |
| 180 кг | 2 | Карточки талантов |
| 300 кг | 3 | Второй слот, карточки умений |
| 500 кг | 4 | Карточки талантов |
| 800 кг | 5 | Третий слот, карточки умений |
| 1200 кг | 6 | Карточки талантов |
| 1800 кг+ | 7+ | Карточки талантов за каждое ×1.5 массы |

### 5.2. Слоты умений

| Слот | Момент получения | Механика |
|---|---|---|
| Первый | Сразу | Классовое умение без выбора |
| Второй | Уровень 3 | Карточки с выбором 1 из 3 |
| Третий | Уровень 5 | Карточки с выбором 1 из 3 |

Пустых слотов не бывает — карточки появляются сразу при получении слота.

### 5.3. Сохранение при гибели

| Сохраняется | Сбрасывается |
|---|---|
| Выбранные таланты | Текущая масса (→ 100 кг) |
| Полученные умения и их уровни | Текущий уровень (пересчёт по массе) |
| Накопитель Берсерка | Временные усиления |
| Очередь выборов | Бонус Разгона |

Таймеры очереди приостанавливаются на время возрождения (2 сек).

---

## 6. Статус Короля

### 6.1. Определение

Игрок с наибольшей массой в текущий момент получает статус Короля.

### 6.2. Эффекты

| Эффект | Описание |
|---|---|
| Визуальная метка | Корона над слаймом |
| Видимость на мини-карте | Позиция видна всем |
| Цвет пузырей | Золотой (`density` 0.5) |
| Бонус атакующим | Стандартное количество пузырей, но золотых |

### 6.3. Смена статуса

- Переход мгновенный при изменении лидера по массе.
- При равной массе статус сохраняется у текущего Короля.

---

## 7. Противодействие лавинному эффекту

| Механика | Описание |
|---|---|
| Масштабирование по корню | Мощность двигателей растёт как √mass |
| Плоский урон | Малый слайм откусывает тот же процент массы |
| Бонус хвоста | Большой хвост — большая мишень |
| Метка лидера | Первое место видно всем на мини-карте |
| Бонус Короля | Золотые пузыри при укусе лидера |
| Безопасные зоны | Финальное выравнивание |
| Честная стоимость | Все платят одинаковый процент массы |
| Столкновение пастями | Тяжёлый побеждает без бесплатных атак |
| Спорная награда сундуков | Разлёт пузырей позволяет перехватить часть награды |

---

## 8. Глобальная перезарядка (GCD)

### 8.1. Определение

Любое действие (укус, активация умения) блокирует все остальные действия на время `GCD`.

| Параметр | Значение |
|---|---|
| `gcdTicks` | 3 |
| Длительность | `gcdTicks × tickMs` = 100 мс при 30 Гц |

### 8.2. Применение

- После укуса нельзя активировать умение в течение `gcdTicks`.
- После умения нельзя кусать в течение `gcdTicks`.
- Один игрок может засчитать не более одного укуса за один `gcdTicks`.

**Пример:** После активации умения нельзя выполнить укус в течение 3 тиков (100 мс), и наоборот.

---

## 9. Технические параметры

### 9.1. Слайм (базовые значения)

| Параметр | Значение |
|---|---|
| `baseMassKg` | 100 |
| `baseRadiusM` | 10.0 |
| `slimeDensity` | 0.318 кг/м² |
| `minSlimeMassKg` | 50 |
| `biteMassPercent` | 0.10 (10%) |
| `invulnAfterDamageSec` | 0.2 |
| `respawnMassKg` | 100 |

**Формула радиуса слайма:**
```
slimeRadius = baseRadiusM × √(mass / baseMassKg)
```

| Масса | Радиус |
|---:|---:|
| 50 кг | 7.07 м |
| 100 кг | 10.0 м |
| 400 кг | 20.0 м |
| 1600 кг | 40.0 м |

### 9.2. Двигатели слайма (базовые значения для 100 кг)

| Параметр | Значение |
|---|---|
| `thrustForwardN` | 9000 |
| `thrustReverseN` | 6750 |
| `thrustLateralN` | 8500 |
| `turnTorqueNm` | 175 |
| `speedLimitForwardMps` | 260 |
| `speedLimitReverseMps` | 180 |
| `speedLimitLateralMps` | 220 |
| `angularSpeedLimitDegps` | 80 |

### 9.3. Масштабирование параметров

| Параметр | Зависимость |
|---|---|
| Радиус | `baseRadiusM × √(mass / baseMassKg)` |
| Тяга двигателей | `baseThrust × √(mass / baseMassKg)` |
| Момент поворота | `baseTorque × √(mass / baseMassKg)` |
| Момент инерции | `0.5 × mass × radius²` |

### 9.4. Сервер

| Параметр | Значение |
|---|---|
| Частота обновления `tickRate` | 30 Гц |
| Длительность тика `tickMs` | 33.3 мс |
| `gcdTicks` | 3 |
| Размеры карт | См. [GDD-Arena.md](GDD-Arena.md) раздел 1 |
| `spawnRetryCount` | 10 (попыток размещения объекта) |

Безопасная зона возрождения: см. [GDD-Arena.md](GDD-Arena.md) раздел 5.

### 9.5. Приоритет событий

При одновременных событиях в одном тике:

1. Получение урона
2. Гибель
3. Получение массы
4. Активация умений

### 9.6. Потеря связи

- Слайм останавливается (тяга = 0).
- Через 5 сек неактивности слайм исчезает.
- Масса не выбрасывается в пузыри.
- Слайм не получает защиту при отключении.

---

## Связанные документы

- [GDD-Combat.md](GDD-Combat.md) — бой и механики
- [GDD-Abilities.md](GDD-Abilities.md) — умения
- [GDD-Talents.md](GDD-Talents.md) — таланты
- [GDD-Chests.md](GDD-Chests.md) — сундуки и усиления
- [GDD-Arena.md](GDD-Arena.md) — карты, зоны, препятствия
- [GDD-UI.md](GDD-UI.md) — интерфейс
