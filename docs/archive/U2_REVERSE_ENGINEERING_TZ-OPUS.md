# U2 — Техническое задание: Модули управления и физики полёта

## 1. Физика полёта

### 1.1 Архитектура

Система использует релятивистскую кинематику с переменной скоростью света (CPrime). Интеграция происходит на сервере в PhysicsSystem с фиксированным тиком 30 Гц. Клиент выполняет предсказание с частотой 60 Гц.

Порядок выполнения систем в игровом цикле: FlightAssistSystem → PhysicsSystem → CollisionSystem.

### 1.2 Модель движения

| Параметр | Значение |
|----------|----------|
| Тип модели | Импульсная (momentum-based) |
| Константа CPrime | 5000 м/с (локальная скорость света) |
| Предел скорости | 0.99 × CPrime (жёсткое ограничение) |
| Интегратор | Euler первого порядка |

### 1.3 Релятивистская математика

Связь скорости и импульса определяется фактором Лоренца (Гамма). Импульс вычисляется как произведение массы, скорости и Гаммы. Гамма зависит от отношения скорости к CPrime.

Обратное преобразование импульса в скорость выполняется итерационным методом Newton-Raphson за 5 итераций.

### 1.4 Цикл интеграции

1. Получить силу из PhysicsGateway на основе управляющих сигналов.
2. Преобразовать силу в изменение импульса (сила × время тика).
3. Обновить импульс (старый импульс + изменение).
4. Преобразовать импульс в скорость методом Newton-Raphson.
5. Ограничить скорость до 0.99 × CPrime.
6. Обновить позицию (старая позиция + скорость × время тика).
7. Интегрировать угловую скорость аналогично, без релятивистских эффектов.

При рассинхронизации импульса и скорости выполняется принудительная синхронизация.

### 1.5 Вычисление сил

PhysicsGateway преобразует нормализованные входы в диапазоне [-1, 1] в физические силы:

| Вход | Преобразование |
|------|----------------|
| Thrust | Умножение на силу тяги вперёд |
| StrafeX | Умножение на силу боковой тяги |
| StrafeY | Умножение на силу обратной тяги |
| Yaw | Умножение на угловое ускорение рыскания |

Силы применяются в локальной системе координат корабля, затем преобразуются в мировую.

### 1.6 Инерция

Без внешних сил корабль сохраняет вектор импульса. Трение отсутствует. Остановка возможна только через контр-тягу: вручную или через FlightAssist.

---

## 2. Тактико-технические характеристики кораблей

### 2.1 Структура конфигурации

Конфигурация корабля (ShipConfig) включает блоки:

| Блок | Назначение |
|------|------------|
| Meta | Идентификатор, название, производитель, версия |
| Geometry | Габариты для расчёта коллизий |
| Hull | Масса, прочность, грузоподъёмность |
| Propulsion | Силы тяги, угловые ускорения |
| FlightAssist | Лимиты скорости и ускорения для режима FA:ON |
| Signatures | Заметность в спектрах (инфракрасный, электромагнитный, сечение) |

### 2.2 Параметры Default Fighter

#### Meta

| Параметр | Значение |
|----------|----------|
| ID | default_fighter |
| Name | Default Fighter |
| Manufacturer | Generic |
| Version | 0.8.6 |

#### Hull

| Параметр | Значение | Единицы |
|----------|----------|---------|
| DryMass | 10 | тонн |
| MaxCargoMass | 0 | тонн |
| Hull_HP | 1000 | HP |

#### Geometry

| Параметр | Значение | Единицы |
|----------|----------|---------|
| Length | 11.5 | м |
| Width | 11.0 | м |
| Height | 3.5 | м |

#### Propulsion

| Направление | Ускорение | Сила |
|-------------|-----------|------|
| Forward | 90 м/с² | 0.9 МН |
| Reverse | 67.5 м/с² | 0.675 МН |
| Lateral | 85 м/с² | 0.85 МН |

| Ось вращения | Угловое ускорение |
|--------------|-------------------|
| Yaw | 200 °/с² |
| Pitch | 180 °/с² |
| Roll | 220 °/с² |

#### FlightAssist Limits

| Параметр | Значение | Единицы |
|----------|----------|---------|
| SpeedLimit_Forward | 260 | м/с |
| SpeedLimit_Reverse | 180 | м/с |
| SpeedLimit_Lateral | 220 | м/с |
| SpeedLimit_Vertical | 220 | м/с |
| AngularSpeedLimit_Yaw | 80 | °/с |
| AngularSpeedLimit_Pitch | 95 | °/с |
| AngularSpeedLimit_Roll | 130 | °/с |
| CrewGLimit | 11 | g |
| ComfortableBrakingTime | 3.5 | с |
| AngularStopTime | 1.0 | с |

#### Окружение

| Параметр | Значение |
|----------|----------|
| CPrime | 5000 м/с |
| Тик сервера | 30 Гц |
| Тик клиента (предсказание) | 60 Гц |

### 2.3 Загрузка конфигурации

Параметры загружаются из файла physics.json через SharedPhysics.LoadConfig. При отсутствии файла используются значения Default Fighter.

---

## 3. Принцип управления кораблём

### 3.1 Входные данные

Система принимает нормализованные команды:

| Команда | Диапазон | Описание |
|---------|----------|----------|
| Thrust | [0, 1] | Тяга вперёд |
| StrafeX | [-1, 1] | Боковое перемещение |
| StrafeY | [-1, 1] | Вертикальное перемещение, торможение |
| Yaw | [-1, 1] | Рыскание (поворот) |
| FlightAssist | булево | Режим FA:ON/OFF |
| Brake | булево | Активное торможение |

### 3.2 Каналы ввода

| Устройство | Обработчик |
|------------|------------|
| Клавиатура и мышь | InputManager |
| Сенсорный экран (два джойстика) | TouchInputManager |
| Сенсорный экран (один джойстик) | SingleJoystickManager, InputTranslator |

### 3.3 Путь обработки ввода

1. InputManager собирает ввод с устройства.
2. Формируется CommandFrame с меткой времени и порядковым номером.
3. PredictionEngine применяет ввод локально (предсказание на клиенте).
4. Команда отправляется на сервер.
5. Сервер обрабатывает в цепочке: FlightAssistSystem → PhysicsSystem.

### 3.4 Нормализация и валидация

Вектор движения ограничивается единичной длиной при превышении. Время между кадрами ограничивается максимальным значением для предотвращения скачков после паузы. Устаревшие команды отклоняются сервером по порядковому номеру.

При потере фокуса окна все команды сбрасываются в нейтральное состояние.

---

## 4. Flight Assist и режимы полёта

### 4.1 Режимы работы

| Режим | Описание |
|-------|----------|
| FA:ON | Стабилизация, ограничение скорости и перегрузок |
| FA:OFF | Прямое управление без ограничений |
| BRAKE | Агрессивное торможение (подрежим FA:ON) |

### 4.2 Режим FA:OFF

При отключённом ассистенте:
- Входные сигналы ограничиваются диапазоном [-1, 1].
- Передаются напрямую в PhysicsGateway.
- Нет ограничений скорости, кроме 0.99 × CPrime.
- Нет демпфирования угловой скорости.
- Нет защиты от перегрузок.
- Корабль сохраняет импульс бесконечно.

### 4.3 Режим FA:ON

**Ограничение скорости:**
1. Определить текущую скорость по осям (вперёд, вбок, назад).
2. Сравнить с лимитами из конфигурации FlightAssist.
3. При превышении рассчитать требуемое торможение.
4. Ограничить торможение по CrewGLimit.

**Демпфирование угловой скорости:**
При отсутствии управляющего ввода по оси вращения угловая скорость экспоненциально затухает. Коэффициент демпфирования вычисляется из AngularStopTime.

**Ограничение перегрузок:**
Суммарное ускорение ограничивается произведением CrewGLimit и ускорения свободного падения (9.81 м/с²).

**Гашение дрейфа:**
При отпускании управления система применяет контр-тягу для сведения скорости к нулю. Обеспечивается плавный разгон и торможение за ComfortableBrakingTime.

### 4.4 Режим BRAKE

Активируется при StrafeY меньше -0.5 или нажатии кнопки Brake:
- Рассчитывается вектор торможения, противоположный текущей скорости.
- Применяется максимальное доступное ускорение с учётом CrewGLimit.
- Цель — остановка за ComfortableBrakingTime.

### 4.5 Переключение режимов

Пилот может мгновенно переключаться между FA:ON и FA:OFF во время полёта.

---

## 5. Ассистент управления в мобильном режиме

### 5.1 Архитектура модуля

| Компонент | Ответственность |
|-----------|-----------------|
| TouchInputManager | Обработка касаний, два джойстика |
| SingleJoystickManager | Управление одним джойстиком |
| InputTranslator | Преобразование ввода в команды |
| ModeTransition | Плавные переходы между режимами |

### 5.2 Режим двух джойстиков

**Раскладка:**
- Левый джойстик: Thrust (вверх) + StrafeX (лево/право).
- Правый джойстик: Yaw (лево/право).
- Кнопки: BRAKE, FA, AUTO.

**Мёртвая зона:**
- Радиус: 15% от размера джойстика.
- Значения внутри зоны обнуляются.
- Значения снаружи линейно масштабируются к диапазону [0, 1].

**Адаптивная раскладка:**
Позиция и размер элементов управления подстраиваются под размер экрана и ориентацию устройства. На телефонах джойстики смещаются ближе к краям для удобства управления большими пальцами.

**Виброотклик:**
При использовании джойстиков и кнопок срабатывает вибрация для тактильного подтверждения действия.

### 5.3 Режим одного джойстика

Управление в стиле fly-by-wire с адаптивным демпфированием:

1. Направление джойстика определяет целевой курс.
2. Разница между текущим и целевым курсом преобразуется в команду Yaw.
3. При FA:OFF применяется дополнительное демпфирование для предотвращения колебаний.

**Детектирование колебаний:**
Отслеживается количество смен знака Yaw за последние N кадров. При превышении порога увеличивается демпфирование.

### 5.4 Режимы управления InputTranslator

| Режим | Условие | Поведение |
|-------|---------|-----------|
| FreeFlightMode | Нет валидной цели | Джойстик управляет тягой и стрейфом |
| CombatLockMode | Есть враждебная цель | Автонаведение на цель |

**Переход между режимами:**
- Длительность: 300 мс (настраивается).
- Линейная интерполяция всех параметров.
- Brake — логическое ИЛИ от обоих режимов.
- FlightAssist — берётся из целевого режима.

### 5.5 Валидация цели

Цель считается валидной при выполнении условий:
- Сущность существует.
- Сущность враждебна.
- Сущность жива.
- Дистанция в пределах допустимого диапазона.

### 5.6 Усиленная помощь в мобильном режиме

В мобильном режиме FlightAssist работает агрессивнее:
- Повышенное демпфирование дрейфа.
- Мягкое ограничение скорости вращения.
- Автоматическая коррекция вектора тяги при маневрах.

---

## 6. Алгоритм прогнозного сглаживания

### 6.1 Назначение

Обеспечение плавного отображения удалённых сущностей на клиенте с компенсацией сетевых задержек. Устранение резких скачков и телепортаций при получении обновлений от сервера.

### 6.2 Компоненты системы

| Компонент | Назначение |
|-----------|------------|
| EntitySmoother | Управление визуальным состоянием сущностей |
| HermiteSpline | Математика кривых Эрмита |
| PredictionEngine | Предсказание на стороне клиента для локального игрока |
| SnapshotStore | Буфер серверных снимков, синхронизация времени |

### 6.3 Алгоритм работы

На каждом кадре рендеринга:

1. **Прогнозирование цели.** Целевая позиция вычисляется как позиция из снимка плюс скорость, умноженная на время с момента снимка и опережение (lookAhead).

2. **Построение кривой.** Создаётся кубическая кривая Эрмита от текущей визуальной позиции к целевой. Кривая учитывает позиции и скорости в обеих точках.

3. **Продвижение по кривой.** Скорость адаптируется:
   - При отставании от цели — ускорение (catchUpFactor).
   - При опережении — замедление.

4. **Телепортация.** При превышении критического расхождения (maxDeviation) выполняется мгновенное выравнивание.

### 6.4 Кривые Эрмита

Используется кубическая интерполяция Эрмита вместо линейной. Кривая определяется четырьмя параметрами: начальная позиция, начальная скорость, конечная позиция, конечная скорость. Это обеспечивает гладкость движения без углов в точках обновления.

### 6.5 Конфигурация по типам сущностей

| Параметр | Локальный игрок | Удалённый игрок |
|----------|-----------------|-----------------|
| lookAheadMs | 30 | 80 |
| transitionDurationMs | 100 | 150 |
| catchUpFactor | 1.0 | 0.5 |
| maxDeviationM | 10 | 50 |

### 6.6 Обработка пропуска снимков

При отсутствии новых данных с сервера:
1. До maxExtrapolationMs — экстраполяция с текущей скоростью.
2. После — плавное затухание скорости до нуля за transitionDurationMs.

### 6.7 Тороидальный мир

При расчёте кривой учитывается зацикленность мира:
- Если дельта по оси превышает половину размера мира — корректировка через противоположную границу.
- Применяется к обеим осям независимо.
- Координаты нормализуются функцией wrapCoord.

### 6.8 Интерполяция углов

Для вращения используется отдельная кривая с нормализацией дельты угла к диапазону от минус пи до пи. Это обеспечивает выбор кратчайшего пути поворота.

---

## 7. Связанные файлы

| Модуль | Путь |
|--------|------|
| Физика | src/shared/ECS/Systems/PhysicsSystem.cs |
| Ассистент | src/shared/ECS/Systems/FlightAssistSystem.cs |
| Шлюз физики | src/shared/Physics/PhysicsGateway.cs |
| Релятивистская математика | src/shared/Physics/RelativisticMath.cs |
| Конфигурация корабля | src/shared/Ships/ShipConfig.cs |
| Общие параметры | src/shared/Config/SharedPhysics.cs |
| Файл параметров | src/shared/physics.json |
| Ввод (клавиатура) | src/clients/testbed/chatgpt-vite/client/input/InputManager.ts |
| Ввод (сенсорный, два) | src/clients/testbed/chatgpt-vite/client/input/TouchInputManager.ts |
| Ввод (сенсорный, один) | src/clients/testbed/chatgpt-vite/client/input/SingleJoystickManager.ts |
| Транслятор ввода | src/clients/testbed/chatgpt-vite/client/input/DirectControlMode/InputTranslator.ts |
| Режим свободного полёта | src/clients/testbed/chatgpt-vite/client/input/DirectControlMode/modes/FreeFlightMode.ts |
| Режим захвата цели | src/clients/testbed/chatgpt-vite/client/input/DirectControlMode/modes/CombatLockMode.ts |
| Буфер снимков | src/clients/testbed/chatgpt-vite/client/world/SnapshotStore.ts |
| Сглаживание | src/clients/testbed/chatgpt-vite/client/world/EntitySmoother.ts |
| Кривые Эрмита | src/clients/testbed/chatgpt-vite/network/HermiteSpline.ts |
| Предсказание | src/clients/testbed/chatgpt-vite/network/PredictionEngine.ts |
