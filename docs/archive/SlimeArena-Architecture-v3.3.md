# Slime Arena — Архитектура

**Версия:** 3.3.2  
**Автор:** Claude Opus, Copilot  
**Дата:** январь 2026  

Документ описывает техническую архитектуру проекта в соответствии с модульным пакетом GDD v3.3.

---

## 0. Изменения версии 3.3.2

- **Собиратель:** стартовое умение изменено с «Замедление» на «Притяжение».
- **Общий пул:** «Замедление» доступно всем классам через карточки.

## 1. Изменения версии 3.3.0

Синхронизация с модульным пакетом GDD v3.3:

- **Версия документа:** приведена к 3.3 для соответствия GDD.
- **Респаун-щит:** добавлена механика `respawnShieldSec=5` с правилами.
- **Таблица лидеров:** унифицирована на Top-10 везде.
- **GCD:** везде указано `gcdTicks=3` (100 мс при 30 Гц).
- **Карточки:** `talentChoice` заменён на `cardChoiceIndex`.
- **Системы:** добавлены `TalentSystem`, `BoostSystem`.
- **Состояния комнаты:** добавлены правила переходов.
- **Флаги слайма:** расписаны битовые маски.

---

## 1. Источники правды

| Документ | Содержание |
|----------|------------|
| `GDD-Core.md` | Базовые правила, классы, масса, прогресс, GCD, Король |
| `GDD-Combat.md` | Боевая система, зоны слайма, урон, эффекты контроля |
| `GDD-Abilities.md` | Умения, слоты, улучшения, двойная активация |
| `GDD-Talents.md` | Таланты, редкости, уровни, карточки выбора |
| `GDD-Chests.md` | Сундуки, обручи, награды, усиления |
| `GDD-Arena.md` | Карты, зоны эффектов, препятствия, безопасные зоны |
| `GDD-UI.md` | Интерфейс, джойстик, камера, мини-карта |
| `GDD-Glossary.md` | Единый глоссарий терминов |
| `SlimeArena-Plan-v3.3.md` | Этапы разработки |
| Этот документ | Техническая архитектура |

---

## 2. Технологический стек

### 2.1. Клиент

| Компонент | Технология |
|-----------|------------|
| Язык | TypeScript |
| Сборка | Vite |
| Рендер (MVP) | Canvas 2D |
| Рендер (позже) | PixiJS |
| Аудио | Howler.js |

### 2.2. Сервер

| Компонент | Технология |
|-----------|------------|
| Среда выполнения | Node.js |
| Язык | TypeScript |
| Сетевой фреймворк | Colyseus |
| HTTP API | Express / Fastify |

### 2.3. Данные

| Компонент | Технология |
|-----------|------------|
| База данных | PostgreSQL |
| Библиотека | pg (node-postgres) |
| Кеш | Redis (опционально) |

### 2.4. Инфраструктура

| Компонент | Технология |
|-----------|------------|
| Контейнеризация | Docker / Docker Compose |
| CI/CD | GitHub Actions |

---

## 3. Архитектурные цели

### 3.1. Обязательные требования

- **Сервер — источник правды:** урон, столкновения, масса, награды.
- **Фиксированная симуляция:** 30 Гц, фиксированный порядок систем.
- **Масштабируемость:** горизонтальное масштабирование Colyseus.
- **Наблюдаемость:** метрики тика, задержки, размер снапшотов.

### 3.2. Ограничения

- Управление: адаптивный джойстик + кнопки умений.
- Транспорт: WebSocket (Colyseus).
- Геометрия: прямоугольная арена с упругими бортами.
- Клиент отправляет только намерения.

---

## 4. Компоненты системы

### 4.1. Сервер

| Модуль | Назначение |
|--------|------------|
| `MatchService` | Поиск/создание матчей |
| `ArenaRoom` | Игровая сессия: мир, игроки, таймеры |
| `systems/*` | Симуляция: движение, столкновения, боёвка, спавн |
| `abilities/*` | Умения, кулдауны, GCD, уровни (1–3) |
| `talents/*` | Таланты, уровни, карточки |
| `chests/*` | Сундуки, обручи, награды |
| `boosts/*` | Усиления, длительность, стеки |
| `arena/*` | Зоны эффектов, препятствия, безопасные зоны |
| `meta/api/*` | HTTP API: профиль, валюта, магазин |
| `meta/persistence/*` | Доступ к БД (pg) |
| `telemetry/*` | Логи, метрики, события |

### 4.2. Клиент

| Модуль | Назначение |
|--------|------------|
| `NetClient` | Подключение к Colyseus |
| `VisualStateSystem` | U2-стиль сглаживания |
| `InputHandler` | Джойстик, кнопки умений, карточки |
| `CameraSystem` | Автомасштабирование камеры |
| `Renderer` | Canvas/Pixi отрисовка |
| `UI` | Лобби, HUD, результаты |
| `Audio/Haptics` | Звук и вибрация |

### 4.3. Общие данные

| Модуль | Назначение |
|--------|------------|
| `shared/types` | Типы сообщений и состояния |
| `shared/config` | Схемы конфигов (Zod/TypeBox) |
| `shared/constants` | Коды, enum, bitmask |

---

## 5. Серверная симуляция

### 5.1. Порядок систем в тике

| Порядок | Система | Назначение |
|---------|---------|------------|
| 1 | `updateMatchPhase` | Переключение фаз (Growth, Hunt, Final, Results) |
| 2 | `collectInputs` | Сбор команд от клиентов |
| 3 | `applyInputs` | Валидация и применение векторов движения |
| 4 | `boostSystem` | Усиления: длительность, стеки, эффекты |
| 5 | `abilitySystem` | Умения, кулдауны, GCD, уровни (1–3) |
| 6 | `abilityCardSystem` | Выбор умений (слоты 2 и 3) |
| 7 | `talentCardSystem` | Выбор талантов, очередь, автовыбор |
| 8 | `updateOrbs` | Спавн и движение пузырей |
| 9 | `updateChests` | Спавн и движение сундуков |
| 10 | `toxicPoolSystem` | Урон от посмертных луж |
| 11 | `slowZoneSystem` | Зоны замедления (умение Собирателя) |
| 12 | `flightAssistSystem` | Силы/моменты по джойстику, учёт замедления |
| 13 | `physicsSystem` | Интеграция, сопротивление, лимиты скорости |
| 14 | `collisionSystem` | Круг-круг, круг-граница, импульсы |
| 15 | `projectileSystem` | Движение и столкновения снарядов |
| 16 | `mineSystem` | Логика мин |
| 17 | `chestSystem` | Физика сундуков, обручи, награды |
| 18 | `statusEffectSystem` | Оглушение, невидимость, отравление |
| 19 | `zoneEffectSystem` | Эффекты аренных зон (Нектар, Лёд, Лава, Турбо) |
| 20 | `deathSystem` | Гибель, респаун, респаун-щит |
| 21 | `hungerSystem` | Потеря массы со временем (фазы Hunt/Final) |
| 22 | `safeZoneSystem` | Безопасные зоны, урон вне зон |
| 23 | `rebelSystem` | Назначение Короля (Rebel) |
| 24 | `updatePlayerFlags` | Обновление битовых масок состояния |
| 25 | `SnapshotSystem` | Рассылка состояния (Colyseus) |

### 5.2. Детерминизм

- Фиксированный шаг времени: 33.3 мс (`tickMs`).
- Один поток на матч.
- RNG через `seed`, только на сервере.

---

## 6. Физика и сущности

### 6.1. Сущности

| Сущность | Описание |
|----------|----------|
| `Player` | Игрок или бот |
| `Orb` | Пузырь (масса + цвет + плотность) |
| `Projectile` | Снаряд умения |
| `Chest` | Сундук (тип, обручи, физика) |
| `Zone` | Зона эффекта (Нектар, Лёд, Слизь, Лава, Турбо) |
| `Obstacle` | Препятствие (проход, столб, шипы) |
| `SafeZone` | Безопасная зона (финал) |
| `Mine` | Мина (умение) |

### 6.2. Ключевые параметры (из config)

**SlimeConfig:**
- Геометрия: `initialMass=100`, `minSlimeMass=50`, `slimeDensity=0.318`
- Движение: `thrustForwardN`, `thrustReverseN`, `thrustLateralN`, `turnTorqueNm`
- Лимиты: `speedLimitForwardMps=260`, `speedLimitReverseMps=180`, `speedLimitLateralMps=220`
- Боевые: `pvpBiteMassPercent=0.10`, `invulnerableTicks=6` (200 мс)

**WorldPhysicsConfig:**
- `linearDragK`, `angularDragK`
- `restitution=0.3`
- Размеры карт: 800×800, 1200×1200, 1600×1600

**ChestConfig:**
- `spawnIntervalSec`: 18–26
- `maxAliveTotal`: 3
- `chestLifeTimeSec`: 35
- Обручи: rare=0, epic=1, gold=2

### 6.3. Плотность пузырей

| Цвет | density (кг/м²) |
|------|-----------------|
| Зелёный | 0.2 |
| Синий | 0.3 |
| Красный | 0.4 |
| Золотой | 0.5 |

Формула радиуса: `radius = √(mass / π / density)`

### 6.4. Зоны эффектов

| Зона | Эффект |
|------|--------|
| Нектар | +1% массы в секунду |
| Лёд | Трение ×0.3 |
| Слизь | Скорость ×0.5, трение ×2 |
| Лава | −2% массы в секунду |
| Турбо | Скорость ×1.4 |

### 6.5. Препятствия

| Тип | Параметры |
|-----|-----------|
| Узкий проход | Ширина 25 м, макс. 350 кг |
| Столб | Непроходим, укрытие |
| Шипы | 5% массы при касании |

---

## 7. Боевая система

### 7.1. Зоны урона

| Зона | Угол | Свойства |
|------|------|----------|
| Пасть | 120° спереди | Урон, поглощение |
| Бока | 60° × 2 | Отскок |
| Хвост | 120° сзади | ×1.5 урона |

### 7.2. Урон укусом

| Зона | Жертва теряет | Атакующий получает | В пузыри |
|------|---------------|-------------------|----------|
| Бок | 20% | 10% | 10% |
| Хвост | 30% | 15% | 15% |

### 7.3. Столкновение пастями

- Разница массы > 10%: тяжёлый наносит 20% урона лёгкому.
- Разница ≤ 10%: оба отскакивают, урон никому.

### 7.4. Эффекты при гибели

- Токсичная лужа: радиус 20 м, 3 сек, 1% урон/сек, −20% скорость.
- Пузыри: 6–8 штук, цвет по классу (Король — золотые).

### 7.5. Эффекты контроля

| Эффект | Источник | Длительность |
|--------|----------|--------------|
| Оглушение | Молния | 0.3 сек |
| Замедление | Мороз, Слизь, умение | До 80% |
| Невидимость | Невидимка | 1.5 сек |

---

## 8. Система сундуков

### 8.1. Типы

| Тип | Обручи | Масса (от медианы) |
|-----|--------|-------------------|
| `rare` | 0 | ×0.8 (250–1800 кг) |
| `epic` | 1 | ×1.1 (350–2200 кг) |
| `gold` | 2 | ×1.4 (450–2600 кг) |

### 8.2. Механика вскрытия

1. Укус при `armorRings > 0` → ломает один обруч.
2. Укус при `armorRings == 0` → вскрывает сундук.
3. Разные игроки могут ломать обручи по очереди.
4. Учитывается `gcdTicks=3` (100 мс при 30 Гц) между укусами.

### 8.3. Награда

1. **Талант:** немедленное применение (без карточек).
2. **Пузыри:** разлёт золотых пузырей (12–28% от средней массы игроков).
3. **Усиление:** если талантов нет.

### 8.4. Усиления

| Тип | Эффект | Длительность |
|-----|--------|--------------|
| Ярость | Урон ×1.25 | 10 сек |
| Ускорение | Скорость ×1.30 | 10 сек |
| Защита | Блок урона | 15 сек / 1 удар |
| Жадность | Масса от пузырей ×2.0 | 15 сек / 3 пузыря |

---

## 9. Прогрессия и Король

### 9.1. Уровни по массе

| Масса | Уровень | Событие |
|-------|---------|---------|
| 100 кг | 1 | Старт, классовое умение |
| 180 кг | 2 | Карточки талантов |
| 300 кг | 3 | Второй слот умения |
| 500 кг | 4 | Карточки талантов |
| 800 кг | 5 | Третий слот умения |
| 1200 кг | 6 | Карточки талантов |
| 1800+ кг | 7+ | Карточки за ×1.5 |

### 9.2. Статус Короля

- Игрок с наибольшей массой.
- Визуальная метка: корона + золотое свечение контура.
- Позиция видна на мини-карте всем.
- Пузыри при укусе Короля — золотые.
- Смена мгновенная при изменении лидера.
- Флаг `IS_KING` в `flags` слайма.

---

## 10. Респаун и защита

### 10.1. Механика респауна

| Параметр | Значение |
|----------|----------|
| `respawnDelaySec` | 2 сек |
| `respawnMassKg` | 100 кг |
| `respawnShieldSec` | 5 сек |

### 10.2. Респаун-щит

- Активируется автоматически при возрождении.
- Длительность: 5 сек.
- **Блокирует:** укусы слаймов, снаряды умений.
- **Не блокирует:** урон от зон (Лава, Шипы).
- **Снимается досрочно:** при атаке (укус или умение) или через 5 сек.
- Флаг `HAS_RESPAWN_SHIELD` в `flags` слайма.
- Визуализация: полупрозрачный купол вокруг слайма.

### 10.3. Безопасная зона респауна

- Радиус: 150 м.
- Условие: нет врагов в радиусе.
- Если невозможно — максимально удалённая от врагов точка.

---

## 11. Фазы матча и безопасные зоны

### 11.1. Состояния комнаты

| Состояние | Описание | Переход |
|-----------|----------|---------|
| `Lobby` | Ожидание игроков | → `Running` при достижении минимума |
| `Running` | Матч идёт | → `Results` по таймеру 180 сек |
| `Results` | Экран результатов | → `Running` через `resultsDurationSec=12` |

**Правила подключения:**
- В `Lobby`: игрок ждёт старта.
- В `Running`: игрок появляется сразу с `respawnMassKg` и `respawnShieldSec`.
- В `Results`: игрок ждёт следующего матча.

**Правила отключения:**
- Слайм останавливается (тяга = 0).
- Через 5 сек неактивности слайм исчезает.
- Масса не выбрасывается в пузыри.

### 11.2. Фазы

| Фаза | Время | Особенности |
|------|-------|-------------|
| Рост | 0–60 сек | Максимум ресурсов |
| Охота | 60–120 сек | Меньше ресурсов, конфликты |
| Финал | 120–180 сек | Безопасные зоны активны |

### 11.3. Безопасные зоны

- Активация: последние 60 сек (120–180).
- Количество: 1–3 (по размеру карты).
- Урон вне зоны: 1–2% массы в секунду.
- Предупреждение: за 10 сек с миганием.
- Визуализация: зелёный цвет, пульсация.

---

## 12. Умения

### 12.1. Слоты

| Слот | Момент | Содержимое |
|------|--------|-----------|
| 1 | Старт | Классовое умение |
| 2 | Уровень 3 | Выбор 1 из 3 |
| 3 | Уровень 5 | Выбор 1 из 3 |

### 12.2. Стартовые по классам

| Класс | Умение | Ключевой эффект |
|-------|--------|-----------------|
| Охотник | Рывок | 80 м за 0.3 сек |
| Воин | Щит | 2.5 сек блока |
| Собиратель | Притяжение | 120 м, 50 м/с |

### 12.3. Общий пул

| Умение | Стоимость | Перезарядка |
|--------|-----------|-------------|
| Притяжение | 2% | 7 сек |
| Выброс | 2% | 3 сек |
| Плевок | 3% | 4 сек |
| Бомба | 4% | 6 сек |
| Отталкивание | 3% | 6 сек |
| Мина | 2% | 10 сек |

### 12.4. Уровни умений

Каждое умение имеет уровни 1–3 с улучшениями. Улучшения появляются в карточках после заполнения всех слотов.

---

## 13. Таланты и карточки

### 13.1. Редкости

| Редкость | Цвет | Источник |
|----------|------|----------|
| Обычный | Серый | Карточки, сундуки |
| Редкий | Синий | Карточки, сундуки |
| Эпический | Фиолетовый | Карточки, сундуки |

### 13.2. Уровни

- По умолчанию `talentMaxLevel = 1`.
- Часть талантов имеет уровни 1–3.
- Повторное получение увеличивает уровень.

### 13.3. Карточки выбора

| Параметр | Значение |
|----------|----------|
| Формат | 1 из 3 |
| Таймер `cardAutoPickSec` | 12 сек |
| Очередь `cardQueueMax` | 3 |

Матч не ставится на паузу. Карточки сворачиваются при уроне. Таймеры приостанавливаются на время респауна (2 сек).

---

## 14. Сетевой протокол

### 14.1. Команда игрока

| Поле | Тип | Описание |
|------|-----|----------|
| `inputSeq` | uint16 | Порядковый номер |
| `moveX` | float32 | [-1..+1] |
| `moveY` | float32 | [-1..+1] |
| `abilitySlot` | uint8 | 0/1/2/3 — активация умения |
| `cardChoiceIndex` | uint8 | 0/1/2 — выбор карточки (талант/умение/улучшение) |

### 14.2. Состояние матча

| Поле | Тип | Описание |
|------|-----|----------|
| `phase` | uint8 | Фаза матча |
| `timeRemaining` | float32 | Оставшееся время |
| `kingId` | string | ID Короля |
| `slimes` | MapSchema | Все слаймы |
| `orbs` | MapSchema | Все пузыри |
| `chests` | MapSchema | Все сундуки |
| `zones` | ArraySchema | Зоны эффектов |
| `obstacles` | ArraySchema | Препятствия |
| `safeZones` | ArraySchema | Безопасные зоны |
| `leaderboard` | ArraySchema | **Top-10** |

### 14.3. Состояние слайма

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | uint16 | id |
| `pos` | Vector2 | позиция |
| `vel` | Vector2 | скорость |
| `angle` | float32 | ориентация |
| `angVel` | float32 | угловая скорость |
| `mass` | float32 | масса |
| `level` | uint8 | уровень |
| `classId` | uint8 | 0/1/2 |
| `flags` | uint8 | битовые флаги (см. 14.5) |
| `boosts` | uint8 | активные усиления (битовая маска) |

### 14.4. Состояние сундука

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | uint16 | id |
| `pos` | Vector2 | позиция |
| `vel` | Vector2 | скорость |
| `type` | uint8 | rare/epic/gold |
| `armorRings` | uint8 | оставшиеся обручи |

### 14.5. Битовые флаги слайма (`flags`)

| Бит | Название | Описание |
|-----|----------|----------|
| 0 | `IS_KING` | Статус Короля |
| 1 | `HAS_RESPAWN_SHIELD` | Респаун-щит активен |
| 2 | `HAS_ABILITY_SHIELD` | Щит умения активен |
| 3 | `IS_INVISIBLE` | Невидимость |
| 4 | `IS_STUNNED` | Оглушение |
| 5 | `IS_INVULN` | Неуязвимость (i-frames) |
| 6-7 | резерв | — |

### 14.6. Битовые флаги усилений (`boosts`)

| Бит | Название | Описание |
|-----|----------|----------|
| 0 | `BOOST_RAGE` | Ярость |
| 1 | `BOOST_HASTE` | Ускорение |
| 2 | `BOOST_GUARD` | Защита |
| 3 | `BOOST_GREED` | Жадность |
| 4-7 | резерв | — |

---

## 15. Клиентское отображение

### 15.1. U2-стиль сглаживания

| Параметр | Значение |
|----------|----------|
| `VELOCITY_WEIGHT` | 0.7 |
| `CATCH_UP_SPEED` | 10.0 |
| `MAX_CATCH_UP_SPEED` | 800 |
| `TELEPORT_THRESHOLD` | 100 |
| `ANGLE_CATCH_UP_SPEED` | 12.0 |

### 15.2. Автомасштабирование камеры

Формула зума:
```
cameraZoom = 1.0 + 0.3 × log₂(mass / 100)
```

| Масса | Зум |
|-------|-----|
| 100 кг | 1.0 |
| 400 кг | 1.6 |
| 1600 кг | 2.2 |

Ограничения:
- Зум не меняется во время боя (cooldown 3 сек после урона).
- Слайм всегда виден полностью.
- Изменение за 1–2 сек, не мгновенно.

---

## 16. Телеметрия

### 16.1. События матча

| Событие | Поля |
|---------|------|
| `match_start` | matchId, playerCount, mode, seed, mapSize |
| `match_end` | matchId, duration, winnerMass, avgMass, phase |
| `player_death` | matchId, playerId, killerId, mass, phase |
| `player_respawn` | matchId, playerId, shieldActive |
| `king_assigned` | matchId, kingId |
| `chest_opened` | matchId, playerId, chestType, rewardType |
| `talent_chosen` | matchId, playerId, talentId, method |
| `ability_used` | matchId, playerId, abilityId |
| `boost_gained` | matchId, playerId, boostType |

### 16.2. Метрики сервера

| Метрика | Тип | Порог |
|---------|-----|-------|
| `tick_duration_ms` p99 | histogram | > 30 мс |
| `snapshot_bytes` p99 | histogram | > 2 КБ |
| `ws_disconnect_rate` | counter | > 5%/час |

---

## 17. Безопасность

### 17.1. Базовые меры

- Валидация частоты и диапазонов команд.
- Сервер не принимает клиентские позиции/урон.
- Rate limit на сообщения.
- Идемпотентность наград.

### 17.2. Детекция аномалий

| Аномалия | Действие |
|----------|----------|
| Скорость выше лимита | Авто-коррекция, лог |
| Flood сообщений | Disconnect |
| Дублирование наград | Deny |

---

## 18. Развёртывание

- Локально: `docker compose up`
- Staging/Prod: Docker image с откатами

---

## Приложение A. Структура репозитория

| Директория | Содержимое |
|------------|------------|
| `client/` | Клиент |
| `server/` | Сервер (Colyseus + HTTP API) |
| `shared/` | Общие типы и конфиги |
| `docs/` | Документация |
| `config/` | Баланс и механики |
| `tests/` | Тесты |
| `docker/` | Docker/Compose |

---

## Приложение B. Глоссарий

| Термин | Определение |
|--------|-------------|
| Tick | Шаг симуляции (30 Гц, `tickMs=33.3`) |
| Snapshot | Снимок состояния |
| GCD | `gcdTicks=3` (100 мс при 30 Гц) |
| Обруч | Слой защиты сундука |
| Король | Лидер по массе |
| Безопасная зона | Область без урона в финале |
| Усиление | Временный эффект из сундука |
| Респаун-щит | Защита 5 сек после возрождения |
