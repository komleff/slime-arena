# Slime Arena — Архитектура

**Версия:** 1.5  
**Автор:** Claude Opus  
**Дата:** декабрь 2025  

Документ описывает техническую архитектуру проекта в соответствии с `SlimeArena-GDD-v2_4.md` и инженерным ТЗ движения/полёта `slime_arena_flight_tz_merged.md`.

---

## 0. Изменения версии 1.5

- Обновлена ссылка на GDD: `SlimeArena-GDD-v2_4.md`.
- Добавлена ссылка на инженерное ТЗ полёта/управления: `slime_arena_flight_tz_merged.md` (источник правды для `FlightAssist/Physics/Collision`).
- Обновлён серверный пайплайн симуляции: `FlightAssistSystem → PhysicsSystem → CollisionSystem` (встроено в общий порядок систем тика).
- Приведена в соответствие система координат: начало мира в центре `(0,0)`, границы задаются как `[-width/2..+width/2]` и `[-height/2..+height/2]` (или круг).
- Уточнены параметры мира/слайма: `SlimeConfig`, `WorldPhysicsConfig`, `ClientNetSmoothingConfig`, отказ от `overspeedDampingRate`/`linearDragK/angularDragK` в пользу `overspeedDampingRate` и `linearDragK/angularDragK`.

### Изменения версии 1.3 (исторически)

Обновлено по сравнению с версией 1.2:

- Приведено в соответствие с GDD 2.4: адаптивный/фиксированный джойстик, честная упругая физика (импульс), постепенное гашение превышения скорости, глобальный кулдаун умений 100 мс с очередью.
- Добавлены серверные механики: **«Последний вздох»** (0.5 сек после смерти) и **«Мятежник»** (маркер лидера + награда за убийство).
- Уточнены сущности и физика: сундуки — физические объекты с наградой в % от массы; пузыри имеют цвет (для заданий) и плотность (для физики).
- Расширена «продуктовая» часть: ежедневный бесплатный сундук (MVP) и каркас для **Сезонного альбома** (после MVP) согласно Приложению D (серверные сущности, API, миграции, идемпотентность открытия паков).
- GCD умений фиксируется в **тиках** (при 30 Гц: 3 тика = 100 мс), чтобы избежать «4 тиков» из-за округлений.
- Зоны урона (углы пасти/хвоста/боков) вынесены в **config** + предусмотрены дискретные апгрейды углов.
- Валидация вектора движения использует сравнение **квадратов длины** (без `sqrt`).
- Клиентская синхронизация: **предиктивная интерполяция** и плавные коррекции по **кривым Эрмье**.


---

## 1. Технологический стек

### 1.1. Клиент

| Компонент | Технология |
|-----------|------------|
| Язык | TypeScript |
| Сборка | Vite |
| Рендер (MVP) | Canvas 2D |
| Рендер (позже) | PixiJS |
| Аудио | Howler.js |

### 1.2. Сервер

| Компонент | Технология |
|-----------|------------|
| Среда выполнения | Node.js |
| Язык | TypeScript |
| Сетевой фреймворк | Colyseus |
| HTTP API для мета-систем | Express (в составе Colyseus), либо отдельный Fastify/Express слой |

### 1.3. Данные

| Компонент | Технология |
|-----------|------------|
| База данных | PostgreSQL |
| ORM | Prisma |
| Кеш и очереди | Redis (опционально для MVP; обязателен при горизонтальном масштабировании) |

### 1.4. Инфраструктура

| Компонент | Технология |
|-----------|------------|
| Контейнеризация | Docker / Docker Compose |
| CI/CD | GitHub Actions |

---

## 2. Архитектурные цели

### 2.1. Обязательные требования

- **Сервер — источник правды:** урон, столкновения, рост массы, награды рассчитываются на сервере.
- **Фиксированная симуляция:** 30 тиков в секунду, фиксированный порядок систем.
- **Масштабируемость:** много матчей параллельно, возможность горизонтального масштабирования Colyseus (Presence/Driver).
- **Наблюдаемость:** метрики тика, задержки, размер снапшотов, причины дисконнектов.
- **Расширяемость мета-систем:** сезонные системы (пропуск, альбом, кланы) не должны ломать матчевую симуляцию.

### 2.2. Ограничения и допущения

- Управление: **один джойстик** (adaptive/fixed) + кнопки умений + быстрый выбор талантов (без паузы матча).
- Обработка касаний **вне управляющих областей**: игнорировать (не считать вводом). Управляющие области:
  - левая половина экрана — зона джойстика (в adaptive это «первое касание» задаёт якорь);
  - UI-кнопки умений/талантов/меню.
- Транспорт: WebSocket (Colyseus).
- Геометрия мира: **арена с бортами** (без тора).
- Клиент не отправляет позиции/урон/массу — только намерения (input).

---

## 3. Компоненты системы

### 3.1. Сервер (real-time + meta)

| Модуль | Назначение |
|--------|------------|
| `MatchService` | Поиск/создание матчей, параметры комнат |
| `MatchRoom` | Одна игровая сессия: мир, игроки, таймеры |
| `systems/*` | Системы симуляции: движение, столкновения, боёвка, спавн, правила |
| `abilities/*` | Реализация умений, кулдауны, глобальный GCD, очередь нажатий |
| `meta/api/*` | HTTP API: профиль, валюта, магазин, ежедневный сундук, (позже) альбом/кланы |
| `meta/persistence/*` | Доступ к БД (Prisma), транзакции и идемпотентность |
| `shared-config` | Загрузка и валидация конфигов (баланс/сезоны/экономика) |
| `telemetry/*` | Логи, метрики, бизнес-события |

### 3.2. Клиент

| Модуль | Назначение |
|--------|------------|
| `NetClient` | Подключение к Colyseus, подписка на state |
| `SnapshotBuffer` | Буфер снапшотов, предиктивная интерполяция, сглаживание коррекций |
| `InputHandler` | Адаптивный/фиксированный джойстик, кнопки умений, выбор талантов |
| `Renderer` | Canvas/Pixi отрисовка мира |
| `UI` | Лобби, HUD, результаты, профиль, магазин, ежедневный сундук |
| `Audio/Haptics` | Звук и вибрация по событиям |

### 3.3. Общие данные

| Модуль | Назначение |
|--------|------------|
| `shared/types` | Типы сообщений и состояния |
| `shared/config` | Схема конфигов (Zod/TypeBox), значения по умолчанию |
| `shared/constants` | Сетевые коды, enum, bitmask флагов |

---

## 4. Потоки данных

### 4.1. Подключение к матчу

1. Клиент открывает WebSocket соединение (Colyseus).
2. Клиент входит в комнату (matchmaking/roomId).
3. Сервер присваивает `playerId` и отправляет первичный снапшот.
4. Сервер начинает рассылку состояния (10–30 Гц), симуляция — 30 Гц.

### 4.2. Управление

Клиент каждый тик (30 Гц) формирует команду:

- `inputSeq` — порядковый номер
- `move` — нормализованный вектор джойстика (x,y)
- `abilitySlot` — «нажатие» умения (0/1/2/3) **только на тик нажатия**
- `talentChoice` — выбор таланта (0/1/2/3) **только на тик подтверждения**

Особенности:
- Адаптивный джойстик сам выбирает «якорь» по первому касанию левой половины экрана (см. GDD 2.4, 2.2).
- Сервер **не доверяет** частоте/валидности нажатий: проверяет cooldown, стоимость, GCD, очередь.

### 4.3. Синхронизация состояния

- Сервер рассылает авторитетное состояние.
- Клиент рендерит «в прошлом» (`now - interpolationDelay`) по 3–5 снапшотам.
- Используется предиктивная интерполяция/коррекции (см. раздел 10).

### 4.4. Out-of-band события (не в state)

Для редких «событий-уведомлений» используется broadcast сообщений:
- «Новый Мятежник»
- «Мятежник убит»
- «Последний вздох начался/закончился»
- «Игрок получил титул в конце матча» и т.д.

Это уменьшает размер снапшотов и не требует хранить в state «историю событий».

### 4.5. Meta API (HTTP)

- Лобби/профиль/магазин/ежедневный сундук работают через HTTP API.
- Матчевые награды (капли, рейтинг, статистика) записывает сервер **по окончании матча** транзакционно.

---

## 5. Серверная симуляция

### 5.1. Порядок систем в тике

Внутри каждого тика (~33 мс) сервер выполняет системы в фиксированном порядке:

| Порядок | Система | Назначение |
|---------|---------|------------|
| 1 | `CollectInputs` | Сбор и очередь команд по игрокам |
| 2 | `ApplyInputs` | Валидация и сохранение `latestInput` (moveX/moveY), edge-нажатия умений/талантов |
| 3 | `AbilitySystem` | Кулдауны, стоимость массы, **GCD 100 мс = 3 тика @30 Гц**, очередь нажатий (max 1) |
| 4 | `FlightAssistSystem` | Управляющие силы/моменты по джойстику + автопомощь (см. `slime_arena_flight_tz_merged.md`) |
| 5 | `PhysicsSystem` | Ньютоновская интеграция (Semi-Implicit Euler), сопротивление среды (`linearDragK/angularDragK`) |
| 6 | `CollisionSystem` | Круг‑круг + круг‑границы (прямоугольник/круг), импульсы + позиционная коррекция, итерационный решатель |
| 7 | `CombatSystem` | Урон (пасть/хвост/бока), i-frames, щиты, отскок (если нужен доп. импульс) |
| 8 | `PickupSystem` | Укус пузырей (полный/частичный), притяжение (orbs only) |
| 9 | `ChestSystem` | Физика сундуков, открытие пастью, выдача награды |
| 10 | `DeathSystem` | «Последний вздох», смерть/респаун, щит респауна |
| 11 | `PhaseSystem` | Фазы матча, Hot Zones, голод вне зоны |
| 12 | `RebelSystem` | Назначение «Мятежника», награда за убийство лидера |
| 13 | `SnapshotSystem` | Сбор снапшотов, отправка состояния 10–20 Гц |


Примечание: конкретное разбиение можно оптимизировать, но **порядок должен быть фиксирован** (детерминизм).

### 5.2. Детерминизм и случайность

- Фиксированный шаг времени.
- Один поток симуляции на матч.
- Случайность (спавн, лут) — через `seed`, фиксируемый на старте матча.
- Любой RNG используется только на сервере.

---

## 6. Физика и сущности

### 6.1. Сущности мира (ECS/Entity)

| Сущность | Описание |
|----------|----------|
| `SlimeEntity` | Игрок (или бот) |
| `OrbEntity` | Питательный пузырь (масса + цвет + физическая плотность) |
| `ProjectileEntity` | Снаряд умения «Выброс» |
| `ChestEntity` | Сундук (бронза/серебро/золото), физический |
| `HotZoneEntity` | Горячая зона (радиус + множитель) |

### 6.2. Ключевые параметры (из config)

С версии **GDD 2.4** движение слаймов и параметры «полёта» задаются через **силы/моменты** и вынесены в отдельные конфиги (детали и формулы — в `slime_arena_flight_tz_merged.md`).

**SlimeConfig (на каждого класса/босса):**
- Геометрия: `baseMassKg`, `baseRadiusM`, `radiusFromMass` (по умолчанию √‑закон).
- Движение: `thrustForwardN`, `thrustReverseN`, `thrustLateralN`, `turnTorqueNm`.
- Лимиты: `speedLimitForwardMps`, `speedLimitReverseMps`, `speedLimitLateralMps`, `angularSpeedLimitRadps`.
- Assist: `comfortableBrakingTimeS`, `angularStopTimeS`, `autoBrakeMaxThrustFraction`, `overspeedDampingRate`, `yawFullDeflectionAngleRad`, анти‑осцилляции yaw (`yawOscillation*`, `yawDampingBoostFactor`, `yawCmdEps`).
- Боевые: `biteDamagePctOfMass`, `orbBitePctOfMass`.
- Mass scaling кривые: по умолчанию thrust `m^0.5`, torque `m^1.5`.

**WorldPhysicsConfig (на карту/биом):**
- `linearDragK`, `angularDragK` (сопротивление среды, формулы через силы/моменты).
- `restitution` (энергия столкновения), `maxPositionCorrectionM` (лимит коррекции).
- `worldShape` (`rectangle|circle`) + размеры (`widthM/heightM` или `radiusM`).

**ClientNetSmoothingConfig (клиент):**
- `lookAheadMs`, `maxDeviationM`, `catchUpMin/catchUpMax`, `maxExtrapolationMs`, `transitionDurationMs`, `angleMaxDeviationRad`.

### 6.3. Масса пузыря vs плотность

- `orb.mass` — **питательность** (сколько массы получает слайм).
- `orb.density` — **только физика** (насколько «тяжело» сдвигать пузырь и как он отлетает).
- Эффективная масса в физике: `orb.physicsMass = orb.mass * densityByColor[color]`.
- Визуальный радиус пузыря зависит от `orb.mass` и `orbs.minRadius`; `orb.density` на размер не влияет.

В state достаточно передавать `orb.mass` и `orb.colorId` (плотность восстанавливается по цвету на клиенте).

### 6.4. Упругая реакция столкновений

- Все тела — круги (2D).
- При проникновении: позиционное раздвижение + импульс по закону сохранения импульса.
- Импульс ограничивается `collisionImpulseCap`.
- Дрейф энергии: учитывается через `collisionRestitution` и линейное затухание.

### 6.5. Превышение скорости (overspeed)

Слайм может получить скорость выше лимитов (например, при столкновении с большим объектом или от взрыва).  
Важно: в симуляции **запрещены мгновенные clamp’ы скорости** (без физического импульса).

Механика возврата в лимит:
- `FlightAssistSystem` на каждом серверном тике применяет **мягкое гашение превышения** по локальным осям (forward/reverse/lateral) через параметр `overspeedDampingRate` (доля превышения за тик), но строго в рамках доступной тяги (`thrust*`) и текущей массы.
- При отсутствии ввода используется «комфортный режим» автоторможения: не выше `autoBrakeMaxThrustFraction` от доступной тяги.
- Дополнительно скорость гасится сопротивлением среды (`linearDragK`), если оно не равно нулю.

Целевые ориентиры (acceptance): для базового слайма превышение по forward должно спадать до лимита за ~1–3 секунды без резких скачков (см. `slime_arena_flight_tz_merged.md`).

### 6.6. Арена с бортами (world bounds)

С версии **GDD 2.4** начало координат мира — **центр карты** `(0,0)` (см. `slime_arena_flight_tz_merged.md`).

Поддерживаемые формы мира (через `WorldPhysicsConfig`):
- `rectangle`: `x ∈ [-widthM/2, +widthM/2]`, `y ∈ [-heightM/2, +heightM/2]`
- `circle`: `|pos| + radiusEntity ≤ radiusM`

Борты реализуются как часть `CollisionSystem` (коллизия «круг‑граница»):
- позиция корректируется внутрь границы на минимально допустимое расстояние,
- скорость отражается по нормали стены с коэффициентом `restitution`,
- тангенциальная компонента сохраняется (даёт «рикошеты»).

---

## 7. Боёвка и ключевые механики

### 7.1. Зоны урона (через config)

Слайм делится на сектора относительно `angle` (ориентации). Базовые углы и модификаторы задаются в `config`:

- `mouthArcDeg` (база: 120°)
- `tailArcDeg` (база: 120°)
- Бока вычисляются автоматически: `sideArcDeg = (360 - mouthArcDeg - tailArcDeg) / 2`

**Будущие перки на изменение углов (дискретные):**
- Пасть: +10° за уровень, до 3 уровней (`mouthArcUpgradeStepDeg=10`, `mouthArcUpgradeMaxLevel=3`)
- Хвост: −10° за уровень, до 3 уровней (`tailArcUpgradeStepDeg=10`, `tailArcUpgradeMaxLevel=3`)

Эффективные углы:
- `mouthArcDegEff = mouthArcDeg + mouthArcUpgradeLevel * mouthArcUpgradeStepDeg`
- `tailArcDegEff = max(tailArcDegMin, tailArcDeg - tailArcUpgradeLevel * tailArcUpgradeStepDeg)`
- Бока пересчитываются из остатка, с клипом до неотрицательных значений.

Правило при границе: приоритет у зоны с большим уроном для атакующего.

**Крит/множители:**
- Попадание пастью в хвост применяет `tailDamageMultiplier` (база: ×1.5). Опционально можно помечать такое попадание как `isCrit=true` для VFX/телеметрии (через config `tailCountsAsCrit`).

### 7.2. Урон и отскок

- Урон рассчитывается сервером.
- Хвост получает множитель `tailDamageMultiplier = 1.5`.
- После любого столкновения: честный отскок по импульсу с учётом `collisionRestitution`.
- После получения урона: i-frames `damageInvuln = 0.2 сек` (6 тиков).

### 7.3. Респаун-щит

- Базовый щит при респауне: `respawnShield = 5 сек`.
- Любая атака под щитом снимает щит досрочно.
- Щит — состояние (флаг + таймер) в `SlimeEntity`.

### 7.4. «Последний вздох» (Last Breath)

Модель состояния:

- При смертельном уроне от врага: вместо мгновенного удаления — переход в `LastBreath` на `0.5 сек`.
- В `LastBreath`:
  - слайм **неуязвим**;
  - скорость множится на `0.8`;
  - урон пастью множится на `0.5`;
  - доступны только действия «движение + укус пастью».
- По окончании таймера: финализация смерти (выпадение пузырей, респаун по таймеру 2 сек).

Важно: не активировать при смерти от голода, дисконнекта или других небоевых причин.

### 7.5. «Мятежник» (Rebel)

- Каждые `rebelUpdateInterval = 5 сек` сервер пересчитывает статус.
- Условие: масса лидера > `rebelMassThreshold` × средняя масса.
- В state хранится `rebelId`, а у самого слайма — флаг `IS_REBEL`.
- При убийстве Мятежника:
  - бонус к награде за убийство (mass bonus) и бафф скорости убийце на `10 сек`;
  - на смерти Мятежника увеличивается доля массы, выпадающая в пузыри (`40%` вместо `30%`).

---

## 8. Правила матча

### 8.1. Состояния комнаты

| Состояние | Описание |
|-----------|----------|
| `Lobby` | Ожидание игроков |
| `Running` | Матч идёт |
| `Results` | Экран результатов + начисление наград |

### 8.2. Фазы матча (2–3 минуты)

Фазы как в GDD 9.4:

| Фаза | Время | Особенности |
|------|-------|-------------|
| `Spawn` | 0:00–0:15 | Щит 5 сек, безопасный старт |
| `Collect` | 0:15–1:00 | Много пузырей |
| `Hunt` | 1:00–1:30 | PvP активнее |
| `Chaos` | 1:30–2:00 | Hot Zones, голод |
| `Final` | 2:00–2:30 | 1 большая Hot Zone, сильный голод |

### 8.3. Hot Zones и голод

- Hot Zones создаются сервером по фазам:
  - `Chaos`: 2 зоны, ×3 спавн
  - `Final`: 1 зона в центре, ×5 спавн
- Голод отнимает **массу** вне Hot Zone, но не снижает ниже 50.
- Параметры через config: `hungerBaseDrain`, `hungerScaling`, `hungerMaxDrain`, `hungerStartTime`.

### 8.4. Сундуки

- До 3 сундуков на карте, спавн раз в 20 сек.
- Сундук — физический объект (имеет скорость и участвует в столкновениях).
- Открытие: касание пастью (мгновенно).
- Награда:
  - масса в % от текущей массы (10/20/30) ИЛИ талант (30% шанс),
  - тип сундука определяет качество награды.

---

## 9. Сетевой протокол (Colyseus Schema + сообщения)

### 9.1. Принципы

- Клиент отправляет **команды**, а не состояние.
- Команды валидируются по диапазонам, частоте и контексту (cooldown/GCD).
- State — минимальный для всех; персональные данные (например, собственные кулдауны) можно слать отдельными сообщениями.

### 9.2. Команда игрока (пример)

| Поле | Тип | Описание |
|------|-----|----------|
| `inputSeq` | uint16 | Порядковый номер команды (монотонно растущий) |
| `moveX` | float32 | Ось X, [-1..+1] |
| `moveY` | float32 | Ось Y, [-1..+1] |
| `abilitySlot` | uint8 | 0/1/2/3 — нажатие в этом тике |
| `talentChoice` | uint8 | 0/1/2/3 — подтверждение выбора |

Рекомендация: трактовать `abilitySlot` как edge-triggered (в UI кнопка даёт событие «tap», а не «hold»).

### 9.3. Валидация команд

| Проверка | Действие |
|----------|----------|
| `moveX*moveX + moveY*moveY > 1.01^2` | Отклонить/нормализовать, залогировать (без `sqrt`) |
| `abilitySlot` вне {0,1,2,3} | Отклонить |
| Частота сообщений > лимита | Отклонить/диск |
| `inputSeq` слишком старый | Игнорировать |

### 9.4. Состояние матча (root)

Минимальный набор:

| Поле | Тип | Описание |
|------|-----|----------|
| `phase` | uint8 | Фаза матча |
| `timeRemaining` | float32 | Оставшееся время |
| `rebelId` | string | ID мятежника (или пусто) |
| `slimes` | MapSchema | Все слаймы |
| `orbs` | MapSchema | Все пузыри |
| `chests` | MapSchema | Все сундуки |
| `hotZones` | ArraySchema | Hot Zones |
| `leaderboard` | ArraySchema | Топ-5 id |

### 9.5. Состояние слайма

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | uint16 | id |
| `pos` | Vector2 | позиция (м) |
| `vel` | Vector2 | скорость (м/с) |
| `angle` | float32 | ориентация (рад) |
| `angVel` | float32 | угловая скорость (рад/с) |
| `mass` | float32 | масса (кг) |
| `hp` | float32 | текущие HP (правило: `maxHP = mass`) |
| `level` | uint8 | уровень (0..255) |
| `classId` | uint8 | 0/1/2 (hunter/warrior/collector) |
| `flags` | uint8 | битовое поле (щит, lastBreath, rebel, и т.п.) |

Примечания:
- Поля `angle/angVel` нужны для точного отображения боевых углов и сглаживания.
- `radius` вычисляется на клиенте из массы и `SlimeConfig.radiusFromMass` (при необходимости можно дублировать как debug‑поле).

### 9.6. Состояние пузыря

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | uint16 | id |
| `pos` | Vector2 | позиция |
| `vel` | Vector2 | скорость |
| `mass` | float32 | масса (питательность) |
| `colorId` | uint8 | 0..N (зел/син/красн/золото) |

### 9.7. Состояние сундука

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | uint16 | id |
| `pos` | Vector2 | позиция |
| `vel` | Vector2 | скорость |
| `type` | uint8 | 0/1/2 (bronze/silver/gold) |

---

## 10. Клиентское отображение

Клиент получает авторитетные снапшоты 10–20 Гц и рендерит плавно, учитывая джиттер и потери пакетов.  
Детали алгоритма движения/угла и рекомендуемые дефолты — в `slime_arena_flight_tz_merged.md` (раздел ClientNetSmoothingConfig).

### 10.1. SnapshotBuffer

- Хранить 3–6 последних снапшотов для каждого объекта (slime/orb/chest/projectile).
- Каждый снапшот: `pos`, `vel`, `angle`, `angVel`, а также игровые стейты (HP, флаги, и т.п.).
- Снапшоты привязаны к `serverTick` и `serverTimeMs` (для вычисления `t` внутри буфера).

### 10.2. Предиктивная интерполяция (Hermite + look-ahead)

Рендер‑позиция вычисляется через «целевую точку в будущем»:

- `targetPos = S.pos + S.vel * ((t + lookAheadMs)/1000)`
- Переход к `targetPos` выполняется по кубической кривой Эрмита (позиция + производная‑скорость).
- Коэффициент «догоняния» выбирается адаптивно в диапазоне `catchUpMin..catchUpMax` в зависимости от отклонения `dev = |renderPos - targetPos|`.
- При больших расхождениях (`dev > maxDeviationM`) допускается ускоренная коррекция за 2–3 кадра, но без телепорта.

### 10.3. Потеря снапшотов и переходы

- Если новых снапшотов нет и `t <= maxExtrapolationMs`: краткая экстраполяция `pos += vel * dtRender`.
- Если `t > maxExtrapolationMs`: плавно затухать скорость к нулю за `transitionDurationMs`.

### 10.4. Сглаживание угла (приоритет точности)

- Всегда нормализовать `deltaAngle` в диапазон `[-π..π]` (выбор кратчайшего пути).
- Угол сглаживать быстрее позиции (боёвка зависит от ориентации).
- Если расхождение угла больше `angleMaxDeviationRad`, применять повышенное «догоняние».

---

## 11. Персистентность и мета-системы

### 11.1. Что хранится (MVP)

| Данные | Описание |
|--------|----------|
| Профиль | userId, ник, настройки управления |
| Валюта | капли |
| Рейтинг | текущий, максимум, лига |
| Статистика | матчи, победы, убийства, макс. масса |
| Косметика | инвентарь купленных предметов |
| Достижения | прогресс и отметки получения |
| Ежедневный сундук | время последнего клейма, «сид» награды |

### 11.2. Принципы записи результатов

- Матчевые награды записывает только сервер комнаты при `match_end`.
- Обновления идемпотентны: `matchId` как ключ, чтобы не начислять дважды.
- Все изменения профиля/валюты — транзакционно.

### 11.3. Ежедневный бесплатный сундук (MVP)

Рекомендуемые поля в БД:

- `daily_chest_last_claim_at`
- `daily_chest_streak` (опционально, если появится серия)
- `daily_chest_seed` (если нужна воспроизводимость выпадения)

API минимум:
- `POST /daily-chest/claim` (с проверкой 24h)
- `POST /daily-chest/ad-double` (если rewarded-ad удваивает награду)

### 11.4. Сезонный альбом (после MVP, GDD 12.3 + Приложение D)

Система работает **сервер-авторитетно** (все открытия паков, pity и клей — на сервере).

#### 11.4.1. Ключевые сущности

Минимум, который должен поддержать backend:

- `SeasonConfig`
- `CardDefinition`
- `PlayerAlbumState`
- `PackOpenResult`
- `PlayerAlbumHistory` (архив сезонов)

Схемы и поля — как в Приложении D (GDD 2.4).

#### 11.4.2. Эндпоинты (контракт)

| Метод | Endpoint | Назначение |
|-------|----------|-----------|
| GET | `/album/state` | Текущее состояние игрока |
| GET | `/album/cards` | Список карт сезона (с признаком собрана/нет) |
| POST | `/album/pack/open` | Открыть пак (packType, source, idempotencyKey) |
| POST | `/album/glue/exchange` | Обменять клей на пак |
| GET | `/album/rewards` | Награды за страницы |
| POST | `/album/rewards/claim` | Клейм награды за страницу |
| POST | `/album/arena-chest/claim` | Клейм пака из «сундука арены» |

#### 11.4.3. Идемпотентность открытия паков

Проблема: на мобильной сети запрос может повториться.

Решение:
- Клиент отправляет `idempotencyKey` на `POST /album/pack/open`.
- Сервер сохраняет результат открытия по ключу (Redis или таблица `pack_open_requests`).
- Повторный запрос возвращает тот же `PackOpenResult`.

#### 11.4.4. Интеграции

- После каждого матча: обновлять `arenaChestProgress.currentMass` на основании `totalMassCollected` (из результата матча).
- Задания/пропуск/кланы награждают паками через единый метод `grantPack(playerId, packType, source)`.

#### 11.4.5. Миграция сезона (batch job)

На старте нового сезона:
1. Конвертировать клей → капли (курс из config).
2. Архивировать `PlayerAlbumState` в `PlayerAlbumHistory`.
3. Создать новый `PlayerAlbumState` (нулевые счётчики).
4. Начислить незабранные награды (если выбран подход auto-claim).

---

## 12. Наблюдаемость

### 12.1. Метрики сервера (технические)

| Метрика | Тип | Порог алерта |
|---------|-----|--------------|
| `tick_duration_ms` p99 | histogram | > 30 мс |
| `snapshot_bytes` p99 | histogram | > 2 КБ |
| `ws_disconnect_rate` | counter | > 5%/час |
| `exceptions_total` | counter | > 0 |

### 12.2. Бизнес-события (минимум)

Матч:
- `match_start`, `match_end`
- `player_death` (с флагом lastBreathUsed)
- `rebel_assigned`, `rebel_killed`
- `ability_used`, `talent_chosen`, `chest_opened`

Meta:
- `daily_chest_claimed` (rewardType, doubled)
- (после MVP) события альбома из Приложения D.

---

## 13. Безопасность и античит

### 13.1. Базовые меры

- Сервер валидирует частоту и диапазоны команд.
- Сервер не принимает клиентские позиции/урон.
- Лимиты на размер входящих сообщений и rate limit.
- Для meta API: проверка auth + идемпотентность наград/паков.

### 13.2. Детекция аномалий (пример)

| Аномалия | Признак | Действие |
|----------|---------|----------|
| Speed hack | скорость выше лимита длительное время | лог + авто-коррекция, флаг |
| Flood | > лимита сообщений/сек | disconnect |
| Duplicate reward | повтор `match_end` или `pack_open` | идемпотентность, deny |

---

## 14. Тестирование

### 14.1. Модульные тесты (сервер)

- Борты: отражение/коррекция позиций у границ.
- Упругая физика: conservation-like, отсутствие «взрыва» скорости.
- `overspeedDampingRate`: корректное гашение превышения скорости.
- Зоны (пасть/хвост/бок): классификация контакта.
- GCD/очередь умений: 100 мс и максимум 1 в очереди.
- Last Breath: переход состояний, неуязвимость, таймер.
- Rebel: вычисление среднего, выбор лидера, tie-break (кто раньше достиг).

### 14.2. Интеграционные тесты

- Матч от начала до конца (с фазами, зонами, голодом).
- Укус пузыря: полный/частичный, минимум остатка.
- Сундук: столкновения, открытие пастью, выдача награды.
- Респаун: щит, снятие щита атакой.
- Отображение rebelId и уведомления.

### 14.3. После MVP (альбом)

- Открытие паков: вероятности, pity, новые карты, дубликаты → клей.
- Идемпотентность `/album/pack/open`.
- Миграция сезона: корректная конвертация клея и архивирование.

---

## 15. Развёртывание

Как в версии 1.1: локально через `docker compose up`, далее staging/prod с Docker image и откатами.

---

## Приложение A. Структура репозитория (рекомендация)

| Директория | Содержимое |
|------------|------------|
| `client/` | Клиент |
| `server/` | Сервер (Colyseus + HTTP API) |
| `shared/` | Общие типы и конфиги |
| `docs/` | Документация |
| `tests/` | Тесты |
| `docker/` | Docker/Compose |

---

## Приложение B. Глоссарий

| Термин | Определение |
|--------|-------------|
| Tick | Один шаг серверной симуляции (30 Гц) |
| Snapshot | Снимок состояния мира для клиента |
| GCD | Global Cooldown между умениями (100 мс) |
| Last Breath | Фаза 0.5 сек после смерти для контратаки |
| Rebel | Маркер лидера (мятежник) с наградой за убийство |
| Pity | Гарантии выпадения (альбом/капсулы) |
| Idempotency | Защита от повторной выдачи наград |
