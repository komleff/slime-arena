# Ревью ТЗ: Server Monitoring Dashboard

**Ревьювер:** Architect (Claude Opus 4.5)
**Дата:** 2026-02-03
**Документ:** `docs/plans/TZ-SERVER-MONITORING-DASHBOARD.md` (ветка `feature/server-monitoring-dashboard`)
**Статус:** CHANGES_REQUESTED

---

## Резюме

ТЗ хорошо структурировано и содержит необходимые секции (функциональные требования, архитектура, безопасность, риски). Однако обнаружены несоответствия утверждённому технологическому стеку проекта и нарушения требований к документации Architect.

---

## Замечания

### P0 — Критичные (блокеры)

| # | Секция | Проблема | Рекомендация |
|---|--------|----------|--------------|
| 1 | 9. Технологический стек | **Frontend: React/Vue/Svelte** — нарушение утверждённого стека. В проекте используется **Preact 10.x** | Использовать Preact + @preact/signals. Это обеспечит консистентность и позволит переиспользовать компоненты |
| 2 | 9. Технологический стек | **SQLite (better-sqlite3)** — в проекте только PostgreSQL + Redis. Добавление третьей БД усложняет инфраструктуру | Использовать существующий PostgreSQL. Создать таблицы `admin_users`, `audit_log` в той же БД |
| 3 | 4.1 Архитектура | **Отдельный Auth** — дублирует функционал MetaServer. Уже есть: JWT, rate limiting, refresh tokens | Расширить MetaServer новыми endpoints для admin-функционала вместо создания параллельной системы |

### P1 — Важные

| # | Секция | Проблема | Рекомендация |
|---|--------|----------|--------------|
| 4 | 5.1-5.4 | **Примеры кода в ТЗ** — нарушает требования к документации Architect (см. AGENT_ROLES.md секция 1) | Заменить код на текстовые описания контрактов API или диаграммы последовательности |
| 5 | 9. Frontend | **Tailwind CSS + shadcn/ui** — новые зависимости. Текущий бандл 70 kB gzip, лимит 150 kB | Использовать существующие CSS-паттерны из client/src/ui/ или добавить обоснование увеличения бандла |
| 6 | 4.2 | **Дублирование health endpoint** — уже существует `GET /health` на MetaServer, возвращает статус DB и Redis | Переиспользовать существующий endpoint, расширить при необходимости |
| 7 | Весь документ | **Отсутствуют ссылки на источники** — требования не привязаны к GDD, TZ или issue-id | Добавить Beads ID задачи и ссылки на требования Soft Launch |

### P2 — Желательно исправить

| # | Секция | Проблема | Рекомендация |
|---|--------|----------|--------------|
| 8 | 8. Этапы | **Оценка 2-3 дня для MVP** — не учитывает тесты, code review, интеграцию | Пересмотреть оценку: Backend ~20ч, Frontend ~16ч, DevOps ~8ч, Review ~8ч = ~6-7 дней |
| 9 | 3.1 NF-SEC-05 | **IP whitelist как P2** — для admin-панели с кнопкой Restart это должен быть P1 | Повысить приоритет до P1 |
| 10 | 7.2 | **"Encrypted в SQLite"** — не конкретизировано шифрование 2FA secrets | Указать алгоритм (AES-256-GCM) и способ хранения ключа |
| 11 | 12. Открытые вопросы | **4 вопроса без ответов** — блокируют начало разработки | Принять решения до передачи в работу |

### P3 — Косметика

| # | Секция | Проблема | Рекомендация |
|---|--------|----------|--------------|
| 12 | 6.2 | Wireframes содержат ASCII-art — сложно редактировать | Использовать Mermaid или Excalidraw |
| 13 | 4.1 | Диаграмма архитектуры дублирует информацию из таблицы 4.2 | Объединить в одну секцию |

---

## Архитектурные рекомендации

### 1. Интеграция с существующей инфраструктурой

Вместо создания отдельного Monitoring API рекомендую:

```
MetaServer (существующий)
├── /api/v1/auth/*          ← существующие endpoints
├── /api/v1/admin/*         ← НОВЫЕ endpoints (защищены admin role)
│   ├── GET  /health/detailed
│   ├── GET  /stats
│   ├── GET  /rooms
│   ├── GET  /logs
│   ├── POST /restart
│   └── GET  /audit
└── /api/v1/ws/admin        ← WebSocket для real-time
```

**Преимущества:**
- Один сервис вместо двух
- Переиспользование auth-инфраструктуры
- Единая БД (PostgreSQL)
- Проще деплой и мониторинг

### 2. Модель данных (PostgreSQL)

| Таблица | Назначение |
|---------|------------|
| `admin_users` | Администраторы (id, username, password_hash, totp_secret, created_at) |
| `admin_sessions` | Сессии (id, user_id, refresh_token, ip, expires_at) |
| `audit_log` | Аудит (id, user_id, action, target, ip, timestamp, details) |

### 3. Frontend

| Компонент | Рекомендация |
|-----------|--------------|
| Framework | Preact 10.x (как в основном проекте) |
| State | @preact/signals |
| Styling | CSS Modules (существующий паттерн) |
| Charts | Lightweight: uPlot (~30 kB) вместо Chart.js (~200 kB) |

### 4. Ответы на открытые вопросы

| Вопрос | Рекомендация |
|--------|--------------|
| Где хостить? | **Sidecar в Docker** (MVP). Минимальные затраты, достаточно для 1-2 админов |
| Frontend framework? | **Preact** (консистентность со стеком) |
| Telegram бот? | **Webhook** в MVP, бот в Phase 2 (если потребуется интерактив) |
| Сколько пользователей? | **1-3 администратора**. Достаточно простого login + 2FA |

---

## Что хорошо в ТЗ

1. Чёткая приоритизация требований (P0-P3)
2. Глоссарий терминов (секция 10)
3. Анализ рисков с митигацией (секция 11)
4. Responsive wireframes для desktop и mobile
5. Детальные требования безопасности (NF-SEC-*)
6. Разбиение на фазы разработки

---

## Рекомендуемые действия

1. **Исправить P0 замечания** — выбрать Preact, PostgreSQL, интеграцию с MetaServer
2. **Убрать примеры кода** — заменить на описания контрактов
3. **Добавить Beads ID** — создать epic-задачу через `bd create`
4. **Ответить на открытые вопросы** — зафиксировать решения в документе
5. **Пересмотреть оценку** — учесть тесты и review

---

## Вердикт

**CHANGES_REQUESTED**

ТЗ требует доработки перед передачей Developer:
- 3 критичных замечания (P0)
- 4 важных замечания (P1)
- 4 желательных исправления (P2)

После внесения правок документ будет готов к декомпозиции на задачи Beads.

---

## Глоссарий (дополнение к ТЗ)

| Термин | Определение |
|--------|-------------|
| **Preact** | Легковесная альтернатива React (3 kB vs 40 kB), используемая в Slime Arena |
| **@preact/signals** | Библиотека реактивного состояния для Preact |
| **Sidecar** | Паттерн деплоя: вспомогательный контейнер рядом с основным |
| **uPlot** | Легковесная библиотека для графиков (~30 kB) |

