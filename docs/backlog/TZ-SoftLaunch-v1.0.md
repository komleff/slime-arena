# Техническое задание: Slime Arena — Подготовка к софт-лончу

**Версия:** 1.0
**Дата:** 2 января 2026
**Платформа:** Telegram Mini Apps (первая), далее мультиплатформа
**Целевые рынки:** РФ, СНГ, Европа, США, Азия

---

## 1. Текущее состояние проекта

### 1.1. Готовые компоненты

Геймплей реализован на 90%:

- Сервер на Colyseus с детерминированной симуляцией 30 тиков в секунду
- Полный игровой цикл: появление, рост, бой, смерть, возрождение, результаты
- Три класса персонажей с умениями и пассивными способностями
- Система талантов: 40 талантов, выбор одного из трёх
- Сундуки с механикой обручей и наградами
- Временные усиления четырёх типов
- Генератор арен с препятствиями и зонами эффектов
- Отрисовка на Canvas 2D со сглаживанием
- Адаптивный джойстик для касания и мыши
- Интерфейс: индикаторы, мини-карта, экран результатов
- Телеметрия событий матча в локальные файлы

### 1.2. Отсутствующие компоненты

Критичные для коммерческой эксплуатации:

- Хранилище данных — нет
- Авторизация пользователей — нет
- Сохранение прогресса — нет
- Монетизация — нет
- Внутриигровой магазин — нет
- Косметические предметы — нет

---

## 2. Выбор хранилища данных

### 2.1. Сравнение решений

| Критерий | PostgreSQL + Prisma | PostgreSQL + pg | MongoDB | Redis |
|----------|---------------------|-----------------|---------|-------|
| Типизация запросов | Полная | Частичная | Частичная | Нет |
| Генерация схемы | Автоматическая | Ручная | Ручная | Неприменимо |
| Миграции | Встроенные | Отдельный инструмент | Отдельный инструмент | Неприменимо |
| Связи между сущностями | Декларативные | SQL-запросы | Вложенные документы | Ручное управление |
| Производительность | Средняя | Высокая | Высокая | Очень высокая |
| Порог входа для ИИ | Низкий | Средний | Средний | Высокий |
| Переход к людям | Средний | Лёгкий | Лёгкий | Лёгкий |
| Реляционные данные | Да | Да | Ограниченно | Нет |

### 2.2. Рекомендация

**PostgreSQL с библиотекой pg** (без Prisma).

Обоснование:

1. PostgreSQL входит в технологический стек компании
2. Библиотека pg знакома инженерам компании
3. Реляционная модель соответствует структуре данных
4. ИИ-кодеры справятся с SQL-запросами при наличии схемы
5. Передача проекта людям пройдёт без дополнительного обучения

Дополнительно:

- Redis для хранения сессий и временных данных
- Redis для лидербордов с сортировкой по рейтингу

---

## 3. Концепция игрового процесса

### 3.1. Вход без регистрации

Игрок может начать игру без авторизации:

- Случайное имя из генератора
- Случайный базовый скин
- Полный доступ к геймплею

После успешного боя (вошёл в топ-10) предлагается:

- Сохранить профиль через авторизацию платформы
- Сохранить полученные награды и скин

### 3.2. Косметические предметы

Категории косметики:

| Категория | Описание | Источник |
|-----------|----------|----------|
| Скины слаймов | Внешний вид персонажа | Магазин, боевой пропуск, достижения |
| Рамки аватарок | Обрамление иконки профиля | Боевой пропуск, достижения |
| Аватарки | Изображение профиля | Боевой пропуск, достижения |
| Оформление профиля | Фон и стиль профиля | Магазин, боевой пропуск |
| Титулы | Текст под именем | Достижения, боевой пропуск |

Будущие категории:

- Скины эффектов: следы движения, визуал выстрелов
- Спецэффекты победы
- Стикеры и эмодзи для чата

### 3.3. Принцип магазина

**Только косметика. Никаких прокачек и усилений.**

В магазине доступно:

- Скины всех категорий
- Мягкая валюта (за рекламу)
- Премиум боевой пропуск

Недопустимо:

- Усиления характеристик
- Ускорение прогресса
- Преимущества в бою

### 3.4. Система рейтинга

**Алгоритм Glicko-2** вместо Эло.

Параметры игрока:

- Рейтинг (начальный 1500)
- Отклонение рейтинга (начальное 350)
- Волатильность (начальная 0.06)

Преимущества Glicko-2:

- Учитывает неопределённость рейтинга
- Адаптируется к активности игрока
- Более точное ранжирование

---

## 4. Архитектура платформенной абстракции

### 4.1. Цель

Обеспечить работу игры на разных платформах без изменения основного кода.

### 4.2. Интерфейсы провайдеров

#### IAuthProvider — авторизация

- Инициализация
- Проверка состояния авторизации
- Получение данных игрока
- Вход и выход

#### IAdsProvider — реклама

- Инициализация
- Показ межстраничной рекламы
- Показ рекламы с вознаграждением
- Проверка доступности

#### IPaymentProvider — платежи

- Инициализация
- Покупка товара
- Получение списка товаров
- Подтверждение потребления

#### ISocialProvider — социальные функции

- Приглашение друзей
- Список друзей в игре
- Отправка подарков
- Публикация результатов

### 4.3. Адаптеры платформ

| Адаптер | Платформа | Особенности |
|---------|-----------|-------------|
| TelegramAdapter | Telegram Mini Apps | initData, Stars, инвайты в чаты |
| YandexAdapter | Яндекс Игры | Yandex ID, ЮMoney |
| PokiAdapter | Poki | Гостевой режим |
| StandaloneAdapter | Локальная разработка | Заглушки |

### 4.4. Определение платформы

Автоматическое определение по глобальным объектам браузера:

- Telegram.WebApp → TelegramAdapter
- YaGames → YandexAdapter
- PokiSDK → PokiAdapter
- Иначе → StandaloneAdapter

---

## 5. Схема базы данных

### 5.1. Таблица users

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| platform_id | VARCHAR | Идентификатор на платформе |
| platform_type | VARCHAR | Тип платформы |
| nickname | VARCHAR | Отображаемое имя (изменяемое) |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

### 5.2. Таблица profiles

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID | Внешний ключ на users |
| level | INTEGER | Уровень игрока |
| experience | INTEGER | Накопленный опыт |
| total_kills | INTEGER | Всего убийств |
| total_deaths | INTEGER | Всего смертей |
| total_matches | INTEGER | Всего матчей |
| total_wins | INTEGER | Всего побед (первое место) |
| total_top3 | INTEGER | Всего попаданий в топ-3 |
| total_playtime | INTEGER | Время в игре (секунды) |
| hunter_matches | INTEGER | Матчей за Охотника |
| hunter_wins | INTEGER | Побед за Охотника |
| warrior_matches | INTEGER | Матчей за Воина |
| warrior_wins | INTEGER | Побед за Воина |
| collector_matches | INTEGER | Матчей за Собирателя |
| collector_wins | INTEGER | Побед за Собирателя |

### 5.3. Таблица player_ratings

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID | Внешний ключ на users |
| rating | FLOAT | Рейтинг Glicko-2 |
| deviation | FLOAT | Отклонение рейтинга |
| volatility | FLOAT | Волатильность |
| league | VARCHAR | Текущая лига |
| season_id | VARCHAR | Идентификатор сезона |
| updated_at | TIMESTAMP | Дата последнего расчёта |

### 5.4. Таблица inventories

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID | Внешний ключ на users |
| soft_currency | INTEGER | Мягкая валюта |
| hard_currency | INTEGER | Жёсткая валюта |
| selected_skin | VARCHAR | Выбранный скин слайма |
| selected_frame | VARCHAR | Выбранная рамка аватарки |
| selected_avatar | VARCHAR | Выбранная аватарка |
| selected_title | VARCHAR | Выбранный титул |

### 5.5. Таблица unlocked_items

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID | Внешний ключ на users |
| item_id | VARCHAR | Идентификатор предмета |
| item_type | VARCHAR | Тип: skin, frame, avatar, title, effect |
| unlocked_at | TIMESTAMP | Дата получения |
| source | VARCHAR | Источник: shop, battlepass, achievement, gift |

### 5.6. Таблица match_results

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| match_id | VARCHAR | Идентификатор матча |
| user_id | UUID | Внешний ключ на users (nullable для гостей) |
| position | INTEGER | Итоговая позиция |
| final_mass | INTEGER | Итоговая масса |
| kills | INTEGER | Убийств за матч |
| deaths | INTEGER | Смертей за матч |
| class_id | INTEGER | Класс персонажа |
| duration | INTEGER | Длительность (секунды) |
| xp_earned | INTEGER | Полученный опыт |
| rating_change | FLOAT | Изменение рейтинга |
| created_at | TIMESTAMP | Дата матча |

### 5.7. Таблица battle_pass_progress

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID | Внешний ключ на users |
| season_id | VARCHAR | Идентификатор сезона |
| tier | INTEGER | Текущий уровень |
| xp | INTEGER | Опыт в текущем уровне |
| is_premium | BOOLEAN | Куплен ли премиум |
| claimed_free | INTEGER[] | Полученные бесплатные награды |
| claimed_premium | INTEGER[] | Полученные премиум награды |

### 5.8. Таблица achievements

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID | Внешний ключ на users |
| achievement_id | VARCHAR | Идентификатор достижения |
| progress | INTEGER | Текущий прогресс |
| completed_at | TIMESTAMP | Дата выполнения (nullable) |
| reward_claimed | BOOLEAN | Получена ли награда |

### 5.9. Таблица daily_rewards

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| user_id | UUID | Внешний ключ на users |
| streak | INTEGER | Текущая серия входов |
| last_claim | DATE | Дата последнего получения |
| free_chest_at | TIMESTAMP | Время следующего бесплатного сундука |

### 5.10. Таблица social_invites

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| inviter_id | UUID | Пригласивший игрок |
| invited_id | UUID | Приглашённый игрок |
| reward_claimed | BOOLEAN | Получена ли награда |
| created_at | TIMESTAMP | Дата приглашения |

---

## 6. Модули софт-лонча

### 6.1. Уровень P0 — критичные

#### 6.1.1. Интеграция Telegram Mini Apps

- Подключение Telegram WebApp
- Извлечение данных пользователя из initData
- Верификация подписи на сервере
- Опциональная авторизация после успешного боя

#### 6.1.2. Хранилище данных

- PostgreSQL в Docker Compose
- Схема базы данных
- SQL-миграции
- Пул соединений
- Репозитории сущностей

#### 6.1.3. Гостевой режим и авторизация

- Игра без регистрации со случайным именем и скином
- Предложение сохранить профиль после успешного боя
- Связывание гостевых результатов с аккаунтом
- Возможность смены имени

#### 6.1.4. Профиль игрока

- Отображение статистики по классам
- Выбор косметики из инвентаря
- Редактирование имени
- Отображение рейтинга и лиги

#### 6.1.5. Прогресс уровней

- Расчёт опыта за матч
- Пороги уровней
- Начисление опыта после матча
- Награды за уровни

#### 6.1.6. Реклама

- Telegram Native Ads
- Реклама с вознаграждением после матча
- Удвоение награды при просмотре
- Ограничение частоты межстраничной рекламы

### 6.2. Уровень P1 — важные

#### 6.2.1. Социальные функции Telegram

- Приглашение друзей через диалоги и каналы
- Бонус за приглашённого (обоим)
- Список друзей в игре
- Уведомления о друзьях онлайн
- Публикация результатов в историю

#### 6.2.2. Боевой пропуск

- 30 уровней за сезон
- Бесплатная и премиум дорожки
- Награды: скины, рамки, аватарки, титулы
- Ежедневные и еженедельные миссии

#### 6.2.3. Косметика и инвентарь

- Конфигурация всех категорий предметов
- Экипировка с сохранением
- Предпросмотр предметов
- Синхронизация с сервером матча

#### 6.2.4. Магазин

- Скины всех категорий
- Покупка мягкой валюты за рекламу
- Премиум пропуск за Telegram Stars или ЮMoney
- Ротация предложений

#### 6.2.5. Ежедневные награды

- Календарь входа на 7 дней
- Бесплатный сундук раз в 24 часа
- Прогрессивные награды
- Сброс серии при пропуске

#### 6.2.6. Лидерборды

- Глобальный рейтинг Glicko-2
- Сезонные лиги
- Лидерборд друзей
- История позиций

### 6.3. Уровень P2 — желательные

#### 6.3.1. Достижения

15-20 достижений. Категории: бой, сбор, выживание, социальные. Награды: скины и титулы.

#### 6.3.2. Туториал

Обучающий матч. Подсказки управления. Награда за прохождение.

#### 6.3.3. Модерация

Фильтр никнеймов. Система жалоб. Бан-система.

---

## 7. Структура файлов

### 7.1. Общий пакет shared

Папка platform:

- types.ts — интерфейсы провайдеров
- index.ts — экспорты

### 7.2. Серверный пакет server

Папка api/routes:

- auth.ts — авторизация и гостевой режим
- profile.ts — профиль пользователя
- shop.ts — магазин
- battlepass.ts — боевой пропуск
- leaderboard.ts — лидерборды
- social.ts — социальные функции
- achievements.ts — достижения

Папка api/middleware:

- platformAuth.ts — проверка токенов
- optionalAuth.ts — опциональная авторизация для гостей

Папка services:

- PlayerService.ts — управление игроками
- ProgressionService.ts — прогресс уровней
- RatingService.ts — расчёт Glicko-2
- BattlePassService.ts — боевой пропуск
- ShopService.ts — магазин
- SocialService.ts — социальные функции
- AchievementService.ts — достижения

Папка db:

- pool.ts — пул соединений PostgreSQL
- repositories — репозитории сущностей
- migrations — SQL-миграции

### 7.3. Клиентский пакет client

Папка platform/adapters:

- TelegramAdapter.ts
- YandexAdapter.ts
- PokiAdapter.ts
- StandaloneAdapter.ts

Папка platform:

- PlatformManager.ts

Папка services:

- AuthService.ts
- ProfileService.ts
- AdsService.ts
- SocialService.ts

Папка ui:

- ProfileScreen.ts
- ShopScreen.ts
- BattlePassScreen.ts
- LeaderboardScreen.ts
- FriendsScreen.ts
- AchievementsScreen.ts

---

## 8. Порядок реализации

### 8.1. Фаза 0 — Абстракция платформ (1 неделя)

1. Интерфейсы провайдеров в shared
2. PlatformManager с определением платформы
3. StandaloneAdapter для разработки

### 8.2. Фаза 1 — Telegram MVP (3-4 недели)

1. TelegramAdapter с авторизацией и социальными функциями
2. PostgreSQL и схема
3. Гостевой режим и опциональная авторизация
4. Сохранение результатов матчей
5. Прогресс уровней
6. Реклама с вознаграждением

### 8.3. Фаза 2 — Монетизация и социальные функции (2-3 недели)

1. Инвайты и бонусы за друзей
2. Система косметики и инвентарь
3. Магазин со скинами
4. Ежедневные награды
5. Платежи через Stars

### 8.4. Фаза 3 — Удержание (2-3 недели)

1. Боевой пропуск
2. Лидерборды Glicko-2
3. Достижения с наградами
4. YandexAdapter для параллельного запуска

---

## 9. Оценка трудозатрат

| Модуль | Оценка |
|--------|--------|
| Абстракция платформ | 5 дней |
| PostgreSQL и схема | 3 дня |
| Гостевой режим и авторизация | 4 дня |
| Профиль | 3 дня |
| Прогресс уровней | 3 дня |
| Реклама | 3 дня |
| Социальные функции | 5 дней |
| Боевой пропуск | 5 дней |
| Косметика и инвентарь | 5 дней |
| Магазин | 4 дня |
| Ежедневные награды | 2 дня |
| Лидерборды Glicko-2 | 4 дня |
| Достижения | 4 дня |

Итого: 50-55 рабочих дней (10-12 недель для одного разработчика).

---

## 10. Сравнение платформ

| Возможность | Telegram | Яндекс Игры | Poki |
|-------------|----------|-------------|------|
| Авторизация | WebApp initData | Yandex ID | Гостевая |
| Сохранение | Своя БД | Cloud Saves | Своя БД |
| Реклама | Telegram Ads | Yandex Ads | Poki Ads |
| Платежи | Telegram Stars | ЮMoney | Нет |
| Социальные | Инвайты, каналы, истории | Нет | Нет |
| Регион | Глобально | РФ, СНГ | Европа, США |

---

## Глоссарий

| Термин | Описание |
|--------|----------|
| Адаптер | Реализация интерфейса для конкретной платформы |
| Боевой пропуск | Сезонная система прогресса с наградами за уровни |
| Волатильность | Параметр Glicko-2, отражающий стабильность результатов |
| Гостевой режим | Игра без регистрации со случайными данными |
| Жёсткая валюта | Валюта, приобретаемая за реальные деньги |
| Инвайт | Приглашение друга в игру |
| Инвентарь | Коллекция разблокированных предметов игрока |
| Интерфейс провайдера | Контракт методов для реализации адаптерами |
| Косметика | Предметы, влияющие только на внешний вид |
| Лидерборд | Таблица лидеров с ранжированием |
| Миграция | Скрипт изменения структуры базы данных |
| Мягкая валюта | Валюта, получаемая за игровую активность |
| Отклонение рейтинга | Параметр Glicko-2, отражающий неопределённость |
| Провайдер | Компонент, предоставляющий функциональность |
| Рамка аватарки | Декоративное обрамление иконки профиля |
| Репозиторий | Компонент для работы с данными сущности |
| Сессия | Авторизованное соединение с сервером |
| Скин | Косметический внешний вид персонажа |
| Софт-лонч | Ограниченный запуск для тестирования |
| Телеметрия | Система сбора событий для аналитики |
| Титул | Текстовая подпись под именем игрока |
| Эндпоинт | Адрес обработчика запросов на сервере |
| Glicko-2 | Алгоритм расчёта рейтинга с учётом неопределённости |
| initData | Подписанные данные от Telegram для верификации |
| UUID | Универсальный уникальный идентификатор |
