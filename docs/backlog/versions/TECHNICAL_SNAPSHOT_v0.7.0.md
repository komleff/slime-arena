# Slime Arena — Технический слепок v0.7.0

**Дата:** 31 января 2026
**Версия:** 0.7.0-dev
**Назначение:** Контекст для внешнего ИИ при подготовке ТЗ на Sprint 16

---

## 1. Обзор проекта

**Slime Arena** — мобильная PvP-игра с мультиплеером в реальном времени.

| Параметр | Значение |
|----------|----------|
| Жанр | io-game, PvP arena |
| Платформы | Telegram Mini App (P0), Яндекс.Игры (P0), VK/OK (P1) |
| Игроков | 2–30 в матче |
| Длительность матча | 180 секунд (3 минуты) |
| Tick rate | 30 Hz (33.3 мс) |

---

## 2. Технологический стек

### 2.1 Клиент

| Компонент | Технология | Версия |
|-----------|------------|--------|
| Фреймворк | Preact | 10.28.1 |
| Состояние | @preact/signals | 2.0.5 |
| Сборка | Vite | 5.x |
| Рендеринг | Canvas 2D | — |
| Аудио | Howler.js | — |
| Сеть | colyseus.js | 0.15.0 |

### 2.2 Сервер

| Компонент | Технология | Версия |
|-----------|------------|--------|
| Runtime | Node.js | 20.x LTS |
| Язык | TypeScript | 5.x |
| Мультиплеер | Colyseus | 0.15.0 |
| HTTP API | Express | — |
| ORM | Prisma | — |
| База данных | PostgreSQL | 15+ |
| Кеш | Redis | опционально |

### 2.3 Инфраструктура

| Компонент | Технология |
|-----------|------------|
| Контейнеризация | Docker / Docker Compose |
| CI/CD | GitHub Actions |
| Мониторинг | Планируется |

---

## 3. Архитектура

### 3.1 Модель данных

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENT                                   │
│  Preact + Canvas 2D + Signals                                   │
│  InputManager → SmoothingSystem → Renderer                      │
└─────────────────────┬───────────────────────────────────────────┘
                      │ WebSocket (Colyseus Schema)
┌─────────────────────┴───────────────────────────────────────────┐
│                      MatchServer                                 │
│  Colyseus Room (30 tick/s)                                      │
│  ArenaRoom → Systems (Combat, Ability, Physics...)              │
└─────────────────────┬───────────────────────────────────────────┘
                      │ HTTP API
┌─────────────────────┴───────────────────────────────────────────┐
│                      MetaServer + DB                             │
│  Express + Prisma + PostgreSQL                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Принципы

1. **Authoritative Server** — сервер единственный источник истины
2. **Fixed Timestep** — симуляция 30 Hz для детерминизма
3. **U2-style Smoothing** — клиентская интерполяция с предсказанием

### 3.3 Порядок систем в тике

| # | Система | Назначение |
|---|---------|------------|
| 1 | CollectInputs | Сбор команд игроков |
| 2 | ApplyInputs | Валидация ввода |
| 3 | AbilitySystem | Умения, GCD, очередь |
| 4 | FlightAssistSystem | Силы по джойстику |
| 5 | PhysicsSystem | Интеграция движения |
| 6 | CollisionSystem | Столкновения |
| 7 | ZoneSystem | Эффекты зон |
| 8 | CombatSystem | Урон, i-frames |
| 9 | PickupSystem | Сбор пузырей |
| 10 | ChestSystem | Сундуки |
| 11 | BoostSystem | Усиления |
| 12 | TalentSystem | Карточки талантов |
| 13 | DeathSystem | Гибель, респаун |
| 14 | SafeZoneSystem | Безопасные зоны |
| 15 | KingSystem | Назначение Короля |
| 16 | SnapshotSystem | Рассылка состояния |

---

## 4. Игровые механики

### 4.1 Базовые параметры

| Параметр | Значение | Источник |
|----------|----------|----------|
| Стартовая масса | 100 кг | `balance.json` |
| Минимальная масса (смерть) | 50 кг | `balance.json` |
| Базовый радиус | 10 м | `balance.json` |
| GCD | 100 мс (3 тика) | `balance.json` |
| Респаун | 2 сек | `balance.json` |
| Респаун-щит | 5 сек | `balance.json` |

### 4.2 Фазы матча

| Фаза | Время | Описание |
|------|-------|----------|
| Growth | 0–60 сек | Сбор массы, пузыри |
| Hunt | 60–120 сек | Активный PvP |
| Final | 120–180 сек | Сжатие зоны, финал |

### 4.3 Система боя

**Зоны слайма:**
- Пасть (120° спереди) — стандартный урон
- Боки (60° × 2) — стандартный урон
- Хвост (120° сзади) — ×1.5 урон

**Урон:**
- Укус слайма: атакующий получает 10% от своей массы
- Жертва: теряет 10% массы (разбрасывается в пузыри)
- Неуязвимость после урона: 0.2 сек

### 4.4 Классы

| Класс | Умение | Пассивка |
|-------|--------|----------|
| Hunter | Рывок (Dash) | +30% скорость |
| Warrior | Щит (Shield) | +20% урон |
| Collector | Притяжение (Pull) | +50% сбор |
| Healer | Вампиризм (Vampirism) | +15% восстановление |

### 4.5 Слоты умений

| Слот | Уровень | Что открывается |
|------|---------|-----------------|
| 1 | 1 (100 кг) | Классовое умение (автоматически) |
| 2 | 3 (300 кг) | Выбор из 3 карточек |
| 3 | 5 (800 кг) | Выбор из 3 карточек |

### 4.6 Уровни и пороги массы

| Уровень | Масса (кг) |
|---------|------------|
| 1 | 100 (старт) |
| 2 | 180 |
| 3 | 300 |
| 4 | 500 |
| 5 | 800 |
| 6 | 1200 |
| 7+ | 1800+ |

---

## 5. Структура репозитория

```
slime-arena/
├── client/           # Фронтенд (Preact + Canvas)
│   ├── src/
│   │   ├── main.ts           # Точка входа
│   │   ├── systems/          # Извлечённые системы
│   │   │   ├── SmoothingSystem.ts
│   │   │   ├── VisualEffects.ts
│   │   │   └── GameLoopManager.ts
│   │   └── input/
│   │       └── InputManager.ts
│   └── public/
├── server/           # Бэкенд (Colyseus)
│   ├── src/
│   │   ├── rooms/
│   │   │   └── ArenaRoom.ts  # Игровая логика
│   │   ├── systems/          # Извлечённые системы
│   │   │   ├── combatSystem.ts
│   │   │   ├── abilityActivationSystem.ts
│   │   │   ├── arenaGenerator.ts
│   │   │   └── playerStateManager.ts
│   │   └── utils/
│   │       └── rng.ts        # Детерминированный RNG
│   └── tests/
├── shared/           # Общий код
│   ├── src/
│   │   ├── config.ts         # Парсинг баланса
│   │   ├── formulas.ts       # Игровые формулы
│   │   └── types.ts          # Типы и интерфейсы
├── config/
│   └── balance.json          # Все параметры баланса
├── assets/           # Игровые ресурсы
├── docs/             # Документация
│   ├── gdd/          # Game Design Document (v3.3.2)
│   ├── soft-launch/  # Архитектура Soft Launch (v4.2.5)
│   ├── meta-min/     # ТЗ Meta-геймплея (v1.9)
│   └── agents/       # Документация для ИИ-агентов
├── .memory_bank/     # Контекст проекта
└── .beads/           # Задачи и роли агентов
```

---

## 6. Ключевые файлы

| Файл | Назначение |
|------|------------|
| `server/src/rooms/ArenaRoom.ts` | Игровая логика |
| `client/src/main.ts` | Клиентский код |
| `config/balance.json` | Все параметры баланса |
| `shared/src/config.ts` | Типизация конфига |
| `shared/src/formulas.ts` | Игровые формулы |
| `server/src/utils/rng.ts` | Детерминированный RNG |

---

## 7. Документация

### 7.1 Актуальные версии

| Документ | Версия | Путь |
|----------|--------|------|
| GDD (модульный) | 3.3.2 | `docs/gdd/GDD-*.md` |
| Архитектура Soft Launch | 4.2.5 | `docs/soft-launch/SlimeArena-Architecture-v4.2.5-Part*.md` |
| ТЗ Soft Launch | 1.4.7 | `docs/soft-launch/TZ-SoftLaunch-v1.4.7.md` |
| ТЗ Meta-геймплея | 1.9 | `docs/meta-min/TZ-MetaGameplay-v1.9-*.md` |
| Роли агентов | 1.5 | `.beads/AGENT_ROLES.md` |
| PM Orchestration | 1.0 | `docs/agents/PM-ORCHESTRATION-PLAN.md` |

### 7.2 Memory Bank

| Файл | Содержание |
|------|------------|
| `activeContext.md` | Текущее состояние проекта |
| `techContext.md` | Технический стек |
| `productContext.md` | Продуктовый контекст |
| `systemPatterns.md` | Архитектурные паттерны |
| `progress.md` | История изменений |

---

## 8. Текущее состояние (v0.7.0-dev)

### 8.1 Завершённые спринты

| Спринт | Фокус | Статус |
|--------|-------|--------|
| Sprint 13 | PM Orchestration, GDD Sync | ✅ Завершён |
| Sprint 14 | Gameplay MVP | ✅ Завершён |
| Sprint 15 | Production Readiness | ✅ Завершён |

### 8.2 Что реализовано

- ✅ Полный игровой цикл (Лобби → Матч → Результаты)
- ✅ 4 класса с уникальными умениями
- ✅ Система талантов (3 слота, карточки выбора)
- ✅ Мультиплеер в реальном времени (Colyseus)
- ✅ Детерминированная симуляция
- ✅ Мобильное управление (адаптивный джойстик)
- ✅ Docker-контейнеризация
- ✅ CI/CD (GitHub Actions)
- ✅ PM Orchestration (автоматизация review через оркестратор)
- ✅ U2-style smoothing (предиктивная интерполяция)
- ✅ Система сундуков с armorRings

### 8.3 Экраны

| Экран | Статус |
|-------|--------|
| BootScreen | 🔴 TODO |
| MainScreen | 🟡 Частично |
| LobbyScreen | ✅ Готов |
| BattleScreen | ✅ Готов |
| ResultsScreen | 🟡 Частично |

### 8.4 Что в работе (Sprint 16)

- 🔜 Meta-геймплей (альбом, достижения, прогрессия)
- 🔜 UI улучшения (MainScreen, ResultsScreen)
- 🔜 Soft Launch подготовка

---

## 9. Ограничения и требования

### 9.1 Технические ограничения

1. **Детерминизм** — обязательно использовать `Rng` из `server/src/utils/rng.ts`
2. **Порядок систем** — изменение порядка в `onTick()` ломает симуляцию
3. **Баланс** — все числа в `config/balance.json`, не в коде
4. **Mobile-First** — никаких CSS-градиентов в анимации

### 9.2 Правила для агентов

1. Работать только в своей ветке
2. Пуш в main запрещён — только через PR
3. После изменений: `npm run build && npm run test`
4. Обновлять Memory Bank при значимых изменениях

---

## 10. Команды

```bash
# Разработка
npm run dev:server      # ws://localhost:2567
npm run dev:client      # http://localhost:5173

# Сборка и тесты
npm run build           # shared → server → client
npm run test            # determinism + orb-bite + arena-generation

# Beads (задачи)
bd ready                # Доступные задачи
bd show <id>            # Детали задачи
```

---

## Глоссарий

| Термин | Определение |
|--------|-------------|
| **Authoritative Server** | Сервер — единственный источник истины |
| **GCD** | Global Cooldown — глобальная перезарядка умений |
| **i-frames** | Кадры неуязвимости после получения урона |
| **Memory Bank** | Внешняя память проекта для сохранения контекста |
| **Schema** | Структура данных Colyseus для синхронизации |
| **Seeded RNG** | Генератор случайных чисел с фиксированным началом |
| **tick** | Один шаг симуляции (33.3 мс при 30 Hz) |
| **U2-smoothing** | Система предиктивной интерполяции позиций |
| **PM Orchestration** | Автоматизация review-fix-review цикла через ИИ-агентов |
