# Slime Arena — Game Design Document

**Версия:** 2.5.0  
**Статус:** Camera & Mouse Control Fixes  
**Автор:** Claude Opus, Copilot  
**Дата:** декабрь 2025  
**Платформа:** мобильный браузер (основная), браузер на компьютере  
**Жанр:** казуальная многопользовательская арена  

---

## 0. Краткое резюме

### 0.1. Описание

Slime Arena — короткая (2–3 минуты) браузерная онлайн-арена. Милые слаймы собирают массу, растут и сражаются на навыке позиционирования: пасть наносит урон и «кусает» добычу, хвост уязвим. Прокачка только внутри матча (таланты), мета-прогресс — косметика и рейтинг.

### 0.2. Главный крючок (одна фраза)

«Съешь или будь съеден — но мило и за 2 минуты.»

### 0.3. Столпы проекта

1. **Матч не ставится на паузу.** Любые меню и выборы не лишают игрока контроля.
2. **Управление одним джойстиком.** Одна рука — движение с инерцией и заносом, вторая — умения.
3. **Бой без автоприцела.** Наведение и попадание — результат движения и тайминга.
4. **Против «снежного кома».** Сила растёт, но манёвренность падает по логарифму.
5. **Милота и антифрустрация.** Быстрый респаун, короткий матч, проигрыш не наказывает.

### 0.4. Целевой темп

**Сначала рост, потом стычки.** Первая минута — сбор и рост. Вторая минута — активные столкновения. Финал — интенсивная борьба за Hot Zone.

### 0.5. Баланс навыка и случайности

**Навык важнее.** Случайность влияет на спавн ресурсов и выбор талантов, но победа определяется позиционированием и таймингом.

### 0.6. Изменения версии 2.5.0

**Камера:**
- Следит за сглаженной позицией игрока (плавное движение, без дёрганья)
- Игрок всегда в центре экрана (с учётом clamp к границам мира)

**Управление мышью:**
- Привязано к позиции слайма на экране (не к центру)
- Корректная работа у краёв карты
- Направление вычисляется от слайма к курсору

**Орбы:**
- Честная физика: `radius = baseRadius × √(mass / baseMass / density)`
- Плотности: green=0.2, blue=0.3, red=0.4, gold=0.5 кг/м²
- Spawn: 10 начальных, 15 максимум
- orbBitePctOfMass = 10% (порог для проглатывания)

**Физика:**
- environmentDrag = 1% за тик (единый для всех сущностей)
- orbLinearDamping = 0 (убран как нефизический)

**Управление:**
- turnTorqueNm = 35000 (было 17500)
- angularSpeedLimitDegps = 180 (было 80)
- angularStopTimeS = 0.3 (было 1.0)
- yawRateGain = 4.0 (было 2.0)
- Сундуки отлетают при столкновении, содержат % от массы игрока

**Пузыри:**
- Цвет и масса независимы (цвет — резерв для заданий)
- Добавлена плотность по цветам (золотой — самый плотный)

**Таланты:**
- Автовыбор через 30 сек (а не в конце матча)
- Исправлены некорректные таланты (Сила удара → Силовой приём, и др.)
- Яд разделён на Ядовитый плевок и Ядовитый укус

**Карта:**
- Прямоугольная арена с упругими стенками (отскоки от границ)

**Защита от злоупотреблений:**
- Лидеры не получают защиты при отключении
- Базовый щит 5 сек при респауне для всех

### 0.7. Изменения версии 2.1

**Новые механики (по анализу конкурентов):**
- **Последний вздох** — 0.5 сек на контратаку после смерти
- **Система Мятежник** — награда за убийство лидера
- **Адаптивный джойстик** — привязка под палец
- **Юмористические титулы** в конце матча

**Социальные функции:**
- Кланы и клановые сезоны (после MVP)

**Монетизация:**
- Ежедневный бесплатный сундук за вход

**Карта:**
- Биомы с разными свойствами (после MVP)

**Временные события:**
- Праздничные режимы (Хэллоуин, Новый год и др.)

### 0.8. Изменения версии 2.2

**Коллекционирование:**
- **Энциклопедия слаймов удалена** — заменена на Сезонный альбом
- **Сезонный альбом** — 50 карт за 4 недели, сброс каждый сезон
- **Сундук арены** — новый источник паков за накопленную массу
- **Слайм-клей** — сезонная валюта из дубликатов

**Технические заметки:**
- Добавлено Приложение D с требованиями для архитектуры
- Добавлены серверные сущности для системы паков и pity

### 0.9. Изменения версии 2.3

**Карта:**
- **Тороидальный мир удалён** — выбрана окончательно прямоугольная арена
- **Ghost-объекты удалены** — упрощение механики и восприятия
- **Упругие стенки** — все объекты отскакивают от границ карты
- **Углы карты** — тактически важные точки для опытных игроков

### 0.10. Изменения версии 2.4

**Физика полёта (капитальное обновление):**
- **Ньютоновская модель** — все параметры движения задаются через силы и моменты (не ускорения)
- **Динамическая масса** — масса меняется в процессе игры, физика автоматически адаптируется
- **Момент инерции** — слайм аппроксимируется диском, `I = 0.5 × m × r²`
- **Кривые масштабирования** — тяга растёт как `m^0.5`, момент поворота как `m^1.5`

**Система FlightAssist:**
- Автоматический поворот к целевому курсу
- Компенсация бокового дрейфа
- Мягкое гашение перескорости
- Демпфирование осцилляций при повороте

**Конфигурации:**
- `SlimeConfig` — параметры слайма (тяга, лимиты, боевые характеристики)
- `WorldPhysicsConfig` — параметры мира (сопротивление среды, реституция, форма)
- `ClientNetSmoothingConfig` — клиентское сглаживание

**Масса как здоровье (Mass-as-HP):**
- Масса = здоровье, отдельного HP нет
- Укус отбирает % массы жертвы (PvP bite)
- Смерть при `mass <= minSlimeMass` (50 кг)
- Last Breath: 0.5 сек неуязвимости перед смертью

**Столкновения:**
- Импульсный метод с позиционной коррекцией
- Итерационный решатель (4 итерации по умолчанию)
- Коэффициент реституции из конфига мира

### 0.11. Изменения версии 2.4.1

**Клиентское сглаживание (U2-стиль):**
- **Visual State System** — визуальное состояние отделено от серверного
- **Предиктивная экстраполяция** — `lookAheadMs = 150` компенсирует сетевую задержку
- **Velocity Integration** — движение предсказывается по скорости из снапшота
- **Catch-up коррекция** — визуальная позиция плавно догоняет целевую
- **VELOCITY_WEIGHT = 0.7** — баланс между точностью и плавностью

**Упрощение ClientNetSmoothingConfig:**
- Удалены неиспользуемые параметры: `maxDeviationM`, `catchUpMin/Max`, `maxExtrapolationMs`, `transitionDurationMs`, `angleMaxDeviationRad`
- Остаётся только `lookAheadMs` — все остальные константы захардкожены в клиенте

---

## 1. Концепция

### 1.1. Высокоуровневое описание

Игрок управляет слаймом на арене. На карте — питательные пузыри и сундуки. Собирая пузыри, слайм растёт. Большой слайм сильнее, но хуже поворачивает. Побеждает самый «толстый» к концу матча.

### 1.2. Целевая аудитория

**Основная:** мобильные казуальные игроки 12–35 лет, игра «урывками».  
**Вторичная:** игроки на компьютере, которым нравится соревноваться.

**Сложность управления:** низкий порог входа, высокий потолок мастерства. Новичок может играть без дрифта, опытный — использовать продвинутые техники.

### 1.3. Эмоциональное ядро

Игрок получает удовольствие от движения, отскоков и «кусачего» взаимодействия с пузырями. Проигрыш — не наказание: он краткий и понятный.

---

## 2. Управление и физика

### 2.1. Схема управления

- **Левая рука:** виртуальный джойстик — направление и сила тяги
- **Правая рука:** кнопки умений (по мере открытия) и быстрый выбор талантов

**Обработка касаний вне элементов управления:** игнорируются (не считаются вводом).

### 2.2. Адаптивный джойстик

**Режим привязки (по умолчанию):**
- Джойстик появляется в точке первого касания левой половины экрана
- Центр джойстика «следует» за пальцем, пока не достигнут максимальный радиус
- При отпускании джойстик исчезает
- Палец не заслоняет обзор, так как управление интуитивно

**Фиксированный режим (в настройках):**
- Статичный джойстик в левом нижнем углу
- Для игроков, предпочитающих постоянное положение

**Параметры через config:**

| Параметр | Назначение | Диапазон | По умолчанию |
|----------|------------|----------|--------------|
| `joystickMode` | Режим джойстика | adaptive / fixed | adaptive |
| `joystickRadius` | Радиус зоны | 60–140 px | 100 |
| `joystickDeadzone` | Мёртвая зона | 5–20% | 10% |
| `joystickSensitivity` | Множитель силы тяги | 0.5–2.0 | 1.0 |
| `joystickFollowSpeed` | Скорость следования центра | 0.5–1.0 | 0.8 |

**Настройки одинаковы для мобильных и десктопа.** На десктопе джойстик управляется мышью или WASD (переключается в настройках).

### 2.3. Система координат и единицы

**Единицы измерения:**
- Масса: кг
- Радиус/позиция: м
- Скорость: м/с
- Сила: Н
- Момент (torque): Н·м
- Угол/угловая скорость: рад, рад/с (в конфигах допускаются градусы с конвертацией)

**Система координат мира:**
- Начало координат: центр карты (0, 0)
- Ось X: вправо
- Ось Y: вверх
- Угол `angle = 0` смотрит вдоль +X
- Положительное вращение: против часовой стрелки

**Локальные оси слайма:**
- `forward = (cos(angle), sin(angle))`
- `right = (-sin(angle), cos(angle))`

### 2.4. Модель движения (ньютоновская физика)

Джойстик задаёт желаемое направление. Слайм плавно разворачивается и движется туда. При резких поворотах слайм уходит в занос, потом «подтягивает нос» к направлению движения.

**Принцип:** все параметры движения задаются через силы и моменты. Ускорения вычисляются как производные (`a = F/m`, `α = τ/I`).

**Порядок выполнения систем (серверный тик 30 Гц):**
1. FlightAssistSystem — расчёт управляющих сил и моментов
2. PhysicsSystem — интеграция (Semi-Implicit Euler)
3. CollisionSystem — разрешение столкновений

### 2.5. Конфигурация слайма (SlimeConfig)

**Геометрия:**

| Параметр | Описание | Базовое значение |
|----------|----------|------------------|
| `baseMassKg` | Базовая масса | 100 |
| `baseRadiusM` | Базовый радиус | 10.0 |
| `radiusFromMass` | Формула радиуса | `r = baseRadius × √(m/baseMass)` |

**Тяга:**

| Параметр | Описание | Базовое значение |
|----------|----------|------------------|
| `thrustForwardN` | Тяга вперёд | 9000 Н (90 м/с² при 100 кг) |
| `thrustReverseN` | Тяга назад | 6750 Н (67.5 м/с²) |
| `thrustLateralN` | Боковая тяга | 8500 Н (85 м/с²) |
| `turnTorqueNm` | Момент поворота | 175 Н·м |

**Лимиты скорости:**

| Параметр | Описание | Базовое значение |
|----------|----------|------------------|
| `speedLimitForwardMps` | Макс. скорость вперёд | 260 м/с |
| `speedLimitReverseMps` | Макс. скорость назад | 180 м/с |
| `speedLimitLateralMps` | Макс. боковая скорость | 220 м/с |
| `angularSpeedLimitRadps` | Макс. угловая скорость | 3.14 рад/с (180°/с) |

**Параметры FlightAssist:**

| Параметр | Описание | Базовое значение |
|----------|----------|------------------|
| `comfortableBrakingTimeS` | Время комфортного торможения | 3.5 с |
| `angularStopTimeS` | Время остановки вращения | 0.3 с |
| `autoBrakeMaxThrustFraction` | Макс. доля тяги на автоторможение | 0.6 |
| `overspeedDampingRate` | Доля превышения, снимаемая за тик | 0.2 |
| `yawFullDeflectionAngleRad` | Угол полного отклонения джойстика | π/2 |
| `yawRateGain` | Усиление команды поворота | 4.0 |

**Боевые параметры:**

| Параметр | Описание | Базовое значение |
|----------|----------|------------------|
| `biteDamagePctOfMass` | Урон укуса (% от массы) | 2% |
| `orbBitePctOfMass` | Откусывание пузыря (% от массы слайма) | 10% |

### 2.6. Прогрессия параметров от массы

**Радиус (обязательное правило):**
```
radius(m) = baseRadiusM × √(m / baseMassKg)
```

**Момент инерции (диск):**
```
I(m) = 0.5 × m × radius(m)²
```

**Типы кривых масштабирования:**

*Power:* `value(m) = baseValue × (m/baseMass)^exp`

*Log:* `value(m) = baseValue × (1 + k × ln(m/baseMass))`

**Масштабирование по умолчанию:**

| Параметр | Тип кривой | Экспонента |
|----------|------------|------------|
| Тяга (все направления) | Power | 0.5 |
| Момент поворота | Power | 1.5 |
| Лимиты скорости | Константа или Power | 0 до -0.1 |

**Результат:** при увеличении массы в 10 раз линейное ускорение падает в ~3.2 раза, угловое — в ~10 раз.

### 2.7. Конфигурация мира (WorldPhysicsConfig)

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `environmentDrag` | Сопротивление среды (% на тик) | 1% |
| `restitution` | Коэффициент реституции | 0.9 |
| `maxPositionCorrectionM` | Макс. коррекция позиции за тик | 0.5 м |
| `worldShape` | Форма мира | rectangle |
| `widthM` / `heightM` | Размеры прямоугольника | по карте |

**Сопротивление среды:** единое для всех объектов. Скорость умножается на `(1 - environmentDrag)` каждый тик. Через 1 сек (30 тиков) остаётся ~74% скорости.

**Отдельного затухания для орбов нет** — это было бы нефизично.

### 2.7.1. Камера

**Режим:** игрок всегда в центре экрана (стиль Agar.io).

| Параметр | Описание | Значение |
|----------|----------|----------|
| `desiredView` | Видимая область | 400×400 м |
| Центрирование | Мгновенное | да |
| Интерполяция | Нет | — |

**Обоснование:** при мгновенном центрировании управление мышью интуитивно — курсор всегда указывает направление относительно игрока.

### 2.8. Система FlightAssist

**Назначение:** воспроизвести ощущения управления из U2 (FA:Mobile) для 2D круглых слаймов с ньютоновской физикой.

**Компоненты:**

1. **Поворот к целевому курсу:**
   - Целевой курс определяется направлением джойстика
   - Момент пропорционален ошибке курса (с ограничением)
   - Демпфирование угловой скорости для предотвращения осцилляций

2. **Компенсация бокового дрейфа:**
   - При отклонении джойстика применяется боковая тяга
   - Гасит накопленную боковую скорость

3. **Продольная тяга:**
   - Тяга вперёд/назад по проекции джойстика на направление слайма
   - При отсутствии ввода — автоматическое торможение

4. **Мягкое гашение перескорости:**
   - Если скорость выше лимита (после столкновения) — плавное снижение
   - Каждый тик снимается `overspeedDampingRate` от превышения
   - Запрещены резкие клэмпы скорости

### 2.9. Система физики (PhysicsSystem)

**Интегратор: Semi-Implicit Euler**

На каждом тике (dt = 1/30):
1. `a = F_total / m`
2. `vel = vel + a × dt`
3. `pos = pos + vel × dt`
4. `α = τ_total / I`
5. `angVel = angVel + α × dt`
6. `angle = angle + angVel × dt`

**Изменение массы во время движения:**
- При изменении массы скорость и угловая скорость сохраняются
- Ускорения автоматически меняются через формулы `a = F/m`, `α = τ/I`

### 2.10. Система столкновений (CollisionSystem)

**Принцип:** импульсный метод + позиционная коррекция проникновения.

**Круг-круг (слайм-слайм, слайм-пузырь):**

1. Проверка пересечения: `dist < rA + rB`
2. Вычисление нормали: `n = (pB - pA) / dist`
3. Позиционная коррекция:
   - `penetration = rSum - dist`
   - `corrMag = max(penetration - slop, 0) / (invMassA + invMassB) × 0.8`
   - `corrMag = min(corrMag, maxPositionCorrectionM)`
4. Импульс:
   - `velAlongNormal = dot(vB - vA, n)`
   - Если `velAlongNormal > 0` — тела расходятся, импульс не применять
   - `j = -(1 + restitution) × velAlongNormal / (invMassA + invMassB)`
   - `vA = vA - n × j × invMassA`
   - `vB = vB + n × j × invMassB`

**Круг-граница (прямоугольник):**
- Если позиция ± радиус выходит за границу — коррекция позиции и отражение скорости с реституцией

**Итерационный решатель:**
- По умолчанию 4 итерации на тик
- На каждой итерации обрабатываются все пары пересечений

### 2.11. Mass-as-HP (масса как здоровье)

**Принцип:** HP удалён из схемы, масса = здоровье.

**PvP Bite (укус слайма):**
- Жертва теряет 20% массы (`pvpBiteVictimLossPct`)
- Потерянная масса распределяется: 50% атакующему, 50% в scatter orbs
- Орбы: 3 шт, скорость 60 м/с, разлёт веером

**Инвариант массы:** `massLoss = attackerGain + scatterMass` — масса не создаётся и не уничтожается.

**Last Breath:**
- Активируется при `mass <= minSlimeMass` (50 кг)
- Длительность: 0.5 сек неуязвимости
- Награды масштабируются пропорционально фактической потере массы
- После истечения — смерть

**Смерть:**
- Часть массы теряется, часть превращается в орбы
- Респавн через 2 сек с начальной массой

### 2.12. Обратная связь

| Событие | Визуал | Звук | Вибрация |
|---------|--------|------|----------|
| Ускорение | Тело вытягивается | — | — |
| Торможение | Тело сплющивается | — | — |
| Столкновение | Упругий отскок, волна | «Бам» | Короткая |
| Укус пузыря | Уменьшение пузыря | «Чавк» | Короткая |
| Полное поглощение | Исчезновение + частицы | «Поп» | Средняя |
| Получение урона | Красная вспышка | «Ой» | Длинная |
| Перк готов | Свечение индикатора | «Динь» | Короткая |
| Последний вздох | Мигание слайма | «Эхо» | Пульсация |

### 2.13. Крайние случаи физики

| Ситуация | Поведение |
|----------|-----------|
| Столкновение 3+ объектов | Обрабатываются попарно в порядке обнаружения |
| Объект застрял | Принудительное раздвижение на следующем тике |
| Скорость выше максимума | Постепенное гашение: каждый тик −20% от превышения |
| Масса слайма < 10 | Невозможно (минимум при респауне = 50) |
| Масса слайма > 1 000 000 | Формулы работают, тесты обязательны |

### 2.14. Настройки чувствительности

| Настройка | Описание | Диапазон |
|-----------|----------|----------|
| Чувствительность джойстика | Множитель силы тяги | 0.5–2.0 |
| Размер джойстика | Радиус в пикселях | 60–140 |
| Мёртвая зона | Процент от радиуса | 5–20% |

### 2.15. Клиентское сглаживание

**Параметры (ClientNetSmoothingConfig):**

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `lookAheadMs` | Опережение прогноза | 100 мс |
| `maxDeviationM` | Макс. отклонение до коррекции | 2.0 м |
| `catchUpMin` / `catchUpMax` | Диапазон коэффициентов догоняния | 0.9 / 1.2 |
| `maxExtrapolationMs` | Макс. время экстраполяции без снапшотов | 250 мс |
| `transitionDurationMs` | Время перехода при потере связи | 200 мс |
| `angleMaxDeviationRad` | Макс. отклонение угла | 0.35 рад (~20°) |

**Алгоритм:**
1. Берём последний снапшот S
2. Целевая позиция = `S.pos + S.vel × ((t + lookAhead) / 1000)`
3. Движение к цели по кубической кривой Эрмита
4. При большом отклонении — ускоренное догоняние
5. При пропуске снапшотов — экстраполяция, затем затухание

---

## 3. Слайм, бой и добыча

### 3.1. Зоны слайма

| Зона | Угол | Свойства |
|------|------|----------|
| Пасть | 120° (±60° от heading) | Наносит урон, кусает пузыри |
| Хвост | 120° (±60° от противоположного heading) | Получает ×1.5 урона |
| Бока | 2×60° | Нейтральные |

**Границы зон:** чёткие, без плавных переходов. При касании точно на границе — приоритет у зоны с большим уроном для атакующего.

### 3.2. Ближний бой

**Общий принцип:** при любом столкновении слаймов отрабатывается:
1. Проверка на возможный укус (контакт пастью)
2. Расчёт урона (если укус)
3. Отскок обоих слаймов по закону сохранения импульса с учётом `restitution`

| Ситуация | Результат |
|----------|-----------|
| Пасть → хвост | Полный урон + бонус ×1.5 по хвосту + отскок |
| Пасть → пасть | Оба получают урон + взаимный отскок |
| Пасть → бок | Обычный урон + отскок |
| Бок → бок | Только отскок, без урона |
| Хвост → хвост | Только отскок, без урона |

**Отскок:** всегда по закону сохранения импульса. Лёгкий слайм отлетает сильнее, тяжёлый — слабее. Никакого особого «продавливания» — физика честная.

**Неуязвимость после урона:** 0.2 сек (6 тиков). Предотвращает мгновенную смерть от серии попаданий.

**Дружественный огонь в командных режимах:** отключён. Союзники проходят сквозь друг друга.

### 3.3. Механика «Последний вздох»

При смерти слайм получает краткий шанс на контратаку:

| Параметр | Значение | Через config |
|----------|----------|--------------|
| Длительность | 0.5 сек | `lastBreathDuration` |
| Доступные действия | Только атака пастью | — |
| Урон | 50% от обычного | `lastBreathDamageMultiplier` |
| Скорость | 80% от обычной | `lastBreathSpeedMultiplier` |
| Визуал | Слайм мигает, полупрозрачный | — |
| Активация | Автоматическая при смерти от врага | — |

**Правила:**
- Если слайм успевает укусить врага — наносит урон
- Успешный укус даёт +10% к массе пузырей, выпадающих при смерти
- Убийца не получает дополнительного урона, если добьёт слайма в этой фазе
- Не работает при смерти от голода, отключения или окружения
- Слайм в фазе «Последний вздох» неуязвим

**Визуализация:**
- Слайм становится полупрозрачным (50% opacity)
- Быстрое мигание (5 Гц)
- Эффект «распадающихся частиц» вокруг
- Звуковой эффект «эхо»

**Цель:** снизить фрустрацию, дать шанс «отомстить», добавить драматизма финальным моментам боя.

### 3.4. Дальний бой

Направление выстрела совпадает с heading. Попадание — результат правильного наведения, без автоприцела.

**Можно ли активировать умение во время дрифта:** да.  
**Можно ли активировать умение во время отталкивания:** да.  
**Глобальный кулдаун между разными умениями:** да, 100 мс (см. раздел 4.3).

### 3.5. Питательные пузыри

#### 3.5.1. Типы пузырей

**Честная физика:** радиус орба вычисляется по формуле:
```
radius = baseRadius × √(mass / baseMass / density)
```
где `density` — плотность относительно слайма (1.0 = такая же плотность как у слайма).

**Типы орбов:**

| Тип | density | Масса | Частота | Радиус (при мин-макс массе) |
|-----|---------|-------|---------|----------------------------|
| Зелёный | 0.2 | 10–50 кг | 45% | 7–16 м |
| Синий | 0.3 | 30–150 кг | 30% | 10–22 м |
| Красный | 0.4 | 80–400 кг | 20% | 14–32 м |
| Золотой | 0.5 | 200–1000 кг | 5% | 20–45 м |

**density < 1** означает, что орб легче слайма при той же массе → крупнее и легче толкать.

**Количество орбов на карте:**
- Начальное: 10
- Максимум: 15
- Интервал респавна: 0.5 сек

#### 3.5.2. Поведение пузырей

| Свойство | Значение |
|----------|----------|
| Движение | По инерции от столкновений |
| Самостоятельное движение | Нет (только от физики) |
| Столкновения между пузырями | Да, обмениваются импульсом |
| Вращение | Нет (только линейное движение) |
| Плотность | Зависит от типа (см. таблицу) |

#### 3.5.3. Спавн пузырей

| Параметр | Значение |
|----------|----------|
| Начальное количество | 10 на карту |
| Максимум на карте | 15 |
| Интервал респавна | 0.5 сек (если < максимума) |
| Распределение | Равномерное, исключая Hot Zones в финале |

#### 3.5.4. Механика укуса

**Событие укуса:** контакт пасти с пузырём. Отдельной кнопки нет.

**Кулдаун укуса:** 0.1 сек (3 тика). Нельзя «пулемётить» пузыри.

**Правило поглощения:**
- Если `orbMass <= orbBitePctOfMass × playerMass` → полное поглощение
- Иначе → откусывание `orbBitePctOfMass × playerMass` от орба

**Откусывание (orbBitePctOfMass = 10%):**
- Слайм получает: `playerMass × 0.10` массы от орба
- Остаток пузыря уменьшается на ту же величину

**Можно ли «добить» остаток сразу:** да, после кулдауна укуса (0.1 сек).

**Критический укус:** нет. Поглощение детерминировано.

#### 3.5.5. Минимальный размер пузыря

| Параметр | Значение |
|----------|----------|
| `orbMinMass` | 3 |
| `orbMinRadius` | 5 пикселей |

Если после укуса `остаток < orbMinMass` → полное поглощение (остаток не создаётся).

#### 3.5.6. Физика при укусе

При контакте слайма с пузырём происходит **взаимный отскок** по закону сохранения импульса:

**Пузырь:**
- Направление: от центра слайма к центру пузыря
- Величина: зависит от массы слайма и скорости столкновения
- Ограничение: `collisionImpulseCap`

**Слайм:**
- Тоже получает импульс отталкивания
- Если слайм маленький, а пузырь большой — слайм отлетит сильнее
- Импульс сохраняется относительно исходного движения (векторное сложение)

**Пример:** слайм массой 100 врезается в золотой пузырь массой 80 с высокой плотностью — оба отлетают примерно одинаково.

#### 3.5.7. Визуализация взаимодействия с пузырём

| Событие | Описание | Визуал | Звук |
|---------|----------|--------|------|
| Полное поглощение | Пасть + пузырь по силам | Исчезновение + частицы | «Поп» |
| Частичный укус | Пасть + пузырь больше лимита | Уменьшение + отлёт | «Чавк» |
| Столкновение без укуса | Бок/хвост + пузырь | Оба отлетают | «Буп» (ниже тоном) |

---

## 4. Умения

### 4.1. Ячейки умений

| Ячейка | Открытие | Описание |
|--------|----------|----------|
| `slot1` | Сразу | Классовое умение |
| `slot2` | Уровень 3 | Выбор 1 из 2 |
| `slot3` | Уровень 5 | Выбор 1 из 2 |

### 4.2. Набор умений

| Умение | Назначение | Стоимость | Восстановление | MVP |
|--------|------------|-----------|----------------|-----|
| Рывок | Догнать/уйти | 3% | 5 сек | Да |
| Выброс | Дальняя атака | 2% | 3 сек | Да |
| Щит | Пережить разворот | 4% | 8 сек | Да |
| Притяжение | Облегчить сбор | 1.5% | 6 сек | Да |
| Приманка | Сбить преследование | 2% | 4 сек | Нет |
| Деление | Временный двойник | 25% | 15 сек | Нет |
| Шип | Конусная атака | 2.5% | 4 сек | Нет |

**Умения для MVP:** Рывок, Выброс, Щит, Притяжение.

### 4.3. Детали умений

**Глобальный кулдаун (GCD):** 100 мс (3 тика) между любыми умениями. Предотвращает спам из трёх умений одновременно.

**Очередь нажатий:** если игрок нажал умение во время GCD, оно ставится в очередь и активируется автоматически после окончания GCD. Максимум 1 умение в очереди.

**Отмена умения:** нет. Все умения мгновенные.

**Стоимость:** только `massPercent`. Отдельного ресурса нет.

**Рывок:**
- Дистанция: 150 единиц
- Длительность: 0.2 сек
- Во время рывка можно есть пузыри
- Столкновение с врагом наносит урон и прерывает рывок

**Выброс:**
- Дальность: 300 единиц
- Скорость снаряда: 400 единиц/сек
- Урон: 100% от базового урона слайма
- Снаряд проходит сквозь пузыри, но не сквозь слаймов

**Щит:**
- Длительность: 2 сек
- Поглощает весь входящий урон
- Можно есть пузыри под щитом
- Атака снимает щит досрочно

**Притяжение:**
- Радиус: 150 единиц
- Длительность: 1.5 сек
- Притягивает только пузыри, не слаймов
- Сила притяжения: 50 единиц/сек к центру слайма

**Двойник (Деление):**
- Цель: ближайший враг в радиусе 200 единиц
- Если врагов нет: двойник следует за игроком
- HP двойника: 50% от HP хозяина
- Живёт до смерти или 10 сек (что раньше)
- Наносит 50% урона владельца
- Масса двойника: 25% от массы владельца (расходуется при активации)

### 4.4. Будущее развитие (после MVP)

**Четвёртое умение — Ульта:**
- Открывается на уровне 7
- Требует энергии ульты (копится от урона/убийств)
- Мощный эффект с длинным кулдауном (30 сек)
- Примеры: Взрывная волна, Временная неуязвимость, Массовое притяжение

### 4.5. Взаимодействия умений

| Комбинация | Поведение |
|------------|-----------|
| Щит + Дрифт | Работают независимо |
| Щит + Укус пузыря | Можно есть под щитом |
| Рывок + Укус | Можно есть во время рывка |
| Рывок + Столкновение | Урон наносится, рывок прерывается |
| Притяжение + Рывок | Можно комбинировать |
| Выброс + Дрифт | Выстрел в направлении до дрифта |

---

## 5. Классы

### 5.1. Базовые характеристики

| Класс | Пассив | Стартовое умение | Роль | Сложность |
|-------|--------|------------------|------|-----------|
| Охотник | +15% скорость, −10% HP | Рывок | Мобильная агрессия | Средняя |
| Воин | +15% HP, +10% урон по слаймам, −10% скорость | Щит | Танк-боец | Новичок |
| Собиратель | +25% радиус сбора, +15% eatingPower | Притяжение | Фарм и поддержка | Новичок |

**Количество классов на запуск:** 3.

**Смена класса после начала матча:** нет.

**Уникальные умения:** только стартовое. Остальные умения общие для всех классов.

### 5.2. Различия классов

**Охотник:**
- Быстрый, но хрупкий
- Лучше в погонях и побегах
- Хуже в лобовых столкновениях
- Рывок позволяет быстро сокращать дистанцию
- Оптимален для охоты на Мятежника

**Воин:**
- Толстый и бьёт сильно
- Медленнее, но опаснее в бою
- Щит позволяет выживать в замесах
- Больше откусывает от противников (урон = масса)
- Часто становится Мятежником из-за высокой живучести

**Собиратель:**
- Лучший фармер
- Быстрее растёт по массе
- Слабее в прямом бою
- Притяжение эффективно в зонах с высокой плотностью пузырей

### 5.3. Пожирательная способность

| Класс | swallowLimit | Бонус/уровень | biteFraction |
|-------|--------------|---------------|--------------|
| Охотник | 50 | +5% | 0.3 |
| Воин | 45 | +4% | 0.35 |
| Собиратель | 70 | +8% | 0.5 |

### 5.4. Могут ли классы менять роль перками

**Да, частично.** Охотник может взять перки на выживание. Собиратель может взять перки на урон. Но базовые пассивы остаются.

---

## 6. Прогресс внутри матча

### 6.1. Масса и уровни

| Масса | Уровень | Что открывается |
|-------|---------|-----------------|
| 0–100 | 1 | Старт, `slot1` |
| 100–250 | 2 | 1 талант |
| 250–500 | 3 | `slot2` |
| 500–1000 | 4 | 2 талант |
| 1000–2000 | 5 | `slot3` |
| 2000+ | 6+ | Талант при удвоении |

**Минимальная масса:** 50 (при респауне).  
**Максимальная масса:** не ограничена (формулы работают).

### 6.2. Источники и потери массы

**Источники:**
- Питательные пузыри
- Сундуки (процент от текущей массы, см. раздел 8)
- 10% от нанесённого урона (мгновенно)
- Пузыри от убитого врага (см. ниже)

**При смерти врага:**
- 50% его массы теряется навсегда
- 30% разлетается в виде 3–5 пузырей вокруг места смерти
- 20% остаётся у убитого при респауне (минимум 50)

**Пузыри от смерти:**
- Разлетаются радиально от точки смерти
- Цвет случайный
- Масса распределяется равномерно между пузырями
- Любой игрок может их собрать (включая убийцу и союзников убитого)

**Бонус от «Последний вздох»:**
- Если слайм успешно укусил врага в фазе «Последний вздох» — выпадает 40% массы (вместо 30%)

**Потери:**
- Стоимость умений
- 50% при смерти (30% в пузыри + 20% исчезает)
- Эффект голода вне Hot Zone

### 6.3. Формулы баланса

| Параметр | Формула |
|----------|---------|
| HP | 50 + 50 × ln(1 + mass / 100) |
| Урон | 10 + 10 × ln(1 + mass / 100) |
| Скорость | 1 / (1 + ln(1 + mass / 500)) |
| Радиус | 10 × √(1 + ln(1 + mass / 50)) |
| Поворот | 180° / (1 + ln(1 + mass / 200)) |

### 6.4. Границы параметров

| Параметр | Минимум | Максимум |
|----------|---------|----------|
| Скорость | 10% от базовой | 100% от базовой |
| Поворот | 20°/сек | 180°/сек |
| HP | 50 | Не ограничено |
| Урон | 10 | Не ограничено |

---

## 7. Таланты без паузы

### 7.1. Механика очереди

- При повышении уровня талант добавляется в очередь
- Максимум в очереди: **3**
- **Автовыбор:** если игрок не выбрал талант за 12 сек, автоматически выбирается лучший по приоритету класса (или случайный среди равных)

**Приоритет автовыбора по классам:**
- Охотник: Манёвренность > Урон > остальное
- Воин: Живучесть > Урон > остальное
- Собиратель: Сбор > Живучесть > остальное

### 7.2. Быстрый выбор

**Как открывается:** нажатие на индикатор «+N» возле кнопок умений.

**Время на выбор:** не ограничено (пока игрок в режиме выбора).

**Описания талантов:** краткие (2–3 слова), без развёрнутого текста.

**При бездействии:** режим выбора остаётся активным, пока игрок не выберет или не отменит.

**Конфликт с умениями:** при входе в режим выбора кнопки умений заменяются на таланты. Если игрок хотел нажать умение — он должен сначала отменить выбор (свайп вниз).

### 7.3. Защита от ошибок

- При получении урона режим выбора закрывается автоматически
- Талант остаётся в очереди
- Задержка перед повторным открытием: 0.5 сек

### 7.4. Редкость талантов

| Редкость | Вероятность | Количество в пуле |
|----------|-------------|-------------------|
| Обычный | 60% | 15 |
| Редкий | 30% | 10 |
| Эпический | 10% | 5 |

**Всего талантов в пуле:** 30.

### 7.5. Пул талантов

#### Обычные (15 штук)

| Категория | Талант | Эффект |
|-----------|--------|--------|
| Живучесть | Толстая кожа | +10% HP |
| Живучесть | Регенерация | +1% массы/5 сек |
| Живучесть | Упорство | −10% потерь при смерти |
| Манёвренность | Проворность | +10% скорость |
| Манёвренность | Лёгкость | +10% скорость поворота |
| Манёвренность | Экономия | −20% стоимость рывка |
| Урон | Острые зубы | +15% урон укусом |
| Урон | Силовой приём | Столкновение боком/хвостом наносит 5 урона |
| Урон | Тяжесть | +20% отталкивание врагов |
| Сбор | Магнетизм | +20% радиус притяжения |
| Сбор | Обжора | +10% eatingPower |
| Сбор | Жадность | +20% массы от пузырей |
| Сбор | Предчувствие | Видеть место появления сундука за 5 сек |
| Универсал | Ускорение КД | −10% восстановление умений |
| Универсал | Экономия массы | −10% стоимость умений |

#### Редкие (10 штук)

| Категория | Талант | Эффект |
|-----------|--------|--------|
| Живучесть | Большой щит | +2 сек к щиту при респауне |
| Живучесть | Стойкость | +25% HP |
| Манёвренность | Мастер дрифта | −30% потеря скорости при дрифте |
| Манёвренность | Скользкий | +20% скорость, +15% поворот |
| Урон | Ядовитый плевок | Выброс отравляет на 3 сек (−2% массы/сек) |
| Урон | Ядовитый укус | Укус отравляет на 3 сек (−2% массы/сек) |
| Урон | Пробивание | Выброс проходит сквозь первую цель |
| Сбор | Вакуум | Автосбор пузырей в радиусе 50 |
| Сбор | Большой рот | +30% eatingPower |
| Универсал | Адреналин | +20% скорость при HP < 30% |

#### Эпические (5 штук)

| Категория | Талант | Эффект |
|-----------|--------|--------|
| Живучесть | Бессмертие | Выживание с 1 HP раз в 30 сек |
| Манёвренность | Призрак | 1 сек неуязвимости после рывка |
| Урон | Кровожадность | +50% урона по целям с HP < 30% |
| Сбор | Чревоугодие | Полное поглощение пузырей любого размера |
| Универсал | Мультизадачность | −50% GCD между умениями |

---

## 8. Сундуки

### 8.1. Типы сундуков

| Тип | Содержимое | Частота появления |
|-----|------------|-------------------|
| Обычный | 40% талант / 60% масса | 70% |
| Редкий | Гарантированный талант | 25% |
| Эпический | Эпический талант | 5% |

### 8.2. Награда за открытие

**Масса из сундука:**
- Обычный: 5–10% от текущей массы игрока
- Редкий: 10–15% от текущей массы игрока
- Эпический: 15–20% от текущей массы игрока

**Талант из сундука:**
- Добавляется в очередь как обычный талант уровня
- Если очередь полна (3) — талант теряется (предупреждение игроку)

### 8.3. Спавн сундуков

| Параметр | Значение |
|----------|----------|
| Интервал появления | 15–25 сек |
| Максимум на карте | 3 |
| Места появления | Случайные, но не в Hot Zone |
| Время жизни | До открытия или 30 сек |

### 8.4. Открытие сундука

- Сундук открывается при контакте с пастью
- Сундук **отлетает** при столкновении с боком/хвостом (как пузырь)
- При открытии — визуальный эффект и звук
- Содержимое применяется мгновенно

### 8.5. Индикация

- Обычный: серый контур
- Редкий: синий контур + лёгкое свечение
- Эпический: золотой контур + яркое свечение + частицы

---

## 9. Карта и Hot Zones

### 9.1. Структура карты

**Форма:** прямоугольник с упругими стенками.

**Размер:** настраивается под количество игроков.

| Игроков | Размер карты |
|---------|--------------|
| 2–4 | Малая |
| 5–8 | Средняя |
| 9–16 | Большая |

### 9.2. Границы карты

**Упругие стенки:**
- Все объекты отскакивают от границ
- Коэффициент реституции из `WorldPhysicsConfig`
- Нет «проваливания» за карту

**Углы карты:**
- Тактически важные точки
- Можно зажать противника в угол
- Риск самому оказаться в ловушке

### 9.3. Hot Zones

**Механика:** в финале матча активируется одна или несколько Hot Zones. Вне зон — эффект голода.

| Параметр | Значение |
|----------|----------|
| Время активации | Последние 60 сек матча |
| Количество зон | 1–3 (зависит от размера карты) |
| Размер зоны | Уменьшается со временем |
| Голод вне зоны | −1% массы/сек |

### 9.4. Визуализация Hot Zone

- Яркая граница зоны
- Индикатор направления к ближайшей зоне
- Предупреждение за 10 сек до активации
- Пульсация границы при уменьшении

---

## 10. Система Мятежник

### 10.1. Назначение

Система для предотвращения «снежного кома»: награждает игроков за убийство лидера.

### 10.2. Определение лидера

Лидер — игрок с наибольшей массой. Если несколько игроков имеют одинаковую максимальную массу, лидером считается тот, кто достиг её первым.

### 10.3. Награда за убийство лидера

| Параметр | Значение |
|----------|----------|
| Бонусная масса | +20% от массы убитого лидера |
| Титул | «Мятежник» на 30 сек |
| Визуал | Корона над слаймом |

### 10.4. Ограничения

- Награда только за убийство топ-1 по массе
- Один игрок не может получить награду дважды за 60 сек
- Самоубийство лидера не даёт награды

---

## 11. Режимы игры

### 11.1. MVP: Свободный для всех (FFA)

| Параметр | Значение |
|----------|----------|
| Игроков | 8–16 |
| Длительность | 2–3 мин |
| Цель | Максимальная масса к концу |
| Респаун | Да, с 20% массы (мин. 50) |

### 11.2. Будущие режимы (после MVP)

**Командный (2v2, 4v4):**
- Общий счёт массы команды
- Дружественный огонь отключён
- Возможность делиться пузырями

**Босс-рейд:**
- 4–8 игроков против AI-босса
- Босс с уникальными механиками
- Награды за убийство

**Турнир:**
- Серия матчей с выбыванием
- Ранговые награды

---

## 12. Мета-прогресс

### 12.1. Рейтинговая система

| Лига | Очки | Награда за сезон |
|------|------|------------------|
| Бронза | 0–999 | Базовый скин |
| Серебро | 1000–2499 | Редкий скин |
| Золото | 2500–4999 | Эпический скин |
| Платина | 5000–9999 | Легендарный скин |
| Алмаз | 10000+ | Уникальный титул |

### 12.2. Начисление очков

| Результат | Очки |
|-----------|------|
| Победа (топ-1) | +30 |
| Топ-3 | +15 |
| Топ-5 | +5 |
| Ниже топ-5 | −5 |
| Отключение | −15 |

### 12.3. Косметика

**Типы:**
- Скины слаймов (цвет, текстура, эффекты)
- Эффекты смерти
- Следы движения
- Звуки укуса

**Источники:**
- Рейтинговые награды
- Сезонный альбом
- Магазин (премиум валюта)
- Временные события

---

## 13. Монетизация

### 13.1. Принцип

**Pay-to-customize, не pay-to-win.** Никаких геймплейных преимуществ за деньги.

### 13.2. Источники дохода

| Источник | Описание |
|----------|----------|
| Battle Pass | Сезонный пропуск с косметикой |
| Скины | Прямая покупка премиум скинов |
| Паки альбома | Ускорение сбора коллекции |
| Rewarded Ads | Удвоение награды из ежедневного сундука |

### 13.3. Ежедневный бесплатный сундук

- Доступен раз в 24 часа
- Содержит: валюту, случайный пак альбома
- Rewarded ad удваивает содержимое

---

## 14. Технические требования

### 14.1. Серверная симуляция

| Параметр | Значение |
|----------|----------|
| Тик-рейт | 30 Гц (фиксированный) |
| Авторитетность | Сервер авторитетен |
| Валидация ввода | Все действия проверяются |

### 14.2. Сетевая модель

- Клиентское предсказание с серверной коррекцией
- Интерполяция других игроков
- Компенсация лага для хитов

### 14.3. Клиентские требования

| Платформа | Минимум |
|-----------|---------|
| iOS | Safari 15+ |
| Android | Chrome 90+ |
| Desktop | Chrome/Firefox/Safari последних версий |

---

## Приложение A. Критерии приёмки физики

### A.1. FlightAssist: гашение дрейфа

При отпускании джойстика (mag=0) слайм с базовыми параметрами в мире linearDragK=0.1 снижает скорость до near-zero (|v| < 1 м/с) за время, близкое к `comfortableBrakingTimeS`. Допуск: ±20%.

### A.2. FlightAssist: перескорость

После столкновения, разогнавшего слайма выше `speedLimitForwardMps`, скорость плавно снижается до лимита в течение 1–3 секунд. Запрещены резкие клэмпы скорости (скачок более 20% за тик без физического импульса).

### A.3. FlightAssist: удержание лимита при движении

При удержании джойстика в одном направлении более 2 секунд слайм стабилизируется около `speedLimitForwardMps`. Допуск по превышению: не более 5% (без внешних импульсов).

### A.4. Масса и управляемость

При увеличении массы в 10 раз (100 → 1000 кг) линейные/угловые ускорения уменьшаются согласно заданным кривым (thrust exp=0.5, torque exp=1.5) без «скачков».

### A.5. Коллизии

При одинаковых массах и лобовом столкновении без сопротивления (linearDragK=0) скорости после удара соответствуют импульсному решению с restitution. Проникновение после решения коллизий не превышает slop + 0.01 м.

---

## Приложение B. Референсные значения базового слайма

| Параметр | Значение |
|----------|----------|
| baseMassKg | 100 |
| baseRadiusM | 10.0 |
| thrustForwardN | 9000 |
| thrustReverseN | 6750 |
| thrustLateralN | 8500 |
| turnTorqueNm | 175 |
| speedLimitForwardMps | 260 |
| speedLimitReverseMps | 180 |
| speedLimitLateralMps | 220 |
| angularSpeedLimitDegps | 80 |
| comfortableBrakingTimeS | 3.5 |
| angularStopTimeS | 1.0 |
| autoBrakeMaxThrustFraction | 0.6 |
| overspeedDampingRate | 0.2 |
| yawFullDeflectionAngleDeg | 90 |
| biteDamagePctOfMass | 0.02 |
| orbBitePctOfMass | 0.05 |

---

## Приложение C. Классы слаймов и боссы

Каждый класс и босс — отдельный `SlimeConfig` с собственными параметрами тяги, моментов, лимитов и кривых масштабирования.

---

## Приложение D. Архитектурные требования

### D.1. Серверные сущности

**PlayerAlbumState:**
```
{
  playerId: string,
  seasonId: string,
  collectedCards: string[],
  glueBalance: number,
  pityCounters: {
    newCard: number,
    epic: number,
    legendary: number
  },
  arenaChestProgress: {
    currentMass: number,
    packsClaimedToday: number,
    lastClaimDate: date
  }
}
```

**PackOpenResult:**
```
{
  packType: string,
  cards: [
    {
      cardId: string,
      rarity: string,
      isNew: boolean,
      glueAwarded: number
    }
  ],
  pityTriggered: {
    newCard: boolean,
    epic: boolean,
    legendary: boolean
  }
}
```

### D.2. API-эндпоинты

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/album/state` | Текущее состояние альбома игрока |
| GET | `/album/cards` | Список всех карт сезона с статусом |
| POST | `/album/pack/open` | Открыть пак (body: packType, source) |
| POST | `/album/glue/exchange` | Обменять клей на пак |
| GET | `/album/rewards` | Доступные награды за страницы |
| POST | `/album/rewards/claim` | Забрать награду за страницу |
| POST | `/album/arena-chest/claim` | Забрать пак из сундука арены |

### D.3. Рекомендуемая структура модулей

| Модуль | Путь |
|--------|------|
| SlimePhysicsSystem | `src/server/systems/PhysicsSystem.ts` |
| SlimeFlightAssistSystem | `src/server/systems/FlightAssistSystem.ts` |
| CollisionSystem | `src/server/systems/CollisionSystem.ts` |
| SlimeConfig | `src/shared/config/SlimeConfig.ts` |
| WorldPhysicsConfig | `src/shared/config/WorldConfig.ts` |
| ClientNetSmoothingConfig | `src/client/config/NetSmoothingConfig.ts` |
| SingleJoystickManager | `src/client/input/SingleJoystickManager.ts` |
| InputTranslator | `src/client/input/InputTranslator.ts` |
| SnapshotStore | `src/client/world/SnapshotStore.ts` |
| EntitySmoother | `src/client/world/EntitySmoother.ts` |

---

## История версий

| Версия | Дата | Основные изменения |
|--------|------|-------------------|
| 1.0 | — | Начальная версия |
| 2.0 | — | Физика, классы, механики |
| 2.1 | — | Последний вздох, Мятежник, кланы |
| 2.2 | — | Сезонный альбом, сундук арены |
| 2.3 | — | Прямоугольная арена, упругие стенки |
| 2.4 | декабрь 2025 | Ньютоновская физика полёта, SlimeConfig, WorldPhysicsConfig, FlightAssist, HP=масса |
