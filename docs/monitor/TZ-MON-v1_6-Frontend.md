# ТЗ: Server Monitoring Dashboard — Frontend

**Версия:** 1.6 | **Часть:** Frontend
**Читает:** Coder B (Frontend)
**Зависимости:** Core (API-контракты, правила статусов, цвета)

---

## 1. Технологический стек

| Компонент | Выбор | Обоснование |
|-----------|-------|-------------|
| Framework | Preact 10.x | Консистентность с игровым клиентом |
| State | @preact/signals | Консистентность с игровым клиентом |
| Styling | CSS Modules | Существующий паттерн |
| Charts | uPlot (~30 kB) | Phase 2 |
| Build | Vite → static files | Раздача через Nginx `/admin/` |

Новые зависимости Phase 1: нет (используются существующие).

---

## 2. Хранение токенов на клиенте

| Токен | Хранение | Обоснование |
|-------|----------|-------------|
| Access token (JWT) | Переменная в памяти (signal) | Короткий TTL (15 мин), защита от XSS. Не localStorage, не sessionStorage |
| Refresh token | HttpOnly Secure cookie (устанавливается сервером) | Недоступен из JS, переживает закрытие вкладки |

**Поведение при закрытии вкладки:** access token теряется. При повторном открытии [MUST] вызвать `POST /api/v1/admin/refresh` — cookie отправится автоматически браузером. Если refresh истёк — показать экран Login.

**Поведение при 401 на любом запросе:** попробовать `POST /refresh`. Если 401 на refresh — перенаправить на Login.

---

## 3. Структура экранов

### 3.1 Login

- Поля: username, password.
- Кнопка «Войти».
- Обработка ошибок: 401 → «Неверные данные», 429 → «Слишком много попыток, подождите».
- После успешного входа → Dashboard. Если `totpRequired = true` и 2FA не настроена → перенаправить на Settings.

### 3.2 Dashboard (главная)

- **Карточка статуса:** Online / Degraded / Offline / Unknown с цветом (см. Core 3).
- **Метрики (карточки стеком):** CPU %, RAM %, Rooms, Players, Tick Latency (avgTickMs).
- **Кнопка Restart:** с confirmation dialog.
- **Лента событий:** последние 20 записей, сворачиваемая.
- **Опрос:** каждые 5 сек вызывать `GET /health/detailed` + `GET /stats`.

### 3.3 Rooms

- Список комнат в виде карточек (не таблица — мобильный).
- Каждая карточка: название, игроки/максимум, фаза, tick latency.
- Опрос: каждые 5 сек `GET /rooms`.

### 3.4 Audit

- Список действий карточками с пагинацией.
- Фильтр по пользователю и типу действия.
- Данные из `GET /audit`.

### 3.5 Settings

- Настройка 2FA: кнопка «Настроить» → вызов `/totp/setup` → показать QR-код (рендер `otpauth://` URI) → поле для ввода 6-значного кода → `/totp/verify`.
- Если 2FA уже настроена — показать статус «2FA включена».

### 3.6 Restart dialog

1. Админ нажимает кнопку Restart → появляется модальное окно.
2. Текст: «Перезапустить сервер? Все текущие матчи будут прерваны.»
3. Поле ввода TOTP-кода (6 цифр).
4. Кнопки: «Отмена», «Перезапустить» (красная).
5. При отправке: `POST /restart` с `X-2FA-Code`.
6. Ответ 202 → режим ожидания: таймер + опрос `/health/detailed` каждые 5 сек.
7. Ответ 409 → сообщение: «Перезапуск уже выполняется, подождите».
8. Восстановление: любой успешный ответ `/health/detailed` после периода недоступности (статус может быть Online, Degraded или Unknown — отображать как есть). [MUST] не ждать именно Online.
9. Таймаут 120 сек без восстановления → сообщение «Сервер не ответил в течение 2 минут. Может потребоваться ручное вмешательство.»

---

## 4. Навигация

Нижний tab bar (4 вкладки):
1. **Dashboard** (иконка: grid/gauge)
2. **Rooms** (иконка: users)
3. **Audit** (иконка: list/log)
4. **Settings** (иконка: gear)

---

## 5. Responsive

| Breakpoint | Поведение |
|------------|-----------|
| Mobile (<480px) | Основной. 1 колонка, карточки стеком, нижний tab bar |
| Tablet (480-768px) | 2 колонки карточек |
| Desktop (>768px) | 3 колонки, таблица вместо карточек для Rooms |

Минимальная ширина: 320px. [MUST] все элементы видимы и не обрезаны.

---

## 6. Структура каталога

```
admin-dashboard/
├── index.html
├── vite.config.ts
├── src/
│   ├── main.tsx              — точка входа
│   ├── app.tsx               — корневой компонент, роутинг
│   ├── api/                  — HTTP-клиент, интерцепторы (401 → refresh)
│   ├── auth/                 — signals для токена, login/logout логика
│   ├── pages/
│   │   ├── LoginPage.tsx
│   │   ├── DashboardPage.tsx
│   │   ├── RoomsPage.tsx
│   │   ├── AuditPage.tsx
│   │   └── SettingsPage.tsx
│   ├── components/
│   │   ├── StatusCard.tsx
│   │   ├── MetricCard.tsx
│   │   ├── RestartDialog.tsx
│   │   ├── RoomCard.tsx
│   │   ├── AuditEntry.tsx
│   │   ├── TabBar.tsx
│   │   └── TotpSetup.tsx
│   └── styles/               — CSS Modules
└── dist/                     — результат сборки (статика для Nginx)
```

---

## 7. Критерии приёмки (Frontend)

| ID | Проверка | Результат |
|----|----------|-----------|
| ACC-MON-009 | Dashboard показывает CPU, RAM, Rooms, Players | Обновляется каждые 5 сек |
| ACC-MON-010 | Статус Online/Degraded/Offline/Unknown | Цвет корректен по правилам Core 3 |
| ACC-MON-013 | После Restart сервер восстанавливается | `/health/detailed` отвечает успешно ≤ 60 сек; статус может быть online/degraded/unknown — отображать как есть |
| ACC-MON-015 | Mobile layout (320px) | Все элементы видимы, не обрезаны |
| ACC-FE-001 | Закрытие вкладки → повторное открытие | Refresh работает, login не требуется (если <7 дней) |
| ACC-FE-002 | Истёкший access token при запросе | Автоматический refresh, запрос повторяется |
| ACC-FE-003 | 409 при restart | Сообщение «Перезапуск уже выполняется» |
| ACC-FE-004 | 2FA setup → QR → verify | Полный цикл настройки работает |
