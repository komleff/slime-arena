# Slime Arena — Архитектура

**Версия:** 1.4  
**Автор:** Claude Opus  
**Дата:** декабрь 2025  

Документ описывает техническую архитектуру проекта в соответствии с `SlimeArena-GDD-v2.3.md`.

---

## 0. Изменения версии 1.4

- Обновлена ссылка на GDD: `SlimeArena-GDD-v2.3.md` (арена с бортами закреплена в дизайне).

### Изменения версии 1.3 (исторически)

Обновлено по сравнению с версией 1.2:

- Приведено в соответствие с GDD 2.3: адаптивный/фиксированный джойстик, честная упругая физика (импульс), постепенное гашение превышения скорости, глобальный кулдаун умений 100 мс с очередью.
- Добавлены серверные механики: **«Последний вздох»** (0.5 сек после смерти) и **«Мятежник»** (маркер лидера + награда за убийство).
- Уточнены сущности и физика: сундуки — физические объекты с наградой в % от массы; пузыри имеют цвет (для заданий) и плотность (для физики).
- Расширена «продуктовая» часть: ежедневный бесплатный сундук (MVP) и каркас для **Сезонного альбома** (после MVP) согласно Приложению D (серверные сущности, API, миграции, идемпотентность открытия паков).
- GCD умений фиксируется в **тиках** (при 30 Гц: 3 тика = 100 мс), чтобы избежать «4 тиков» из-за округлений.
- Зоны урона (углы пасти/хвоста/боков) вынесены в **config** + предусмотрены дискретные апгрейды углов.
- Валидация вектора движения использует сравнение **квадратов длины** (без `sqrt`).
- Клиентская синхронизация: **предиктивная интерполяция** и плавные коррекции по **кривым Эрмье**.


---

## 1. Технологический стек

### 1.1. Клиент

| Компонент | Технология |
|-----------|------------|
| Язык | TypeScript |
| Сборка | Vite |
| Рендер (MVP) | Canvas 2D |
| Рендер (позже) | PixiJS |
| Аудио | Howler.js |

### 1.2. Сервер

| Компонент | Технология |
|-----------|------------|
| Среда выполнения | Node.js |
| Язык | TypeScript |
| Сетевой фреймворк | Colyseus |
| HTTP API для мета-систем | Express (в составе Colyseus), либо отдельный Fastify/Express слой |

### 1.3. Данные

| Компонент | Технология |
|-----------|------------|
| База данных | PostgreSQL |
| ORM | Prisma |
| Кеш и очереди | Redis (опционально для MVP; обязателен при горизонтальном масштабировании) |

### 1.4. Инфраструктура

| Компонент | Технология |
|-----------|------------|
| Контейнеризация | Docker / Docker Compose |
| CI/CD | GitHub Actions |

---

## 2. Архитектурные цели

### 2.1. Обязательные требования

- **Сервер — источник правды:** урон, столкновения, рост массы, награды рассчитываются на сервере.
- **Фиксированная симуляция:** 30 тиков в секунду, фиксированный порядок систем.
- **Масштабируемость:** много матчей параллельно, возможность горизонтального масштабирования Colyseus (Presence/Driver).
- **Наблюдаемость:** метрики тика, задержки, размер снапшотов, причины дисконнектов.
- **Расширяемость мета-систем:** сезонные системы (пропуск, альбом, кланы) не должны ломать матчевую симуляцию.

### 2.2. Ограничения и допущения

- Управление: **один джойстик** (adaptive/fixed) + кнопки умений + быстрый выбор талантов (без паузы матча).
- Обработка касаний **вне управляющих областей**: игнорировать (не считать вводом). Управляющие области:
  - левая половина экрана — зона джойстика (в adaptive это «первое касание» задаёт якорь);
  - UI-кнопки умений/талантов/меню.
- Транспорт: WebSocket (Colyseus).
- Геометрия мира: **арена с бортами** (без тора).
- Клиент не отправляет позиции/урон/массу — только намерения (input).

---

## 3. Компоненты системы

### 3.1. Сервер (real-time + meta)

| Модуль | Назначение |
|--------|------------|
| `MatchService` | Поиск/создание матчей, параметры комнат |
| `MatchRoom` | Одна игровая сессия: мир, игроки, таймеры |
| `systems/*` | Системы симуляции: движение, столкновения, боёвка, спавн, правила |
| `abilities/*` | Реализация умений, кулдауны, глобальный GCD, очередь нажатий |
| `meta/api/*` | HTTP API: профиль, валюта, магазин, ежедневный сундук, (позже) альбом/кланы |
| `meta/persistence/*` | Доступ к БД (Prisma), транзакции и идемпотентность |
| `shared-config` | Загрузка и валидация конфигов (баланс/сезоны/экономика) |
| `telemetry/*` | Логи, метрики, бизнес-события |

### 3.2. Клиент

| Модуль | Назначение |
|--------|------------|
| `NetClient` | Подключение к Colyseus, подписка на state |
| `SnapshotBuffer` | Буфер снапшотов, предиктивная интерполяция, сглаживание коррекций |
| `InputHandler` | Адаптивный/фиксированный джойстик, кнопки умений, выбор талантов |
| `Renderer` | Canvas/Pixi отрисовка мира |
| `UI` | Лобби, HUD, результаты, профиль, магазин, ежедневный сундук |
| `Audio/Haptics` | Звук и вибрация по событиям |

### 3.3. Общие данные

| Модуль | Назначение |
|--------|------------|
| `shared/types` | Типы сообщений и состояния |
| `shared/config` | Схема конфигов (Zod/TypeBox), значения по умолчанию |
| `shared/constants` | Сетевые коды, enum, bitmask флагов |

---

## 4. Потоки данных

### 4.1. Подключение к матчу

1. Клиент открывает WebSocket соединение (Colyseus).
2. Клиент входит в комнату (matchmaking/roomId).
3. Сервер присваивает `playerId` и отправляет первичный снапшот.
4. Сервер начинает рассылку состояния (10–30 Гц), симуляция — 30 Гц.

### 4.2. Управление

Клиент каждый тик (30 Гц) формирует команду:

- `seq` — порядковый номер
- `move` — нормализованный вектор джойстика (x,y)
- `abilitySlot` — «нажатие» умения (0/1/2/3) **только на тик нажатия**
- `talentChoice` — выбор таланта (0/1/2/3) **только на тик подтверждения**

Особенности:
- Адаптивный джойстик сам выбирает «якорь» по первому касанию левой половины экрана (см. GDD 2.3, 2.2).
- Сервер **не доверяет** частоте/валидности нажатий: проверяет cooldown, стоимость, GCD, очередь.

### 4.3. Синхронизация состояния

- Сервер рассылает авторитетное состояние.
- Клиент рендерит «в прошлом» (`now - interpolationDelay`) по 3–5 снапшотам.
- Используется предиктивная интерполяция/коррекции (см. раздел 10).

### 4.4. Out-of-band события (не в state)

Для редких «событий-уведомлений» используется broadcast сообщений:
- «Новый Мятежник»
- «Мятежник убит»
- «Последний вздох начался/закончился»
- «Игрок получил титул в конце матча» и т.д.

Это уменьшает размер снапшотов и не требует хранить в state «историю событий».

### 4.5. Meta API (HTTP)

- Лобби/профиль/магазин/ежедневный сундук работают через HTTP API.
- Матчевые награды (капли, рейтинг, статистика) записывает сервер **по окончании матча** транзакционно.

---

## 5. Серверная симуляция

### 5.1. Порядок систем в тике

Внутри каждого тика (~33 мс) сервер выполняет системы в фиксированном порядке:

| Порядок | Система | Назначение |
|---------|---------|------------|
| 1 | `CollectInputs` | Сбор и очередь команд по игрокам |
| 2 | `ApplyInputs` | Применение вектора тяги и edge-нажатий |
| 3 | `AbilitySystem` | Кулдауны, стоимость массы, **GCD 100 мс = 3 тика @30 Гц**, очередь нажатий (max 1) |
| 4 | `MovementSystem` | Интеграция движения, ограничения, дрифт-разворот |
| 5 | `BoundsSystem` | Борты арены: отражение/коррекция позиций, сохранение импульса (без тора) |
| 6 | `CollisionBroadphase` | Поиск потенциальных столкновений |
| 7 | `CollisionNarrowphase` | Точное вычисление контактов (круги) |
| 8 | `CombatSystem` | Урон (пасть/хвост/бока), i-frames, щиты, отскок |
| 9 | `PickupSystem` | Укус пузырей (полный/частичный), притяжение |
| 10 | `ChestSystem` | Физика сундуков, открытие пастью, выдача награды |
| 11 | `DeathSystem` | «Последний вздох», выпадение пузырей, респаун, щит |
| 12 | `HotZoneSystem` | Создание/параметры Hot Zone, множитель спавна |
| 13 | `HungerSystem` | Отъём массы вне зоны (не ниже 50) |
| 14 | `RebelSystem` | Пересчёт статуса «Мятежник» (каждые N тиков) |
| 15 | `MatchRulesSystem` | Таймер, фазы, завершение матча |
| 16 | `SnapshotBuild` | Сбор снапшота для рассылки |

Примечание: конкретное разбиение можно оптимизировать, но **порядок должен быть фиксирован** (детерминизм).

### 5.2. Детерминизм и случайность

- Фиксированный шаг времени.
- Один поток симуляции на матч.
- Случайность (спавн, лут) — через `seed`, фиксируемый на старте матча.
- Любой RNG используется только на сервере.

---

## 6. Физика и сущности

### 6.1. Сущности мира (ECS/Entity)

| Сущность | Описание |
|----------|----------|
| `SlimeEntity` | Игрок (или бот) |
| `OrbEntity` | Питательный пузырь (масса + цвет + физическая плотность) |
| `ProjectileEntity` | Снаряд умения «Выброс» |
| `ChestEntity` | Сундук (бронза/серебро/золото), физический |
| `HotZoneEntity` | Горячая зона (радиус + множитель) |

### 6.2. Ключевые параметры (из config)

Физика (см. GDD 2.3, 2.6):

- `environmentDrag`
- `collisionRestitution` (не зависит от массы)
- `slimeLinearDamping`, `orbLinearDamping`
- `collisionImpulseCap`
- `maxOrbSpeed`, `maxSlimeSpeed`
- `speedDampingRate` — гашение превышения скорости (не «обрубать» мгновенно)

### 6.3. Масса пузыря vs плотность

- `orb.mass` — **питательность** (сколько массы получает слайм).
- `orb.density` — **только физика** (насколько «тяжело» сдвигать пузырь и как он отлетает).
- Эффективная масса в физике: `orb.physicsMass = orb.mass * densityByColor[color]`.

В state достаточно передавать `orb.mass` и `orb.colorId` (плотность восстанавливается по цвету на клиенте).

### 6.4. Упругая реакция столкновений

- Все тела — круги (2D).
- При проникновении: позиционное раздвижение + импульс по закону сохранения импульса.
- Импульс ограничивается `collisionImpulseCap`.
- Дрейф энергии: учитывается через `collisionRestitution` и линейное затухание.

### 6.5. Превышение скорости

Если скорость выше `max*Speed`, она **гасится постепенно**:

- На каждом тике: `v = v - (v - maxV) * speedDampingRate` (по модулю).
- Это даёт «приятный» откат после сильного удара (важно при больших массах).

### 6.6. Арена с бортами

- Сервер хранит координаты в диапазоне `[0..worldSize]` и **не переносит** объекты через край.
- При выходе за границу применяется коррекция:
  - позиция «вталкивается» внутрь на минимальное расстояние,
  - скорость отражается по нормали стены с коэффициентом `wallRestitution` (через config),
  - тангенциальная компонента сохраняется (добавляет тактические «рикошеты»).

---

## 7. Боёвка и ключевые механики

### 7.1. Зоны урона (через config)

Слайм делится на сектора относительно `heading`. Базовые углы и модификаторы задаются в `config`:

- `mouthArcDeg` (база: 120°)
- `tailArcDeg` (база: 120°)
- Бока вычисляются автоматически: `sideArcDeg = (360 - mouthArcDeg - tailArcDeg) / 2`

**Будущие перки на изменение углов (дискретные):**
- Пасть: +10° за уровень, до 3 уровней (`mouthArcUpgradeStepDeg=10`, `mouthArcUpgradeMaxLevel=3`)
- Хвост: −10° за уровень, до 3 уровней (`tailArcUpgradeStepDeg=10`, `tailArcUpgradeMaxLevel=3`)

Эффективные углы:
- `mouthArcDegEff = mouthArcDeg + mouthArcUpgradeLevel * mouthArcUpgradeStepDeg`
- `tailArcDegEff = max(tailArcDegMin, tailArcDeg - tailArcUpgradeLevel * tailArcUpgradeStepDeg)`
- Бока пересчитываются из остатка, с клипом до неотрицательных значений.

Правило при границе: приоритет у зоны с большим уроном для атакующего.

**Крит/множители:**
- Попадание пастью в хвост применяет `tailDamageMultiplier` (база: ×1.5). Опционально можно помечать такое попадание как `isCrit=true` для VFX/телеметрии (через config `tailCountsAsCrit`).

### 7.2. Урон и отскок

- Урон рассчитывается сервером.
- Хвост получает множитель `tailDamageMultiplier = 1.5`.
- После любого столкновения: честный отскок по импульсу с учётом `collisionRestitution`.
- После получения урона: i-frames `damageInvuln = 0.2 сек` (6 тиков).

### 7.3. Респаун-щит

- Базовый щит при респауне: `respawnShield = 5 сек`.
- Любая атака под щитом снимает щит досрочно.
- Щит — состояние (флаг + таймер) в `SlimeEntity`.

### 7.4. «Последний вздох» (Last Breath)

Модель состояния:

- При смертельном уроне от врага: вместо мгновенного удаления — переход в `LastBreath` на `0.5 сек`.
- В `LastBreath`:
  - слайм **неуязвим**;
  - скорость множится на `0.8`;
  - урон пастью множится на `0.5`;
  - доступны только действия «движение + укус пастью».
- По окончании таймера: финализация смерти (выпадение пузырей, респаун по таймеру 2 сек).

Важно: не активировать при смерти от голода, дисконнекта или других небоевых причин.

### 7.5. «Мятежник» (Rebel)

- Каждые `rebelUpdateInterval = 5 сек` сервер пересчитывает статус.
- Условие: масса лидера > `rebelMassThreshold` × средняя масса.
- В state хранится `rebelId`, а у самого слайма — флаг `IS_REBEL`.
- При убийстве Мятежника:
  - бонус к награде за убийство (mass bonus) и бафф скорости убийце на `10 сек`;
  - на смерти Мятежника увеличивается доля массы, выпадающая в пузыри (`40%` вместо `30%`).

---

## 8. Правила матча

### 8.1. Состояния комнаты

| Состояние | Описание |
|-----------|----------|
| `Lobby` | Ожидание игроков |
| `Running` | Матч идёт |
| `Results` | Экран результатов + начисление наград |

### 8.2. Фазы матча (2–3 минуты)

Фазы как в GDD 9.4:

| Фаза | Время | Особенности |
|------|-------|-------------|
| `Spawn` | 0:00–0:15 | Щит 5 сек, безопасный старт |
| `Collect` | 0:15–1:00 | Много пузырей |
| `Hunt` | 1:00–1:30 | PvP активнее |
| `Chaos` | 1:30–2:00 | Hot Zones, голод |
| `Final` | 2:00–2:30 | 1 большая Hot Zone, сильный голод |

### 8.3. Hot Zones и голод

- Hot Zones создаются сервером по фазам:
  - `Chaos`: 2 зоны, ×3 спавн
  - `Final`: 1 зона в центре, ×5 спавн
- Голод отнимает **массу** вне Hot Zone, но не снижает ниже 50.
- Параметры через config: `hungerBaseDrain`, `hungerScaling`, `hungerMaxDrain`, `hungerStartTime`.

### 8.4. Сундуки

- До 3 сундуков на карте, спавн раз в 20 сек.
- Сундук — физический объект (имеет скорость и участвует в столкновениях).
- Открытие: касание пастью (мгновенно).
- Награда:
  - масса в % от текущей массы (10/20/30) ИЛИ талант (30% шанс),
  - тип сундука определяет качество награды.

---

## 9. Сетевой протокол (Colyseus Schema + сообщения)

### 9.1. Принципы

- Клиент отправляет **команды**, а не состояние.
- Команды валидируются по диапазонам, частоте и контексту (cooldown/GCD).
- State — минимальный для всех; персональные данные (например, собственные кулдауны) можно слать отдельными сообщениями.

### 9.2. Команда игрока (пример)

| Поле | Тип | Описание |
|------|-----|----------|
| `seq` | uint16 | Порядковый номер |
| `moveX` | float32 | Ось X, [-1..+1] |
| `moveY` | float32 | Ось Y, [-1..+1] |
| `abilitySlot` | uint8 | 0/1/2/3 — нажатие в этом тике |
| `talentChoice` | uint8 | 0/1/2/3 — подтверждение выбора |

Рекомендация: трактовать `abilitySlot` как edge-triggered (в UI кнопка даёт событие «tap», а не «hold»).

### 9.3. Валидация команд

| Проверка | Действие |
|----------|----------|
| `moveX*moveX + moveY*moveY > 1.01^2` | Отклонить/нормализовать, залогировать (без `sqrt`) |
| `abilitySlot` вне {0,1,2,3} | Отклонить |
| Частота сообщений > лимита | Отклонить/диск |
| `seq` слишком старый | Игнорировать |

### 9.4. Состояние матча (root)

Минимальный набор:

| Поле | Тип | Описание |
|------|-----|----------|
| `phase` | uint8 | Фаза матча |
| `timeRemaining` | float32 | Оставшееся время |
| `rebelId` | string | ID мятежника (или пусто) |
| `slimes` | MapSchema | Все слаймы |
| `orbs` | MapSchema | Все пузыри |
| `chests` | MapSchema | Все сундуки |
| `hotZones` | ArraySchema | Hot Zones |
| `leaderboard` | ArraySchema | Топ-5 id |

### 9.5. Состояние слайма

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | string | Уникальный id |
| `pos` | Vector2 | Позиция |
| `vel` | Vector2 | Скорость |
| `heading` | float32 | Направление |
| `mass` | float32 | Масса |
| `hp` | float32 | HP |
| `level` | uint8 | Уровень |
| `classId` | uint8 | Класс |
| `flags` | uint32 | Бит-поле статусов и «лёгких» баффов/апгрейдов |

Рекомендуемая раскладка `flags` (можно расширять):

- `bit 0` — `RESPAWN_SHIELD`
- `bit 1` — `ABILITY_SHIELD`
- `bit 2` — `LAST_BREATH_ACTIVE`
- `bit 3` — `IS_REBEL`
- `bit 4` — `IS_DEAD` (для клиентских эффектов)
- `bits 8..9` — `MOUTH_ARC_UPGRADE_LVL` (0–3)
- `bits 10..11` — `TAIL_ARC_UPGRADE_LVL` (0–3)
- `bits 12..13` — `CRIT_BUFF_LVL` (0–3, резерв)
- остальное — резерв под будущие баффы (яд, ускорение, замедление и т.п.).

### 9.6. Состояние пузыря

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | uint16 | id |
| `pos` | Vector2 | позиция |
| `vel` | Vector2 | скорость |
| `mass` | float32 | масса (питательность) |
| `colorId` | uint8 | 0..N (зел/син/красн/золото) |

### 9.7. Состояние сундука

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | uint16 | id |
| `pos` | Vector2 | позиция |
| `vel` | Vector2 | скорость |
| `type` | uint8 | 0/1/2 (bronze/silver/gold) |

---

## 10. Клиентское отображение

### 10.1. Буфер снапшотов и интерполяция

- Клиент хранит последние 3–6 снапшотов (позиция, скорость, угол/heading, стейты).
- Рендерит состояние в момент `renderTime = now - interpolationDelay` (обычно 80–120 мс).
- Между двумя снапшотами используется **кривая Эрмье (cubic Hermite)** по позиции (и отдельно по углу), чтобы движение было гладким и устойчивым к сетевому джиттеру.
  - Если сервер не шлёт скорость, она оценивается по разности позиций соседних снапшотов.

### 10.2. Предиктивная интерполяция при разрывах

- Если `renderTime` вышел за последний полученный снапшот (потеря пакетов/пауза), клиент делает **краткосрочное прогнозирование** по последней известной скорости.
- Лимит прогноза: `maxPredictMs` (например 100 мс). После лимита — «удержание» последнего состояния до прихода нового снапшота.
- При приходе нового снапшота после разрыва применяется коррекция (см. 10.3), без жёсткого snap.

### 10.3. Коррекции и сглаживание (Hermite-blend)

- Для локального игрока используется **client-side prediction**: ввод применяется сразу, сервер периодически присылает авторитетное состояние.
- При расхождении выполняется reconciliation: переигрывание истории инпутов от `lastAckTick`.
- Визуально расхождение гасится **плавным blend по Эрмье** в течение `correctionBlendMs` (обычно 100–150 мс):
  - небольшие ошибки (до `softErrorThreshold`) сглаживаются без резкого сдвига;
  - большие ошибки (телепорт/чит/резкая коллизия) — принудительная коррекция, но тоже с коротким blend, чтобы не «рвало» картинку.

---

## 11. Персистентность и мета-системы

### 11.1. Что хранится (MVP)

| Данные | Описание |
|--------|----------|
| Профиль | userId, ник, настройки управления |
| Валюта | капли |
| Рейтинг | текущий, максимум, лига |
| Статистика | матчи, победы, убийства, макс. масса |
| Косметика | инвентарь купленных предметов |
| Достижения | прогресс и отметки получения |
| Ежедневный сундук | время последнего клейма, «сид» награды |

### 11.2. Принципы записи результатов

- Матчевые награды записывает только сервер комнаты при `match_end`.
- Обновления идемпотентны: `matchId` как ключ, чтобы не начислять дважды.
- Все изменения профиля/валюты — транзакционно.

### 11.3. Ежедневный бесплатный сундук (MVP)

Рекомендуемые поля в БД:

- `daily_chest_last_claim_at`
- `daily_chest_streak` (опционально, если появится серия)
- `daily_chest_seed` (если нужна воспроизводимость выпадения)

API минимум:
- `POST /daily-chest/claim` (с проверкой 24h)
- `POST /daily-chest/ad-double` (если rewarded-ad удваивает награду)

### 11.4. Сезонный альбом (после MVP, GDD 12.3 + Приложение D)

Система работает **сервер-авторитетно** (все открытия паков, pity и клей — на сервере).

#### 11.4.1. Ключевые сущности

Минимум, который должен поддержать backend:

- `SeasonConfig`
- `CardDefinition`
- `PlayerAlbumState`
- `PackOpenResult`
- `PlayerAlbumHistory` (архив сезонов)

Схемы и поля — как в Приложении D (GDD 2.3).

#### 11.4.2. Эндпоинты (контракт)

| Метод | Endpoint | Назначение |
|-------|----------|-----------|
| GET | `/album/state` | Текущее состояние игрока |
| GET | `/album/cards` | Список карт сезона (с признаком собрана/нет) |
| POST | `/album/pack/open` | Открыть пак (packType, source, idempotencyKey) |
| POST | `/album/glue/exchange` | Обменять клей на пак |
| GET | `/album/rewards` | Награды за страницы |
| POST | `/album/rewards/claim` | Клейм награды за страницу |
| POST | `/album/arena-chest/claim` | Клейм пака из «сундука арены» |

#### 11.4.3. Идемпотентность открытия паков

Проблема: на мобильной сети запрос может повториться.

Решение:
- Клиент отправляет `idempotencyKey` на `POST /album/pack/open`.
- Сервер сохраняет результат открытия по ключу (Redis или таблица `pack_open_requests`).
- Повторный запрос возвращает тот же `PackOpenResult`.

#### 11.4.4. Интеграции

- После каждого матча: обновлять `arenaChestProgress.currentMass` на основании `totalMassCollected` (из результата матча).
- Задания/пропуск/кланы награждают паками через единый метод `grantPack(playerId, packType, source)`.

#### 11.4.5. Миграция сезона (batch job)

На старте нового сезона:
1. Конвертировать клей → капли (курс из config).
2. Архивировать `PlayerAlbumState` в `PlayerAlbumHistory`.
3. Создать новый `PlayerAlbumState` (нулевые счётчики).
4. Начислить незабранные награды (если выбран подход auto-claim).

---

## 12. Наблюдаемость

### 12.1. Метрики сервера (технические)

| Метрика | Тип | Порог алерта |
|---------|-----|--------------|
| `tick_duration_ms` p99 | histogram | > 30 мс |
| `snapshot_bytes` p99 | histogram | > 2 КБ |
| `ws_disconnect_rate` | counter | > 5%/час |
| `exceptions_total` | counter | > 0 |

### 12.2. Бизнес-события (минимум)

Матч:
- `match_start`, `match_end`
- `player_death` (с флагом lastBreathUsed)
- `rebel_assigned`, `rebel_killed`
- `ability_used`, `talent_chosen`, `chest_opened`

Meta:
- `daily_chest_claimed` (rewardType, doubled)
- (после MVP) события альбома из Приложения D.

---

## 13. Безопасность и античит

### 13.1. Базовые меры

- Сервер валидирует частоту и диапазоны команд.
- Сервер не принимает клиентские позиции/урон.
- Лимиты на размер входящих сообщений и rate limit.
- Для meta API: проверка auth + идемпотентность наград/паков.

### 13.2. Детекция аномалий (пример)

| Аномалия | Признак | Действие |
|----------|---------|----------|
| Speed hack | скорость выше лимита длительное время | лог + авто-коррекция, флаг |
| Flood | > лимита сообщений/сек | disconnect |
| Duplicate reward | повтор `match_end` или `pack_open` | идемпотентность, deny |

---

## 14. Тестирование

### 14.1. Модульные тесты (сервер)

- Борты: отражение/коррекция позиций у границ.
- Упругая физика: conservation-like, отсутствие «взрыва» скорости.
- `speedDampingRate`: корректное гашение превышения скорости.
- Зоны (пасть/хвост/бок): классификация контакта.
- GCD/очередь умений: 100 мс и максимум 1 в очереди.
- Last Breath: переход состояний, неуязвимость, таймер.
- Rebel: вычисление среднего, выбор лидера, tie-break (кто раньше достиг).

### 14.2. Интеграционные тесты

- Матч от начала до конца (с фазами, зонами, голодом).
- Укус пузыря: полный/частичный, минимум остатка.
- Сундук: столкновения, открытие пастью, выдача награды.
- Респаун: щит, снятие щита атакой.
- Отображение rebelId и уведомления.

### 14.3. После MVP (альбом)

- Открытие паков: вероятности, pity, новые карты, дубликаты → клей.
- Идемпотентность `/album/pack/open`.
- Миграция сезона: корректная конвертация клея и архивирование.

---

## 15. Развёртывание

Как в версии 1.1: локально через `docker compose up`, далее staging/prod с Docker image и откатами.

---

## Приложение A. Структура репозитория (рекомендация)

| Директория | Содержимое |
|------------|------------|
| `client/` | Клиент |
| `server/` | Сервер (Colyseus + HTTP API) |
| `shared/` | Общие типы и конфиги |
| `docs/` | Документация |
| `tests/` | Тесты |
| `docker/` | Docker/Compose |

---

## Приложение B. Глоссарий

| Термин | Определение |
|--------|-------------|
| Tick | Один шаг серверной симуляции (30 Гц) |
| Snapshot | Снимок состояния мира для клиента |
| GCD | Global Cooldown между умениями (100 мс) |
| Last Breath | Фаза 0.5 сек после смерти для контратаки |
| Rebel | Маркер лидера (мятежник) с наградой за убийство |
| Pity | Гарантии выпадения (альбом/капсулы) |
| Idempotency | Защита от повторной выдачи наград |
