# PROTOBUF_ADOPTION_PLAN
**Проект:** Slime Arena  
**Автор:** ChatGPT  
**Версия:** 1.2  

Куда положить: `docs/PROTOBUF_ADOPTION_PLAN.md`

Назначение: зафиксировать, **когда** и **зачем** вводить Protobuf в стеке `Node.js` + `TypeScript` + `Colyseus`, не ломая принятую архитектуру. 

**Источник истины:** `SlimeArena-Architecture-v1.5.md` (v1.5.1). 

---

## 1) Текущее решение (для MVP)
- В матчах используется `Colyseus Schema` и синхронизация состояния (патчи).
- Клиент отправляет только `PlayerInput`/команды; сервер остаётся источником правды.
- Protobuf **не является блокером** для прототипа, внутреннего MVP и публичного MVP.

---

## 2) Когда Protobuf действительно нужен
Protobuf имеет смысл вводить только при подтверждённой проблеме на «горячем пути» матча. Типичные причины:
- Трафик снапшотов стал критичным для мобильных сетей (размер/частота обновлений).
- Значимая доля времени тика уходит на сериализацию/обработку патчей состояния.
- Нужна более жёсткая дисциплина версий сетевого контракта (при большом количестве клиентов).

Наблюдаемые сигналы (ориентиры из архитектуры):
- рост `snapshot_bytes` (среднее и p95);
- рост `tick_duration_ms` (p95/p99) вместе с числом игроков/сущностей;
- жалобы на «рывки» при нормальном RTT (проблема именно в объёме/частоте данных).

---

## 3) Принцип внедрения без переделки архитектуры
- `Colyseus` остаётся каркасом (комнаты, подбор матчей, presence/driver).
- Изменяется только способ упаковки «частых обновлений» матча (снапшоты/события), при сохранении авторитетности сервера и логики `SnapshotBuffer` на клиенте.

Обязательное правило:
- любое изменение wire‑контракта сопровождается ADR и стратегией совместимости.

---

## 4) Минимальный объём данных для бинарного канала
Если Protobuf вводится, сначала переводятся только данные, которые:
- часто меняются;
- сильно влияют на трафик;
- не являются удобной «обвязкой» комнаты.

Минимальный набор (по смыслу, без жёсткой схемы):
- снапшот матча: номер тика, список сущностей с минимальными атрибутами (позиция, скорость, размер, флаги), агрегаты HUD (таймер, топ‑N);
- события матча: убийство, респаун, завершение матча, награды.

Что разумно оставить на `Colyseus Schema` даже после внедрения:
- метаданные лобби и комнаты;
- простые настройки и статусы готовности;
- редкие события, не влияющие на поток снапшотов.

---

## 5) Стратегия совместимости
Цель: возможность обновлять сервер без одновременного обновления всех клиентов.

Требования:
- версионирование контракта и явная договорённость о поддерживаемых версиях;
- возможность отката на режим `schema` при проблемах (через конфигурацию);
- плавное включение по проценту матчей или серверов.

---

## 6) Критерии готовности перед включением Protobuf
Проверки (уровни, как в архитектуре и плане):
- unit: корректность кодирования/декодирования, устойчивость на граничных значениях, отсутствие некорректных чисел;
- integration: матч с ботами проходит стабильно, тик 30 Hz не деградирует;
- e2e: сценарий «лобби → матч → результаты» работает при включённом и выключенном режиме;
- наблюдаемость: метрики `snapshot_bytes` и `tick_duration_ms` сравнимы «до/после», есть отчёт о выигрыше.

---

## 7) Ожидаемый эффект
- меньше трафик на игрока при сопоставимом качестве отображения;
- меньше затрат CPU на упаковку данных;
- стабильнее p95/p99 длительности тика под ростом нагрузки;
- безопасный откат на `Colyseus Schema` режим.
