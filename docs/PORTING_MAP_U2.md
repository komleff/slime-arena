# PORTING_MAP_U2
**Проект:** Slime Arena  
**Источник идей:** u2 (Universe Unlimited)  
**Автор:** ChatGPT  
**Версия:** 1.3  
**Базовая версия u2 для анализа:** v0.13.3 (ветка изменений v0.13.x)  

Куда положить: `docs/PORTING_MAP_U2.md`

Назначение: карта переноса **архитектурных паттернов** из u2 в Slime Arena. Это не копирование «игры», а перенос практик: авторитетный сервер, фиксированная симуляция, модель ввода, сглаживание на клиенте, симуляция плохой сети, тестовая дисциплина.

**Источник истины для Slime Arena (не менять):** `SlimeArena-Architecture-v1.4.md` + `SlimeArena-GDD-v2.3.md` + `SlimeArena-Plan-v1.7.md`.

---

## 1) Контекст: что важно из u2 v0.13.x
Ключевые идеи, которые целесообразно перенести в Slime Arena:
- **Единая частота симуляции 30 Hz** и фиксированный шаг (устойчивость траекторий и повторяемость поведения).
- **Модель ввода «one per tick»** (`PlayerInput`): один пакет ввода на тик вместо пакетирования.
- Сглаживание на клиенте: интерполяция + ограниченная экстраполяция + мягкие коррекции.
- Топология мира: u2 может использовать torus/wrap; для Slime Arena по Архитектуре 1.4 — **арена с бортами** (без wrap). Тор-специфику переносить только как идеи тестирования/инвариантов.
- Практики CI/CD и дисциплина релизов (как процесс, а не как технология).

---

## 2) Что переносим (и зачем)

### A) Единое описание правил (shared rules) + шлюз команд
**Идея:** и сервер, и клиент опираются на одинаковые определения: формат ввода, инварианты, параметры баланса и физики.

**Польза:**
- меньше расхождений логики и спорных трактовок;
- проще валидировать ввод на сервере;
- проще писать тесты на механику.

### B) Авторитетный сервер + сглаживание на клиенте (без тяжёлых предиктов)
**Идея:** сервер — источник правды, клиент отображает состояние через `SnapshotBuffer`.

**Польза:**
- быстрее собрать MVP;
- меньше классов ошибок на синхронизации;
- проще параллельная разработка несколькими агентами.

### C) Симуляция плохой сети + панель диагностики
**Идея:** встроенные профили задержек/потерь/джиттера и отображение ключевых метрик.

**Польза:**
- воспроизводимость сетевых дефектов;
- единый язык для QA и разработки;
- быстрее подтверждать улучшения.

### D) Регрессионные тесты на симуляцию
**Идея:** каждый найденный баг закрепляется тестом.

**Польза:**
- стабилизация ядра (движение, столкновения, урон, укусы пузырей);
- меньше повторных поломок после правок.

### E) Конфигурируемая физика (важно для Slime Arena)
**Идея:** параметры поведения «резиновой физики» и среды должны меняться через `config`, без изменения кода.

**Польза:**
- быстрее итерации баланса;
- проще A/B проверки ощущений;
- меньше риск «сломать игру» правкой формул.

---

## 3) Как это ложится на модули Slime Arena

### 3.1 `shared/` (описание данных и инвариантов)
Содержит:
- формат `PlayerInput` и ограничения (частота, диапазоны);
- перечень параметров баланса и физики, настраиваемых через `config` (например: `environmentDrag`, `collisionRestitution`, `orbLinearDamping`, `collisionImpulseCap`);
- определения сущностей и флагов для снапшота (минимум для рендера и HUD);
- чистые правила: **границы арены (борты/отражение/коррекция)**, сектора `MouthArc`/`TailArc`, базовые ограничения скорости/поворота.

Не содержит:
- сеть и транспорт;
- рендер и интерфейс;
- доступ к базе данных.

Критерии готовности:
- одинаковый ввод даёт одинаковый результат в контрольных сценариях;
- параметры симуляции управляются через `config`.

### 3.2 `server/` (симуляция и правила матча)
Усилить:
- приём только ввода/команд, а не «состояния»;
- валидации ввода (частота, диапазоны, окно тиков);
- стабильный порядок систем внутри тика, как в архитектуре.

Критерии готовности:
- некорректный ввод отклоняется и логируется;
- тик 30 Hz стабилен на целевой нагрузке внутреннего MVP.

### 3.3 `client/` (отображение и управление)
Усилить:
- `SnapshotBuffer` и интерполяцию;
- мягкие коррекции без «телепортов»;
- симулятор плохой сети и панель диагностики (опционально для QA).

Критерии готовности:
- на нормальной сети движение и столкновения визуально плавные;
- на плохой сети игра остаётся управляемой и предсказуемой.

---

## 4) Порядок внедрения (чтобы агенты могли работать автономно)

### Этап 0 — Формализация решений
Задачи:
- обновить/создать ADR по темам: правила в `shared/`, авторитетность сервера, сглаживание, симуляция сети.

Контрольная точка:
- ADR приняты и не противоречат `SlimeArena-Architecture-v1.4.md`.

### Этап 1 — Минимальное описание правил
Задачи:
- зафиксировать формат `PlayerInput` (one per tick);
- выделить параметры физики и среды в `config` (как минимум для «резиновых столкновений» и движения пузырей);
- описать инварианты карты с бортами (границы, отражение/скольжение, отсутствие «залипания»).

Контрольная точка:
- есть тесты на инварианты (монотонность/границы, поведение у бортов (отражение/коррекция), базовые столкновения).

### Этап 2 — Валидация ввода на сервере
Задачи:
- единая точка проверки ввода;
- ограничения частоты и диапазонов.

Контрольная точка:
- тесты подтверждают, что спам/аномальный ввод не ломает матч.

### Этап 3 — Снапшоты и сглаживание на клиенте
Задачи:
- буфер снапшотов и интерполяция;
- ограниченная экстраполяция;
- сглаживание коррекций.

Контрольная точка:
- проверка «лобби → матч → результаты» проходит без визуальных скачков.

### Этап 4 — Симуляция плохой сети и диагностика
Задачи:
- профили сети (условно: хорошая/средняя/плохая);
- отображение RTT, потерь, длительности тика, размера снапшотов.

Контрольная точка:
- QA может воспроизвести сетевые дефекты одинаково на разных машинах.

### Этап 5 — Регрессии и стабилизация
Задачи:
- каждый исправленный дефект в симуляции закрепляется тестом;
- добавляется минимальный набор сценариев для физики пузырей и укуса.

Контрольная точка:
- ключевые сценарии (движение, столкновения, укусы пузырей, урон) устойчивы между сборками.

---

## 5) Обязательные артефакты при переносе
- ADR (если меняется архитектура/контракт).
- Обновление документов (архитектуру править только отдельным согласованным PR/ADR; в рамках переноса — не противоречить `SlimeArena-Architecture-v1.4.md`).
- Тесты (unit/integration/e2e) на затронутые инварианты.
- Короткая демонстрация (видео или запись экрана) для подтверждения поведения.

---

## 6) Наборы задач (черновик)

### Набор: Единые правила + валидация ввода
- Определить ограничения `PlayerInput`.
- Выделить параметры физики/баланса в `config`.
- Добавить тесты на инварианты.

### Набор: Сглаживание на клиенте
- Ввести `SnapshotBuffer`.
- Добавить интерполяцию и мягкие коррекции.
- Проверить поведение у бортов (коррекции позиции/скорости, отсутствие артефактов и читов на границах).

### Набор: Симулятор сети (для QA)
- Профили сети и переключение профиля.
- Панель диагностики (RTT/потери/тик/размер снапшота/FPS).