# Slime Arena — Архитектура

**Версия:** 4.2.5 (часть 3/4)
**Дата:** 5 января 2026  

---

## 0. Изменения версии 4.2.3

1. Обновлены ссылки на актуальные версии `TZ-SoftLaunch` и Плана Soft Launch.
2. Уточнены формулировки требований `[MUST]/[SHOULD]/[MAY]` без изменения контрактов.

---


## 1. Система событий и аналитики

Назначение: сбор технических и бизнес-событий для расчёта метрик софт-лонча и диагностики проблем.

Требования:
1. События, влияющие на экономику и прогресс, формируются на сервере (`MetaServer`).
2. Клиентские события допускаются для UI-взаимодействий, статуса платформы и ошибок.
3. Любое событие содержит `userId`, `platformType`, `buildVersion`, `configVersion`, `ts`.
4. Запись событий не блокирует критические потоки (матч, покупки).

Полный список событий и обязательные поля: часть 4/4 (Приложение D).

---

## 2. Система A/B тестирования

Назначение: управлять вариантами конфигураций и измерять эффект на метриках без релиза клиента.

Требования:
1. Назначение варианта детерминировано по `userId` и `testId`.
2. Назначение сохраняется и не меняется при повторных входах.
3. Варианты изменяют только конфигурации (без ветвления логики в коде).
4. Результаты измеряются событиями.

Требования к параметрам тестов (минимум):
- `minDurationDays`
- `minUsersPerVariant`
- `alpha`
- `guardrails`

Детальная схема конфигурации A/B тестов и правила назначения: часть 4/4 (Приложение E).

---

## 3. Безопасность и защита данных

Требования:
1. Валидация входных данных на сервере.
2. Защита от повторных операций через `operationId`.
3. Верификация платформенных данных (`initData`, токены).
4. Учёт согласий пользователя (`Consent`) для рекламы и аналитики.
5. Операция удаления данных пользователя (`DataDeletion`) с аудитом.

Детальные требования безопасности (валидаторы, лимиты, структура токенов, удаление данных): часть 4/4 (Приложение F).

---

## 4. Мониторинг и наблюдаемость

### 4.1. Технические метрики (минимум)

| Метрика | Назначение |
|---------|------------|
| Время ответа API p95/p99 | Диагностика деградаций |
| Ошибки 5xx и 4xx | Качество API и валидации |
| Ошибки клиента | Качество клиента и платформ |
| Подключения к БД и задержки запросов | Здоровье хранилища |
| Успехи/ошибки покупок и выдач | Защита экономики |

### 4.2. Бизнес-метрики (минимум)

| Метрика | Назначение |
|---------|------------|
| DAU/MAU | Размер аудитории |
| Retention D1/D7 | Удержание |
| ARPU/ARPPU | Доход |
| Конверсия в платёж | Монетизация |
| Конверсия в рекламу | Реклама |

### 4.3. Инструменты наблюдаемости

Требования:
1. Метрики совместимы с Prometheus.
2. Дашборды доступны в Grafana или эквивалентном инструменте.
3. Ошибки клиента и сервера агрегируются в Sentry или эквивалентной системе.
4. Логи собираются централизованно (Loki/Elastic/OpenSearch или эквивалент) с фильтрацией по `buildVersion`, `configVersion`.
5. Алерты поддерживают доставку в почту/мессенджер/вебхук.

---

## 5. Сборка, развёртывание и окружения

Окружения: `dev`, `stage`, `prod`.

Требования:
1. Раздельные базы данных и ключи для окружений.
2. Миграции применяются при развёртывании.
3. Откат версии серверов возможен без изменения схемы данных.
4. Для `prod` включено резервное копирование PostgreSQL и проверка восстановления.

### 5.1. Резервное копирование и восстановление

Требования:
1. Резервное копирование PostgreSQL: не реже 1 раза в сутки.
2. Хранение: не менее 14 дней.
3. Восстановление выполняется в `stage` и включает шаги:
   - подготовка пустой базы данных;
   - восстановление из резервной копии;
   - запуск миграций до актуальной версии схемы;
   - проверка целостности;
   - smoke-проверки HTTP API.
4. Контрольное восстановление: не реже 1 раза в месяц.


### 5.2. Миграции базы данных

`PostgreSQL` используется как источник правды для экономики и прогресса.

Требования:
1. `[MUST]` Миграции применяются сначала в `stage`, затем в `prod`.
2. `[MUST]` Миграции софт-лонча должны быть прямыми (без обязательного отката схемы).
3. `[MUST]` Откат релиза выполняется откатом версии сервисов, без отката данных.
4. `[SHOULD]` Для потенциально разрушительных изменений применять стратегию расширения/сжатия:
   - добавление новых полей/таблиц;
   - двойная запись (при необходимости);
   - переключение чтения;
   - удаление старых полей в отдельном релизе.
5. `[MUST]` Перед применением миграций в `prod` выполняется резервная копия и фиксируется её идентификатор.

### 5.3. Устойчивость и восстановление при сбоях

Назначение: определить минимальные правила поведения при сбоях в условиях запуска на одном узле.

Параметры Soft Launch (конфигурация `resilience.json`):
- `reconnectWindowMs` = 15000.
- `summaryTTL` = 86400000.

#### 5.3.1. Потеря соединения клиента с `MatchServer`

Требования:
1. `[MUST]` Клиент показывает состояние «Соединение потеряно» и пытается переподключиться в пределах `reconnectWindowMs` (для Soft Launch по умолчанию 15000, задаётся конфигурацией `resilience.json`).
2. `[MUST]` При успешном переподключении клиент восстанавливает состояние матча по данным комнаты и продолжает игру.
3. `[MUST]` При неуспехе переподключения клиент возвращается в лобби. Итог матча для игрока считается неподтверждённым, пока не получен результат от `MetaServer`.

#### 5.3.2. Падение процесса `MatchServer`

Требования:
1. `[MUST]` Клиент возвращается в лобби после таймаута переподключения.
2. `[MUST]` `MetaServer` не начисляет награды по матчу без подтверждённого `MatchSummary`.
3. `[SHOULD]` `MetaServer` фиксирует техническое событие завершения матча со статусом `aborted` для аналитики.

#### 5.3.3. Потеря связи `MatchServer` → `MetaServer` при отправке `MatchSummary`

Требования:
1. `[MUST]` `MatchServer` отправляет `MatchSummary` с `matchId` и повторяет отправку до получения подтверждения или до истечения `summaryTTL` (для Soft Launch по умолчанию 86400000, задаётся конфигурацией `resilience.json`).
2. `[MUST]` `MetaServer` обрабатывает повторные `MatchSummary` идемпотентно по `matchId` и возвращает один и тот же результат.
3. `[SHOULD]` `MatchServer` хранит неподтверждённые `MatchSummary` в локальной очереди отправки (`summaryOutbox`) и очищает их только после подтверждения.

---


## 6. Тестирование

Требования:
1. Модульные тесты: валидация входных данных, идемпотентность операций, расчёт наград.
2. Интеграционные тесты: вход, конфиги, матчмейкинг, покупка, реклама с наградой, завершение матча.
3. Нагрузочные проверки ключевых путей (API, матчмейкинг, завершение матча).
4. UI проверки: ориентация, WebView клавиатура, кнопка «назад», плохая сеть.

### 6.1. Нагрузочные проверки

Требования:
1. `[MUST]` Нагрузочные проверки выполняются на `stage` перед релизом софт-лонча.
2. `[MUST]` Проверяются ключевые пути `MetaServer` (авторизация, профиль, матчмейкинг, покупки, реклама с наградой) и стабильность `MatchServer` (тик, память, задержки).
3. `[SHOULD]` Целевые значения задаются в плане софт-лонча и обновляются перед релизом.
4. `[MUST]` Критерии провала: рост доли ошибок, рост p99 задержек, деградация тика, утечки памяти.

### 6.2. Smoke-проверки миграций

Требования:
1. `[MUST]` После миграций выполняются smoke-проверки маршрутов из Приложения C (часть 4/4).
2. `[MUST]` Проверяются операции с ценностью: покупка, выдача награды, изменение баланса.

---

## 7. План рефакторинга и снижения технического долга

Цель: повысить поддерживаемость и тестируемость без изменения игровых правил, баланса и сетевых контрактов.

Приоритеты:
- **P0:** типизация систем, устранение `any`, `Preact` UI, единая математика.
- **P1:** декомпозиция монолитов (`ArenaRoom`), разделение клиентских подсистем.
- **P2:** тесты детерминизма и критичных бизнес-операций.
- **P3:** упорядочивание конфигураций и оптимизации производительности.

Критерии завершения:
1. Нет `any` в серверных системах и их контрактах.
2. UI экранов и окон собирается из `Preact` компонентов.
3. Идемпотентность операций подтверждена тестами.

---

## Открытые вопросы

Нет.

---

## 8. Навигация по частям

- Часть 1/4: клиент и `MatchServer`.
- Часть 2/4: `MetaServer`, матчмейкинг, конфигурации.
- Часть 4/4: приложения A–F (детали конфигураций, БД, HTTP API, событий, A/B, безопасности).