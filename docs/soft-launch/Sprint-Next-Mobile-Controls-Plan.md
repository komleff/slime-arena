# План улучшения мобильного управления (A/B)

Краткое резюме: документ описывает план настройки *Virtual Joystick* (см. глоссарий) и *Flight Assist* (см. глоссарий) для мобильных устройств, а также структуру *A/B test* (см. глоссарий) с быстрым переключением через *AB config* (см. глоссарий).

## 1. Цели системы
- [MUST] Повысить отзывчивость управления при поворотах и сменах направления на мобильных устройствах.
- [MUST] Обеспечить быстрый переход между вариантами A и B без деплоя кода (только конфигурация).
- [MUST] Сохранить серверную авторитативность и физическую корректность движения.
- [SHOULD] Снизить боковой занос и осцилляции при поворотах без ухудшения управления на *Desktop* (см. глоссарий).
- [MAY] Добавить дополнительный слой тюнинга для touch-only параметров (см. раздел 4.5).

## 2. Контекст и ограничения
<!-- ВАЖНО: анти-читинг и авторитет сервера не должны нарушаться -->
- [MUST] Клиент отправляет только *InputCommand* (см. глоссарий), без передачи позиций/скоростей.
- [MUST] *MatchServer* (см. глоссарий) валидирует частоту и диапазоны InputCommand для предотвращения читов.
- [MUST] Вариант A/B применяется на уровне матча или серверного пула, чтобы не смешивать физику в одной комнате.
- [MUST] Изменения в A/B сводятся к параметрам *BalanceConfig* (см. глоссарий), без изменения логики симуляции.
- [SHOULD] Конфигурация варианта должна быть обратимой и применяться без изменения протоколов.
- [MAY] Для QA допускается локальный override варианта без изменения server-side назначения.

Связанные материалы:
- `client/src/input/joystick.ts`
- `client/src/main.ts`
- `server/src/rooms/systems/movementSystems.ts`
- `shared/src/config.ts`
- `config/balance.json`
- `config/experiments/mobile-controls-ab.json`
- `.memory_bank/ui_extension/components/virtual_joystick.md`
- `.memory_bank/modules/U2-smoothing.md`

## 3. Компоненты и связи

| Компонент | Ответственность | Вход | Выход | Примечания |
| --- | --- | --- | --- | --- |
| *Virtual Joystick* (см. глоссарий) | Преобразование touch-ввода в вектор | Pointer events | moveX/moveY | Клиентская логика |
| Клиентский ввод | Формирование *InputCommand* (см. глоссарий) | moveX/moveY | InputCommand | Отправка по WebSocket |
| *Flight Assist* (см. глоссарий) | Расчет сил и момента | InputCommand | assistFx/assistFy/assistTorque | Серверная логика |
| *BalanceConfig* (см. глоссарий) | Источник параметров управления | JSON | значения конфигурации | `config/balance.json` |
| *AB config* (см. глоссарий) | Описание вариантов A/B | JSON | overrides параметров | `config/experiments/mobile-controls-ab.json` |
| *RuntimeConfig* (см. глоссарий) | Активная версия баланса | MetaServer | выбранная версия | Для live-экспериментов |

Схема взаимодействия:
1. Touch ввод -> Virtual Joystick.
2. Virtual Joystick -> InputCommand.
3. InputCommand -> Flight Assist.
4. Flight Assist -> Physics loop.

## 4. Детали реализации

### 4.1 Структуры данных

*InputCommand* (см. глоссарий):

| Поле | Тип | Обязательно | Описание |
| --- | --- | --- | --- |
| `seq` | number | да | Монотонный счетчик команд ввода |
| `moveX` | number | да | Нормализованный X в диапазоне [-1..1] |
| `moveY` | number | да | Нормализованный Y в диапазоне [-1..1] |
| `abilitySlot` | number | нет | Номер слота способности |
| `talentChoice` | number | нет | Выбор таланта |

Структура *AB config* (см. глоссарий) для mobile controls:

| Поле | Тип | Обязательно | Описание |
| --- | --- | --- | --- |
| `testId` | string | да | Идентификатор эксперимента |
| `configVersion` | string | да | Версия конфигурации |
| `assignmentScope` | string | да | Гранулярность варианта (например: room/serverPool) |
| `targetPlatforms` | string[] | да | Целевые группы устройств |
| `variants` | object | да | Набор *Variant* (см. глоссарий) параметров |
| `weights` | object | да | Вес распределения по вариантам |
| `defaultVariant` | string | да | Вариант по умолчанию |
| `override` | object | нет | Быстрое переключение для QA |
| `metrics` | string[] | нет | Метрики оценки |

Структура `override`:

| Поле | Тип | Обязательно | Описание |
| --- | --- | --- | --- |
| `enabled` | boolean | да | Активен ли override |
| `variantId` | string | да | Выбранный вариант |
| `reason` | string | нет | Причина/контекст переключения |

### 4.2 Варианты A/B и отличия

Ниже заданы два *Variant* (см. глоссарий) без изменения логики, только параметры.

**Virtual Joystick параметры**

| Параметр | Вариант A (Stability) | Вариант B (Responsiveness) | Ожидаемый эффект |
| --- | --- | --- | --- |
| controls.joystickDeadzone | 0.07 | 0.05 | Более ранний старт поворота |
| controls.joystickSensitivity | 1.15 | 1.25 | Быстрее реакция на малые отклонения |
| controls.joystickFollowSpeed | 0.95 | 1.05 | Меньше инерционность базы |

**Flight Assist параметры**

| Параметр | Вариант A (Stability) | Вариант B (Responsiveness) | Ожидаемый эффект |
| --- | --- | --- | --- |
| assist.yawRateGain | 5.0 | 5.6 | Быстрее достижение угловой скорости |
| assist.reactionTimeS | 0.11 | 0.10 | Быстрее реакция регулятора |
| assist.angularStopTimeS | 0.15 | 0.13 | Быстрее гашение разворота |
| assist.angularBrakeBoostFactor | 1.8 | 2.0 | Меньше перелет угла |
| assist.angularDeadzoneRad | 0.012 | 0.010 | Раннее включение поворота |
| assist.counterAccelTimeS | 0.11 | 0.10 | Быстрее гашение бокового заноса |
| assist.counterAccelDirectionThresholdDeg | 22 | 18 | Ранее включение *Counter-acceleration* (см. глоссарий) |
| assist.overspeedDampingRate | 0.30 | 0.35 | Сильнее демпфирование превышения |
| assist.velocityErrorThreshold | 0.06 | 0.05 | Реакция на меньшую ошибку |

**World Physics параметры**

| Параметр | Вариант A (Stability) | Вариант B (Responsiveness) | Ожидаемый эффект |
| --- | --- | --- | --- |
| worldPhysics.angularDragK | 1.3 | 1.3 | Без изменения, чтобы не смешивать физику |

Ключевые отличия:
- Вариант A приоритетно снижает осцилляции и удерживает курс.
- Вариант B приоритетно ускоряет поворот и сокращает задержку реакции.

### 4.3 Быстрое переключение вариантов (A/B assignment)

Нумерованный процесс выбора варианта:
1. Определить вариант через *A/B test* (см. глоссарий) на основе userId и testId.
2. Если включен `override`, использовать его вариант как приоритетный.
3. Применить параметры варианта как overlay к BalanceConfig (без изменения логики симуляции).
4. Зафиксировать вариант на весь матч и передать его в метрики.
5. Для QA обеспечить ручное переключение без пересборки (см. раздел 4.2).

### 4.4 План внедрения

| Шаг | Ожидаемый результат | Файлы/модули | Риски/неопределенности |
| --- | --- | --- | --- |
| 1. Зафиксировать A/B конфиг и описание вариантов | Готовый источник параметров для эксперимента | `config/experiments/mobile-controls-ab.json`, `docs/soft-launch/Sprint-Next-Mobile-Controls-Plan.md` | Несогласованность значений с актуальным balance.json |
| 2. Встроить выбор варианта на уровне матча | Единый вариант для комнаты, без смешивания физики | MatchServer matchmaking flow | Перенос пользователя между пулами серверов |
| 3. Добавить быстрый override для QA | Переключение варианта за секунды | MetaServer/RuntimeConfig | Риск обхода assignment при неверных правах |
| 4. Подключить метрики A/B | Измеримость эффекта | Analytics | Недостаточная детализация метрик |
| 5. Провести A/B прогон на приоритетных устройствах | Данные по эффективности | QA/Device lab | Смещение выборки по устройствам |

### 4.5 Дополнительные параметры для тонкой настройки (MAY)

| Параметр | Где применяется | Назначение | Риск/замечания |
| --- | --- | --- | --- |
| assist.yawFullDeflectionAngleDeg | Flight Assist | Порог полной команды yaw | Может увеличить чувствительность рывками |
| assist.yawOscillationWindowFrames | Flight Assist | Окно детекта осцилляций | Требует калибровки на 30 Hz |
| assist.yawOscillationSignFlipsThreshold | Flight Assist | Порог смены знака yaw | Риск подавления резких маневров |
| assist.yawDampingBoostFactor | Flight Assist | Усиление демпфирования yaw | Может сделать поворот вязким |
| assist.yawCmdEps | Flight Assist | Минимальный порог yaw-команды | Влияет на микроповороты |
| assist.inputMagnitudeThreshold | Flight Assist | Порог наличия ввода | Риск “мертвой зоны” |
| assist.autoBrakeMaxThrustFraction | Flight Assist | Ограничение авто-тормоза | Может увеличить тормозной путь |
| assist.accelTimeS | Flight Assist | Время набора линейной скорости | Влияет на резкость старта |
| assist.comfortableBrakingTimeS | Flight Assist | Комфортное торможение | Может усилить инерцию |
| assist.counterAccelMinSpeedMps | Flight Assist | Минимальная скорость для counter-accel | Риск дрейфа на низких скоростях |

## 5. Требования к качеству
- [MUST] Вариант A/B фиксируется на матч и не меняется в процессе игры.
- [MUST] Время выравнивания курса на 90/180 градусов на мобильных улучшается минимум на 15% в варианте B.
- [MUST] Предотвращение читов сохраняется за счет валидации частоты и диапазонов InputCommand на MatchServer.
- [SHOULD] Боковой занос при поворотах снижается без ухудшения контроля на Desktop.
- [SHOULD] Количество осцилляций при зигзаге не увеличивается относительно варианта A.
- [MAY] Дополнительные параметры включаются только при наличии метрик и обратимой конфигурации.

### Открытые вопросы
Q1: Какая стратегия assignmentScope предпочтительнее: room или serverPool?
Варианты: [a) room, b) serverPool, c) региональные пулы]

Q2: Нужен ли обязательный holdout (5-10%) для baseline при запуске A/B?
Варианты: [a) да, b) нет]

Q3: Достаточно ли текущих метрик или требуется отдельная метрика “turn-lag”?
Варианты: [a) текущие, b) добавить turn-lag]

Q4: Можно ли подключить device-class сегментацию без изменения assignment логики?
Варианты: [a) да через targetPlatforms, b) нет, нужен отдельный routing]

## 6. Глоссарий

| Термин | Описание | Синонимы |
| --- | --- | --- |
| A/B test | Эксперимент с разделением аудитории на варианты | AB test |
| AB config | Конфигурация вариантов эксперимента и их параметров | experiment config |
| BalanceConfig | Набор параметров баланса и управления, читается из `config/balance.json` | balance config |
| Counter-acceleration | Серверная компенсация бокового дрейфа при смене направления | counter accel |
| Desktop | Настольные устройства с мышью и клавиатурой | PC |
| Flight Assist | Слой управления движением, вычисляющий силы и момент по InputCommand | fly-by-wire |
| InputCommand | Пакет ввода от клиента к серверу с moveX/moveY и опциональными полями | input cmd |
| MatchServer | Сервер симуляции, применяющий физику и правила игры | game server |
| RuntimeConfig | Активная версия конфигурации, выдаваемая MetaServer | config runtime |
| Variant | Вариант параметров в A/B тесте | variant arm |
| Virtual Joystick | Клиентский элемент управления для touch ввода, выдающий нормализованный вектор | joystick |
