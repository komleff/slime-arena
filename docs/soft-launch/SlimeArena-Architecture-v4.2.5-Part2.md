# Slime Arena — Архитектура

**Версия:** 4.2.5 (часть 2/4)
**Дата:** 5 января 2026  

---

## 0. Изменения версии 4.2.3

1. Обновлены ссылки на актуальные версии `TZ-SoftLaunch` и Плана Soft Launch.
2. Уточнены формулировки требований `[MUST]/[SHOULD]/[MAY]` без изменения контрактов.

---


## 1. Назначение `MetaServer`

`MetaServer` предоставляет HTTP API для мета-части игры и выполняет бизнес-операции, не связанные с симуляцией боя.

Обязанности:
1. Авторизация и управление сессиями.
2. Профиль, прогресс, инвентарь, валюты.
3. Магазин, офферы, боевой пропуск, достижения.
4. Рейтинги и лидерборды.
5. Выдача наград и аудит действий.
6. Управление конфигурациями, A/B тестами, переключателями возможностей (`featureFlags`), откат.

Ограничения:
1. Не выполняет симуляцию матча.
2. Не доверяет данным клиента, кроме данных, верифицированных платформой.
3. Любая операция экономики должна быть идемпотентной по `operationId`.

---

## 2. Платформенная абстракция

### 2.1. Принципы

1. Код игры не зависит от конкретной платформы.
2. Различия платформ локализованы в `PlatformManager` и `*Adapter`.
3. Недоступность функции на платформе не должна ломать базовый сценарий (вход → матч → результаты).

### 2.2. Интерфейсы платформенных поставщиков

Обязательные интерфейсы:
- `IAuthProvider` — авторизация и получение токена верификации.
- `IAdsProvider` — показ рекламы (межстраничной и с наградой).
- `IPaymentProvider` — покупка за реальные деньги и выдача подтверждения (`receipt`).
- `ISocialProvider` — приглашения и публикации (опционально для софт-лонча).

Минимальные методы (имена фиксированы):
- `initialize`
- `isAvailable` или эквивалентная проверка доступности
- `getUser` / `getAuthToken` для `IAuthProvider`
- `showRewarded` для `IAdsProvider`
- `purchase` для `IPaymentProvider`

Детали полей и структур: `TZ-SoftLaunch-v1.4.2.md` и часть 4/4 (Приложение C, маршруты покупок/рекламы).

### 2.3. Менеджер платформы

`PlatformManager`:
1. Определяет платформу.
2. Подключает соответствующий `*Adapter`.
3. Экспортирует набор поставщиков функций (`I*Provider`) в UI и сервисы.

---

## 3. Сервисы `MetaServer`

### 3.1. Общие правила сервисов

1. Публичные операции доступны только через HTTP API.
2. Операции экономики выполняются транзакционно в PostgreSQL.
3. Идемпотентность: повтор запроса с тем же `operationId` возвращает тот же результат без повторной выдачи.
4. Любые административные операции пишутся в `audit_log`.

### 3.2. Перечень сервисов и ответственность

- `AuthService` — верификация платформенного входа, выпуск `accessToken`, управление сессиями.
- `PlayerService` — профиль, ник, язык, базовая статистика.
- `WalletService` — балансы валют, начисления/списания.
- `InventoryService` — разблокированные предметы, выбор активной косметики.
- `ShopService` — каталог, покупка за валюту, обработка покупок за реальные деньги.
- `BattlePassService` — сезоны, прогресс, миссии, выдача наград.
- `AchievementService` — прогресс достижений и выдача наград.
- `RatingService` — рейтинг игрока и лидерборды (алгоритм задаётся конфигурацией сезона).
- `AdsService` — реклама с наградой и защита от повторной выдачи.
- `ConfigService` — выдача `RuntimeConfig`, версионирование, откат, валидация.
- `AdminService` — управляемые операции (выдачи, блокировки, аварийные переключатели).
- `MatchmakingService` — очередь, подбор, назначение матча.

---

## 4. Матчмейкинг

### 4.1. Контракты

`QueueTicket` (выдаётся в ответе на `join`):
- `ticketId`
- `mode`
- `createdAt`
- `expiresAt`

`MatchAssignment` (возвращается в `status` при назначении):
- `roomId`
- `matchServerUrl`
- `joinToken`
- `expiresAt`

Полные формы запросов/ответов: часть 4/4 (Приложение C, маршруты матчмейкинга).

### 4.2. Требования к очереди

1. Очередь хранится в Redis и допускает потерю при перезапуске (пользователь ставится повторно).
2. Подбор выполняется по `mode` и `seasonId` рейтинга (если режим рейтинговый).
3. Окно допуска по рейтингу расширяется со временем ожидания.
4. Максимальное время ожидания и стратегия расширения задаются конфигурацией (`matchmaking.json`).
5. При недостатке игроков допускается заполнение ботами по конфигурации режима.

---

## 5. Конфигурации (`RuntimeConfig`)

Требования:
1. Конфигурации отделены от кода и управляют монетизацией и контентом.
2. Конфигурации версионируются (`configVersion`) и могут быть откатаны.
3. Перед активацией конфигурации валидируются.
4. Клиент получает `RuntimeConfig` при входе и при смене версии (по событию или по таймеру).

Детальная структура файлов и полей: часть 4/4 (Приложение A).

---

## 6. Хранилища данных

### 6.1. PostgreSQL

Назначение:
- Долговременные данные профиля, прогресса, транзакций, аудита.
- Источник правды для идемпотентности операций.

Детальная схема таблиц, индексов и ограничений: часть 4/4 (Приложение B).

### 6.2. Redis

Назначение:
- Очередь матчмейкинга.
- Лидерборды и кеши.
- Краткоживущие блокировки (антидублирование на коротком интервале).

---

## 7. Покупки и идемпотентность (границы)

Требования:
1. Покупки за реальные деньги верифицируются только на сервере.
2. `MetaServer` хранит факт верификации и не выдаёт награду повторно.
3. Любые выдачи, влияющие на баланс или инвентарь, фиксируются в `transactions`.

Детальная последовательность: `TZ-SoftLaunch-v1.4.2.md`.  
Детали маршрутов: часть 4/4 (Приложение C).

---

## 8. Навигация по частям

- Часть 1/4: клиент и `MatchServer`.
- Часть 3/4: события, A/B тесты, безопасность, мониторинг, эксплуатация.
- Часть 4/4: приложения A–F (детали конфигураций, БД, HTTP API, событий, A/B, безопасности).

---

## Принятые решения Soft Launch

1. Рейтинг: модель `Glicko-2`.
2. Боты: допускается заполнение матча ботами; по умолчанию 1 бот на матч (`botsPerMatch=1`). Рейтинг бота задаётся стратегией `median`.
3. Влияние ботов на рейтинг: по умолчанию отключено (`botsAffectRating=false`).
4. Региональность: отключена (`regionMode=off`).

## Открытые вопросы

1. Параметры `Glicko-2` по умолчанию для софт-лонча: начальные значения и ограничения.
