# Slime Arena — Архитектура

**Версия:** 4.2.5 (часть 1/4)
**Дата:** 5 января 2026  

---

## 0. Изменения версии 4.2.3

1. Обновлены ссылки на актуальные версии `TZ-SoftLaunch` и Плана Soft Launch.
2. Уточнены формулировки требований `[MUST]/[SHOULD]/[MAY]` без изменения контрактов.

---


## 1. Источники правды

1. Игровые правила и баланс: пакет GDD (`GDD-*.md`).
2. Требования софт-лонча: `TZ-SoftLaunch-v1.4.7.md`.
3. План софт-лонча: `SlimeArena-SoftLaunch-Plan-v1.0.4.md`.
4. Архитектура: этот документ (части 1–4).
5. Общий план разработки (после софт-лонча): `SlimeArena-Plan-v3.3.md`.

### 1.1. Нотация требований

- `[MUST]` — обязательное требование. Нарушение блокирует релиз софт-лонча.
- `[SHOULD]` — желательное требование. Можно отложить, если есть причины и риски признаны приемлемыми.
- `[MAY]` — допустимое расширение. Не требуется для софт-лонча.

Если маркер не указан, пункт трактуется как `[MUST]`.

### 1.2. Правила документирования требований

1. Требования к реализации формулировать в виде коротких проверяемых утверждений.
2. Сложные процессы описывать нумерованными шагами (1…N) с явными входами/выходами.
3. Структуры данных фиксировать таблицами полей и типов или формальными схемами (JSON Schema, SQL DDL).
4. Неопределённости выносить в раздел «Открытые вопросы» соответствующей части.

---


## 2. Цели архитектуры

### 2.1. Качества системы

1. Детерминированная серверная симуляция и повторяемость результатов при одинаковом вводе.
2. Расширяемость под платформы и поставщиков функций через интерфейсы и адаптеры.
3. Управление монетизацией и контентом конфигурациями с версионированием и откатом.
4. Наблюдаемость: технические метрики, бизнес-метрики, аудит действий.
5. Эксплуатационная готовность: окружения, миграции, резервные копии, восстановление, управляемые обновления.
6. Поддерживаемость: ограничения на связность, типизация, модульность, план снижения технического долга.

### 2.2. Не входит в архитектуру

1. Формулы физики, параметры баланса, описания умений, талантов, сундуков — в GDD.
2. Художественные требования, тексты, визуальный стиль — в арт-документах и GDD.

---

## 3. Контекст системы

### 3.1. Компоненты верхнего уровня

1. **Клиент (`client`)** — ввод, рендер, UI, сетевое подключение, платформенные адаптеры.
2. **`MatchServer`** — сервер авторитетной симуляции боёв (Colyseus комнаты).
3. **`MetaServer`** — HTTP API для профиля, экономики, конфигураций, монетизации и `liveOps`.
4. **PostgreSQL** — долговременные данные профиля, прогресса, покупок, аудита.
5. **Redis** — кеш, лидерборды, блокировки, очереди, антидублирование операций.
6. **Платформенные адаптеры** — авторизация/платежи/реклама/социальные функции через `I*Provider`.

### 3.2. Основные потоки

1. Запуск клиента → определение платформы (`PlatformManager`) → авторизация → загрузка `RuntimeConfig`.
2. Лобби → матчмейкинг (`MetaServer`) → подключение к комнате (`MatchServer`) → матч → `MatchSummary` в `MetaServer`.
3. Метапрогресс (профиль, магазин, пропуск, достижения) → операции через `MetaServer` → обновление `AppState`.

### 3.3. Матчмейкинг (обзор)

1. Подбор игроков выполняется на стороне `MetaServer` в сервисе `MatchmakingService`.
2. `MatchServer` принимает только назначенные матчи и не участвует в выборе состава игроков.
3. Результат подбора — `MatchAssignment`: `roomId`, `matchServerUrl`, `joinToken`, `expiresAt`.
4. Алгоритм подбора заменяемый и настраиваемый конфигурацией (порог по рейтингу, расширение окна, лимит ожидания, боты).
5. Детали: часть 2/4 (матчмейкинг) и часть 4/4 (Приложение A: `matchmaking.json`, Приложение C: HTTP API).

---

## 4. Границы модулей и контракты

### 4.1. Правила связности

1. `MatchServer` не обращается к PostgreSQL в рамках тика симуляции.
2. `MatchServer` не содержит бизнес-логики магазина/прогресса/покупок.
3. `MetaServer` не симулирует бой и не принимает решения симуляции.
4. Общие типы и контракты живут в `shared/` и версионируются.

### 4.2. Версии совместимости

1. `buildVersion` — версия клиента и серверов для диагностики и контроля совместимости.
2. `protocolVersion` — версия сетевого протокола клиент ↔ `MatchServer`.
3. `configVersion` — версия набора конфигураций `RuntimeConfig`.

---

## 5. Архитектура клиента

### 5.1. Слои клиента

1. `platform/*` — определение платформы и адаптеры (`*Adapter`, `IAuthProvider`, `IAdsProvider`, `IPaymentProvider`, `ISocialProvider`).
2. `services/*` — работа с HTTP API (`ApiClient`, сервисы профиля/магазина/аналитики).
3. `state/*` — `AppState` и селекторы.
4. `events/*` — `AppEvents`, шина событий приложения.
5. `ui/*` — `Preact` UI: экраны, компоненты, модальные окна, HUD-обвязка.
6. `battle/*` — `GameSession`, `BattleContainer`, жизненный цикл матча.
7. `input/*` — `InputManager`, джойстик и указатель, формирование команд ввода.
8. `network/*` — подключение к `MatchServer`, обработчики сообщений.
9. `rendering/*` — `RenderSystem`, эффекты, миникарта, отрисовка мира.
10. `net/smoothing.ts` — сглаживание отображения (клиентская интерполяция).

### 5.2. Контракты клиентского уровня

- `AppState`: профиль, инвентарь, валюты, витрины, прогресс, статус матча, статус платформенных функций, UI-состояние.
- `AppActions`: операции UI (авторизация, матчмейкинг, покупки, просмотр витрин, получение наград).
- `AppEvents`: события платформы, матча, экономики, ошибок и уведомлений.
- `UIFacade`: единственная точка доступа UI к операциям сервисов и платформенных функций.
- `GameSession`: управление матчем (подключение, ввод, события, завершение).
- `ScreenManager`: навигация по экранам и стеку модальных окон, обработка кнопки «назад».
- `HUDController`: ограничение частоты обновлений HUD и точечные обновления индикаторов.

---

## 6. UI слой клиента (`Preact`)

### 6.1. Область ответственности

1. Экранные потоки: лобби, матчмейкинг, профиль, магазин, боевой пропуск, рейтинги, достижения, настройки.
2. Модальные окна: награды, подтверждения, ошибки, потеря соединения, ограничения платформы.
3. HUD и внутриигровые оверлеи: панели, кнопки, окна результатов.

### 6.2. Ограничения производительности

1. UI не обновляется на каждом тике симуляции.
2. Часто меняющиеся значения HUD обновляются через `HUDController` с целевой частотой 5–10 раз в секунду.
3. UI получает агрегированные снимки состояния, а не сырой поток тиков.

### 6.3. Жизненный цикл контейнера боя

1. `BattleContainer` создаётся при входе в матч и уничтожается при выходе.
2. `RenderSystem` создаётся и уничтожается только из `BattleContainer`.
3. `Preact` управляет монтированием контейнера и отображением HUD/оверлеев.

---

## 7. Запуск в WebView и `iframe`

Требования:
1. Реакция на изменение размеров окна: ориентация, системные панели, клавиатура.
2. Поддержка безопасных отступов (верх/низ), чтобы UI не перекрывался.
3. Кнопка «назад» обрабатывается `ScreenManager` (возврат по стеку), без неконтролируемого закрытия приложения.
4. Запрет прокрутки страницы и выделения текста во время управления.

---

## 8. Архитектура `MatchServer`

### 8.1. Модель комнаты

1. Один матч = одна комната Colyseus.
2. Сервер авторитетен: клиент отправляет только ввод (`InputCommand`), сервер рассчитывает результат.
3. Симуляция фиксированным шагом времени: 30 тиков в секунду (`dt` фиксированный).

### 8.2. Ввод и валидация

1. Команды ввода валидируются по частоте и диапазонам значений.
2. Команды с неверными параметрами отклоняются и логируются.

### 8.3. Синхронизация состояния

1. Сервер рассылает состояние игрокам с контролем размера сообщений.
2. Клиентское сглаживание не влияет на расчёт симуляции.
3. При рассинхронизации серверное состояние имеет приоритет.

### 8.4. Завершение матча и `MatchSummary`

1. По завершении матча формируется `MatchSummary`.
2. `MatchSummary` передаётся в `MetaServer` асинхронно, с повтором при ошибке.
3. `MatchServer` не выполняет операции мета-экономики синхронно с тиком симуляции.

---

## 9. Общие требования к `shared/`

1. Общие типы: `UserId`, `SessionId`, `OfferId`, `Sku`, `ConfigVersion`, `BuildVersion`.
2. Типы конфигураций и валидация схем переиспользуются клиентом и серверами.
3. Общая математика и утилиты не дублируются.

---

## Открытые вопросы

1. Нет.

---

## 10. Навигация по частям

- Часть 2/4: `MetaServer`, платформенная абстракция, конфигурации, матчмейкинг.
- Часть 3/4: события, A/B тесты, безопасность, мониторинг, развёртывание, тестирование, рефакторинг.
- Часть 4/4: приложения A–F (детали конфигураций, БД, HTTP API, событий, A/B, безопасности).

---

## Глоссарий (общий)

| Термин | Описание |
|--------|----------|
| `MetaServer` | HTTP сервер мета-части: профиль, экономика, конфиги, монетизация |
| `MatchServer` | Сервер симуляции боя, авторитетный |
| `MatchmakingService` | Сервис подбора игроков и назначения матча |
| `MatchAssignment` | Данные подключения к матчу (`roomId`, `matchServerUrl`, `joinToken`) |
| `UIFacade` | Интерфейс, через который UI вызывает операции и получает ответы |
| `operationId` | Идентификатор операции для идемпотентности |
| `RuntimeConfig` | Конфигурации, влияющие на монетизацию и контент |
| `configVersion` | Версия набора конфигураций |
| `buildVersion` | Версия сборки клиента/сервера |
| `protocolVersion` | Версия сетевого протокола клиент ↔ `MatchServer` |
| `iframe` | Встраивание страницы в контейнер другой страницы |
| `liveOps` | Операции сопровождения через конфигурации и административные операции |