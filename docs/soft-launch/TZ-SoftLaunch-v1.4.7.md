# Техническое задание: Slime Arena — Софт-лонч

**Версия:** 1.4.7  
**Дата:** 5 января 2026  
**Статус:** Рабочая версия  
**Платформы софт-лонча:** Telegram Mini Apps, запуск во `iframe` (социальные сети)  
**Целевые рынки:** РФ, СНГ, Европа, США, Азия  

---

## 1. Цели и область применения

### 1.1. Цель документа

Задать требования к системам, необходимым для коммерческой эксплуатации игры в режиме софт-лонча.

### 1.2. Цели коммерческой разработки в софт-лонче

1. Проверить продуктовые метрики по воронке: вход → матч → повторные сессии → просмотр рекламы.
2. Обеспечить изменение монетизации и контента без изменения кода: цены, награды, лимиты, ротации, сезоны.
3. Обеспечить переносимость на другие платформы: изменения только в платформенных адаптерах и настройках.
4. Обеспечить эксплуатационную готовность: развёртывание, мониторинг, резервные копии, восстановление, управляемые обновления.

### 1.3. Критерии успеха софт-лонча

| Метрика | Целевое значение |
|---------|------------------|
| D1 Retention | > 30% |
| D7 Retention | > 12% |
| Средняя сессия | > 5 минут |
| Конверсия в просмотр рекламы | > 20% |
| Конверсия в платёж | N/A (платежи выключены в первой итерации софт-лонча) |
| Средний чек | > $2 |

### 1.4. Ограничения

1. В софт-лонче допускается один экземпляр серверного приложения.
2. Механики боя и физика считаются реализованными; документ описывает системы коммерческой эксплуатации.
3. Защита на уровне инфраструктуры от массовых сетевых атак не является требованием софт-лонча.
4. Реальные платежи в первой итерации софт-лонча выключены: `features.json` → `paymentsEnabled=false`.



## 1.5. Связанные документы

1. Архитектура Soft Launch: `SlimeArena-Architecture-v4.2.5-Part1..4.md`.
2. План Soft Launch: `SlimeArena-SoftLaunch-Plan-v1.0.4.md`.

---

## 2. Состав поставки софт-лонча

### 2.1. Клиент

1. Сборка веб-клиента под Telegram Mini Apps.
2. Сборка веб-клиента для запуска во `iframe` (адаптация UI и навигации).
3. Режим разработки `StandaloneAdapter` для локального запуска.

### 2.2. Сервер

1. `MatchServer` (Colyseus) для матчей.
2. `MetaServer` (HTTP API) для профиля, экономики, конфигов, матчмейкинга.
3. PostgreSQL и Redis.
4. Набор конфигураций `RuntimeConfig` и средство переключения `configVersion`.

---

## 3. Нормативные ссылки

1. Архитектура: `SlimeArena-Architecture-v4.2.5-Part1.md` … `Part4.md`.
2. Игровые правила: пакет GDD (`GDD-*.md`).

Для реализации данных и маршрутов HTTP API источником правды является Архитектура v4.2.5, часть 4/4:
- Приложение A — конфигурации
- Приложение B — схема БД
- Приложение C — HTTP API
- Приложение D — события
- Приложение E — A/B тесты
- Приложение F — безопасность

---

## 4. Ключевые требования к архитектуре

1. Сервер авторитетен: клиент не определяет награды и баланс.
2. Платформенные различия изолированы в `PlatformManager` и `*Adapter`.
3. Любые операции экономики идемпотентны по `operationId`.
4. Монетизация и контент управляются конфигурациями `RuntimeConfig`.
5. Клиентский UI реализован на `Preact`, рендер боя не выполняется через `Preact`.

---

## 5. Функциональные требования

### 5.1. Авторизация и сессии (P0)

Требования:
1. Вход выполняется через `IAuthProvider` платформы.
2. `MetaServer` верифицирует вход и выдаёт `accessToken`.
3. `accessToken` используется для всех защищённых запросов.
4. Сессия имеет срок действия и может быть отозвана.

Маршруты: Архитектура v4.2.5, часть 4/4, Приложение C (раздел “Авторизация”).

### 5.2. Загрузка конфигураций (P0)

Требования:
1. Клиент получает `RuntimeConfig` после успешного входа.
2. Клиент хранит `configVersion` и логирует применение.
3. При смене активной версии конфигураций сервер возвращает новую версию при следующем запросе.

Детали: Архитектура v4.2.5, часть 4/4, Приложение A и C.

### 5.3. Лобби и навигация (P0)

Требования:
1. Обязательные экраны: лобби, матчмейкинг, результаты, профиль (минимум).
2. Навигация через `ScreenManager` со стеком экранов и модальных окон.
3. Кнопка «назад» управляется `ScreenManager` и не закрывает приложение неконтролируемо.
4. Поддержка безопасных отступов и реакции на клавиатуру/ориентацию.

### 5.4. Матчмейкинг (P0)

Требования:
1. Игрок может встать в очередь, проверить статус, отменить очередь.
2. Назначение матча возвращает `MatchAssignment`, достаточный для подключения к `MatchServer`.
3. Повторные запросы клиента не создают дубликаты билетов и назначений.

Маршруты и контракты: Архитектура v4.2.5, часть 4/4, Приложение C (раздел “Матчмейкинг”).  
Параметры подбора: Архитектура v4.2.5, часть 4/4, Приложение A (`matchmaking.json`).

### 5.5. Матч и завершение (P0)

Требования:
1. Подключение к `MatchServer` выполняется по `MatchAssignment`.
2. По завершении матча `MatchServer` формирует `MatchSummary` и отправляет в `MetaServer`.
3. `MetaServer` применяет результаты матча к профилю, валюте, прогрессу миссий/достижений (если включены).

Требования к данным итога: `MatchSummary` должен содержать минимально:
- `matchId`, `mode`, `startedAt`, `endedAt`
- список игроков с `userId`, `position`, `kills`, `finalMass`
- рассчитанные награды и изменения прогресса

Хранение итогов: Архитектура v4.2.5, часть 4/4, Приложение B (`match_results`).

### 5.6. Валюты и транзакции (P0)

Требования:
1. Балансы валют хранятся на сервере.
2. Любое изменение баланса фиксируется в `transactions`.
3. Повтор операции с тем же `operationId` не меняет баланс повторно.

Схема БД: Архитектура v4.2.5, часть 4/4, Приложение B (`wallets`, `transactions`).

### 5.7. Магазин (P1)

Требования:
1. Каталог формируется из `RuntimeConfig`.
2. Покупка за валюту списывает баланс и выдаёт награду транзакционно.
3. Покупка за реальные деньги принимает подтверждение (`receipt`) и выдаёт награду только после серверной верификации.
4. Операции покупки идемпотентны по `operationId`.

Маршруты: Архитектура v4.2.5, часть 4/4, Приложение C (раздел “Магазин”).  
Схема БД: Архитектура v4.2.5, часть 4/4, Приложение B (`purchase_receipts`, `transactions`).

### 5.8. Реклама с наградой (P1)

Требования:
1. Показ рекламы инициируется платформенным `IAdsProvider` на клиенте.
2. После успешного просмотра клиент вызывает `/api/v1/ads/reward/claim` и передаёт `grantId` и `operationId`.
3. `grantId` должен существовать в активной конфигурации `economy.json` (`payload.grants[].grantId`).
4. Награда определяется сервером строго по конфигурации; клиент не передаёт количество награды.
5. Идемпотентность выдачи обеспечивается по (`userId`, `operationId`).
6. Лимиты просмотров и выдач управляются конфигурациями.

Маршруты: Архитектура v4.2.5, часть 4/4, Приложение C (раздел “Реклама с наградой”).  
Конфиги: Архитектура v4.2.5, часть 4/4, Приложение A (`economy.json`).

### 5.9. Боевой пропуск и достижения (P2)

Требования:
1. Прогресс хранится на сервере.
2. Награды выдаются только через сервер и фиксируются в `transactions`.
3. Конфигурации сезонов, уровней, миссий и достижений изменяемы без релиза клиента.

Маршруты и схема: Архитектура v4.2.5, часть 4/4, Приложение B и C.

### 5.10. Лидерборды (P2)

Требования:
1. Лидерборды доступны по сезону и режиму.
2. Источник ранжирования задаётся конфигурацией сезона.
3. Данные могут кешироваться в Redis, но результат должен быть воспроизводим из данных сервера.

Маршруты: Архитектура v4.2.5, часть 4/4, Приложение C (раздел “Лидерборды”).

---

## 6. Нефункциональные требования

### 6.1. Производительность

1. `MatchServer`: 30 тиков/сек, фиксированный `dt`.
2. UI не обновляется на каждом тике; HUD обновляется ограниченно через `HUDController`.
3. HTTP API: p99 времени ответа целевой уровень ≤ 500 мс на `prod` при штатной нагрузке софт-лонча.

### 6.2. Надёжность

1. При падении `MetaServer` пользователь может повторить критические операции без потерь из-за идемпотентности.
2. Резервное копирование PostgreSQL: ежедневно, хранение ≥ 14 дней, контрольное восстановление ≥ 1 раз в месяц.

### 6.3. Наблюдаемость

Требования:
1. Минимальный набор событий и метрик должен быть реализован до запуска.
2. Ошибки клиента и сервера агрегируются и доступны по `buildVersion` и `configVersion`.

Детали: Архитектура v4.2.5, часть 3/4 и часть 4/4 (Приложения D–E).

### 6.4. Безопасность

Требования:
1. Валидация входных данных.
2. Верификация платформенных данных.
3. Идемпотентность экономики.
4. Удаление данных пользователя с аудитом.

Детали: Архитектура v4.2.5, часть 4/4, Приложение F.

---

## 7. Критерии приёмки софт-лонча

### 7.1. Smoke-набор (обязателен)

1. Новый пользователь: вход → получение `RuntimeConfig` → старт матча → завершение → сохранение результатов.
2. Повторные запросы: повтор `purchase` и `ad_reward` с тем же `operationId` не меняет баланс повторно.
3. Матчмейкинг: join → status(waiting) → status(assigned) → подключение к комнате.
4. Смена `configVersion`: клиент получает новую версию без релиза.
5. `iframe` режим: корректные безопасные отступы, запрет прокрутки, работа кнопки «назад».

### 7.2. Минимальные отчёты

1. Логи ошибок клиента и сервера доступны в выбранной системе агрегации.
2. Метрики доступности API и ошибок доступны в дашборде.

---

## Глоссарий

| Термин | Описание |
|--------|----------|
| `MatchServer` | Сервер симуляции боя |
| `MetaServer` | HTTP сервер мета-части |
| `RuntimeConfig` | Набор конфигураций контента и монетизации |
| `configVersion` | Версия конфигураций |
| `operationId` | Ключ идемпотентности операций |
| `MatchSummary` | Итог матча для применения в `MetaServer` |
| `MatchAssignment` | Данные подключения к матчу |
| `receipt` | Подтверждение покупки платформы |
| `iframe` | Встраивание игры в контейнер соцсети |


---

## История изменений

### Версия 1.4.7 (5 января 2026)
- Обновлены нормативные ссылки на Архитектуру v4.2.5 (устранена устаревшая ссылка).

