# Slime Arena — План софт-лонча

**Версия:** 1.0.5  
**Дата:** 5 января 2026  

---

## 1. Назначение

План определяет порядок работ, критерии готовности и чек-листы релиза Soft Launch.

---

## 2. Источники правды

1. Требования Soft Launch: `TZ-SoftLaunch-v1.4.7.md`.
2. Архитектура Soft Launch: `SlimeArena-Architecture-v4.2.5-Part1..4.md`.
3. Игровые правила: пакет GDD (`GDD-*.md`).

---

## 3. Принципы планирования

1. `[MUST]` Выпускать только то, что измеряется метриками и не ломает экономику.
2. `[MUST]` Любые операции с ценностью (валюта, выдачи, покупки, реклама с наградой) должны быть идемпотентны через `operationId`.
3. `[MUST]` Все параметры монетизации и контента управляются конфигурациями и могут быть изменены без релиза клиента.
4. `[SHOULD]` Изменения в коде минимальны; расширения делаются через новые конфиги и новые `*Provider`.

---

## 4. Определение готовности Soft Launch

### 4.1. Обязательные критерии (release gate)

1. `[MUST]` Игрок может: войти → попасть в матч → завершить матч → увидеть результат → вернуться в лобби.
2. `[MUST]` Работают: `matchmaking/join`, `matchmaking/status`, `matchmaking/cancel`.
3. `[MUST]` Работают: покупки за валюту и выдачи наград, без дюпов (`operationId`).
4. `[MUST]` Работает: реклама с наградой, награда определяется сервером по `grantId`.
5. `[MUST]` Есть метрики и логи для диагностики падений и экономических операций.
6. `[MUST]` Есть резервное копирование PostgreSQL и подтверждённая процедура восстановления в `stage`.

### 4.2. Желательные критерии

1. `[SHOULD]` A/B тестирование конфигураций включено и проверено на небольшой аудитории.
2. `[SHOULD]` Технические события `aborted` матча фиксируются для аналитики.
3. `[SHOULD]` Лидерборды отображаются и обновляются без деградации.

---

## 5. Состав релиза Soft Launch

### 5.1. Клиент

1. `[MUST]` Платформы: Telegram Mini App и `iframe` (соцсети).
2. `[MUST]` Рендер боя: PixiJS (Canvas/WebGL).
3. `[MUST]` UI экранов: `Preact` + `ScreenManager`.
4. `[MUST]` Интеграция платформы через `IAuthProvider` и `IPaymentProvider` (если платежи включены на платформе).

### 5.2. Серверы

1. `[MUST]` `MatchServer` и `MetaServer` развёртываются как отдельные процессы.
2. `[MUST]` `MetaServer` использует `PostgreSQL` и `Redis` согласно Архитектуре.
3. `[MUST]` Контракты HTTP API и схемы БД — только из приложений (Архитектура часть 4/4).

---

### 5.3. Базовые параметры Soft Launch

1. `[MUST]` `resilience.json`: `reconnectWindowMs=15000`, `summaryTTL=86400000`.
2. `[MUST]` `matchmaking.json`: `allowBots=true`, `botsPerMatch=1`, `botRatingStrategy=median`.
3. `[SHOULD]` `matchmaking.json`: `botsAffectRating=false` на этапе софт-лонча.
4. `[MUST]` Политика `aborted`: награды не начисляются.
5. `[MUST]` Реальные платежи на этапе софт-лонча выключены: `features.json` → `paymentsEnabled=false`.


### 5.4. Целевые значения нагрузки

1. `[MUST]` `targetCCU=500` (одновременно играющих, пик).
2. `[MUST]` `playersPerRoom=10`.
3. `[MUST]` `targetRooms=60` (расчёт: `ceil(targetCCU / playersPerRoom)` + резерв).
4. `[MUST]` `targetRequestsPerSecond=100` для `MetaServer` (суммарно по всем маршрутам).

## 6. Этапы работ

### 6.1. Этап A — Подготовка окружений

Цель: получить `stage` и `prod` с минимальной наблюдаемостью.

Задачи:
1. `[MUST]` Поднять `PostgreSQL` и `Redis` для `stage`.
2. `[MUST]` Настроить резервное копирование и восстановление в `stage`.
3. `[MUST]` Настроить сбор логов и ошибок (минимально: ошибки + запросы + операции экономики).
4. `[MUST]` Поднять `MatchServer` и `MetaServer` в `stage`.

Критерии приёмки:
- `[MUST]` Выполняются smoke-проверки маршрутов из Приложения C.

### 6.2. Этап B — Функциональный минимум

Задачи:
1. `[MUST]` Авторизация и профиль.
2. `[MUST]` Матчмейкинг и старт матча.
3. `[MUST]` Завершение матча и запись `MatchSummary`.
4. `[MUST]` Магазин за валюту и выдачи в инвентарь.
5. `[MUST]` Реклама с наградой: `ads/reward/claim` с `grantId`.

Критерии приёмки:
- `[MUST]` Невозможна повторная выдача по одному `operationId`.
- `[MUST]` Все операции с ценностью пишутся в `transactions`.

### 6.3. Этап C — Монетизация и liveOps

Задачи:
1. `[MUST]` Конфигурации: `economy.json`, `shop.json`, `features.json`, `matchmaking.json`.
2. `[SHOULD]` A/B тесты конфигураций (`abtests.json`).
3. `[SHOULD]` Административные операции (минимум) и аудит.

Критерии приёмки:
- `[MUST]` Изменение конфигурации влияет на выдачи и магазин без релиза клиента.

### 6.4. Этап D — Тестирование и предрелиз

Задачи:
1. `[MUST]` Регрессионные проверки по чек-листу (раздел 7).
2. `[MUST]` Нагрузочные проверки (раздел 7.3).
3. `[MUST]` Проверка восстановления PostgreSQL из резервной копии на `stage`.
4. `[MUST]` Тестовый релиз на ограниченную аудиторию.

---

## 7. План тестирования

### 7.1. Smoke-проверки (после каждого развёртывания)

1. `[MUST]` `auth/verify`
2. `[MUST]` `player/get`
3. `[MUST]` `config/get`
4. `[MUST]` `matchmaking/join` → `status` → `cancel`
5. `[MUST]` `shop/catalog` → `shop/purchase` (валюта)
6. `[MUST]` `ads/reward/claim` (`grantId`)

### 7.2. Регрессия экономики

1. `[MUST]` Повтор одного запроса с тем же `operationId` не меняет баланс и не выдает награду повторно.
2. `[MUST]` Любой ответ операции возвращает актуальный `wallet`.

### 7.3. Нагрузочные проверки

Требования:
1. `[MUST]` Цели по нагрузке задаются переменными плана: `targetCCU`, `targetRooms`, `targetRequestsPerSecond`.
2. `[MUST]` Проверяются пиковый прогон (30–60 минут) и длительный прогон (2–4 часа).
3. `[MUST]` Критерии провала: доля ошибок, p95/p99 задержек, деградация тика, рост памяти, рост времени GC.

Численные пороги (софт-лонч):
- `MetaServer`: доля 5xx > 1% за 5 минут ИЛИ p99 > 2000 мс за 5 минут.
- `MatchServer`: p99 длительности тика > 20 мс за 5 минут ИЛИ рост памяти без стабилизации в течение 30 минут.
- `PostgreSQL`: рост времени запросов p99 > 200 мс на ключевых операциях экономики в течение 5 минут.


---

## 8. Риски

### 8.1. Митигации

1. Потеря данных экономики при ошибках идемпотентности.
   - `[MUST]` Нагрузочные и негативные тесты повторов `operationId` для всех операций с ценностью.
   - `[MUST]` Алерт по аномальному росту `transactions` и расхождению балансов.

2. Различия поведения WebView/`iframe` и проблемы с вводом/`safe-area`.
   - `[MUST]` Отдельный чек-лист UI для Telegram и `iframe`.
   - `[SHOULD]` Быстрый флаг отключения проблемных UI-элементов через `features.json`.

3. Непредсказуемость задержек и разрывов WebSocket на мобильных сетях.
   - `[MUST]` Тест переподключения в пределах `reconnectWindowMs`.
   - `[MUST]` Ретрай доставки `MatchSummary` в пределах `summaryTTL`.

4. Проблемы с платежами на отдельных платформах.
   - `[MUST]` Платежи выключены в первой итерации софт-лонча.

---

## 9. Решения по открытым вопросам

### 9.1. Рейтинг

1. `[MUST]` Алгоритм рейтинга: `Glicko-2`.
2. `[MUST]` Значения по умолчанию: `initialRating=1500`, `initialRD=350`, `initialSigma=0.06`, `tau=0.5`, `inactivityDays=14`.

### 9.2. Боты

1. `[MUST]` `botsPerMatch=1`.
2. `[MUST]` `botRatingStrategy=median`.
3. `[MUST]` `botsAffectRating=false` на этапе софт-лонча.

### 9.3. Абортированные матчи

1. `[MUST]` Награда за `match_aborted` не начисляется.
2. `[MUST]` Событие `match_aborted` отправляется в аналитику.

### 9.4. Реальные платежи

1. `[MUST]` На софт-лонче платежи выключены: `features.json` → `paymentsEnabled=false`.
2. `[MUST]` `/api/v1/shop/purchase/platform` возвращает `payments_disabled` и не меняет состояние.


---

## История изменений

### Версия 1.0.5 (5 января 2026)
- Обновлены ссылки на TZ-SoftLaunch v1.4.7 и Архитектуру v4.2.5.

