# Техническое задание: Система A/B тестирования

**Версия:** 1.3  
**Дата:** 9 января 2026  
**Автор:** Claude Opus 4.5  
**Статус:** Проект  
**Зависимости:** TZ-SoftLaunch, Sprint-Next-Mobile-Controls-Plan  
**Источники:** SlimeArena-abtest-Gemini, slime_arena_abtests_system_gpt_5_2_thinking

---

## 1. Цели и область применения

### 1.1. Цель документа

Определить архитектуру системы A/B тестирования для проведения экспериментов с различными игровыми параметрами без изменения кода.

Источник требования: TZ-SoftLaunch раздел 18, Sprint-Next-Mobile-Controls-Plan раздел 4.3.

### 1.2. Бизнес-цели

1. Оптимизация игрового опыта через статистически значимые эксперименты.
2. Тестирование настроек управления для улучшения отзывчивости на мобильных устройствах.
3. Тестирование вариантов монетизации, наград и контента.
4. Принятие решений на основе данных, а не предположений.

### 1.3. Области применения

| Категория | Примеры параметров | Уровень применения |
|-----------|-------------------|-------------------|
| Управление | Чувствительность джойстика, параметры Flight Assist | Матч |
| Баланс | Урон, скорость, параметры классов | Матч |
| Монетизация | Цены, скидки, содержимое предложений | Профиль |
| Контент | Стартовые скины, награды боевого пропуска | Профиль |
| Прогресс | Опыт за действия, пороги уровней | Профиль |
| Интерфейс | Расположение элементов, цветовые схемы | Сессия |

---

## 2. Принципы системы

### 2.1. Обязательные требования

1. `[MUST]` Вариант назначается один раз при создании профиля и сохраняется на весь срок жизни профиля.
2. `[MUST]` Назначение варианта детерминировано: один и тот же `userId` всегда получает один вариант.
3. `[MUST]` Все игроки в одном матче используют одинаковые параметры физики и баланса. **Смешивание вариантов в матче запрещено.**
4. `[MUST]` Изменения экспериментов применяются без развёртывания нового кода.
5. `[MUST]` Каждое событие аналитики содержит идентификаторы активных экспериментов и вариантов.
6. `[MUST]` Система поддерживает множество параллельных экспериментов.
7. `[MUST]` Конфигурация варианта хранится как патч поверх базового конфига, а не как полная копия.
8. `[MUST]` Источник правды для определений экспериментов — файл `config/abtests.json`. База данных хранит только назначения.

### 2.2. Желательные требования

1. `[SHOULD]` Быстрое переключение варианта для отладки через административный интерфейс.
2. `[SHOULD]` Автоматическая остановка эксперимента при превышении пороговых значений негативных метрик.
3. `[SHOULD]` Раздельные holdout-группы для контроля долгосрочных эффектов.
4. `[MAY]` Сегментация по устройствам, регионам, когортам.
5. `[MAY]` Постепенное увеличение выборки при запуске эксперимента.

---

## 3. Архитектура

### 3.1. Главная идея: Base + Overlay

Вместо хранения полных копий конфигурации для каждого варианта используется система слияния.

Компоненты:
1. Базовый конфиг (`config/balance.json`) — значения по умолчанию.
2. Конфиг экспериментов (`config/abtests.json`) — описание тестов и патчей.
3. Эффективный конфиг — результат слияния базы и патча варианта.

Преимущества подхода:
- Нет дублирования параметров.
- Можно тестировать любую ветку независимо.
- Легко отключать тесты и откатывать изменения.
- Клиент получает готовый конфиг.

### 3.2. Роль клиента

Клиент **не влияет на геймплей логикой эксперимента**. Клиент:
- Получает готовый эффективный конфиг от сервера.
- Получает массив `experiments[]` как технический контекст для аналитики.
- Прикладывает `experiments[]` к каждому событию аналитики.
- Не принимает решений на основе варианта.

### 3.3. Компоненты системы

| Компонент | Расположение | Ответственность |
|-----------|--------------|-----------------|
| ExperimentRegistry | MetaServer | Загрузка и валидация `config/abtests.json` |
| AssignmentService | MetaServer | Детерминированное назначение вариантов игрокам |
| ConfigResolver | MetaServer | Слияние базового конфига с патчами вариантов |
| ExperimentStore | PostgreSQL | Персистентное хранение назначений и переопределений |
| AnalyticsEnricher | Клиент/Сервер | Добавление контекста экспериментов в события |

### 3.4. Поток данных

```
┌─────────┐     POST /auth/verify      ┌────────────┐
│ Клиент  │ ─────────────────────────► │ MetaServer │
└─────────┘                            └─────┬──────┘
     ▲                                       │
     │                                       ▼
     │                              ┌────────────────┐
     │                              │ ExperimentReg  │
     │                              │ abtests.json   │
     │                              └───────┬────────┘
     │                                      │
     │                                      ▼
     │                              ┌────────────────┐
     │                              │ AssignmentSvc  │
     │                              │ hash(salt +    │
     │                              │ expId + usrId) │
     │                              └───────┬────────┘
     │                                      │
     │                                      ▼
     │                              ┌────────────────┐
     │                              │ ExperimentStore│
     │                              │ (PostgreSQL)   │
     │                              └───────┬────────┘
     │                                      │
     │                                      ▼
     │                              ┌────────────────┐
     │  effectiveConfig + variants  │ ConfigResolver │
     │◄─────────────────────────────│ base + overlay │
     │                              └────────────────┘
```

Описание потока:
1. Клиент запрашивает авторизацию или создание гостевого профиля.
2. ExperimentRegistry загружает определения из `config/abtests.json`.
3. AssignmentService проверяет наличие назначений для userId в базе данных.
4. Если назначений нет — вычисляет варианты через детерминированное хеширование.
5. Назначения сохраняются в ExperimentStore.
6. ConfigResolver формирует эффективный конфиг: базовый + патчи всех назначенных вариантов.
7. Клиент получает готовый конфиг и массив `experiments[]` для аналитики.

### 3.5. Уровни применения конфигурации

| Уровень | Момент применения | Срок жизни | Примеры |
|---------|------------------|------------|---------|
| Профиль | При создании/входе | Постоянно | Цены, награды, скины |
| Сессия | При старте приложения | До перезапуска | Интерфейс |
| Матч | При создании комнаты | До конца матча | Баланс, физика, управление |

---

## 4. Структуры данных

### 4.1. Эксперимент (в `config/abtests.json`)

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| experimentId | string | да | Уникальный идентификатор |
| name | string | да | Человекочитаемое название |
| description | string | нет | Описание гипотезы и целей |
| enabled | boolean | да | Активен ли эксперимент |
| salt | string | да | Соль для независимости распределений между экспериментами |
| startDate | string (ISO) | нет | Дата начала (null означает сразу) |
| endDate | string (ISO) | нет | Дата завершения (null означает бессрочно) |
| targetSampleSize | number | нет | Целевой размер выборки |
| configLayer | enum | да | Значения: profile, session, match |
| priority | number | да | Приоритет применения (выше число — выше приоритет) |
| mutexGroup | string | нет | Группа взаимоисключения (эксперименты в одной группе не применяются одновременно) |
| targetPlatforms | string[] | нет | Целевые платформы (telegram, yandex, poki) |
| targetDevices | string[] | нет | Целевые устройства (mobile, desktop) |
| variants | Variant[] | да | Список вариантов |
| defaultVariant | string | да | Вариант по умолчанию |
| metrics | string[] | да | Отслеживаемые метрики |
| guardrails | Guardrail[] | нет | Пороги для автоматической остановки |

### 4.2. Вариант

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| variantId | string | да | Идентификатор варианта |
| name | string | да | Название (A, B, Control) |
| weight | number | да | Вес распределения (0-100) |
| isControl | boolean | да | Контрольная группа |
| overlay | object | да | Патч параметров поверх базового конфига |

### 4.3. Назначение игрока (в БД)

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| userId | UUID | да | Идентификатор игрока |
| experimentId | string | да | Идентификатор эксперимента |
| variantId | string | да | Назначенный вариант |
| bucket | number | да | Номер корзины (0-9999) |
| assignedAt | timestamp | да | Дата назначения |

### 4.4. Guardrail (защитный порог)

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| metric | string | да | Название метрики |
| operator | enum | да | Значения: gt, lt, gte, lte |
| threshold | number | да | Пороговое значение |
| action | enum | да | Значения: alert, pause, stop |

### 4.5. Переопределение для отладки (в БД)

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| overrideId | UUID | да | Идентификатор переопределения |
| userId | UUID | да | Идентификатор игрока |
| experimentId | string | да | Идентификатор эксперимента |
| variantId | string | да | Принудительный вариант |
| reason | string | да | Причина переопределения |
| expiresAt | timestamp | нет | Срок действия |
| createdBy | string | да | Автор переопределения |
| createdAt | timestamp | да | Дата создания |

---

## 5. Алгоритм назначения

### 5.1. Детерминированное хеширование

Алгоритм обеспечивает воспроизводимость назначения без обязательного хранения результата.

**Формальная спецификация:**

Входные данные:
- salt — секретная соль эксперимента (строка UTF-8)
- experimentId — идентификатор эксперимента (строка UTF-8)
- userId — идентификатор игрока (строка UUID)

Последовательность вычисления:
1. Сформировать строку в UTF-8: `salt + ":" + experimentId + ":" + userId`.
2. Вычислить хеш SHA-256 от байтового представления строки.
3. Взять первые 4 байта хеша.
4. Интерпретировать как беззнаковое 32-битное целое (Big Endian).
5. Вычислить bucket как остаток от деления на 10000 (диапазон 0-9999).
6. Распределить по вариантам согласно весам.

Преимущества подхода:
- Стабильность: один userId всегда получает один вариант.
- Независимость тестов: разные соли перемешивают аудиторию.
- Масштабируемость: работает для любого числа вариантов и процентов трафика.

### 5.2. Распределение по весам

Веса задаются в процентах, сумма всех весов должна равняться 100.

Алгоритм распределения:
1. Отсортировать варианты по variantId для детерминизма.
2. Вычислить кумулятивные границы: variant[i].boundary = sum(weights[0..i]) × 100.
3. Найти первый вариант, где bucket < boundary.

Пример распределения для двух вариантов (50/50):
- Вариант A: boundary = 5000, buckets 0-4999
- Вариант B: boundary = 10000, buckets 5000-9999

### 5.3. Назначение и применение

**Принцип:** назначать всегда, применять по условиям.

Назначение варианта производится для **всех** игроков при первом входе, независимо от текущих условий. Это предотвращает дрейф когорты (игрок зашёл с desktop, не назначился, потом зашёл с mobile и остался без варианта).

**Применение overlay** происходит только при выполнении условий:
1. Эксперимент enabled = true.
2. Текущая дата в диапазоне [startDate, endDate].
3. Платформа игрока в targetPlatforms (если указано).
4. Устройство игрока в targetDevices (если указано).
5. Нет конфликта с mutexGroup.

Если условия не выполнены — overlay не применяется, но назначение сохраняется в БД.

Событие `ab_exposure` отправляется только при реальном применении overlay.

### 5.4. Разрешение конфликтов (mutexGroup)

Эксперименты в одной mutexGroup взаимоисключающи. Правила:
1. Если игрок назначен в несколько экспериментов одной группы — применяется эксперимент с **наибольшим priority**.
2. При одинаковом priority — выбирается эксперимент с меньшим experimentId (лексикографически) как fallback.
3. Остальные эксперименты группы не применяются, но назначения сохраняются.

---

## 6. Формирование конфигурации

### 6.1. Порядок слияния

1. Базовая конфигурация из `config/balance.json`.
2. Платформенные переопределения из `config/platforms/{platform}.json` (если есть).
3. Overlay каждого назначенного варианта **в порядке возрастания priority**.
4. Переопределения для отладки (если есть и не истекли).

### 6.2. Правила слияния (Deep Merge)

| Тип поля | Правило |
|----------|---------|
| Скалярное значение | Замена |
| Объект | Рекурсивное слияние |
| Массив | Замена целиком |

### 6.3. Валидация конфликтов overlay

При загрузке `config/abtests.json` система проверяет пересечение путей overlay.

**Правило MVP:** пересечение путей overlay между активными экспериментами одного configLayer **запрещено**.

Валидация при старте сервера:
1. Для каждой пары активных экспериментов с одинаковым configLayer.
2. Извлечь все пути из overlay каждого варианта (например, `controls.joystickDeadzone`).
3. Если пути пересекаются — эксперимент с меньшим priority не активируется.
4. Записать предупреждение в лог с указанием конфликтующих путей.

**Будущее расширение (Фаза 3):** разрешить пересечение при явном флаге `allowPathOverlap = true` и заданном priority.

---

## 7. Совместимость с матчмейкингом

### 7.1. Требование однородности

`[MUST]` Все игроки в матче используют одинаковые параметры симуляции. **Смешивание вариантов в одной комнате запрещено** для экспериментов уровня match.

Источник требования: Sprint-Next-Mobile-Controls-Plan раздел 2.

### 7.2. Механизм разделения очередей

Для экспериментов с configLayer = match:

1. Игрок получает варианты для всех активных match-экспериментов.
2. Формируется `matchConfigKey` — детерминированный отпечаток всех match-назначений:
   - Собрать все применимые match-эксперименты с их variantId.
   - Отсортировать по experimentId.
   - Сформировать строку: `exp1=varA,exp2=varB`.
   - Вычислить короткий хеш (CRC32 или первые 8 символов SHA-256).
3. Матчмейкер формирует ключ очереди: `{region}:{mode}:{matchConfigKey}`.
4. Игроки с разными matchConfigKey попадают в разные комнаты.
5. Комната фиксирует matchConfigKey и полный набор match-экспериментов при создании.

**Пример:**
- Игрок A: mobile-controls-v1=B, balance-test-v1=A → matchConfigKey = "abc123"
- Игрок B: mobile-controls-v1=B, balance-test-v1=A → matchConfigKey = "abc123" (совпадает)
- Игрок C: mobile-controls-v1=A, balance-test-v1=A → matchConfigKey = "def456" (разный)

### 7.3. Поведение при малом онлайне

**Смешивание вариантов запрещено.** При малом онлайне допустимые действия:

| Ситуация | Действие |
|----------|----------|
| Очередь > 60 сек | Увеличить радиус региона |
| Очередь > 120 сек | Добавить ботов до минимума |
| Онлайн < 50 CCU | Снизить allocation эксперимента до 10% |
| Критически мало игроков | Приостановить эксперимент (enabled = false) |

Событие `matchmaking_timeout` записывается в аналитику с контекстом эксперимента.

### 7.4. Fallback при сбое системы экспериментов

Если система экспериментов недоступна:
1. Матчмейкер игнорирует разделение по вариантам.
2. Все игроки получают базовый конфиг.
3. События помечаются `experiment_fallback = true`.
4. Эти матчи исключаются из анализа A/B теста.

---

## 8. Интеграция с аналитикой

### 8.1. Обогащение событий

Каждое событие аналитики дополняется контекстом экспериментов.

Обязательное поле `experiments` содержит массив объектов:
- experimentId — идентификатор эксперимента
- variantId — назначенный вариант

### 8.2. Специальные события

| Событие | Поля | Момент отправки |
|---------|------|-----------------|
| experiment_assigned | userId, experimentId, variantId, bucket | При первом назначении |
| ab_exposure | userId, experimentId, variantId, context | При реальном применении фичи |
| config_applied | userId, configVersion, experiments | При выдаче конфига |
| experiment_override | userId, experimentId, variantId, reason, author | При отладочном переопределении |
| experiment_rollback | experimentId, reason, affectedUsers | При откате эксперимента |
| guardrail_triggered | experimentId, metric, value, threshold, action | При срабатывании защиты |

### 8.3. Событие ab_exposure

Событие `ab_exposure` фиксирует момент, когда игрок реально столкнулся с изменённой функциональностью.

Примеры контекста:
- Для теста управления: первый матч с изменёнными параметрами.
- Для теста магазина: первое открытие магазина.
- Для теста наград: первое получение награды.

### 8.4. Метрики эксперимента

Минимальный набор для каждого эксперимента:
- Размер выборки по вариантам
- D1 retention по вариантам
- Основные метрики гипотезы
- Технические метрики (отключения, ошибки)

---

## 9. Guardrails и автоматическая остановка

### 9.1. Назначение

Guardrails защищают от негативного влияния эксперимента на продукт. При превышении пороговых значений система автоматически реагирует.

### 9.2. Типы действий

| Действие | Описание |
|----------|----------|
| alert | Отправка уведомления администратору |
| pause | Приостановка назначения новых игроков, существующие сохраняют вариант |
| stop | Полная остановка: откат всех игроков на базовый конфиг |

### 9.3. Рекомендуемые пороги для первого теста

| Метрика | Оператор | Порог | Действие |
|---------|----------|-------|----------|
| disconnect_rate | gt | 0.15 | alert |
| disconnect_rate | gt | 0.25 | stop |
| match_aborted_rate | gt | 0.10 | alert |
| match_aborted_rate | gt | 0.20 | stop |
| d1_retention_delta | lt | -0.05 | alert |
| d1_retention_delta | lt | -0.10 | stop |
| first_match_completion_rate | lt | 0.70 | alert |

### 9.4. Логика проверки

1. Guardrails проверяются периодически (рекомендуется раз в час).
2. Метрики вычисляются за последние 24 часа.
3. Сравниваются между вариантами (delta) или абсолютные значения.
4. При срабатывании порога выполняется указанное действие.
5. Событие `guardrail_triggered` записывается в лог.

---

## 10. Процедура отката (Rollback)

### 10.1. Триггеры отката

- Ручной запуск администратором.
- Автоматический при срабатывании guardrail с action = stop.
- Достижение endDate эксперимента.

### 10.2. Последовательность действий

1. Эксперимент помечается `enabled = false` в `config/abtests.json`.
2. Новые игроки не назначаются в эксперимент.
3. Существующие назначения сохраняются в БД для аналитики.
4. ConfigResolver исключает overlay эксперимента из слияния.
5. Все активные сессии получают обновлённый конфиг при следующем запросе.
6. Событие `experiment_rollback` отправляется в аналитику.

### 10.3. Влияние на текущие матчи

- Матчи в процессе **не прерываются**.
- Параметры матча фиксированы на момент создания комнаты.
- Новые матчи создаются с базовым конфигом.

---

## 11. Схема базы данных

### 11.1. Таблица user_experiment_assignments

Хранит назначения игроков в эксперименты.

| Колонка | Тип | Ограничения | Описание |
|---------|-----|-------------|----------|
| user_id | UUID | NOT NULL FK → users | Игрок |
| experiment_id | VARCHAR(64) | NOT NULL | Эксперимент |
| variant_id | VARCHAR(64) | NOT NULL | Вариант |
| bucket | INTEGER | NOT NULL | Номер корзины |
| assigned_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | Дата |
| PRIMARY KEY | — | (user_id, experiment_id) | — |

Индексы:
- `idx_assignments_experiment` на (experiment_id) для статистики.

### 11.2. Таблица experiment_overrides

Хранит переопределения для отладки.

| Колонка | Тип | Ограничения | Описание |
|---------|-----|-------------|----------|
| override_id | UUID | PRIMARY KEY DEFAULT gen_random_uuid() | Идентификатор |
| user_id | UUID | NOT NULL FK → users | Игрок |
| experiment_id | VARCHAR(64) | NOT NULL | Эксперимент |
| variant_id | VARCHAR(64) | NOT NULL | Принудительный вариант |
| reason | TEXT | NOT NULL | Причина |
| expires_at | TIMESTAMPTZ | — | Срок действия |
| created_by | VARCHAR(128) | NOT NULL | Автор |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | Дата |

Индексы:
- `idx_overrides_user_exp` на (user_id, experiment_id) UNIQUE для быстрого поиска.

### 11.3. Таблица experiment_audit_log

Хранит историю административных действий.

| Колонка | Тип | Ограничения | Описание |
|---------|-----|-------------|----------|
| log_id | UUID | PRIMARY KEY DEFAULT gen_random_uuid() | Идентификатор |
| experiment_id | VARCHAR(64) | NOT NULL | Эксперимент |
| action | VARCHAR(32) | NOT NULL | Действие (enable, disable, rollback, override) |
| actor | VARCHAR(128) | NOT NULL | Кто выполнил |
| details | JSONB | — | Дополнительные данные |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | Дата |

Правило: записи назначений **не удаляются** при отключении эксперимента (история для аналитики).

---

## 12. HTTP API

### 12.1. Публичные эндпоинты

**Получение конфигурации с назначениями:**

Метод: GET /api/config  
Заголовок: Authorization Bearer {token}

Ответ содержит:
- config — эффективный конфиг после слияния
- configVersion — хеш конфигурации для кеширования
- experiments — массив назначений [{experimentId, variantId}]

### 12.2. Административные эндпоинты

**Список активных экспериментов:**

Метод: GET /api/admin/experiments  
Заголовок: Authorization Bearer {adminToken}

**Статистика эксперимента:**

Метод: GET /api/admin/experiments/{id}/stats  
Заголовок: Authorization Bearer {adminToken}

Ответ содержит:
- sampleSize — размер выборки по вариантам
- metrics — значения метрик по вариантам
- guardrailStatus — статус защитных порогов

**Создание переопределения для отладки:**

Метод: POST /api/admin/experiments/{id}/overrides  
Заголовок: Authorization Bearer {adminToken}  
Тело: userId, variantId, reason, expiresAt (опционально)

**Просмотр варианта пользователя:**

Метод: GET /api/admin/users/{userId}/experiments  
Заголовок: Authorization Bearer {adminToken}

---

## 13. Первый эксперимент: Mobile Controls

### 13.1. Описание

Тестирование двух наборов параметров управления на мобильных устройствах для улучшения отзывчивости при поворотах.

Источник: Sprint-Next-Mobile-Controls-Plan раздел 4.2.

### 13.2. Конфигурация эксперимента

| Параметр | Значение |
|----------|----------|
| experimentId | mobile-controls-v1 |
| configLayer | match |
| priority | 100 |
| mutexGroup | controls |
| targetDevices | ["mobile"] |
| targetSampleSize | 10000 |

### 13.3. Варианты

**Вариант A (Stability) — Контроль:**

Overlay пустой, используются значения из базового конфига:
- controls.joystickDeadzone = 0.07
- controls.joystickSensitivity = 1.15
- controls.joystickFollowSpeed = 0.95
- assist.yawRateGain = 5.0
- assist.reactionTimeS = 0.11
- assist.angularStopTimeS = 0.15
- assist.angularBrakeBoostFactor = 1.8
- assist.counterAccelTimeS = 0.11
- assist.counterAccelDirectionThresholdDeg = 22

**Вариант B (Responsiveness):**

Overlay содержит отличия:
- controls.joystickDeadzone = 0.05
- controls.joystickSensitivity = 1.25
- controls.joystickFollowSpeed = 1.05
- assist.yawRateGain = 5.6
- assist.reactionTimeS = 0.10
- assist.angularStopTimeS = 0.13
- assist.angularBrakeBoostFactor = 2.0
- assist.counterAccelTimeS = 0.10
- assist.counterAccelDirectionThresholdDeg = 18

### 13.4. Метрики

Основные:
- turn_completion_time_90deg — время поворота на 90 градусов
- turn_completion_time_180deg — время поворота на 180 градусов
- oscillation_count — количество осцилляций при повороте
- d1_retention — возврат на следующий день
- first_match_completion_rate — доля завершённых первых матчей

Технические:
- disconnect_rate — доля отключений
- match_aborted_rate — доля прерванных матчей
- input_lag_p99 — задержка ввода (99 перцентиль)

### 13.5. Гипотеза

Вариант B улучшит время выполнения поворота на 15% без увеличения количества осцилляций, что приведёт к росту D1 retention на 2-3%.

### 13.6. Guardrails

| Метрика | Оператор | Порог | Действие |
|---------|----------|-------|----------|
| disconnect_rate | gt | 0.15 | alert |
| disconnect_rate | gt | 0.25 | stop |
| oscillation_count_delta | gt | 0.20 | alert |
| first_match_completion_rate | lt | 0.70 | alert |

---

## 14. Чек-лист внедрения

### 14.1. Фаза 1 — MVP

| Шаг | Описание | Критерий готовности |
|-----|----------|---------------------|
| 1 | Схема БД | Таблицы созданы, миграции работают |
| 2 | Файл config/abtests.json | Структура валидируется, первый тест описан |
| 3 | ConfigResolver | Base + overlay слияние работает |
| 4 | AssignmentService | Детерминированное назначение по хешу |
| 5 | Хранение назначений | Запись и чтение из БД |
| 6 | API получения конфига | Клиент получает эффективный конфиг |
| 7 | Обогащение аналитики | События содержат experiments[] |
| 8 | Разделение матчей | Матчмейкер учитывает variantId |
| 9 | Первый тест | mobile-controls-v1 запущен |

### 14.2. Фаза 2 — Расширение

| Шаг | Описание |
|-----|----------|
| 1 | Административный интерфейс |
| 2 | Переопределения для отладки |
| 3 | Guardrails и автоматическая остановка |
| 4 | Событие ab_exposure |
| 5 | Audit log |

### 14.3. Фаза 3 — Масштабирование

| Шаг | Описание |
|-----|----------|
| 1 | Сегментация аудитории |
| 2 | Постепенное увеличение выборки |
| 3 | Автоматическое завершение по выборке |
| 4 | Интерфейс анализа результатов |

---

## 15. Требования к качеству

### 15.1. Корректность

1. `[MUST]` Назначение детерминировано — повторный вызов возвращает тот же результат.
2. `[MUST]` Распределение соответствует заданным весам с погрешностью не более 1%.
3. `[MUST]` Все события содержат корректный контекст экспериментов.
4. `[MUST]` Overlay не изменяет базовый конфиг (иммутабельность).

### 15.2. Производительность

1. `[MUST]` Назначение выполняется менее чем за 50 мс (p99).
2. `[MUST]` Получение конфигурации выполняется менее чем за 100 мс (p99).
3. `[SHOULD]` Кеширование эффективного конфига на уровне сессии.

### 15.3. Надёжность

1. `[MUST]` Недоступность системы экспериментов не блокирует вход в игру.
2. `[MUST]` При ошибках используется конфигурация по умолчанию.
3. `[MUST]` Назначения сохраняются транзакционно.

---

## 16. Глоссарий

| Термин | Описание |
|--------|----------|
| Bucket | Числовой диапазон (0-9999) для распределения игроков по вариантам |
| ConfigLayer | Уровень применения конфигурации эксперимента (profile, session, match) |
| Deep Merge | Рекурсивное слияние объектов с заменой значений |
| Experiment | Определение A/B теста с вариантами и параметрами |
| Guardrail | Защитный порог для автоматической реакции на негативные метрики |
| Holdout | Контрольная группа, не получающая изменений |
| MatchConfigKey | Хеш всех match-назначений игрока для группировки в матчмейкинге |
| MutexGroup | Группа взаимоисключающих экспериментов |
| Overlay | Патч параметров, накладываемый поверх базового конфига |
| Override | Принудительное назначение варианта для отладки |
| Priority | Порядок применения overlay при конфликтах |
| Rollback | Процедура отката эксперимента к базовому конфигу |
| Salt | Строка-seed для независимости распределений между экспериментами |
| Variant | Один из вариантов эксперимента с набором переопределений |
| ab_exposure | Событие реального применения фичи эксперимента к игроку |

---

## История изменений

### Версия 1.3 (9 января 2026)

Изменения по результатам ревью DeepSeek, Gemini, ChatGPT (раунд 2):

- **Составной matchConfigKey** — поддержка нескольких match-экспериментов одновременно. Ключ очереди теперь включает хеш всех match-назначений.
- **Назначать всегда, применять по условиям** — предотвращает дрейф когорты. Назначение сохраняется в БД даже если условия не выполнены.
- **MutexGroup по priority** — при конфликте выбирается эксперимент с наибольшим priority, а не лексикографически.
- **Запрет пересечения путей overlay в MVP** — упрощает валидацию и предотвращает неожиданное поведение.
- **Исправлена формулировка salt** — это seed для независимости распределений, не секрет безопасности.

### Версия 1.2 (9 января 2026)

Изменения по результатам ревью DeepSeek, Gemini, ChatGPT:

- **Убран fallback со смешиванием вариантов** — противоречил MUST требованию. Добавлены альтернативы: боты, увеличение ожидания, снижение allocation.
- **Упрощена схема БД** — убраны таблицы experiments/experiment_variants. Источник правды — файл `config/abtests.json`.
- **Добавлены priority и mutexGroup** — для разрешения конфликтов между экспериментами.
- **Добавлена процедура отката (Rollback)** — раздел 10.
- **Уточнена роль клиента** — клиент не влияет на геймплей, только прикладывает experiments[] к аналитике.
- **Формализован алгоритм хеширования** — указаны кодировка, endian, точный формат строки.
- **Добавлен audit_log** — для истории административных действий.
- **Расширены guardrails** — добавлена метрика first_match_completion_rate.

### Версия 1.1 (8 января 2026)

- Добавлена концепция Base + Overlay.
- Добавлены Guardrails и автоматическая остановка.
- Добавлено событие ab_exposure.
- Добавлен чек-лист внедрения по фазам.

### Версия 1.0 (8 января 2026)

- Первоначальная версия документа.
