# Slime Arena — ТЗ: Минимальный мета-геймплей

**Версия:** 1.0  
**Дата:** 22 января 2026  
**Автор:** Claude Opus 4.5  
**Приоритет:** P0  
**Зависимости:** Архитектура v4.2.5, TZ-SoftLaunch-v1.4.7

---

## 1. Цель

Добавить минимальный мета-геймплей для удержания игроков:
- Гостевой режим для быстрого входа новых игроков
- Регистрация через OAuth для сохранения прогресса
- Профиль игрока с никнеймом и скином
- Накопительный рейтинг массы
- Таблица лидеров

---

## 2. Типы пользователей

### 2.1. Гость (anonymous)

Пользователь без регистрации.

| Параметр | Значение |
|----------|----------|
| `platformType` | `anonymous` |
| Никнейм | Случайный из списка |
| Скин | Случайный из базового набора |
| Рейтинг | Не накапливается |
| Сохранение прогресса | Нет |
| Срок жизни сессии | До закрытия браузера |

### 2.2. Зарегистрированный игрок

Пользователь, прошедший регистрацию через OAuth.

| Параметр | Значение |
|----------|----------|
| `platformType` | `google`, `yandex`, `telegram`, `vk` |
| Никнейм | Выбранный при регистрации |
| Скин | Закреплённый при регистрации |
| Рейтинг | Накапливается |
| Сохранение прогресса | Да |

---

## 3. Пользовательские сценарии

### 3.1. Первый вход нового игрока

1. Игрок открывает игру по ссылке или рекламе.
2. Система определяет платформу через `PlatformManager`.
3. Если платформа — Telegram Mini App: выполняется тихая авторизация.
4. Если платформа — веб-браузер без контекста: создаётся гостевая сессия.
5. Игрок попадает на экран лобби.
6. Система генерирует случайный никнейм и случайный скин.
7. Система предлагает выбор класса (один уже выбран по умолчанию).
8. Игрок нажимает кнопку «Играть!».

### 3.2. Завершение матча гостем

1. После завершения матча показывается экран результатов.
2. Если это первый матч гостя и результат выше порога — показывается предложение регистрации.
3. Предложение содержит:
   - Похвалу за результат
   - Информацию о награде (скин за регистрацию)
   - Две кнопки: «Сохранить прогресс» и «Сыграть ещё»
4. При выборе «Сыграть ещё»: возврат в лобби.
5. При выборе «Сохранить прогресс»: переход на экран регистрации.

### 3.3. Регистрация

1. Экран регистрации показывает доступные способы входа.
2. Для веб-браузера: Google и Яндекс.
3. Для Telegram Mini App: регистрация уже выполнена (тихая авторизация).
4. После успешной OAuth-авторизации:
   - Создаётся запись в таблице `users`
   - Гостевая сессия конвертируется в зарегистрированную
   - Результат первого матча записывается в рейтинг
   - Скин закрепляется за игроком
5. Игроку предлагается изменить никнейм (опционально).
6. После регистрации игрок возвращается в лобби.

### 3.4. Повторный вход зарегистрированного игрока

1. При загрузке страницы система проверяет наличие токена в `localStorage`.
2. Если токен валиден: автоматическая авторизация, переход на главный экран (`MainScreen`).
3. Если токен истёк или отсутствует: показывается лобби с гостевым режимом.
4. Кнопка «Войти» в верхнем правом углу лобби позволяет авторизоваться.

### 3.5. Авторизация существующего игрока

1. Игрок нажимает кнопку «Войти» в лобби.
2. Открывается модальное окно с выбором способа входа.
3. После успешной OAuth-авторизации:
   - Загружается профиль игрока
   - Восстанавливается никнейм, скин, рейтинг
4. Игрок попадает на главный экран (`MainScreen`).

---

## 4. Система рейтинга

### 4.1. Правила расчёта

| Параметр | Значение |
|----------|----------|
| Тип рейтинга | Накопительный |
| Единица измерения | Масса (кг) |
| Начальное значение | 0 |
| Начисление | После каждого матча |
| Формула | `newRating = currentRating + finalMass` |

### 4.2. Условия начисления

- Рейтинг начисляется только зарегистрированным игрокам.
- `finalMass` берётся из `MatchSummary.playerResults`.
- Начисление выполняется `MetaServer` при обработке результатов матча.
- Гостям рейтинг не начисляется.

### 4.3. Таблица лидеров

| Параметр | Значение |
|----------|----------|
| Режим | Глобальный |
| Сортировка | По убыванию рейтинга |
| Отображение | Топ-100 |
| Позиция игрока | Всегда видна |
| Обновление | При каждом запросе |

---

## 5. Изменения в базе данных

### 5.1. Новая таблица `total_mass_leaderboard`

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| `user_id` | UUID | PRIMARY KEY, FK → users.id | Игрок |
| `total_mass` | BIGINT | DEFAULT 0 | Накопленная масса |
| `matches_played` | INT | DEFAULT 0 | Количество матчей |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | Обновление |

Индексы:
- INDEX (`total_mass` DESC) — построение таблицы лидеров

### 5.2. Изменения в таблице `users`

Новые значения для поля `platform_type`:
- `anonymous` — гостевой пользователь
- `google` — OAuth через Google
- `yandex` — OAuth через Яндекс

Новые поля:

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| `registration_skin_id` | VARCHAR(100) | | Скин, полученный при регистрации |
| `converted_from` | UUID | FK → users.id | Гостевой аккаунт, который конвертирован |

### 5.3. Новая таблица `oauth_links`

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| `id` | UUID | PRIMARY KEY | Идентификатор |
| `user_id` | UUID | FK → users.id | Игрок |
| `provider` | VARCHAR(50) | NOT NULL | google, yandex |
| `provider_user_id` | VARCHAR(255) | NOT NULL | Идентификатор у провайдера |
| `email` | VARCHAR(255) | | Email |
| `created_at` | TIMESTAMP | DEFAULT NOW() | Создание |

Индексы:
- UNIQUE (`provider`, `provider_user_id`) — запрет дублей

---

## 6. Изменения в HTTP API

### 6.1. POST `/api/v1/auth/anonymous`

Назначение: создание гостевой сессии.

Запрос: пустой.

Ответ:

| Поле | Тип | Описание |
|------|-----|----------|
| `accessToken` | string | Токен API |
| `userId` | string | UUID |
| `nickname` | string | Сгенерированный никнейм |
| `skinId` | string | Сгенерированный скин |
| `isAnonymous` | boolean | `true` |

### 6.2. POST `/api/v1/auth/oauth`

Назначение: OAuth-авторизация или регистрация.

Запрос:

| Поле | Тип | Описание |
|------|-----|----------|
| `provider` | string | `google`, `yandex` |
| `code` | string | OAuth-код от провайдера |
| `redirectUri` | string | URI перенаправления |
| `anonymousToken` | string? | Токен гостевой сессии для конвертации |

Ответ:

| Поле | Тип | Описание |
|------|-----|----------|
| `accessToken` | string | Токен API |
| `userId` | string | UUID |
| `profile` | ProfileSummary | Данные профиля |
| `isNewUser` | boolean | Первая регистрация |
| `convertedFrom` | string? | UUID гостевого аккаунта |

### 6.3. POST `/api/v1/auth/convert`

Назначение: конвертация гостевого аккаунта в зарегистрированный.

Запрос:

| Поле | Тип | Описание |
|------|-----|----------|
| `provider` | string | `google`, `yandex` |
| `code` | string | OAuth-код |
| `redirectUri` | string | URI перенаправления |
| `nickname` | string? | Желаемый никнейм |

Заголовки: `Authorization: Bearer <anonymousAccessToken>`

Ответ: как `/auth/oauth`.

### 6.4. GET `/api/v1/leaderboard/total-mass`

Назначение: получение таблицы лидеров по накопленной массе.

Параметры запроса:

| Параметр | Тип | Описание |
|----------|-----|----------|
| `limit` | number | Количество записей (по умолчанию 100) |
| `offset` | number | Смещение (по умолчанию 0) |

Ответ:

| Поле | Тип | Описание |
|------|-----|----------|
| `entries` | array | Список записей |
| `myPosition` | number? | Позиция текущего игрока |
| `myTotalMass` | number? | Масса текущего игрока |

Структура записи:

| Поле | Тип | Описание |
|------|-----|----------|
| `position` | number | Место в рейтинге |
| `userId` | string | UUID |
| `nickname` | string | Никнейм |
| `skinId` | string | Скин |
| `totalMass` | number | Накопленная масса |
| `matchesPlayed` | number | Количество матчей |

### 6.5. POST `/api/v1/profile/registration-skin`

Назначение: фиксация скина при регистрации.

Запрос:

| Поле | Тип | Описание |
|------|-----|----------|
| `skinId` | string | Идентификатор скина |
| `operationId` | string | Ключ идемпотентности |

Ответ: обновлённый профиль.

---

## 7. Изменения в клиенте

### 7.1. Новые экраны

| Экран | Назначение |
|-------|------------|
| `RegistrationPromptModal` | Предложение регистрации после первого матча |
| `OAuthScreen` | Выбор способа входа |
| `NicknameEditModal` | Изменение никнейма при регистрации |

### 7.2. Изменения в экране лобби

| Элемент | Расположение | Описание |
|---------|--------------|----------|
| Кнопка «Войти» | Верхний правый угол | Для гостей, открывает `OAuthScreen` |
| Кнопка «Регистрация» | Верхний правый угол, рядом с «Войти» | Появляется после 2+ матчей гостя |
| Аватар/никнейм | Верхний правый угол | Для зарегистрированных, открывает профиль |
| Поле никнейма | Рядом с выбором класса | Редактирование для гостей |

### 7.3. Изменения в экране результатов

| Элемент | Условие показа | Описание |
|---------|----------------|----------|
| `RegistrationPromptModal` | Гость + масса ≥ 200 кг | Модальное окно с предложением |
| Текущий рейтинг | Зарегистрированный игрок | Показ накопленной массы |
| Прирост рейтинга | Зарегистрированный игрок | +X кг за этот матч |

### 7.4. Новый экран «Таблица лидеров»

| Элемент | Описание |
|---------|----------|
| Заголовок | «Таблица лидеров» |
| Список записей | Топ-100 игроков |
| Строка текущего игрока | Выделена, всегда видна |
| Кнопка «Закрыть» | Возврат на предыдущий экран |

### 7.5. Изменения в навигации

| Точка входа | Действие |
|-------------|----------|
| Кнопка в главном меню | Открывает экран таблицы лидеров |
| Кнопка на экране результатов | Открывает экран таблицы лидеров |

---

## 8. Серверная логика

### 8.1. Генерация гостевого никнейма

Формат: `{Прилагательное} {Существительное}`

Примеры:
- `Весёлый Слайм`
- `Быстрый Охотник`
- `Хитрый Собиратель`

Генерация уже реализована в текущей версии.

### 8.2. Генерация гостевого скина

- Выбор случайного скина из базового набора (`baseSkins` в `config/skins.json`).
- Гарантия отсутствия премиальных скинов.
- Скин связывается с гостевой сессией.

### 8.3. Конвертация гостевого аккаунта

1. Валидация OAuth-токена у провайдера.
2. Проверка отсутствия существующей привязки `oauth_links`.
3. Создание записи в `oauth_links`.
4. Обновление `users.platform_type` с `anonymous` на `google`/`yandex`.
5. Обновление `users.platform_id`.
6. Запись `users.registration_skin_id`.
7. Создание записи в `unlocked_items` для скина.
8. Создание записи в `total_mass_leaderboard` с результатом первого матча.
9. Запись в `audit_log`.

### 8.4. Обновление рейтинга после матча

Выполняется в `MetaServer` при обработке `MatchSummary`:

1. Для каждого `playerResult` с непустым `userId`:
2. Проверка существования записи в `total_mass_leaderboard`.
3. Обновление: `total_mass += finalMass`, `matches_played += 1`.
4. Запись в `transactions` с `source = 'match'`.

---

## 9. OAuth-интеграция

### 9.1. Google OAuth 2.0

| Параметр | Значение |
|----------|----------|
| Точка авторизации | `https://accounts.google.com/o/oauth2/v2/auth` |
| Точка токена | `https://oauth2.googleapis.com/token` |
| Точка информации о пользователе | `https://www.googleapis.com/oauth2/v2/userinfo` |
| Область доступа | `openid email profile` |

### 9.2. Яндекс OAuth

| Параметр | Значение |
|----------|----------|
| Точка авторизации | `https://oauth.yandex.ru/authorize` |
| Точка токена | `https://oauth.yandex.ru/token` |
| Точка информации о пользователе | `https://login.yandex.ru/info` |
| Область доступа | `login:info login:email` |

### 9.3. Конфигурация

OAuth-ключи хранятся в переменных окружения:

| Переменная | Описание |
|------------|----------|
| `GOOGLE_CLIENT_ID` | Идентификатор приложения Google |
| `GOOGLE_CLIENT_SECRET` | Секрет приложения Google |
| `YANDEX_CLIENT_ID` | Идентификатор приложения Яндекс |
| `YANDEX_CLIENT_SECRET` | Секрет приложения Яндекс |

---

## 10. Конфигурации

### 10.1. Изменения в `config/skins.json`

Новые поля:

| Поле | Тип | Описание |
|------|-----|----------|
| `baseSkins` | string[] | Скины для гостей |
| `registrationBonus` | boolean | Выдаётся ли при регистрации |

### 10.2. Новые поля в `config/features.json`

| Флаг | Описание |
|------|----------|
| `anonymousPlayEnabled` | Разрешён гостевой режим |
| `oauthGoogleEnabled` | Разрешена авторизация через Google |
| `oauthYandexEnabled` | Разрешена авторизация через Яндекс |
| `registrationPromptEnabled` | Показывать предложение регистрации |

---

## 11. Логика предложения регистрации

### 11.1. Предложение после удачного матча

| Параметр | Значение |
|----------|----------|
| Минимальная масса | 200 кг |
| Частота показа | После каждого удачного матча |

Логика: `finalMass >= 200 AND isAnonymous`

Показывается модальное окно `RegistrationPromptModal` с похвалой и предложением сохранить прогресс.

### 11.2. Кнопка «Регистрация» в лобби

После второго матча гостя (независимо от результата) в лобби рядом с кнопкой «Войти» появляется кнопка «Регистрация».

| Параметр | Значение |
|----------|----------|
| Условие появления | `matchCount >= 2 AND isAnonymous` |
| Расположение | Верхний правый угол, рядом с «Войти» |
| Действие | Открывает `OAuthScreen` |

Это позволяет удержать игроков, которые хотят зарегистрироваться, но не достигают порога 200 кг.

---

## 12. Требования к безопасности

1. OAuth-токены никогда не хранятся на клиенте.
2. `accessToken` имеет ограниченный срок действия (24 часа).
3. Конвертация гостевого аккаунта возможна только один раз.
4. Операции с рейтингом идемпотентны по `matchId`.
5. Валидация OAuth-токена выполняется только на сервере.
6. Защита от повторной регистрации по одному OAuth-аккаунту.

---

## 13. Критерии приёмки

### 13.1. Гостевой режим

- [ ] Новый игрок попадает в лобби без авторизации
- [ ] Генерируется случайный никнейм
- [ ] Генерируется случайный скин из базового набора
- [ ] Гость может играть матчи
- [ ] Рейтинг гостя не накапливается

### 13.2. Регистрация

- [ ] После удачного матча (≥200 кг) гостя показывается предложение регистрации
- [ ] После 2+ матчей в лобби появляется кнопка «Регистрация»
- [ ] Регистрация через Google работает
- [ ] Регистрация через Яндекс работает
- [ ] Скин закрепляется за игроком
- [ ] Результат первого матча записывается в рейтинг
- [ ] Никнейм можно изменить при регистрации

### 13.3. Авторизация

- [ ] Кнопка «Войти» видна гостям в лобби
- [ ] Повторный вход ведёт на главный экран (`MainScreen`)
- [ ] При истечении токена требуется повторная авторизация

### 13.4. Рейтинг

- [ ] После каждого матча рейтинг зарегистрированного игрока увеличивается
- [ ] Таблица лидеров показывает топ-100
- [ ] Позиция текущего игрока всегда видна
- [ ] Рейтинг обновляется корректно

---

## Глоссарий

| Термин | Описание |
|--------|----------|
| `accessToken` | Токен для авторизации запросов к API |
| `anonymousToken` | Токен гостевой сессии |
| `finalMass` | Масса слайма в конце матча |
| `localStorage` | Локальное хранилище браузера |
| `MainScreen` | Главный экран игры для зарегистрированных игроков |
| `MatchSummary` | Итоговые данные матча |
| OAuth | Протокол авторизации через сторонние сервисы |
| `PlatformManager` | Менеджер определения платформы |
| `platformType` | Тип платформы авторизации |
| `ProfileSummary` | Сводные данные профиля игрока |
| `skinId` | Идентификатор скина персонажа |
| `total_mass` | Накопленная масса (рейтинг) |
| UUID | Универсальный уникальный идентификатор |

---

## История изменений

### Версия 1.0 (22 января 2026)
- Первоначальная версия документа
