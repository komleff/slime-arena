# Slime Arena — ТЗ: Минимальный мета-геймплей

## Часть: Client

**Версия:** 1.9  
**Дата:** 23 января 2026  
**Аудитория:** Фронтенд-разработчики

**Связанные части:**
- `TZ-MetaGameplay-v1.9-Index.md` — приоритеты, критерии, глоссарий
- `TZ-MetaGameplay-v1.9-Core.md` — типы пользователей, сценарии

---

## 1. Новые экраны и компоненты

### 1.1. Экраны

| Компонент | Назначение |
|-----------|------------|
| `LeaderboardScreen` | Таблица лидеров с двумя вкладками |

### 1.2. Модальные окна

| Компонент | Назначение |
|-----------|------------|
| `RegistrationPromptModal` | Предложение сохранить прогресс после матча |
| `OAuthModal` | Выбор способа входа (Google / Яндекс) |
| `NicknameEditModal` | Редактирование никнейма при завершении профиля |

---

## 2. Изменения на существующих экранах

### 2.1. Главная (`LobbyScreen`)

| Элемент | Расположение | Условие |
|---------|--------------|---------|
| Кнопка «Войти» | Верхний правый угол | Только для Standalone-гостя |
| Аватар + никнейм | Верхний правый угол | Для зарегистрированных и Telegram-анонимов |
| Кнопка «Рейтинги» | Центральная область | Всегда |
| Кнопка «Арена» | Центральная область | Всегда |

**Поведение кнопки «Войти»:**
1. Открывает `OAuthModal`.
2. После успешного входа → загрузка профиля.
3. При ошибке 404 → сообщение «Аккаунт не найден».

### 2.2. Подготовка (`MatchmakingScreen`)

| Элемент | Расположение | Условие |
|---------|--------------|---------|
| Поле никнейма | Над выбором класса | Для гостей — редактируемое |
| Выбор класса | Центр | 3 кнопки, один выбран по умолчанию |
| Кнопка «Играть!» | Низ | Всегда |
| Кнопка «Назад» | Верхний левый угол | Всегда → Главная |

**Поведение поля никнейма:**
- Гость: редактируемое, изменения сохраняются в `localStorage.guest_nickname`.
- Зарегистрированный: только отображение, не редактируется.

### 2.3. Результаты (`ResultsScreen`)

| Элемент | Условие | Описание |
|---------|---------|----------|
| Финальная масса | Всегда | Показ `finalMass` |
| Место в матче | Всегда | 1-е, 2-е, 3-е и т.д. |
| `RegistrationPromptModal` | Гость/аноним + масса ≥ порога | Предложение сохранить прогресс |
| Текущий рейтинг | Зарегистрированный | Накопленная `total_mass` |
| Прирост рейтинга | Зарегистрированный | «+X кг» |
| Кнопка «Играть снова» | Всегда | → Подготовка |
| Кнопка «Выйти» | Всегда | → Главная |

**Логика показа `RegistrationPromptModal`:**
1. Проверить: пользователь гость **или** Telegram-аноним (`is_anonymous = true`).
2. Проверить: `finalMass >= registrationPromptMinMass`.
3. Если оба условия → показать модальное окно.

**После показа Результатов:**
1. Запросить `POST /match-results/claim` → получить `claimToken`.
2. Сохранить `claimToken` в `localStorage.registration_claim_token`.

---

## 3. LeaderboardScreen

### 3.1. Структура

| Элемент | Описание |
|---------|----------|
| Заголовок | «Таблица лидеров» |
| Переключатель | Две вкладки: «Накопительный» / «Рекордный» |
| Список | Топ-100 игроков (виртуализированный) |
| Строка игрока | Выделена, закреплена внизу списка |
| Кнопка «Закрыть» | Верхний правый угол → предыдущий экран |

### 3.2. Строка записи

| Поле | Описание |
|------|----------|
| Позиция | 1, 2, 3... |
| Аватар | Скин игрока |
| Никнейм | Имя игрока |
| Значение | Масса (кг) |

### 3.3. Поведение

1. По умолчанию открывается вкладка «Накопительный».
2. При переключении — запрос `GET /leaderboard?mode=total|best`.
3. Если игрок авторизован и `is_anonymous = false`:
   - Показать его позицию и значение внизу.
4. Если гость или аноним:
   - Строка игрока не показывается.

---

## 4. RegistrationPromptModal

### 4.1. Структура

| Элемент | Описание |
|---------|----------|
| Заголовок | «Отличный результат!» |
| Текст | «Сохрани прогресс, чтобы не потерять достижения» |
| Иконка | Скин игрока |
| Кнопка «Сохранить прогресс» | Основная, яркая |
| Кнопка «Сыграть ещё» | Вторичная, менее заметная |

### 4.2. Поведение

**«Сохранить прогресс»:**
- Standalone-гость → открыть `OAuthModal`.
- Telegram-аноним → открыть `NicknameEditModal` (или сразу `auth/upgrade`).

**«Сыграть ещё»:**
- Закрыть модальное окно.
- Перейти на Подготовку (`MatchmakingScreen`).

---

## 5. OAuthModal

### 5.1. Структура

| Элемент | Описание |
|---------|----------|
| Заголовок | «Войти» или «Сохранить прогресс» |
| Кнопка Google | Иконка + «Войти через Google» |
| Кнопка Яндекс | Иконка + «Войти через Яндекс» |
| Кнопка «Отмена» | Закрыть модальное окно |

### 5.2. Поведение при завершении профиля (convert_guest)

1. Нажатие на провайдера → запуск OAuth-флоу.
2. После получения `code` → открыть `NicknameEditModal`.
3. После ввода никнейма → `POST /auth/upgrade` режим `convert_guest`.

### 5.3. Поведение при входе в существующий аккаунт

1. Нажатие на провайдера → запуск OAuth-флоу.
2. После получения `code` → `POST /auth/oauth`.
3. Если 404 → показать ошибку «Аккаунт не найден».
4. Если успех → загрузить профиль, обновить UI.

---

## 6. NicknameEditModal

### 6.1. Структура

| Элемент | Описание |
|---------|----------|
| Заголовок | «Выбери имя» |
| Поле ввода | Предзаполнено текущим никнеймом |
| Счётчик символов | «X/20» |
| Кнопка «Сохранить» | Активна если валидный никнейм |
| Кнопка «Отмена» | Закрыть без сохранения |

### 6.2. Валидация

- Длина: 2–20 символов.
- Допустимые: буквы, цифры, пробел, дефис, подчёркивание.
- Запрещены: эмодзи, спецсимволы.

### 6.3. Поведение

1. При вводе — валидация в реальном времени.
2. Если невалидно — кнопка «Сохранить» неактивна, показать ошибку.
3. При нажатии «Сохранить»:
   - Если это часть завершения профиля → вызвать `auth/upgrade`.
   - Если это редактирование (P1) → вызвать `profile/nickname`.

---

## 7. Хранение в localStorage

### 7.1. Ключи

| Ключ | Тип | Описание |
|------|-----|----------|
| `guest_token` | string | JWT гостя |
| `guest_nickname` | string | Сгенерированный никнейм |
| `guest_skin_id` | string | Сгенерированный скин |
| `guest_class_id` | string | Последний выбранный класс |
| `registration_claim_token` | string | Последний `claimToken` для завершения профиля |
| `access_token` | string | JWT зарегистрированного или Telegram-анонима |

### 7.2. Очистка

**При успешном завершении профиля:**
- Удалить `guest_token`.
- Удалить `registration_claim_token`.
- Сохранить `access_token`.

**При выходе из аккаунта (P2):**
- Удалить `access_token`.
- Не удалять `guest_*` — они могут остаться для повторного гостевого режима.

---

## 8. Конфигурации

### 8.1. config/balance.json

| Параметр | Тип | Значение | Описание |
|----------|-----|----------|----------|
| `registrationPromptMinMass` | integer | 200 | Минимальная масса для показа предложения |
| `claimTokenTtlMinutes` | integer | 60 | Срок действия `claimToken` |

### 8.2. config/features.json

| Параметр | Тип | Значение | Описание |
|----------|-----|----------|----------|
| `enableRegistrationPrompt` | boolean | true | Показывать предложение регистрации |
| `enableLeaderboard` | boolean | true | Включить таблицу лидеров |

### 8.3. config/nicknames.json

```
{
  "adjectives": ["Happy", "Fast", "Green", "Blue", ...],
  "nouns": ["Slime", "Blob", "Jelly", "Cookie", ...]
}
```

### 8.4. config/skins.json

```
{
  "basic": ["slime_green", "slime_blue", "slime_red", ...],
  "premium": [...]
}
```

---

## 9. Аналитика

### 9.1. События

| Событие | Триггер | Параметры |
|---------|---------|-----------|
| `guest_created` | Создание гостевой сессии | `skinId`, `nickname` |
| `guest_match_completed` | Завершение матча гостем | `matchId`, `finalMass` |
| `registration_prompt_shown` | Показ `RegistrationPromptModal` | `matchId`, `finalMass` |
| `registration_prompt_accepted` | Нажатие «Сохранить прогресс» | `matchId` |
| `registration_prompt_declined` | Нажатие «Сыграть ещё» | `matchId` |
| `registration_completed` | Успешное завершение профиля | `authProvider`, `initialMass` |
| `leaderboard_viewed` | Открытие `LeaderboardScreen` | `mode`, `myPosition` |

### 9.2. Реализация

Использовать существующий `AnalyticsManager`:

```
AnalyticsManager.track('registration_prompt_shown', {
  matchId: matchId,
  finalMass: finalMass
});
```

---

## 10. Генерация данных гостя

### 10.1. Генерация никнейма

При первом входе гостя:

1. Загрузить `config/nicknames.json`.
2. Случайное прилагательное + существительное + число (1–99).
3. Сохранить в `localStorage.guest_nickname`.

### 10.2. Генерация скина

1. Загрузить `config/skins.json`.
2. Случайный выбор из `basic`.
3. Сохранить в `localStorage.guest_skin_id`.

### 10.3. Класс по умолчанию

1. Случайный из 3 классов или первый по порядку.
2. Сохранить в `localStorage.guest_class_id`.

---

## 11. Состояния UI

### 11.1. Индикаторы загрузки

| Действие | Индикатор |
|----------|-----------|
| Загрузка лидерборда | Spinner в центре списка |
| OAuth-флоу | Полноэкранный overlay |
| `auth/upgrade` | Кнопка disabled + spinner |

### 11.2. Обработка ошибок

| Ошибка | Действие |
|--------|----------|
| 404 на `auth/oauth` | Toast «Аккаунт не найден» |
| 409 на `auth/upgrade` | Toast «Аккаунт уже существует» |
| Сеть | Toast «Нет соединения» + retry |
| `claimToken` истёк | Toast «Сессия истекла, сыграйте ещё раз» |

---

## 12. Навигация

### 12.1. Переходы

| Откуда | Куда | Триггер |
|--------|------|---------|
| Главная | Подготовка | Кнопка «Арена» |
| Главная | Рейтинги | Кнопка «Рейтинги» |
| Подготовка | Главная | Кнопка «Назад» |
| Подготовка | Бой | Кнопка «Играть!» |
| Бой | Результаты | Конец матча |
| Результаты | Подготовка | Кнопка «Играть снова» |
| Результаты | Главная | Кнопка «Выйти» |
| Рейтинги | Предыдущий | Кнопка «Закрыть» |

### 12.2. Deep links (P2)

- `/leaderboard` → Рейтинги
- `/play` → Подготовка
