# Slime Arena — ТЗ: StandaloneAdapter с OAuth авторизацией

**Версия:** 1.9  
**Дата:** 31 января 2026  
**Автор:** Claude Opus 4.5 (Architect)  
**Приоритет:** P0  
**Зависимости:** TZ-MetaGameplay-v1.9, Architecture v4.2.5 Part4

---

## История изменений

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.9 | 31.01.2026 | Добавлен UNKNOWN в правило 9.3. Глоссарий: WebView, postMessage. Уточнён пример WebView. |
| 1.8 | 31.01.2026 | Уточнена формулировка критерия (1.4). Уточнено хранение state (4.2). |
| 1.7 | 31.01.2026 | Добавлен `UNKNOWN` в ответ `/auth/config`. Уточнён строгий режим. |
| 1.6 | 31.01.2026 | Раздел 1 переписан как техническое ограничение. |
| 1.5 | 31.01.2026 | Строгий fallback региона. Добавлен `oauth_intent`. |
| 1.4 | 31.01.2026 | Google скрывается для РФ. Унифицированы пути API. |
| 1.3 | 30.01.2026 | Очистка localStorage. Одноразовость `pendingAuthToken`. |
| 1.2 | 30.01.2026 | Добавлен `pendingAuthToken` для 409. |
| 1.1 | 30.01.2026 | Синхронизация с MetaGameplay v1.9. |
| 1.0 | 30.01.2026 | Первоначальная версия |

---

## 1. Ограничения по регионам

### 1.1. Правило

Для пользователей из региона РФ список провайдеров авторизации ограничен. Провайдер `google` **не должен быть доступен** в регионе `RU`. Это продуктовое ограничение.

### 1.2. Матрица доступности

| Регион | `google` | `yandex` | `vk` |
|--------|:--------:|:--------:|:----:|
| `RU` | ❌ запрещён | ✅ разрешён | ✅ при готовности (P1) |
| `CIS` | ✅ разрешён | ✅ разрешён | ✅ при готовности (P1) |
| `GLOBAL` | ✅ разрешён | ✅ разрешён | ❌ не показывать |
| `UNKNOWN` | ❌ запрещён | ✅ разрешён | ❌ не показывать |

### 1.3. Строгий режим

Если `oauthRegionDetectionStrict=true`, то при невозможности надёжно определить регион пользователь считается `UNKNOWN`, и применяется самый строгий набор (только `yandex`).

### 1.4. Критерий проверки

`GET /api/v1/auth/config` при определённом регионе `RU` или `UNKNOWN` **никогда** не возвращает `google` в списке провайдеров.

### 1.5. Конфигурируемость

| Требование | Описание |
|------------|----------|
| Региональные ограничения | Сервер определяет регион по IP и фильтрует провайдеров |
| Изменение политики | Без изменения кода — только конфигурация |
| Логирование | Запись авторизаций с IP для аудита |

---

## 2. Набор провайдеров

### 2.1. Приоритеты реализации

| Провайдер | Приоритет | Регионы |
|-----------|:---------:|---------|
| **Google OAuth** | P0 | Весь мир, **кроме РФ** |
| **Яндекс ID** | P0 | РФ, СНГ, весь мир |
| **VK ID** | P1 | РФ, СНГ |
| Mail.ru ID | P2 | СНГ |

### 2.2. Логика отображения провайдеров

В интерфейсе отображаются только провайдеры, которые **реализованы** и **разрешены** для региона пользователя.

| Регион | Доступные провайдеры (P0) | После реализации P1 |
|--------|---------------------------|---------------------|
| РФ | Яндекс ID | Яндекс ID, VK ID |
| СНГ | Яндекс ID, Google | Яндекс ID, VK ID, Google |
| Мир | Google, Яндекс ID | Google, Яндекс ID |

**Правило:** Провайдеры P1/P2 не отображаются до включения соответствующего флага и готовности реализации.

---

## 3. Архитектура

### 3.1. Синхронизация с MetaGameplay v1.9

| Правило | Описание |
|---------|----------|
| OAuth не создаёт пользователя | `POST /api/v1/auth/oauth` возвращает 404 если аккаунт не найден |
| Создание только через `auth/upgrade` | С `claimToken` после матча |
| Токены провайдера на клиенте не хранятся | Только `code` передаётся на сервер |
| Рейтинг только для `is_anonymous = false` | После завершения профиля |

### 3.2. Определение региона

| Метод | Приоритет | Описание |
|-------|:---------:|----------|
| GeoIP по IP-адресу | 1 | Основной способ |
| Accept-Language | 2 | Резервный, если GeoIP недоступен и `oauthRegionDetectionStrict=false` |
| Часовой пояс браузера | 3 | Дополнительный сигнал |

**Строгий режим (`oauthRegionDetectionStrict=true`, по умолчанию):**
- Если GeoIP недоступен или даёт неопределённый результат → регион фиксируется как `UNKNOWN`.
- Accept-Language и часовой пояс **не могут расширять** список провайдеров.
- Это обеспечивает выполнение ограничения раздела 1 при сбое GeoIP.

**Нестрогий режим (`oauthRegionDetectionStrict=false`):**
- Допускается резервное определение региона по Accept-Language и часовому поясу.

### 3.3. Способ открытия авторизации

| Платформа | Способ | Обоснование |
|-----------|--------|-------------|
| Компьютер | Всплывающее окно | Не теряется контекст игры |
| Мобильное устройство | Переход на страницу | Всплывающие окна блокируются |
| Встроенный браузер (например, Telegram) | Переход на страницу | Всплывающие окна не работают |

Перед переходом клиент сохраняет состояние в `localStorage`. После возврата — восстанавливает.

---

## 4. Интерфейс провайдера на клиенте

### 4.1. Обязанности

| Метод | Описание |
|-------|----------|
| `getProviderName()` | Возвращает идентификатор: `google`, `yandex`, `vk` |
| `generateState()` | Генерация CSRF-токена |
| `generatePKCE()` | Генерация `codeVerifier` и `codeChallenge` (если требуется) |
| `buildAuthUrl(state, codeChallenge?)` | Формирует URL авторизации |
| `getButtonConfig()` | Конфигурация кнопки (цвет, текст, иконка) |

Обмен `code` на токен происходит **только на сервере**.

### 4.2. Сценарий на клиенте

1. Пользователь нажимает кнопку провайдера.
2. Генерация `state` и PKCE (если требуется).
3. Сохранение временных данных:
   - `oauth_state` — CSRF-токен
   - `oauth_code_verifier` — PKCE (если требуется)
   - `oauth_provider` — идентификатор провайдера
   - `oauth_intent` — намерение: `login` или `convert_guest`
   - состояние игры (только для перехода на страницу)
   
   **Где хранить:** Для сценария с переходом на страницу — в `localStorage`. Для сценария со всплывающим окном допускается хранение в памяти.

4. Открытие URL провайдера (окно или переход).
5. Пользователь авторизуется у провайдера.
6. Провайдер возвращает `code` на `redirectUri`.
7. Клиент проверяет `state`.
8. Клиент отправляет запрос на сервер в зависимости от `oauth_intent`:
   - `login` → `POST /api/v1/auth/oauth`
   - `convert_guest` → `POST /api/v1/auth/upgrade`
9. **Обязательная очистка**: удалить `oauth_state`, `oauth_code_verifier`, `oauth_provider`, `oauth_intent`, сохранённое состояние игры.
10. Обработка ответа сервера.

**Важно:** Очистка выполняется **всегда** — и при успехе, и при ошибке.

### 4.3. Обработка возврата из авторизации

После возврата клиент обязан:

1. Проверить `state` (сравнить с сохранённым `oauth_state`).
2. Получить `code` из параметров URL.
3. Определить сценарий по сохранённому `oauth_intent`:
   - `login` → `POST /api/v1/auth/oauth`
   - `convert_guest` → `POST /api/v1/auth/upgrade`
4. Выполнить соответствующий запрос к API.
5. Удалить временные ключи из `localStorage`: `oauth_state`, `oauth_code_verifier`, `oauth_provider`, `oauth_intent`, состояние игры.

Для компьютера: закрыть окно, передать данные через `postMessage`.
Для мобильных: перенаправить на основное приложение.

---

## 5. Google OAuth 2.0 (P0)

### 5.1. Общая информация

| Параметр | Значение |
|----------|----------|
| Документация | developers.google.com/identity/protocols/oauth2 |
| Тип интеграции | Чистый OAuth 2.0 (без SDK) |
| Области доступа | `openid`, `email`, `profile` |
| Регионы | Весь мир, **кроме РФ** |

### 5.2. Точки доступа

| Назначение | URL |
|------------|-----|
| Авторизация | accounts.google.com/o/oauth2/v2/auth |
| Токен | oauth2.googleapis.com/token |
| Информация о пользователе | googleapis.com/oauth2/v2/userinfo |

### 5.3. Параметры запроса авторизации

| Параметр | Значение |
|----------|----------|
| `client_id` | Из конфигурации сервера |
| `redirect_uri` | Из белого списка |
| `response_type` | `code` |
| `scope` | `openid email profile` |
| `state` | CSRF-токен |

Для P0 параметры `access_type=offline` и `prompt=consent` **не используются**.

### 5.4. Данные пользователя

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | string | Уникальный идентификатор |
| `email` | string | Электронная почта |
| `name` | string | Полное имя |
| `picture` | string | URL аватарки |

---

## 6. Яндекс ID (P0)

### 6.1. Общая информация

| Параметр | Значение |
|----------|----------|
| Документация | yandex.ru/dev/id/doc/ |
| Тип интеграции | OAuth 2.0 |
| Области доступа | `login:info`, `login:email`, `login:avatar` |
| Регионы | Весь мир |

### 6.2. Точки доступа

| Назначение | URL |
|------------|-----|
| Авторизация | oauth.yandex.ru/authorize |
| Токен | oauth.yandex.ru/token |
| Информация о пользователе | login.yandex.ru/info |

### 6.3. Параметры запроса авторизации

| Параметр | Значение |
|----------|----------|
| `client_id` | Из конфигурации сервера |
| `redirect_uri` | Из белого списка |
| `response_type` | `code` |
| `scope` | `login:info login:email login:avatar` |
| `state` | CSRF-токен |
| `force_confirm` | `yes` |

### 6.4. Данные пользователя

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | string | Уникальный идентификатор |
| `login` | string | Логин |
| `display_name` | string | Отображаемое имя |
| `default_email` | string | Электронная почта (может быть пустым!) |
| `default_avatar_id` | string | Идентификатор аватарки |

**Важно:** Поле `default_email` может быть пустым. Логика регистрации должна работать без email.

---

## 7. VK ID (P1)

### 7.1. Общая информация

| Параметр | Значение |
|----------|----------|
| Документация | id.vk.com/about/business/go/docs |
| Тип интеграции | OAuth 2.0 + **обязательный PKCE** |
| Области доступа | `vkid.personal_info`, `email` |
| Регионы | РФ, СНГ |

### 7.2. Точки доступа

| Назначение | URL |
|------------|-----|
| Авторизация | id.vk.com/authorize |
| Токен | id.vk.com/oauth2/token |
| Информация о пользователе | id.vk.com/oauth2/user_info |

### 7.3. Параметры запроса авторизации

| Параметр | Значение |
|----------|----------|
| `client_id` | Из конфигурации сервера |
| `redirect_uri` | Из белого списка |
| `response_type` | `code` |
| `scope` | `vkid.personal_info email` |
| `state` | CSRF-токен |
| `code_challenge` | PKCE challenge (метод S256) |
| `code_challenge_method` | `S256` |

### 7.4. Данные пользователя

| Поле | Тип | Описание |
|------|-----|----------|
| `user_id` | string | Уникальный идентификатор |
| `first_name` | string | Имя |
| `last_name` | string | Фамилия |
| `avatar` | string | URL аватарки |
| `email` | string | Электронная почта (может быть пустым!) |

---

## 8. Изменения в базе данных

### 8.1. Таблица oauth_links

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Первичный ключ |
| `user_id` | UUID | Внешний ключ → users.id |
| `provider` | VARCHAR(32) | `google`, `yandex`, `vk`, `telegram` |
| `provider_user_id` | VARCHAR(255) | Идентификатор у провайдера |
| `provider_email` | VARCHAR(255) | Электронная почта (может быть пустым) |
| `provider_avatar_url` | TEXT | URL аватарки |
| `created_at` | TIMESTAMP | Дата создания |
| `updated_at` | TIMESTAMP | Дата обновления |

**Индексы:**
- Уникальный: `(provider, provider_user_id)`
- Обычный: `(user_id, provider)`

### 8.2. Поле platform_type в таблице users

В таблице `users` используется поле `platform_type` для хранения провайдера авторизации:

| Значение | Описание |
|----------|----------|
| `telegram` | Авторизация через Telegram |
| `google` | Авторизация через Google |
| `yandex` | Авторизация через Яндекс ID |
| `vk` | Авторизация через VK ID |

---

## 9. HTTP API

Все маршруты API имеют префикс `/api/v1`. Использование маршрутов без префикса считается ошибкой интеграции.

### 9.1. POST /api/v1/auth/oauth

**Назначение:** Вход в **существующий** аккаунт. Создание запрещено.

**Запрос:**

| Поле | Тип | Обязательно | Описание |
|------|-----|:-----------:|----------|
| `provider` | string | Да | `google`, `yandex`, `vk` |
| `code` | string | Да | Код авторизации |
| `redirectUri` | string | Да | URI (должен быть в белом списке) |
| `codeVerifier` | string | Для VK | PKCE verifier |

**Ответ (успех):**

| Поле | Тип | Описание |
|------|-----|----------|
| `accessToken` | string | JWT токен игры |
| `userId` | string | UUID пользователя |
| `profile` | ProfileSummary | Данные профиля |
| `isAnonymous` | boolean | Всегда `false` для OAuth |

**Ответ (ошибки):**

| Код | Описание | Действие клиента |
|----|----------|------------------|
| 400 | Невалидный code или provider | Показать ошибку |
| 401 | Ошибка авторизации у провайдера | Показать ошибку |
| **404** | **Аккаунт не найден** | Показать сообщение и кнопку «Сыграть как гость» |

### 9.2. POST /api/v1/auth/upgrade (режим convert_guest)

**Назначение:** Завершение профиля гостя с OAuth.

**Требует:** Заголовок `Authorization: Bearer <guestToken>`

**Запрос:**

| Поле | Тип | Обязательно | Описание |
|------|-----|:-----------:|----------|
| `mode` | string | Да | `convert_guest` |
| `provider` | string | Да | `google`, `yandex`, `vk` |
| `code` | string | Да | Код авторизации |
| `redirectUri` | string | Да | URI |
| `codeVerifier` | string | Для VK | PKCE verifier |
| `claimToken` | string | Да | JWT с результатом матча |
| `nickname` | string | Да | 2–20 символов |

**Ответ (успех):** Аналогичен `/api/v1/auth/oauth`

**Ответ (ошибки):**

| Код | Описание | Действие клиента |
|----|----------|------------------|
| 400 | Невалидные данные | Показать ошибку |
| 409 | OAuth уже привязан к другому аккаунту | Показать диалог конфликта |
| 410 | claimToken истёк или использован | Показать «Сыграйте ещё раз» |

### 9.3. GET /api/v1/auth/config

**Назначение:** Получение списка доступных провайдеров для текущего региона.

**Параметры:** Нет (регион определяется по IP)

**Ответ:**

| Поле | Тип | Описание |
|------|-----|----------|
| `region` | string | Определённый регион: `RU`, `CIS`, `GLOBAL`, `UNKNOWN` |
| `providers` | array | Список провайдеров |

**Структура элемента providers[]:**

| Поле | Тип | Описание |
|------|-----|----------|
| `name` | string | `google`, `yandex`, `vk` |
| `clientId` | string | Идентификатор приложения |
| `priority` | number | Порядок отображения (1 = первый) |
| `requiresPKCE` | boolean | Требуется PKCE |

**Правило:** Провайдер Google **не включается** в список для регионов `RU` и `UNKNOWN`.

### 9.4. POST /api/v1/auth/oauth/resolve

**Назначение:** Вход в существующий аккаунт после конфликта 409.

**Запрос:**

| Поле | Тип | Обязательно | Описание |
|------|-----|:-----------:|----------|
| `pendingAuthToken` | string | Да | Токен из ответа 409 |

**Ответ (успех):** Аналогичен `/api/v1/auth/oauth`

**Ответ (ошибки):**

| Код | Описание |
|----|----------|
| 400 | Невалидный или истёкший токен |
| 410 | Токен уже использован |

---

## 10. Обработка конфликта аккаунтов (409)

### 10.1. Сценарий

Игрок играл гостем, набрал массу 500. Решил сохранить прогресс через Яндекс. Но этот Яндекс ID уже привязан к другому аккаунту с массой 100.

### 10.2. Проблема одноразового кода

Код авторизации OAuth — **одноразовый**. После отправки в `POST /api/v1/auth/upgrade` он использован. Повторный вызов с тем же кодом невозможен.

**Решение:** При 409 сервер возвращает `pendingAuthToken` — временный токен с данными провайдера (срок жизни 5 минут). Клиент использует его для входа в существующий аккаунт без повторной авторизации.

### 10.3. Ответ сервера при 409

| Поле | Тип | Описание |
|------|-----|----------|
| `error` | string | `oauth_already_linked` |
| `pendingAuthToken` | string | Временный токен (JWT, 5 мин) |
| `existingAccount` | object | Данные существующего аккаунта |
| `existingAccount.userId` | string | UUID |
| `existingAccount.nickname` | string | Никнейм |
| `existingAccount.totalMass` | number | Накопленная масса |
| `existingAccount.avatarUrl` | string | URL аватарки |

### 10.4. Диалог выбора аккаунта

| Элемент | Описание |
|---------|----------|
| Заголовок | «Найден существующий аккаунт» |
| Текст | «Этот {Провайдер} уже привязан к другому аккаунту.» |
| Блок «Текущий» | Иконка, никнейм, масса текущего гостя |
| Блок «Найденный» | Иконка, никнейм, масса из `existingAccount` |
| Кнопка 1 | «Загрузить найденный» |
| Кнопка 2 | «Выбрать другой способ» |

### 10.5. Поведение кнопок

**«Загрузить найденный»:**
1. Вызвать `POST /api/v1/auth/oauth/resolve` с `pendingAuthToken`.
2. Сервер проверяет токен, возвращает `accessToken` существующего аккаунта.
3. Клиент отбрасывает `guestToken`, загружает профиль.
4. **Предупреждение:** «Текущий прогресс будет потерян».

**«Выбрать другой способ»:**
1. Закрыть диалог.
2. Вернуться к выбору провайдера.
3. `pendingAuthToken` не используется (истечёт через 5 минут).

### 10.6. Требования к pendingAuthToken

| Требование | Описание |
|------------|----------|
| **Одноразовость** | Сервер помечает токен как использованный после успешного `/resolve`. Повторное использование → 410. |
| **Хранение на сервере** | Кэш с временем жизни 5 минут. Ключ: хэш токена. |
| **Запрет хранения на клиенте** | Клиент не записывает токен в `localStorage`, URL или логи. Только в памяти. |
| **Формат** | JWT с полями: `provider`, `providerUserId`, `existingUserId`, `exp`. |

---

## 11. Безопасность

### 11.1. PKCE

| Провайдер | PKCE |
|-----------|:----:|
| VK ID | **Обязательно** |
| Google | Рекомендуется |
| Яндекс | Рекомендуется |

Для провайдеров, требующих PKCE, используется метод `S256`. `code_verifier` хранится только на клиенте до завершения авторизации и удаляется после возврата (успех или ошибка).

### 11.2. Параметр state

| Требование | Значение |
|------------|----------|
| Генерация | Криптографически случайная строка (32+ символов) |
| Хранение | `localStorage` (для перехода) или память (для окна) |
| Время жизни | 10 минут |
| Проверка | Строгое сравнение при возврате |

### 11.3. URI перенаправления

`redirectUri` выбирается из белого списка, заданного конфигурацией сервера для текущего окружения. Клиент не использует произвольные значения.

**Альтернатива (P2):** Вместо передачи полного `redirectUri` клиент передаёт ключ окружения (`prod`/`dev`), а сервер подставляет значение из конфигурации.

### 11.4. Ограничение частоты запросов

| Маршрут | Лимит |
|---------|-------|
| `POST /api/v1/auth/oauth` | 10 запросов/мин на IP |
| `POST /api/v1/auth/upgrade` | 5 запросов/мин на IP |
| `GET /api/v1/auth/config` | 60 запросов/мин на IP |
| `POST /api/v1/auth/oauth/resolve` | 5 запросов/мин на IP |

### 11.5. Хранение токенов

| Токен | Где хранить | Примечание |
|-------|-------------|------------|
| `accessToken` (игры) | `localStorage` | JWT, проверяется на сервере |
| `guestToken` | `localStorage` | JWT |
| `pendingAuthToken` | Память (не сохранять!) | Временный, 5 минут |
| Токены провайдера | **Нигде** | Используются только при обмене кода |

Для P0 refresh-токены провайдеров **не сохраняются**.

---

## 12. Аватарки

### 12.1. P0: Прямые ссылки

При регистрации сервер сохраняет URL аватарки от провайдера в `oauth_links.provider_avatar_url`.

### 12.2. P1: Копирование на собственное хранилище

| Причина | Описание |
|---------|----------|
| Стабильность | Провайдеры меняют форматы URL |
| Доступность | VK может быть заблокирован в некоторых странах |
| Приватность | Не раскрываем провайдеров в запросах клиента |

Скачивание аватарки выполняется **асинхронно** (фоновая задача), чтобы не блокировать вход игрока.

---

## 13. Конфигурация

### 13.1. Переменные окружения

| Переменная | Описание | Обязательно |
|------------|----------|:-----------:|
| `GOOGLE_CLIENT_ID` | Идентификатор приложения Google | Да (P0) |
| `GOOGLE_CLIENT_SECRET` | Секрет Google | Да (P0) |
| `YANDEX_CLIENT_ID` | Идентификатор приложения Яндекс | Да (P0) |
| `YANDEX_CLIENT_SECRET` | Секрет Яндекс | Да (P0) |
| `VK_CLIENT_ID` | Идентификатор приложения VK | Да (P1) |
| `VK_CLIENT_SECRET` | Секрет VK | Да (P1) |

### 13.2. Флаги конфигурации

| Флаг | Тип | Значение по умолчанию | Описание |
|------|-----|:---------------------:|----------|
| `oauthGoogleEnabled` | boolean | true | Включить Google глобально |
| `oauthYandexEnabled` | boolean | true | Включить Яндекс глобально |
| `oauthVKEnabled` | boolean | false | Включить VK (P1) |
| `oauthGoogleEnabledRU` | boolean | **false** | Google для региона РФ |
| `oauthRegionDetectionEnabled` | boolean | true | Определение региона по IP |
| `oauthRegionDetectionStrict` | boolean | **true** | При неудаче определения → строгий режим (только Яндекс) |

**Важно:** 
- Флаг `oauthGoogleEnabledRU` по умолчанию **выключен** для выполнения ограничения раздела 1.
- Флаг `oauthRegionDetectionStrict` по умолчанию **включен** — при сбое GeoIP применяется строгий набор провайдеров.

### 13.3. Регистрация приложений

| Провайдер | Консоль разработчика |
|-----------|---------------------|
| Google | console.cloud.google.com/apis/credentials |
| Яндекс | oauth.yandex.ru/client/new |
| VK ID | id.vk.com/about/business/go |

**Важно:** Регистрация приложений может занять 3–5 рабочих дней. Начать параллельно с разработкой.

---

## 14. Тестирование

### 14.1. Google OAuth (P0)

- [ ] Переход на страницу авторизации работает
- [ ] `POST /api/v1/auth/oauth` возвращает 404 для нового пользователя
- [ ] `POST /api/v1/auth/upgrade` создаёт пользователя с `claimToken`
- [ ] Повторный вход загружает существующий аккаунт
- [ ] Параметр `state` проверяется корректно
- [ ] Провайдер **не отображается** для региона РФ

### 14.2. Яндекс ID (P0)

- [ ] Переход на страницу авторизации работает
- [ ] Обработка случая email = пусто
- [ ] Аватарка загружается
- [ ] `POST /api/v1/auth/oauth` возвращает 404 для нового пользователя
- [ ] `POST /api/v1/auth/upgrade` работает

### 14.3. VK ID (P1)

- [ ] PKCE работает корректно
- [ ] Обработка случая email = пусто
- [ ] Аватарка загружается
- [ ] Приложение настроено на новый VK ID (не старый OAuth)

### 14.4. Интеграция

- [ ] `GET /api/v1/auth/config` возвращает провайдеров по региону
- [ ] Для РФ Google **не включён** в список
- [ ] Для Европы Google включён в список
- [ ] **При неопределённом регионе показывается только Яндекс** (строгий fallback)
- [ ] Переход на мобильном устройстве сохраняет и восстанавливает состояние
- [ ] Диалог конфликта показывается при 409
- [ ] `pendingAuthToken` позволяет войти без повторной авторизации
- [ ] `POST /api/v1/auth/oauth/resolve` работает корректно
- [ ] Ограничение частоты запросов работает
- [ ] `oauth_intent` корректно определяет сценарий (login/convert_guest)

### 14.5. Тесты на отказоустойчивость

- [ ] GeoIP сервис недоступен + `oauthRegionDetectionStrict=true` → `region=UNKNOWN`, доступен только `yandex`
- [ ] GeoIP сервис недоступен + `oauthRegionDetectionStrict=false` → резервное определение по Accept-Language
- [ ] Провайдер недоступен → понятное сообщение об ошибке
- [ ] Сетевая ошибка при обмене кода → повтор с задержкой
- [ ] Пользователь отозвал доступ у провайдера → 401, предложить переавторизацию

### 14.6. Особые случаи

- [ ] Вход через VK, находясь внутри WebView Telegram/Discord
- [ ] localStorage недоступен (режим инкогнито)
- [ ] Пользователь закрыл окно авторизации до завершения

---

## 15. План реализации

### 15.1. P0 — Обязательно

| Идентификатор | Задача | Оценка |
|---------------|--------|:------:|
| AUTH-1 | `GET /api/v1/auth/config` маршрут | 2ч |
| AUTH-2 | Сервис определения региона + резервный вариант | 3ч |
| AUTH-3 | Фабрика провайдеров + интерфейсы | 2ч |
| AUTH-4 | Клиент Google OAuth | 3ч |
| AUTH-5 | Сервер Google OAuth | 4ч |
| AUTH-6 | Клиент Яндекс ID | 3ч |
| AUTH-7 | Сервер Яндекс ID | 4ч |
| AUTH-8 | Интерфейс выбора провайдера | 4ч |
| AUTH-9 | Переход на мобильном + восстановление состояния | 3ч |
| AUTH-10 | Диалог конфликта + `pendingAuthToken` | 4ч |
| AUTH-11 | `POST /api/v1/auth/oauth/resolve` маршрут | 2ч |
| AUTH-12 | Тестирование Google | 2ч |
| AUTH-13 | Тестирование Яндекс | 2ч |

**Итого P0:** 38 часов (~5 рабочих дней)

### 15.2. P1 — После запуска

| Идентификатор | Задача | Оценка |
|---------------|--------|:------:|
| AUTH-14 | Клиент VK ID + PKCE | 4ч |
| AUTH-15 | Сервер VK ID | 4ч |
| AUTH-16 | Тестирование VK | 3ч |
| AUTH-17 | Копирование аватарок на хранилище | 4ч |

**Итого P1:** 15 часов

### 15.3. P2 — Будущее

- Mail.ru ID
- Apple ID
- Привязка/отвязка провайдеров
- Ключ окружения вместо полного `redirectUri`

---

## 16. Критерии приёмки

### 16.1. P0

- [ ] Google OAuth работает для входа в существующий аккаунт
- [ ] Google OAuth работает для `POST /api/v1/auth/upgrade` с `claimToken`
- [ ] Яндекс ID работает аналогично
- [ ] `POST /api/v1/auth/oauth` возвращает 404 если аккаунт не найден
- [ ] `POST /api/v1/auth/upgrade` возвращает 409 с `pendingAuthToken` при конфликте
- [ ] `POST /api/v1/auth/oauth/resolve` позволяет войти по `pendingAuthToken`
- [ ] `GET /api/v1/auth/config` возвращает провайдеров по региону
- [ ] **Google не включён в список для региона РФ**
- [ ] **При неопределённом регионе показывается только Яндекс**
- [ ] Переход на мобильном устройстве корректно сохраняет/восстанавливает состояние
- [ ] Диалог конфликта показывается при 409
- [ ] `oauth_intent` корректно определяет сценарий (login/convert_guest)
- [ ] PKCE реализован (готов для VK)
- [ ] Параметр `state` проверяется
- [ ] Ограничение частоты запросов работает

Во всех проверках используются маршруты `/api/v1/...`. Любые отличия путей считаются несоответствием ТЗ.

### 16.2. P1

- [ ] VK ID работает с PKCE
- [ ] Аватарки копируются на собственное хранилище

---

## 17. Глоссарий

| Термин | Описание |
|--------|----------|
| OAuth 2.0 | Протокол авторизации для делегирования доступа |
| PKCE | Расширение OAuth для защиты кода авторизации (метод S256) |
| Код авторизации (`code`) | Одноразовый код, обмениваемый на токен доступа |
| `state` | Параметр для защиты от CSRF-атак |
| `redirectUri` | URL возврата после авторизации у провайдера |
| GeoIP | Определение геолокации по IP-адресу |
| `claimToken` | JWT с результатом матча для завершения профиля |
| `pendingAuthToken` | Временный токен (5 мин) с данными провайдера для разрешения конфликта 409 |
| `oauth_intent` | Сохранённое намерение: `login` (вход) или `convert_guest` (завершение профиля) |
| JWT | JSON Web Token — формат токенов |
| UUID | Универсальный уникальный идентификатор |
| CSRF | Cross-Site Request Forgery — тип атаки |
| `localStorage` | Хранилище браузера для данных |
| Встроенный браузер (WebView) | Браузер внутри приложения (например, Telegram) |
| `postMessage` | Механизм обмена сообщениями между окнами браузера |
| StandaloneAdapter | Адаптер платформы для браузерной версии |
| MetaGameplay | Мета-система игры (авторизация, профиль, рейтинги) |

---

## 18. Ссылки

| Документ | Расположение |
|----------|--------------|
| MetaGameplay v1.9 | Внутренний документ |
| Google OAuth | developers.google.com/identity/protocols/oauth2 |
| Яндекс OAuth | yandex.ru/dev/id/doc/ |
| VK ID | id.vk.com/about/business/go/docs |

---

## История версий

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.9 | 31.01.2026 | UNKNOWN в правило 9.3. Глоссарий: WebView, postMessage. |
| 1.8 | 31.01.2026 | Уточнена формулировка критерия (1.4). Хранение state (4.2). |
| 1.7 | 31.01.2026 | Добавлен `UNKNOWN` в ответ API. Строгий режим. |
| 1.6 | 31.01.2026 | Раздел 1 переписан как техническое ограничение. |
| 1.5 | 31.01.2026 | Строгий fallback региона. Добавлен `oauth_intent`. |
| 1.4 | 31.01.2026 | Google скрывается для РФ. Унифицированы пути API. |
| 1.3 | 30.01.2026 | Очистка localStorage. Одноразовость `pendingAuthToken`. |
| 1.2 | 30.01.2026 | Добавлен `pendingAuthToken` для 409. |
| 1.1 | 30.01.2026 | Синхронизация с MetaGameplay v1.9. |
| 1.0 | 30.01.2026 | Первоначальная версия |
