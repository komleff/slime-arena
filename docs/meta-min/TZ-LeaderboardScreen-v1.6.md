# ТЗ: Экран лидеров (LeaderboardScreen)

**Версия:** 1.6  
**Дата:** 1 февраля 2026  
**Автор:** Claude Opus 4.5  
**Приоритет:** P0  
**Источники:** TZ-MetaGameplay-v1.9, ScreenMap-v1.6.1, UI-TZ-v1.6.1

---

## 1. Назначение

Экран отображает глобальную таблицу лидеров с двумя режимами. Позволяет игроку видеть топ-100 и свою позицию.

---

## 2. Точки входа

### 2.1. Кнопка на `LobbyScreen`

| Параметр | Значение |
|----------|----------|
| Расположение | Навигационная панель или боковое меню |
| Название | «Лидеры» |
| Иконка | `icon_menu_leaderboard.png` |
| Переход | `LeaderboardScreen` |

### 2.2. Кнопка на `MatchmakingScreen`

| Параметр | Значение |
|----------|----------|
| Расположение | Верхняя панель, рядом с кнопкой «Назад» |
| Название | «Лидеры» (компактно) или только иконка |
| Иконка | `icon_menu_leaderboard.png` |
| Переход | `LeaderboardScreen` |

**Поведение при нахождении матча:**

| Ситуация | Действие |
|----------|----------|
| Матч найден, пока открыт `LeaderboardScreen` | Автоматическое закрытие экрана лидеров, переход к матчу |
| Экран открыт из `LobbyScreen` (игрок не в очереди) | Автозакрытие не происходит |

---

## 3. Структура экрана

### 3.1. Общий макет

| Область | Содержимое |
|---------|------------|
| Заголовок | Название экрана («Лидеры»), кнопка «Закрыть» |
| Переключатель | Две вкладки |
| Список | Топ-100 игроков (виртуализированный) |
| Плашка игрока | Закреплённая строка с данными текущего пользователя |

### 3.2. Переключатель режимов

| Вкладка | Режим API | Описание |
|---------|-----------|----------|
| «Накопительный» | `mode=total` | Сумма массы за все матчи |
| «Рекордный» | `mode=best` | Лучший результат за один матч |

По умолчанию открывается вкладка «Накопительный».

---

## 4. Строка записи в списке

### 4.1. Структура строки

| Элемент | Описание | Режим | Источник данных |
|---------|----------|-------|-----------------|
| Позиция | Число (1, 2, 3...) | Оба | `position` |
| Миниатюра скина | Уменьшенное изображение слайма (32×32 или 40×40) | Оба | `skinId` |
| Никнейм | Имя игрока | Оба | `nickname` |
| Значение | Масса (игровое значение) | Оба | `totalMass` или `bestMass` |
| Количество матчей | Число проведённых матчей | Только «Накопительный» | `matchesPlayed` |

**Сортировка:** 
- Первичный ключ: значение массы по убыванию (`totalMass` для режима «Накопительный», `bestMass` для режима «Рекордный»)
- Вторичный ключ: время последнего обновления записи в таблице рейтинга по убыванию — при равной массе выше тот, кто достиг значения позже

**Видимость столбца «Количество матчей»:** 
- В режиме `mode=total` — столбец отображается
- В режиме `mode=best` — столбец скрыт, ширина остальных колонок адаптируется

**Обработка никнейма:**
- При длинном никнейме — обрезка с многоточием
- Если никнейм пустой или недоступен — показать «Игрок» + последние 4 символа `userId`

### 4.2. Визуальное выделение топ-3

| Позиция | Выделение |
|---------|-----------|
| 1 | Золотая рамка или фон |
| 2 | Серебряная рамка или фон |
| 3 | Бронзовая рамка или фон |
| 4–100 | Стандартный стиль |

---

## 5. Плашка текущего игрока

### 5.1. Концепция

Плашка игрока **всегда видна на экране**. Используется гибридная модель отображения.

### 5.2. Правила отображения

| Условие | Поведение |
|---------|-----------|
| Игрок в топ-100 и его строка видна в области прокрутки | Строка игрока подсвечивается в списке, закреплённая плашка скрыта |
| Игрок в топ-100, строка выше видимой области | Плашка закреплена **сверху** экрана |
| Игрок в топ-100, строка ниже видимой области | Плашка закреплена **снизу** экрана |
| Игрок вне топ-100 | Плашка закреплена **снизу** экрана |
| Нет данных о позиции (аноним) | Плашка закреплена **снизу** с пометкой «Не в рейтинге» |

**Логика:** Плашка указывает направление прокрутки к позиции игрока.

**Ключевое требование:** Кнопка «Сохранить прогресс» для анонимов должна быть доступна без прокрутки.

### 5.3. Состояния по типу игрока

#### Зарегистрированный игрок (`is_anonymous = false`)

| Элемент | Описание | Источник |
|---------|----------|----------|
| Позиция | Место в рейтинге | `myPosition` из API |
| Миниатюра скина | Скин игрока | Профиль |
| Никнейм | Имя игрока | Профиль |
| Значение | Масса | `myValue` из API |
| Количество матчей | Число матчей (только «Накопительный») | `myMatchesPlayed` из API |
| Выделение | Акцентный цвет фона | — |

#### Гость Standalone

| Элемент | Описание | Источник |
|---------|----------|----------|
| Позиция | «—» или «Не в рейтинге» | — |
| Миниатюра скина | Текущий скин | `localStorage.guest_skin_id` |
| Никнейм | Текущий никнейм | `localStorage.guest_nickname` |
| Значение | Результат последнего матча | `claimToken.finalMass` (приоритет) или `localStorage.last_match_mass` (резерв) |
| Кнопка | «Сохранить прогресс» | — |

#### Анонимный пользователь Telegram (`is_anonymous = true`)

| Элемент | Описание | Источник |
|---------|----------|----------|
| Позиция | «—» или «Не в рейтинге» | — |
| Миниатюра скина | Текущий скин | Профиль Telegram |
| Никнейм | Никнейм из Telegram (если доступен), иначе «Игрок» | Профиль Telegram |
| Значение | Результат последнего матча | `claimToken.finalMass` (приоритет) или `localStorage.last_match_mass` (резерв) |
| Кнопка | «Сохранить прогресс» | — |

### 5.4. Источник `claimToken` на клиенте

| Параметр | Значение |
|----------|----------|
| Ключ хранения | `localStorage.registration_claim_token` |
| Время жизни | Определяется конфигом `claimTokenTtlMinutes` (по умолчанию 60 мин) |
| Удаление | После успешного завершения профиля |
| Маршрут получения | `POST /api/v1/match-results/claim` |

### 5.5. Условия отображения плашки анонима

| Условие | Результат |
|---------|-----------|
| Есть валидный `claimToken` | Показать плашку с данными из токена |
| `claimToken` истёк, но есть `localStorage.last_match_mass` | Показать плашку с данными из хранилища |
| Нет данных о матчах | Показать плашку с текстом «Сыграйте матч, чтобы увидеть свой ранг» |
| Данные загружаются | Показать заглушку плашки (скелетон) |

### 5.6. Поведение кнопки «Сохранить прогресс»

| Тип пользователя | Действие |
|------------------|----------|
| Гость Standalone | Открыть `OAuthModal` |
| Анонимный пользователь Telegram | Открыть `NicknameEditModal` |

После успешного завершения профиля:
- Экран остаётся открытым
- Выполняется повторная загрузка рейтинга
- Плашка переключается на режим зарегистрированного игрока

---

## 6. Загрузка данных

### 6.1. Запрос к API

| Параметр | Значение |
|----------|----------|
| Метод | `GET` |
| Путь | `/api/v1/leaderboard` |
| Параметр `mode` | `total` или `best` |
| Параметр `limit` | `100` |
| Параметр `offset` | `0` |

**Авторизация:**
- Запрос **публичный** — топ-100 доступен без токена
- Поля `myPosition`, `myValue`, `myMatchesPlayed` возвращаются только при наличии валидного `accessToken` с `is_anonymous = false`
- Для анонимных пользователей (`is_anonymous = true`) эти поля не возвращаются, даже если токен есть

### 6.2. Структура ответа

| Поле | Тип | Условие | Описание |
|------|-----|---------|----------|
| `mode` | string | Всегда | Режим рейтинга |
| `entries` | array | Всегда | Массив записей |
| `myPosition` | integer | Только с `accessToken` и `is_anonymous = false` | Позиция текущего игрока |
| `myValue` | integer | Только с `accessToken` и `is_anonymous = false` | Значение текущего игрока |
| `myMatchesPlayed` | integer | Только для `mode=total` с авторизацией | Количество матчей текущего игрока |

**Примечание:** В режиме `mode=best` поле `myMatchesPlayed` **отсутствует** в ответе.

**Требование к бэкенду:** Добавить поле `myMatchesPlayed` в контракт `GET /api/v1/leaderboard` для режима `mode=total`.

### 6.3. Структура записи (`entries[]`)

| Поле | Тип | Режим | Описание |
|------|-----|-------|----------|
| `position` | integer | Оба | Место в рейтинге |
| `userId` | string | Оба | Идентификатор игрока |
| `nickname` | string | Оба | Никнейм |
| `skinId` | string | Оба | Идентификатор скина |
| `totalMass` | integer | «Накопительный» | Сумма массы |
| `matchesPlayed` | integer | «Накопительный» | Количество матчей |
| `bestMass` | integer | «Рекордный» | Лучший результат |

---

## 7. Поведение

### 7.1. При открытии экрана

1. Показать индикатор загрузки
2. Запросить данные с `mode=total`
3. Отобразить список
4. Определить видимость плашки согласно правилам раздела 5.2

### 7.2. При переключении вкладки

1. Показать индикатор загрузки в области списка
2. Запросить данные с соответствующим `mode`
3. Обновить список и плашку игрока
4. Скрыть или показать столбец «Количество матчей» в зависимости от режима

### 7.3. Кэширование

Данные кэшируются на время сессии экрана. При повторном переключении на вкладку использовать кэш.

**Принудительное обновление (жест потянуть вниз):**
1. Сбросить кэш для текущего режима
2. Перезапросить данные с сервера
3. Обновить список и плашку

### 7.4. Отслеживание видимости строки игрока

Если игрок в топ-100, клиент отслеживает положение его строки относительно видимой области:

| Положение строки | Действие |
|------------------|----------|
| Видна в области прокрутки | Скрыть закреплённую плашку, подсветить строку в списке |
| Выше видимой области | Показать закреплённую плашку **сверху** |
| Ниже видимой области | Показать закреплённую плашку **снизу** |

---

## 8. Обработка ошибок

| Ситуация | Действие |
|----------|----------|
| Сетевая ошибка | Уведомление «Нет соединения», кнопка «Повторить» |
| Ошибка сервера | Уведомление «Ошибка сервера», кнопка «Повторить» |
| Пустой список | Сообщение «Рейтинг пока пуст» |
| `claimToken` истёк | Использовать данные из `localStorage` или показать «Сыграйте матч» |
| `myPosition` = null для зарегистрированного | Показать «Вы пока не в рейтинге» |

---

## 9. Переходы

| Действие | Результат |
|----------|-----------|
| Кнопка «Закрыть» | Возврат на предыдущий экран |
| Кнопка «Сохранить прогресс» | `OAuthModal` или `NicknameEditModal` |
| Нажатие на строку игрока | Нет действия |
| Матч найден (из `MatchmakingScreen`) | Автозакрытие экрана, переход к матчу |

---

## 10. Визуальные требования

### 10.1. Миниатюра скина

| Параметр | Значение |
|----------|----------|
| Размер | 32×32 или 40×40 пикселей |
| Форма | Круг или скруглённый квадрат |
| Заглушка | При отсутствии ассета |

### 10.2. Виртуализация списка

Список из 100 записей должен использовать виртуализацию для плавной прокрутки на мобильных устройствах.

### 10.3. Закреплённая плашка

| Параметр | Значение |
|----------|----------|
| Позиция сверху | Фиксирована вверху экрана, если строка игрока выше видимой области |
| Позиция снизу | Фиксирована внизу экрана, если строка игрока ниже видимой области или игрок вне топ-100 |
| Тень | Снизу (для верхней плашки) или сверху (для нижней плашки) |
| Фон | Акцентный цвет |
| Видимость | Скрывается, если строка игрока видна в списке |

### 10.4. Выделение строки игрока в списке

| Параметр | Значение |
|----------|----------|
| Фон | Тот же акцентный цвет, что у закреплённой плашки |
| Применение | Только когда строка игрока видна в области прокрутки |

---

## 11. Сохранение данных последнего матча

Клиент сохраняет после каждого матча на `ResultsScreen`:

| Ключ | Значение | Источник |
|------|----------|----------|
| `last_match_id` | Идентификатор матча | `matchId` из `MatchSummary` |
| `last_match_mass` | Масса в конце матча | `finalMass` из `MatchSummary` |
| `registration_claim_token` | JWT с данными матча | Ответ `POST /api/v1/match-results/claim` |

Данные из `localStorage` используются как резервный источник для плашки анонима, если `claimToken` недоступен или истёк.

---

## 12. Критерии приёмки

### 12.1. Точки входа

- [ ] Кнопка «Лидеры» присутствует на `LobbyScreen`
- [ ] Кнопка «Лидеры» присутствует на `MatchmakingScreen`
- [ ] При нахождении матча экран автоматически закрывается

### 12.2. Переключатель режимов

- [ ] Переключатель «Накопительный» / «Рекордный» работает
- [ ] Загрузка данных при переключении вкладок
- [ ] Столбец «Количество матчей» виден только в режиме «Накопительный»
- [ ] В режиме «Рекордный» столбец скрыт, ширина колонок адаптируется

### 12.3. Список топ-100

- [ ] Топ-100 отображается с виртуализацией
- [ ] Топ-3 визуально выделены (золото, серебро, бронза)
- [ ] При длинном никнейме — обрезка с многоточием
- [ ] Пустой никнейм заменяется на резервное значение

### 12.4. Плашка игрока

- [ ] Плашка всегда видна на экране (закреплена сверху, снизу или подсвечена в списке)
- [ ] Если игрок в топ-100 и строка видна — подсветка в списке, плашка скрыта
- [ ] Если строка игрока выше видимой области — плашка закреплена сверху
- [ ] Если строка игрока ниже видимой области — плашка закреплена снизу
- [ ] Если игрок вне топ-100 — плашка закреплена снизу
- [ ] Плашка зарегистрированного показывает позицию и значение
- [ ] Плашка гостя Standalone показывает данные из `claimToken` или `localStorage`
- [ ] Плашка Telegram-анонима показывает никнейм из Telegram
- [ ] Плашка анонима показывает «Сыграйте матч», если нет данных
- [ ] Кнопка «Сохранить прогресс» доступна без прокрутки
- [ ] После завершения профиля экран перезагружает данные

### 12.5. Обработка ошибок

- [ ] Обработка сетевых ошибок с уведомлением
- [ ] Резервные данные при истёкшем `claimToken`
- [ ] Сообщение «Вы пока не в рейтинге» при `myPosition = null`

### 12.6. Навигация

- [ ] Кнопка «Закрыть» возвращает на предыдущий экран

---

## 13. Зависимости

| Компонент | Описание |
|-----------|----------|
| `GET /api/v1/leaderboard` | Серверный маршрут (публичный) |
| `POST /api/v1/match-results/claim` | Получение `claimToken` |
| `OAuthModal` | Модальное окно авторизации |
| `NicknameEditModal` | Модальное окно ввода никнейма |
| `ScreenManager` | Управление навигацией |
| `ResultsScreen` | Сохранение данных матча |

---

## 14. События аналитики

| Событие | Триггер | Параметры |
|---------|---------|-----------|
| `leaderboard_viewed` | Открытие экрана | `source` (`lobby`, `matchmaking`), `mode`, `myPosition` |
| `leaderboard_tab_switched` | Переключение вкладки | `mode` (`total`, `best`) |
| `leaderboard_save_progress_clicked` | Нажатие «Сохранить прогресс» | `userType` (`guest`, `telegram_anonymous`) |

---

## 15. Требования к бэкенду

Для реализации экрана необходимо обновить серверный контракт:

| Изменение | Описание |
|-----------|----------|
| Поле `myMatchesPlayed` | Добавить в ответ `GET /api/v1/leaderboard` для `mode=total` |
| Сортировка | Первичный ключ — значение массы по убыванию, вторичный — время обновления записи по убыванию |

---

## 16. Отложенные задачи (P2)

### 16.1. Эндпоинт истории матчей гостя

| Маршрут | Метод | Описание |
|---------|-------|----------|
| `/api/v1/match-results/last` | GET | Последний матч по `guestSubjectId` |

Реализовать при добавлении экрана «История матчей» или профиля гостя.

### 16.2. Профиль игрока по нажатию

Нажатие на строку в списке открывает профиль выбранного игрока.

### 16.3. Оптимизация позиции для больших таблиц

Если игроков более 1000, API может возвращать `myPosition = null` или «999+» для позиций за пределами топ-1000.

---

## Глоссарий

| Термин | Описание |
|--------|----------|
| `total_mass` | Накопленная масса за все матчи |
| `best_mass` | Лучший результат за один матч |
| `finalMass` | Масса в конце матча |
| `matchesPlayed` | Количество завершённых матчей игрока (поле записи) |
| `myMatchesPlayed` | Количество матчей текущего игрока (поле ответа API) |
| `is_anonymous` | Флаг незавершённого профиля в таблице `users` |
| `skinId` | Идентификатор скина персонажа |
| `myPosition` | Позиция текущего игрока в рейтинге |
| `myValue` | Значение метрики текущего игрока |
| `claimToken` | Краткоживущий JWT с данными последнего матча |
| `registration_claim_token` | Ключ хранения `claimToken` в `localStorage` |
| `claimTokenTtlMinutes` | Параметр конфига: время жизни `claimToken` в минутах |
| `guestToken` | Токен авторизации гостя Standalone |
| `guestSubjectId` | Идентификатор гостя из `guestToken` |
| `accessToken` | Токен авторизации зарегистрированного пользователя |
| `localStorage` | Локальное хранилище браузера |
| `last_match_id` | Ключ хранения идентификатора последнего матча |
| `last_match_mass` | Ключ хранения массы последнего матча |
| `guest` | Гость Standalone, работает по `guestToken` |
| `telegram_anonymous` | Игрок Telegram с `is_anonymous = true` |
| `registered` | Игрок с завершённым профилем, `is_anonymous = false` |
| `LobbyScreen` | Главный экран игры |
| `MatchmakingScreen` | Экран подбора матча |
| `LeaderboardScreen` | Экран таблицы лидеров |
| `ResultsScreen` | Экран итогов матча |
| `MatchSummary` | Итоговые данные матча |
| `OAuthModal` | Модальное окно выбора способа авторизации |
| `NicknameEditModal` | Модальное окно ввода никнейма |
| `ScreenManager` | Компонент управления стеком экранов и навигацией |
| `updated_at` | Время последнего обновления записи в таблице рейтинга (используется для вторичной сортировки) |

---

## История изменений

### Версия 1.6 (1 февраля 2026) — Финальная

- Плашка указывает направление: закреплена сверху (если строка игрока выше) или снизу (если ниже или вне топ-100)
- Убран SQL из требований, оставлено текстовое описание сортировки
- Уточнена связь сортировки с полями `totalMass`/`bestMass`
- Определён источник `updated_at` — время обновления записи в таблице рейтинга

### Версия 1.5 (1 февраля 2026)

- Плашка указывает направление прокрутки к позиции игрока
- Обновлены визуальные требования для плашки (тень сверху/снизу)
- Расширены критерии приёмки для разных положений плашки

### Версия 1.4 (1 февраля 2026)

- **Плашка всегда видна:** гибридная модель (закреплена внизу, скрывается только когда строка игрока видна в списке)
- Унификация пути API: `POST /api/v1/match-results/claim`
- Разделение логики для гостя Standalone и Telegram-анонима
- Никнейм Telegram-анонима берётся из профиля Telegram
- Убраны англицизмы из текста
- Добавлен раздел «Требования к бэкенду»
- Уточнение: автозакрытие только при переходе из `MatchmakingScreen`
- Добавлена отложенная задача по оптимизации позиции для больших таблиц

### Версия 1.3 (1 февраля 2026)

- Приоритет изменён на P0
- Аналитика: `leaderboard_viewed` вместо `leaderboard_opened`
- API: `myMatchesPlayed` только для `mode=total`
- Добавлено поведение при нахождении матча
- Авторизация: публичный запрос + «мои поля» только с токеном
- Вторичная сортировка при равных значениях

### Версия 1.2 (1 февраля 2026)

- Концепция «скользящей плашки»
- Названия режимов «Накопительный» / «Рекордный»
- Логика работы с `claimToken` для анонимов

### Версия 1.1 (1 февраля 2026)

- Добавлено поле `matchesPlayed`
- Сохранение данных в `localStorage`

### Версия 1.0 (1 февраля 2026)

- Первоначальная версия документа
