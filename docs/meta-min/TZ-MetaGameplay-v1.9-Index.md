# Slime Arena — ТЗ: Минимальный мета-геймплей

**Версия:** 1.9  
**Дата:** 23 января 2026  
**Автор:** Claude Opus 4.5  
**Приоритет:** P0  
**Этап:** MVP / Прототип

---

## Структура документации

Документ разбит на части по ролям для удобства работы ИИ-агентов:

| Часть | Файл | Для кого | Содержание |
|-------|------|----------|------------|
| **Index** | `TZ-MetaGameplay-v1.9-Index.md` | Все | Оглавление, зависимости, приоритеты, критерии приёмки, глоссарий |
| **Core** | `TZ-MetaGameplay-v1.9-Core.md` | Все | Цель, терминология, типы пользователей, платформы, сценарии, рейтинги |
| **Backend** | `TZ-MetaGameplay-v1.9-Backend.md` | Бэкенд | База данных, HTTP API, серверная логика, безопасность |
| **Client** | `TZ-MetaGameplay-v1.9-Client.md` | Фронтенд | Клиент, конфигурации, аналитика |

**Правило:** При работе над задачей агент загружает **Index + релевантную часть**.

---

## Зависимости

| Документ | Версия | Назначение |
|----------|--------|------------|
| Architecture v4.2.5 | Part 1-4 | Общая архитектура, схема БД, API |
| TZ-SoftLaunch | v1.4.7 | План soft-launch, платформенные требования |
| UI-TZ | v1.6.2 | Спецификация интерфейса |
| ScreenMap | v1.6.1 | Карта экранов и переходов |
| data-flow.md | — | Потоки данных между компонентами |

---

## Приоритеты реализации

### P0 — Обязательно для запуска

- [ ] `PlatformManager` + адаптеры (`TelegramAdapter`, `StandaloneAdapter`)
- [ ] Гостевой режим (`auth/guest`, `localStorage`)
- [ ] Telegram silent auth (`auth/telegram`, `is_anonymous = true`)
- [ ] OAuth вход (`auth/oauth` — только существующие аккаунты)
- [ ] `claimToken` (`match-results/claim`)
- [ ] Завершение профиля (`auth/upgrade` — оба режима)
- [ ] Накопительный рейтинг (`leaderboard_total_mass`)
- [ ] Рекордный рейтинг (`leaderboard_best_mass`)
- [ ] `LeaderboardScreen` с двумя вкладками

### P1 — Желательно для запуска

- [ ] События аналитики (7 событий)
- [ ] `POST /profile/nickname` (редактирование после регистрации)
- [ ] A/B-тест предложения (1-й vs 2-й матч)

### P2 — После запуска

- [ ] Защита от фарма рекордов (`players_in_match` ≥ N)
- [ ] VK, OK OAuth
- [ ] Недельные/месячные лидерборды

---

## Критерии приёмки

### Гостевой режим (P0)

- [ ] Новый игрок на Standalone может начать матч без регистрации
- [ ] Генерируются случайный никнейм и скин
- [ ] Данные сохраняются в `localStorage`
- [ ] `guestToken` получается через `POST /auth/guest`
- [ ] Рейтинг **не** начисляется

### Telegram-аноним (P0)

- [ ] При первом входе в Telegram создаётся `users` с `is_anonymous = true`
- [ ] Игрок получает `accessToken` без дополнительных вопросов
- [ ] Рейтинг **не** начисляется (пока `is_anonymous = true`)

### Завершение профиля (P0)

- [ ] После матча можно получить `claimToken` через `POST /match-results/claim`
- [ ] Standalone: `auth/upgrade` режим `convert_guest` работает с Google/Яндекс
- [ ] Telegram: `auth/upgrade` режим `complete_profile` работает
- [ ] Скин закрепляется (`registration_skin_id`)
- [ ] Рейтинги инициализируются из `claimToken.finalMass`
- [ ] `is_anonymous` становится `false`
- [ ] Повторное использование `claimToken` запрещено

### Рейтинги (P0)

- [ ] После каждого матча зарегистрированного `total_mass += finalMass`
- [ ] При новом рекорде `best_mass = max(best_mass, finalMass)`
- [ ] Идемпотентность: `rating_awards(user_id, match_id)` предотвращает дубли
- [ ] Топ-100 отображается в обоих режимах
- [ ] Позиция текущего игрока видна

### Авторизация (P0)

- [ ] Telegram: повторный вход восстанавливает сессию
- [ ] Standalone: вход в существующий аккаунт работает
- [ ] `POST /auth/oauth` для нового аккаунта возвращает 404

---

## Обязательные обновления документации

| Документ | Изменения |
|----------|-----------|
| Architecture v4.2.5 Part4 | Приложение B: таблицы, `is_anonymous`, `auth_provider`. Приложение C: API. |
| ScreenMap v1.6.1 | Использовать «Главная / Подготовка». Добавить `LeaderboardScreen`. |
| UI-TZ v1.6.2 | Кнопка «Войти», `LeaderboardScreen`, `RegistrationPromptModal`. |
| GDD-Core | Два рейтинга, типы пользователей. |

---

## Глоссарий

### Токены

| Термин | Описание |
|--------|----------|
| `accessToken` | JWT для зарегистрированных и Telegram-анонимов (24 ч) |
| `guestToken` | JWT для гостей Standalone (7 дней) |
| `joinToken` | Токен входа в матч = `accessToken` или `guestToken` |
| `claimToken` | Одноразовый JWT для завершения профиля (30-120 мин) |

### Платформа и авторизация

| Термин | Описание |
|--------|----------|
| `runtimePlatform` | Платформа выполнения: `telegram`, `standalone` |
| `authProvider` | Провайдер авторизации: `telegram`, `google`, `yandex` |
| `PlatformManager` | Компонент определения платформы |
| `IPlatformAdapter` | Интерфейс платформенного адаптера |
| `IAuthProvider` | Интерфейс провайдера авторизации |

### Типы пользователей

| Термин | Описание |
|--------|----------|
| `guest` | Гость Standalone, только `localStorage`, рейтинг не начисляется |
| `telegram_anonymous` | Telegram-пользователь с `is_anonymous = true`, рейтинг не начисляется |
| `registered` | Завершённый профиль, `is_anonymous = false`, рейтинг начисляется |
| `is_anonymous` | Флаг в `users`: `true` = профиль не завершён |

### Экраны

| Термин | Описание |
|--------|----------|
| `LobbyScreen` | Главная — центральный хаб навигации |
| `MatchmakingScreen` | Подготовка — выбор класса, ожидание матча |
| `BattleScreen` | Бой — игровой процесс |
| `ResultsScreen` | Результаты — итоги матча |
| `LeaderboardScreen` | Рейтинги — таблица лидеров |

### Устаревшие термины

| Устаревший | Актуальный |
|------------|------------|
| `MainScreen` | `LobbyScreen` (Главная) |
| «Лобби» (экран) | `LobbyScreen` (Главная) |
| «Lobby» (подготовка) | `MatchmakingScreen` (Подготовка) |
| `platformType` (в БД) | `auth_provider` |

### Рейтинги и БД

| Термин | Описание |
|--------|----------|
| `total_mass` | Накопленная масса (сумма за все матчи) |
| `best_mass` | Лучший результат за один матч |
| `finalMass` | Масса в конце матча |
| `guestSubjectId` | Идентификатор гостя из `guestToken` |
| `rating_awards` | Таблица идемпотентности начисления |
| `oauth_links` | Таблица привязок провайдеров |

---

## История изменений

### Версия 1.9 (23 января 2026)

**Структурные изменения:**
- Документ разбит на 4 части по ролям (Index, Core, Backend, Client)
- Каждая часть самодостаточна для своей аудитории

**Без изменений содержания** — v1.9 = v1.8 + разбиение.

### Версия 1.8 (22 января 2026)

**Критические исправления:**
- `joinToken` **всегда** JWT (`accessToken` или `guestToken`)
- Разделены `runtimePlatform` и `authProvider`
- Добавлен `telegram_anonymous` с `is_anonymous = true`
- Заменён `lastMatchId` на `claimToken` везде
- Добавлен `LeaderboardScreen` в таблицу экранов

**Улучшения:**
- Два режима `auth/upgrade`: `convert_guest` и `complete_profile`
- Правило: рейтинг начисляется только при `is_anonymous = false`
- Таблица синонимов для обратной совместимости

### Версия 1.7 (22 января 2026)
- Уточнены типы пользователей (Telegram-аноним)
- Разведены `runtimePlatform` и `authProvider`
- `claimToken` поддерживает оба режима

### Версия 1.6.1 (22 января 2026)
- Унифицирована терминология экранов

### Версия 1.6 (22 января 2026)
- Добавлен `PlatformManager`, `claimToken`
- Поддержка двух платформ
