## ТЗ: минимальный мета-геймплей (v0.6.x) — авторизация, профиль, рейтинг массы, лидерборд

**Версия:** 1.0
**Дата:** 22 января 2026
**Автор:** ChatGPT 5.2 Thinking

### 0) Контекст и источники правды

- Текущий клиент/сервер реализуют базовый цикл **Лобби → Матч → Результаты** (Results — частично), BootScreen ещё TODO.
- Платформы P0: **Telegram Mini App, Яндекс.Игры**.
- Для БД и HTTP API **единственный источник правды — Архитектура v4.2.5 Part4**; любые изменения контрактов требуют обновления Part4.
- В плане Soft Launch уже заложены MUST: **авторизация и профиль**, smoke включает `auth/verify` и `player/get`.
- UI-навигация: из Lobby есть переходы в `ProfileScreen` и `LeaderboardScreen` (по feature-флагу).
  `LeaderboardScreen` (минимум UI) описан в UI-TZ.

------

## 1) Цель

Добавить минимальный мета-геймплей:

1. **Авторизация** (включая «тихую» платформенную и явную по кнопке).
2. **Профиль игрока** (ник, фиксированный скин, статус гостя/зарегистрирован).
3. **Лидерборд** игроков по **рейтингу массы**.
4. **Рейтинг массы** считать максимально просто:

- после **каждого матча** рейтинг увеличивается на **итоговую массу игрока** в конце матча;
- до регистрации игрока нельзя отвлекать вопросами авторизации;
- регистрация должна “сохранять прогресс” и закреплять «удачливый» скин.

------

## 2) Термины и правила

- **Guest / Anonymous** — игрок без регистрации (но может иметь серверную сессию).
- **Registered** — игрок с подтверждённой авторизацией (платформа или OAuth).
- **MassRating (CareerMassTotal)** — накопительная сумма итоговой массы за матчи (см. логику ниже).
- **Lucky skin** — скин, с которым игрок сыграл матч, после которого ему предложили регистрацию.

------

## 3) Пользовательский флоу (обязательный)

### 3.1 Первый запуск (новый игрок)

1. Игрок заходит по ссылке/рекламе.
2. **Переходит в Lobby**, не проходя явную регистрацию.
3. Ему назначаются:
   - случайный ник,
   - случайный скин (будущий «удачливый»),
   - предлагается выбрать **1 из 3 классов** (один выбран заранее),
   - CTA: **«Играть!»**.

> Примечание: в текущей сборке реализовано 4 класса. Решение «показывать 3» сделать через конфиг/фичефлаг (чтобы не ломать боевую часть).

### 3.2 Возвратный игрок

- Игра пытается **авторизовать автоматически** (по сохранённой сессии/платформе).
- В Lobby кнопка **Login / Sign In** спрятана в углу (верхний правый), чтобы не мешать онбордингу новых игроков.

### 3.3 После матча (Results)

- Показывается ResultsScreen (как сейчас).
- Дополнительно: если игрок **ещё не зарегистрирован**, показать оффер:
  - текст: «Отличный результат для новичка! Хочешь сохранить прогресс и получить этот удачливый скин?»
  - кнопки:
    - **(A) Да, сохранить!**
    - **(B) Сыграть ещё**

Триггер показа (минимум, без A/B):

- показывать всегда после матча **или** только при «достойном» результате. Рекомендуемый порог: итоговая масса ≥ **300 кг** (примерно уровень 3 по текущим порогам).

Поведение:

- (B) → вернуть в Lobby, дать поменять ник (если гость) и класс.
- (A) → переход на экран регистрации/логина.

------

## 4) Экраны и UI (минимум)

### 4.1 LobbyScreen

- В правом верхнем углу: кнопка **Login / Sign In** для уже зарегистрированных (и для гостей, желающих зарегистрироваться).
- Для гостя:
  - ник editable,
  - выбор класса (3 варианта),
  - кнопка «Играть!».
- Для зарегистрированного:
  - ник read-only,
  - скин read-only,
  - класс можно менять для следующего матча (как сейчас).

### 4.2 ResultsScreen

- После показа результатов: оффер регистрации (см. 3.3).

### 4.3 Registration / Auth Screen (новый экран)

Назначение: привязать аккаунт и “сохранить прогресс”.

- Показывает:
  - «удачливый» скин (превью),
  - поле ника (editable **только здесь** для будущего зарегистрированного профиля),
  - способы входа:
    - **Google**
    - **Яндекс**
  - кнопка «Назад» (возврат в Results или Lobby без регистрации).

Правила:

- После успешной регистрации **ник фиксируется**, скин фиксируется.
- В будущем будет редактирование профиля, но **не сейчас**.

### 4.4 ProfileScreen (уже есть как точка навигации)

Минимальный контент:

- Ник
- Скин
- Статус: Guest / Registered
- Текущий MassRating (CareerMassTotal)
- Кнопка:
  - если Guest → «Сохранить прогресс / Войти» (ведёт в Registration/Auth Screen)
  - если Registered → можно не добавлять logout на первом этапе

Переход в ProfileScreen уже предусмотрен из Lobby.

### 4.5 LeaderboardScreen

Согласно UI-TZ минимально: таблица «место/ник/рейтинг», подсветка своей строки, «Назад».
Переход из Lobby по иконке рейтингов и feature-флагу уже предусмотрен.

------

## 5) Сервер: данные и логика рейтинга

### 5.1 БД (минимальные изменения)

В Архитектуре уже определены:

- `users` с признаком `is_anonymous`
- `sessions`
- `player_profiles` с `nickname`, `selected_skin_id` и пр.

Добавить в `player_profiles` (или отдельную таблицу stats — но проще в profiles):

- `career_mass_total BIGINT NOT NULL DEFAULT 0` — MassRating
- `matches_count INT NOT NULL DEFAULT 0`
- (опционально) `registered_at TIMESTAMP NULL`

Важно: любые добавления полей = обязательное обновление Part4 (Приложение B).

### 5.2 Когда начислять рейтинг

Требование пользователя: рейтинг растёт **после каждого матча зарегистрированного игрока**.

Логика:

1. Пока `users.is_anonymous=true`:
   - матчи сохраняются как обычно (MatchSummary/MatchResult), но **рейтинг не увеличиваем**.
2. В момент регистрации (upgrade):
   - рейтинг инициализируется **массой из матча**, который привёл к регистрации (тот самый “отличный результат”).
3. После регистрации (`is_anonymous=false`):
   - после каждого завершённого матча:
     - `career_mass_total += finalMass`
     - `matches_count += 1`

### 5.3 Защита от дубликатов начисления

Матч-результаты могут приходить повторно (ретраи). Поэтому начисление рейтинга должно быть:

- либо в одной транзакции с записью «обработан матч X для игрока Y» (уникальный ключ),
- либо через отдельную таблицу вида `rating_awards(user_id, match_id)` с UNIQUE(user_id, match_id).

------

## 6) Сервер: авторизация (платформы + домен)

### 6.1 Требования

- **Новые игроки не должны видеть обязательный логин** до первой/нескольких игр.
- Должна быть «тихая» регистрация платформой, если платформа умеет (например Telegram — верификация подписи initData на сервере).
- Для standalone-домена — минимальный набор OAuth: **Google и Яндекс** (прототип).

### 6.2 Upgrade сценарий (гость → зарегистрированный)

Нужно поддержать «привязку» авторизации к текущему гостевому профилю, чтобы:

- сохранить ник (из экрана регистрации),
- закрепить текущий скин,
- инициализировать рейтинг из указанного матча.

------

## 7) HTTP API (что требуется как поведение)

В плане Soft Launch smoke уже ожидает маршруты `auth/verify`, `player/get`.
Поэтому требования формулируем на уровне поведения; точные контракты и урлы — по Приложению C (Part4) и при необходимости расширяются там же.

Минимально нужно обеспечить:

1. `auth/verify`

- Варианты:
  - guest-сессия (создать/вернуть anonymous user + session)
  - platform verify (Telegram/Яндекс.Игры — если уже есть)
  - OAuth verify (Google/Яндекс) + **link/upgrade текущего anonymous**
- Возвращает токены/сессию, `is_anonymous`, `user_id`.

1. `player/get`

- Возвращает профиль: `nickname`, `selected_skin_id`, `is_anonymous`, `career_mass_total`, `matches_count`.

1. `player/update` (или аналог)

- Разрешить менять `nickname`:
  - гостю — да,
  - зарегистрированному — нет (в этой версии).

1. `leaderboard/get`

- Возвращает top-N записей (только `is_anonymous=false`), и позицию текущего игрока (если он зарегистрирован).

> Любые добавления/изменения эндпоинтов — фиксировать в Part4 Приложение C.

------

## 8) Клиент: хранение и автологин

- Хранить сессионные токены локально.
- При старте:
  - попытка восстановить сессию,
  - иначе создать guest-сессию без UI.
- Для оффера регистрации:
  - клиент должен иметь ссылку на «матч, который привёл к офферу» (например `matchId`/`summaryId`), чтобы сервер мог честно инициализировать рейтинг.

------

## 9) Acceptance Criteria (MUST)

1. Новый игрок заходит и **может начать матч без логина**.
2. В Lobby есть кнопка **Login/Sign In** в углу (не мешает онбордингу).
3. После матча гость видит оффер:
   - «Да, сохранить!» → Registration/Auth Screen
   - «Сыграть ещё» → Lobby
4. При регистрации:
   - можно сменить ник,
   - скин фиксируется,
   - рейтинг инициализируется массой «оффер-матча».
5. После регистрации каждый матч увеличивает рейтинг на итоговую массу.
6. LeaderboardScreen показывает таблицу рейтинга и выделение своей строки (если игрок зарегистрирован).
7. Smoke маршруты `auth/verify` и `player/get` работоспособны.

------

## 10) Что сознательно НЕ делаем в этой версии (Non-goals)

- Редактирование ника после регистрации (кроме будущего).
- Коллекция скинов, магазин скинов, смена скина после регистрации.
- Сезоны/лиги/сложные рейтинги (Glicko и т.п.) — только накопительная масса.

------

## 11) Обязательные изменения документации

Если добавляются поля/эндпоинты:

- обновить **SlimeArena-Architecture-v4.2.5-Part4** (Приложения B и C), иначе изменения считаются невалидными.

------

Если нужно, могу сразу подготовить **патч-список изменений для Part4 (Приложение B/C)** в формате “что добавить/заменить строка-в-строку”, чтобы это можно было быстро внести в архитектуру перед началом кодинга.