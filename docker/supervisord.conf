; =============================================================================
; Slime Arena Monolith Full - Supervisord Configuration
; Manages PostgreSQL, Redis, and Application processes in single container
; =============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

; =============================================================================
; PostgreSQL - Priority 1 (starts first)
; =============================================================================
[program:postgresql]
command=/usr/libexec/postgresql16/postgres -D /var/lib/postgresql/data
user=postgres
autostart=true
autorestart=true
priority=1
startsecs=5
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; =============================================================================
; Redis - Priority 2
; =============================================================================
[program:redis]
command=/usr/bin/redis-server --daemonize no --bind 127.0.0.1
user=redis
autostart=true
autorestart=true
priority=2
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; =============================================================================
; MetaServer - Priority 10 (after DB/Redis)
; =============================================================================
[program:meta]
command=node server/dist/server/src/meta/server.js
directory=/app
environment=NODE_ENV="production",DATABASE_URL="postgresql://slime:slime_dev_password@127.0.0.1:5432/slime_arena",REDIS_URL="redis://127.0.0.1:6379",JWT_SECRET="%(ENV_JWT_SECRET)s",CLAIM_TOKEN_TTL_MINUTES="30",ADMIN_ENCRYPTION_KEY="%(ENV_ADMIN_ENCRYPTION_KEY)s"
user=node
autostart=true
autorestart=true
priority=10
startsecs=3
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; =============================================================================
; MatchServer - Priority 10
; =============================================================================
[program:match]
command=node server/dist/server/src/index.js
directory=/app
environment=NODE_ENV="production",DATABASE_URL="postgresql://slime:slime_dev_password@127.0.0.1:5432/slime_arena",REDIS_URL="redis://127.0.0.1:6379",META_SERVER_URL="http://127.0.0.1:3000",MATCH_SERVER_TOKEN="%(ENV_MATCH_SERVER_TOKEN)s"
user=node
autostart=true
autorestart=true
priority=10
startsecs=3
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; =============================================================================
; Client Static Server - Priority 10
; =============================================================================
[program:client]
command=/usr/local/bin/serve -s client/dist -l 5173 --no-clipboard
directory=/app
user=node
autostart=true
autorestart=true
priority=10
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; =============================================================================
; Admin Dashboard Static Server - Priority 10
; =============================================================================
[program:admin]
command=/usr/local/bin/serve -c admin-dashboard/serve.json -l 5175 --no-clipboard
directory=/app
user=node
autostart=true
autorestart=true
priority=10
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
