# Архитектура проекта Slime Arena

Данный документ является основным источником информации об архитектуре проекта.

## Обзор подсистем

Проект организован как монорепозиторий с разделением на следующие ключевые подсистемы:

1.  **Server (`/server`)**:
    *   **Технологии**: Node.js, Colyseus.
    *   **Роль**: Authoritative server (источник истины). Управляет состоянием игры, физикой и сетевыми подключениями.
    *   **Точка входа**: `server/src/index.ts`.
    *   **Логика комнат**: `server/src/rooms/ArenaRoom.ts`.

2.  **Client (`/client`)**:
    *   **Технологии**: Vite, HTML5 Canvas 2D.
    *   **Роль**: Визуализация состояния игры, обработка ввода пользователя, интерполяция снапшотов.
    *   **Точка входа**: `client/src/main.ts`.

3.  **Shared (`/shared`)**:
    *   **Роль**: Общий код, используемый и клиентом, и сервером. Содержит типы данных, константы, математические формулы и логику парсинга конфигураций.

4.  **Config (`/config`)**:
    *   **Роль**: Централизованное хранение игрового баланса в формате JSON (`balance.json`).

## Ключевые модули

### Серверные модули
*   **ArenaRoom**: Основной игровой цикл, управление фазами матча, генерация уникальных имён.
*   **Systems**: Набор систем (Physics, Collision, FlightAssist, Pickup, Combat), выполняющихся каждый тик.
*   **Rng**: Детерминированный генератор случайных чисел.

### Клиентские модули
*   **Rendering**: Модуль отрисовки сущностей на Canvas (`client/src/rendering/`).
*   **Input**: Обработка управления (джойстик, клавиатура, мышь) (`client/src/input/`).
*   **UI Overlays**: 
    - Results screen (победитель, лидерборд, таймер)
    - HUD (имена слаймов с корону для KING)
*   **Snapshot Buffer**: Управление очередью состояний от сервера для плавной интерполяции.

### Общие модули (Shared)
*   **nameGenerator** (`shared/src/nameGenerator.ts`): Генератор русских имён с DRY LCG helper
*   **mathUtils** (`shared/src/mathUtils.ts`): Оптимизированные утилиты (clamp, lerp, wrapAngle O(1), distance)
*   **formulas**: Геометрические и физические формулы
*   **constants**: Флаги состояния (битовые маски)
*   **config**: Типы конфигурации и парсинг balance.json

## Связи между подсистемами

1.  **Сетевое взаимодействие**: Клиент подключается к серверу через WebSockets (протокол Colyseus). Клиент отправляет команды ввода (`InputCommand`), сервер транслирует изменения состояния (`GameState`).
2.  **Общая логика**: И клиент, и сервер импортируют типы и утилиты из `@slime-arena/shared`.
3.  **Конфигурация**: Сервер загружает `config/balance.json` при старте. Параметры включают:
    - Сглаживание сети (clientNetSmoothing: velocityWeight, catchUpSpeed, etc)
    - PvP кража массы (pvpVictimMassLossPct: 0.50, pvpAttackerMassGainPct: 0.25)
4.  **Ресурсы**: Клиент загружает спрайты из корневой папки `assets/` (через проксирование или статику).
5.  **Имена**: Сервер генерирует уникальные имена через generateUniqueName(), клиент отображает их в HUD и Results overlay

## Инфраструктура и CI/CD
*   **Docker**: Контейнеризация сервера и клиента (`docker/`).
*   **GitHub Actions**: Автоматическая сборка и тесты детерминизма (`.github/workflows/`).

---
*Примечание: Данный файл синхронизирован с Memory Bank проекта.*

## Последние изменения
*   **Пакет техдолга 1 (2 янв 2026)**:
    *   PvP укус: награды считаются от фактической потери массы, добавлена проверка инварианта.
    *   Экран результатов: сглаживание орбов и сундуков отключается при `phase === "Results"`.
    *   Рывок (`Dash`): цель ограничивается через `clampPointToWorld()` с учётом формы карты.
