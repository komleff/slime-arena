# Slime Arena

Многопользовательская браузерная игра в реальном времени про боевых слаймов. Игроки управляют персонажами, собирают массу и сражаются на арене в коротких матчах.

## Технологический стек

- **Язык**: TypeScript
- **Сервер**: Node.js, Colyseus (WebSocket)
- **Клиент**: Vite, Canvas 2D (планируется переход на PixiJS)
- **Данные**: PostgreSQL, Prisma
- **Инфраструктура**: Docker, Docker Compose

## Структура проекта

- [client/](client/) — Клиентское приложение.
- [server/](server/) — Игровой сервер и логика комнат.
- [shared/](shared/) — Общие интерфейсы, типы и константы.
- [docs/](docs/) — Техническая документация и проектные материалы.
- [config/](config/) — Конфигурация баланса и игровых механик.

## Быстрый старт

### Требования
- Node.js (версия 18 или выше)
- Docker и Docker Compose (для запуска в контейнерах)

### Установка и запуск

#### 1️⃣ Установка зависимостей
```bash
npm install
```

#### 2️⃣ Запуск серверов

**Windows (PowerShell)** — в отдельных окнах:
```powershell
.\scripts\start-servers.ps1
```

**Windows (Command Prompt)** — в отдельных окнах:
```batch
scripts\start-servers.bat
```

**Linux / macOS** — в отдельных терминалах:
```bash
./scripts/start-servers.sh
```

**Все платформы** — в одном терминале (может зависнуть VS Code на Windows):
```bash
npm run start:servers
```

**Запуск отдельно** (рекомендуется для разработки):
- Сервер: `npm run dev:server` → `ws://localhost:2567`
- Клиент: `npm run dev:client` → `http://localhost:5173`

### Доступ с мобильных устройств (локальная сеть)

1. Убедитесь, что сервер запущен: `npm run dev:server`.
2. Узнайте локальный IP компьютера (например, `192.168.0.10`).
3. Откройте клиент на этом IP: `http://192.168.0.10:5173`.
4. Если нужно явно указать адрес сервера, задайте переменную:
   - Windows (PowerShell): `setx VITE_WS_URL "ws://192.168.0.10:2567"`
   - macOS/Linux: `VITE_WS_URL=ws://192.168.0.10:2567 npm run dev:client`

#### 3️⃣ Остановка серверов

**Windows (PowerShell):**
```powershell
.\scripts\stop-servers.ps1
```

**Windows (Command Prompt):**
```batch
scripts\stop-servers.bat
```

**Все платформы** — нажмите `Ctrl+C` в терминалах.

### Docker (полный стек)
```bash
docker-compose -f docker/docker-compose.yml up
```

### Рекомендуемый рабочий процесс

1. Откройте **два терминала** в VS Code
2. **Терминал 1:** `npm run dev:server`
3. **Терминал 2:** `npm run dev:client`
4. Откройте браузер: `http://localhost:5173`

### Полезные команды

| Команда | Описание |
|---------|---------|
| `npm run build` | Собрать все пакеты |
| `npm run test` | Запустить тесты |
| `npm run dev:server` | Запустить сервер (порт 2567) |
| `npm run dev:client` | Запустить клиент (порт 5173) |
| `npm run start:servers` | Запустить оба одной командой (может зависнуть на Win) |
| `npm run stop:servers` | Остановить все серверы |

Более подробно см. [scripts/README.md](scripts/README.md).

## Документация

- [Игровой дизайн (GDD)](docs/gdd/GDD-Core.md) - модульный пакет v3.3 (базовые правила, механики, таланты, арена).
- [Архитектура](docs/SlimeArena-Architecture-v3.3.md) - техническое устройство системы.
- [План разработки](docs/SlimeArena-Plan-v3.3.md) - этапы реализации.
- [Project Brief](docs/SlimeArena-ProjectBrief.md) - краткое описание целей проекта.
- [Список задач](TODO.md) - текущий прогресс и ближайшие цели.

## Последние изменения

- Добавлена телеметрия матчевых событий с записью в `server/logs/telemetry-YYYY-MM-DD.jsonl` и отключением через `TELEMETRY_DISABLED=1`.
- Добавлена генерация арены: препятствия (столбы/шипы), проходы и безопасные зоны финала.
- Финальные безопасные зоны: урон вне зоны после `safeZones.finalStartSec`, приоритет над голодом.
- Логика генерации арены вынесена во вспомогательный модуль `server/src/rooms/helpers/arenaGeneration.ts`.
- Исправления ревью: урон шипов применяется один раз за тик, безопасные зоны учитывают множитель урона, `matchId` инициализируется до записи событий, голод не отключается при пустых safeZones.
- Исправления ревью: сообщения размещения переведены на русский, очередь телеметрии очищается после записи, убрано магическое число при выборе точки появления.
- Реализованы усиления из сундуков (`rage`, `haste`, `guard`, `greed`) и уточнена логика наград: усиление выдаётся только при отсутствии доступных талантов всех редкостей.
- Добавлены варианты размеров карты через `world.mapSizes` (800/1200/1600).
- **Пакет техдолга 1** (2 янв 2026):
  - PvP укус: награды считаются от фактической потери массы, добавлена проверка инварианта.
  - Экран результатов: сглаживание орбов и сундуков отключается при `phase === "Results"`.
  - Рывок (`Dash`): цель ограничивается через `clampPointToWorld()` с учётом формы карты.
- Эффекты талантов реализованы на сервере (урон, статусы, смерть, модификаторы).
- Клиент отрисовывает невидимость, Левиафана и токсичные лужи.
- Правки ревью: неуязвимость учитывается для яда и токсичных луж, рикошет и пробивание скорректированы.
- UI/UX: мини-карта, обновлённый HUD (таймер, уровень, очередь карточек, убийства) и расширенный экран результатов.

## Разработка

- [Защита ветки main](.github/BRANCH_PROTECTION.md) - настройка защиты основной ветки от прямых изменений.
