# Slime Arena

Многопользовательская браузерная игра в реальном времени про боевых слаймов. Игроки управляют персонажами, собирают массу и сражаются на арене в коротких матчах.

## Технологический стек

- **Язык**: TypeScript
- **Сервер**: Node.js, Colyseus (WebSocket)
- **Клиент**: Vite, Canvas 2D (планируется переход на PixiJS)
- **Данные**: PostgreSQL, pg (node-postgres, планируется для софт-лонча)
- **Инфраструктура**: Docker, Docker Compose

## Структура проекта

- [client/](client/) — Клиентское приложение.
- [server/](server/) — Игровой сервер и логика комнат.
- [shared/](shared/) — Общие интерфейсы, типы и константы.
- [docs/](docs/) — Техническая документация и проектные материалы.
- [config/](config/) — Конфигурация баланса и игровых механик.

## Быстрый старт

### Требования
- Node.js (версия 18 или выше)
- Docker и Docker Compose (для запуска в контейнерах)

### Установка и запуск

#### 1. Установка зависимостей
```bash
npm install
```

#### 2. Запуск серверов

**Windows (PowerShell)** — в отдельных окнах:
```powershell
.\scripts\start-servers.ps1
```

**Windows (Command Prompt)** — в отдельных окнах:
```batch
scripts\start-servers.bat
```

**Linux / macOS** — в отдельных терминалах:
```bash
./scripts/start-servers.sh
```

**Все платформы** — в одном терминале (может зависнуть VS Code на Windows):
```bash
npm run start:servers
```

**Запуск отдельно** (рекомендуется для разработки):
- Сервер: `npm run dev:server` → `ws://localhost:2567`
- Клиент: `npm run dev:client` → `http://localhost:5174`

### Доступ с мобильных устройств (локальная сеть)

1. Убедитесь, что сервер запущен: `npm run dev:server`.
2. Узнайте локальный IP компьютера (например, `192.168.0.10`).
3. Откройте клиент на этом IP: `http://192.168.0.10:5174`.
4. Если нужно явно указать адрес сервера, задайте переменную:
   - Windows (PowerShell): `setx VITE_WS_URL "ws://192.168.0.10:2567"`
   - macOS/Linux: `VITE_WS_URL=ws://192.168.0.10:2567 npm run dev:client`

#### 3. Остановка серверов

**Windows (PowerShell):**
```powershell
.\scripts\stop-servers.ps1
```

**Windows (Command Prompt):**
```batch
scripts\stop-servers.bat
```

**Все платформы** — нажмите `Ctrl+C` в терминалах.

### Docker (полный стек)
```bash
docker compose -f docker/docker-compose.yml up --build
```

Контейнеры доступны в GitHub Container Registry:
- `ghcr.io/komleff/slime-arena-server:v0.2.2`
- `ghcr.io/komleff/slime-arena-client:v0.2.2`

### Рекомендуемый рабочий процесс

1. Откройте **два терминала** в VS Code
2. **Терминал 1:** `npm run dev:server`
3. **Терминал 2:** `npm run dev:client`
4. Откройте браузер: `http://localhost:5174`

### Полезные команды

| Команда | Описание |
|---------|---------|
| `npm run build` | Собрать все пакеты |
| `npm run test` | Запустить тесты |
| `npm run dev:server` | Запустить сервер (порт 2567) |
| `npm run dev:client` | Запустить клиент (порт 5174) |
| `npm run start:servers` | Запустить оба одной командой (может зависнуть на Win) |
| `npm run stop:servers` | Остановить все серверы |

Более подробно см. [scripts/README.md](scripts/README.md).

## Документация

- [Игровой дизайн (GDD)](docs/gdd/GDD-Core.md) - модульный пакет v3.3 (базовые правила, механики, таланты, арена).
- [Архитектура](docs/SlimeArena-Architecture-v3.3.md) - техническое устройство системы.
- [План разработки](docs/SlimeArena-Plan-v3.3.md) - этапы реализации.
- [TZ Soft Launch](docs/TZ-SoftLaunch-v1.0.md) - техническое задание на мягкий запуск.
- [Project Brief](docs/SlimeArena-ProjectBrief.md) - краткое описание целей проекта.
- [Список задач](TODO.md) - текущий прогресс и ближайшие цели.

## Последние изменения

### UI Refactoring (текущая разработка)

**Preact миграция и ScreenManager** — модернизация UI-слоя клиента:

#### Архитектура
- **Preact + Signals** — легковесный реактивный UI (3KB gzip) вместо императивного DOM
- **UIBridge** — мост между Canvas-игрой и Preact компонентами
- **ScreenManager** — стек экранов с модальными окнами и анимациями
- **Throttled HUD** — обновление UI 10 Гц вместо 60 Гц (снижение нагрузки на DOM)

#### Компоненты
- `MainMenu` — главное меню с выбором класса и именем
- `GameHUD` — игровой интерфейс (таймер, уровень, HP, очередь карточек)
- `AbilityButtons` — кнопки способностей с визуализацией кулдауна (SVG)
- `TalentModal` — модальное окно выбора талантов
- `ResultsScreen` — экран результатов матча

#### Структура файлов
```
client/src/ui/
├── signals/
│   └── gameState.ts     — глобальное состояние (Preact Signals)
├── screens/
│   └── ScreenManager.tsx — стек экранов и модалок
├── components/
│   ├── MainMenu.tsx
│   ├── GameHUD.tsx
│   ├── AbilityButtons.tsx
│   ├── TalentModal.tsx
│   └── ResultsScreen.tsx
├── UIBridge.tsx         — API интеграции с Canvas
└── index.ts             — экспорты модуля
```

#### Изменённые файлы
- `client/package.json` — добавлены `preact`, `@preact/signals`
- `client/vite.config.ts` — конфигурация JSX для Preact
- `client/tsconfig.json` — `jsxImportSource: "preact"`

---

### Релиз v0.2.2 (5 января 2026)

**Основное:** Исправлено залипание управления на мобильных устройствах (корневая причина — браузеры генерируют compatibility mouse events на touch-устройствах). Автоматизирована сборка и публикация Docker-контейнеров в GHCR через GitHub Actions.

**Docker:** Контейнеры доступны в GitHub Container Registry:
- `ghcr.io/komleff/slime-arena-server:v0.2.2`
- `ghcr.io/komleff/slime-arena-client:v0.2.2`
- `ghcr.io/komleff/slime-arena-server:latest`
- `ghcr.io/komleff/slime-arena-client:latest`

**История изменений с v0.2:**

#### Исправления управления (Mobile Input) — PR #29
- **P0 Fix: Залипание джойстика при клике на кнопку умения** — добавлена функция `forceResetJoystickForAbility()`, которая принудительно сбрасывает джойстик и `lastSentInput` перед отправкой ability. Все кнопки умений (1, 2, 3) отправляют `moveX: 0, moveY: 0`. Добавлены `pointerdown` обработчики с `stopPropagation`.
- **Fix: Игнорирование mouse-событий на touch-устройствах** — браузеры генерируют compatibility mouse events при касании; добавлены проверки `if (isCoarsePointer) return;` в `onMouseMove` и `onMouseLeave` для предотвращения активации `mouseState`. Backup: `forceResetJoystickForAbility` сбрасывает `mouseState.active = false`.
- **Fix: Защита от сенсорного ввода для кнопок умений** — добавлена функция `applyMobileTouchGuard()` с `touchAction: "manipulation"`, отключением стандартных жестов и двойного касания.
- **Fix: Блокировка масштабирования и viewport-guard** — заблокирована масштабируемость во время игры через meta-тег (`maximum-scale=1.0`, `user-scalable=no`), добавлены глобальные обработчики жестов масштабирования.
- **Refactor: Модульный джойстик** — вынесена логика обработки джойстика в `client/src/input/joystick.ts` (конфиг, состояние, размеры). Добавлены отладочные логи по флагу `?debugJoystick=1`.
- **Review fixes:** Отполированы логи, добавлены документирующие комментарии.

#### Улучшения управления (Flybywire) — PR #30
- **Counter-acceleration:** Реализована система "контр-ускорения" для улучшенного управления джойстиком. Когда палец движется в противоположную сторону, слайм быстрее теряет скорость для более отзывчивого управления.
- **Type safety:** Добавлены TypeScript-типы для улучшения безопасности кода.

#### CI/CD Automation
- **Workflow `publish-containers.yml`:** Автоматическая сборка и публикация образов в GHCR при push в `main` или создании тегов `v*`.
- **Workflow `make-packages-public.yml`:** Ручной workflow для перевода пакетов в публичный доступ через GitHub API.

### Релиз v0.2

#### Релиз v0.2.1

- Исправлено залипание управления на мобильных устройствах с адаптивным джойстиком.
- Контейнеры опубликованы в GitHub Container Registry: `ghcr.io/komleff/slime-arena-server:v0.2.1`, `ghcr.io/komleff/slime-arena-client:v0.2.1`.

#### Релиз v0.2

- Полный цикл матча на 3 минуты с фазами Рост/Охота/Финал, детерминированный сервер 30 Гц.
- Три класса (Hunter, Warrior, Collector) с пассивами, стартовыми умениями и балансом из config/balance.json.
- Умения и уровни умений: `dash`, `shield`, `pull`, `slow`, `projectile`, `spit`, `bomb`, `push`, `mine`.
- Таланты и карточки выбора, редкости, автопик, класс-таланты, очередь карточек.
- Сундуки с наградами (таланты или усиления), вспышки и подписи, карточка таланта.
- Пузыри разных типов, укус ртом, scatter-орбы, детерминированный RNG.
- Арена с препятствиями, проходами, безопасными зонами, зонами эффектов (нектар/лёд/слизь/лава/турбо).
- Управление: тач‑джойстик, мышь как направление движения, поддержка кликов по карточкам.
- Камера с динамическим масштабом, мини‑карта, HUD, экран результатов.
- Контейнеры опубликованы в GitHub Container Registry: `ghcr.io/komleff/slime-arena-server:v0.2`, `ghcr.io/komleff/slime-arena-client:v0.2`.

- **Исправления интерфейса**: у `pendingChestRewards` добавлено ограничение размера и быстрая очистка, параметры визуализации шипов и цвета вынесены в константы, редкость таланта считается через общую функцию, при `chests.onRemove` используется позиция из `chest`. `.claude/` добавлена в `.gitignore`.
- **Изменённые файлы**: `client/src/main.ts`, `.gitignore`, `README.md`, `.memory_bank/activeContext.md`, `.memory_bank/progress.md`.

- **Таланты**: отключены неработающие `sense`, `regeneration`, `momentum`, `berserk`, `symbiosis` из набора. `turnTorqueNm` = 24000 для всех `slimeConfigs`.
- **Изменённые файлы**: `config/balance.json`, `shared/src/config.ts`, `README.md`, `.memory_bank/activeContext.md`, `.memory_bank/progress.md`.

- **Замечания проверки**: выбор карточек убран из `input`, добавлен сброс `pendingLavaScatterMass`, очищаются `pendingChestRewards`.
- **Изменённые файлы**: `server/src/rooms/ArenaRoom.ts`, `client/src/main.ts`, `README.md`, `.memory_bank/activeContext.md`, `.memory_bank/progress.md`.
- **Замечания проверки**: исправлены расчёты точки притяжения, минимальная масса scatter-орбов и описание тяги.
- **Изменённые файлы**: `server/src/rooms/ArenaRoom.ts`, `client/src/main.ts`, `server/src/rooms/schema/GameState.ts`, `config/balance.json`, `README.md`, `.memory_bank/activeContext.md`, `.memory_bank/progress.md`.
- **Карточки выбора**: сворачиваются только при крупной потере массы, мелкие потери их не скрывают.
- **Изменённые файлы**: `client/src/main.ts`, `README.md`, `.memory_bank/activeContext.md`, `.memory_bank/progress.md`.
- **Параметры классов**: приведены к GDD (Охотник +15% к скорости, Воин -10% к скорости и +10% к урону по слаймам, Собиратель +25% к укусу пузырей).
- **Сундуки (карточка награды)**: при получении таланта рядом показывается карточка с описанием и редкостью на пару секунд.
- **Карточки талантов/умений**: вынесены в боковые панели, не перекрывают центр и не мешают управлению; клик мышью на ПК работает.
- **Клик по карточке таланта (ПК)**: обработка выбора не теряется при высокой частоте input-пакетов.
- **Награды сундуков (детали)**: при открытии показывается конкретное название награды/таланта для игрока, открывшего сундук.
- **Изменённые файлы**: `client/src/main.ts`, `README.md`, `.memory_bank/activeContext.md`, `.memory_bank/progress.md`.

- **Шипастые препятствия**: теперь визуально отличаются от столбов — серая основа с серыми металлическими шипами и знаком ⚠.
- **Scatter-орбы**: минимальная масса 5 кг — мелкие объединяются, поле чище.
- **Камера x2**: поле обзора увеличено в 2 раза (800x800 вместо 400x400).
- **Сетка**: яркость увеличена (0.03→0.12), добавлены major-линии каждые 5 клеток.
- **Награды сундуков**: при открытии появляется вспышка и всплывающий текст с названием награды/таланта.
- **Баланс тяги**: вперёд — в 3 раза, назад и боковая — в 1,33 раза, угловая — в 1,33 раза (от прежних значений).
- **Клик по карточкам**: карточки умений и талантов поддерживают клик мышью (помимо клавиш 7/8/9), добавлены подсказки.
- **Джойстик только для тач**: мышь больше не активирует виртуальный джойстик на ПК. Управление мышью: курсор задаёт направление движения.
- **Притяжение к пасти**: орбы теперь притягиваются к точке впереди рта слайма (1.9 радиуса от центра).
- Собиратель: стартовое умение изменено на `pull` (Притяжение), `slow` перенесено в общий пул умений.
- Проведена чистка `.memory_bank`: архивированы устаревшие модули, добавлен `mass-combat.md`.
- Добавлены уровни умений по GDD: параметры в `config/balance.json`, уровни хранятся в `GameState`, улучшения выдаются через карточки талантов.
- Щит: отражение урона на уровне 2, волна отталкивания на уровне 3, щит больше не снимается от урона.
- Выброс: пробивание на уровне 3 с частичным уроном по второй цели.
- Камера: динамическое масштабирование по массе с паузой после получения урона, параметры в `config/balance.json`.
- Добавлен документ `docs/TZ-SoftLaunch-v1.0.md`.
- Добавлены зоны эффектов арены (нектар, лёд, слизь, лава, турбо): генерация, эффекты скорости и массы, отрисовка на карте и в мире.
- Выделены системы симуляции `ArenaRoom.ts` в отдельные модули `server/src/rooms/systems` без изменения логики.
- Добавлены тесты генерации арены, препятствий, безопасных зон и зон эффектов (`server/tests/arena-generation.test.js`).
- Добавлена телеметрия матчевых событий с записью в `server/logs/telemetry-YYYY-MM-DD.jsonl` и отключением через `TELEMETRY_DISABLED=1`.
- Добавлена генерация арены: препятствия (столбы/шипы), проходы и безопасные зоны финала.
- Финальные безопасные зоны: урон вне зоны после `safeZones.finalStartSec`, приоритет над голодом.
- Логика генерации арены вынесена во вспомогательный модуль `server/src/rooms/helpers/arenaGeneration.ts`.
- Исправления ревью: урон шипов применяется один раз за тик, безопасные зоны учитывают множитель урона, `matchId` инициализируется до записи событий, голод не отключается при пустых safeZones.
- Исправления ревью: сообщения размещения переведены на русский, очередь телеметрии очищается после записи, убрано магическое число при выборе точки появления.
- Реализованы усиления из сундуков (`rage`, `haste`, `guard`, `greed`) и уточнена логика наград: усиление выдаётся только при отсутствии доступных талантов всех редкостей.
- Добавлены варианты размеров карты через `world.mapSizes` (800/1200/1600).
- Добавлены Dockerfile для контейнеров: `docker/server.Dockerfile` и `docker/client.Dockerfile`.
- **Пакет техдолга 1** (2 янв 2026):
  - PvP укус: награды считаются от фактической потери массы, добавлена проверка инварианта.
  - Экран результатов: сглаживание орбов и сундуков отключается при `phase === "Results"`.
  - Рывок (`Dash`): цель ограничивается через `clampPointToWorld()` с учётом формы карты.
- Эффекты талантов реализованы на сервере (урон, статусы, смерть, модификаторы).
- Клиент отрисовывает невидимость, Левиафана и токсичные лужи.
- Правки ревью: неуязвимость учитывается для яда и токсичных луж, рикошет и пробивание скорректированы.
- UI/UX: мини-карта, обновлённый HUD (таймер, уровень, очередь карточек, убийства) и расширенный экран результатов.

## Разработка

- [Защита ветки main](.github/BRANCH_PROTECTION.md) - настройка защиты основной ветки от прямых изменений.
