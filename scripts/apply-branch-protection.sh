#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð» Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð²ÐµÑ‚ÐºÐ¸ main Ñ‡ÐµÑ€ÐµÐ· GitHub API
# Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚: GITHUB_TOKEN Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ repo, jq

set -e

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ)
REPO_OWNER="${REPO_OWNER:-komleff}"
REPO_NAME="${REPO_NAME:-slime-arena}"
BRANCH="${BRANCH:-main}"
CONFIG_FILE="${CONFIG_FILE:-.github/branch-protection-config.json}"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ jq
if ! command -v jq &> /dev/null; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ð° jq Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
  echo ""
  echo "Ð”Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸:"
  echo "  Ubuntu/Debian: sudo apt-get install jq"
  echo "  macOS: brew install jq"
  echo "  Windows (Git Bash): choco install jq"
  echo ""
  echo "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ: https://stedolan.github.io/jq/download/"
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
if [ -z "$GITHUB_TOKEN" ]; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ GITHUB_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
  echo ""
  echo "Ð”Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°:"
  echo "1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ https://github.com/settings/tokens"
  echo "2. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Generate new token (classic)'"
  echo "3. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð°: repo (Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿)"
  echo "4. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ ÐµÐ³Ð¾"
  echo ""
  echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ:"
  echo "  export GITHUB_TOKEN=your_token_here"
  echo "  ./scripts/apply-branch-protection.sh"
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
if [ ! -f "$CONFIG_FILE" ]; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $CONFIG_FILE"
  exit 1
fi

# Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ JSON ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
if ! jq empty "$CONFIG_FILE" 2>/dev/null; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹ JSON: $CONFIG_FILE"
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ ÐºÐ»ÑŽÑ‡Ð° protection
if ! jq -e '.protection' "$CONFIG_FILE" > /dev/null 2>&1; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÐºÐ»ÑŽÑ‡ 'protection': $CONFIG_FILE"
  exit 1
fi

echo "ðŸ”’ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð» Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð²ÐµÑ‚ÐºÐ¸ $BRANCH..."
echo "   Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: $REPO_OWNER/$REPO_NAME"
echo ""

# Ð§Ñ‚ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
PROTECTION_CONFIG=$(jq '.protection' "$CONFIG_FILE")

# ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð» Ñ‡ÐµÑ€ÐµÐ· GitHub API
RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $GITHUB_TOKEN" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/branches/$BRANCH/protection" \
  -d "$PROTECTION_CONFIG")

# Ð Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¸ ÐºÐ¾Ð´Ð° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

if [ "$HTTP_CODE" == "200" ]; then
  echo "âœ… ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð²ÐµÑ‚ÐºÐ¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹!"
  echo ""
  echo "ÐÐ°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:"
  echo "  âœ“ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐ»Ð¸ÑÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð²Ð½ÐµÑÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹"
  echo "  âœ“ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¾Ð´Ð¾Ð±Ñ€ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° ÐºÐ¾Ð´Ð° (1 Ð¾Ð´Ð¾Ð±Ñ€ÐµÐ½Ð¸Ðµ)"
  echo "  âœ“ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº: build-and-test"
  echo "  âœ“ ÐžÐ´Ð¾Ð±Ñ€ÐµÐ½Ð¸Ñ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… Ñ„Ð¸ÐºÑÐ°Ñ†Ð¸ÑÑ…"
  echo "  âœ“ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ²"
  echo "  âœ“ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°Ð¼"
  echo "  âœ“ Ð—Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð° Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° (force push)"
  echo "  âœ“ Ð—Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸"
  echo ""
  echo "Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð²ÐµÑ‚ÐºÑƒ main Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð° ÑÐ»Ð¸ÑÐ½Ð¸Ðµ."
elif [ "$HTTP_CODE" == "403" ]; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° 403: ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð²"
  echo ""
  echo "Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹:"
  echo "  1. Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² repo"
  echo "  2. Ð’Ñ‹ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÐµÑÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ"
  echo ""
  echo "Ð”Ð»Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒÑÑ:"
  echo "  - ÐŸÑ€Ð°Ð²Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð² Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸"
  echo "  - Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº API Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸"
elif [ "$HTTP_CODE" == "404" ]; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° 404: Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¸Ð»Ð¸ Ð²ÐµÑ‚ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
  echo ""
  echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
  echo "  - Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: $REPO_OWNER/$REPO_NAME"
  echo "  - Ð’ÐµÑ‚ÐºÐ°: $BRANCH"
else
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ (ÐºÐ¾Ð´ $HTTP_CODE)"
  echo ""
  echo "ÐžÑ‚Ð²ÐµÑ‚ API:"
  echo "$HTTP_BODY" | jq '.' 2>/dev/null || echo "$HTTP_BODY"
  exit 1
fi
